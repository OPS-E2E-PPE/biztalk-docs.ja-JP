---
title: メッセージのカスタム例外ハンドラーのサンプルを永続化を実行している |。Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: a0a4c819-f6bd-4dea-8be9-e3006337665f
caps.latest.revision: 2
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 4ba7ef5fda253f4dc96d4e29a109d0bb0c576cee
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2019
ms.locfileid: "65242734"
---
# <a name="running-the-message-persisting-custom-exception-handler-sample"></a><span data-ttu-id="c36ed-102">メッセージのカスタム例外ハンドラーのサンプルを永続化を実行しています。</span><span class="sxs-lookup"><span data-stu-id="c36ed-102">Running the Message Persisting Custom Exception Handler Sample</span></span>
<span data-ttu-id="c36ed-103">メッセージの永続化カスタム例外ハンドラーのサンプルでは、エラー メッセージを受信、格納、およびディスクのファイルとしてファイル システムに書き込む、Microsoft BizTalk メッセージの抽出を疎結合の一般的なハンドラーを示します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-103">The Message Persisting Custom Exception Handler sample demonstrates a loosely coupled, generic handler that receives fault messages, extracts the Microsoft BizTalk messages they contain, and writes them as disk files to the file system.</span></span>  
  
 <span data-ttu-id="c36ed-104">サンプルでは、オーケストレーションでカスタム例外ハンドラーを使用する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-104">The sample shows how you can use a custom exception handler in an orchestration.</span></span> <span data-ttu-id="c36ed-105">オーケストレーション (EAIProcess.odx) でプロセスには、エラーが発生すると、例外ハンドラーが生成し、ESB エラー メッセージがパブリッシュされます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-105">When a process in the orchestration (EAIProcess.odx) encounters an error, the exception handler generates and publishes an ESB fault message.</span></span> <span data-ttu-id="c36ed-106">このエラー メッセージにはでそのペイロードで (と、BizTalk に関連するコンテキスト プロパティを含む)"インフライト"に含まれていたメッセージが含まれます、BizTalk オーケストレーション エンジンによってキャッチ、現在の System.Exception インスタンスと、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-106">This fault message includes in its payload the messages (including their BizTalk-related context properties) that were "in flight" when the exception occurred, as well as the current System.Exception instance caught by the BizTalk Orchestration engine.</span></span> <span data-ttu-id="c36ed-107">この場合、「拒否」メッセージと"Approved"メッセージが、エラー メッセージを永続化されます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-107">When this occurs, a "Denied" message and an "Approved" message are persisted with the fault message.</span></span>  
  
 <span data-ttu-id="c36ed-108">EAIGenericHandler.odx、これが分離された方法で配置され、カスタム例外ハンドラーとして機能する、という名前の 2 番目のオーケストレーションは EAIGenericHandler.odx オーケストレーションで生成された特定のエラー コードをサブスクライブし、エラー メッセージを使用します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-108">A second orchestration named EAIGenericHandler.odx, which is deployed in a decoupled manner and acts as a custom exception handler, subscribes to the specific fault code generated in the EAIGenericHandler.odx orchestration and consumes the fault message.</span></span> <span data-ttu-id="c36ed-109">この例外ハンドラーが (型のないドキュメント) として元のメッセージを抽出し、System.Exception インスタンスは当初、エラー メッセージに永続化します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-109">This exception handler extracts the original messages (as type-less documents) and the System.Exception instances originally persisted in the fault message.</span></span>  
  
 <span data-ttu-id="c36ed-110">メッセージの永続化カスタム例外ハンドラーのサンプルは、このサンプルで使用する EAIGenericHandler.odx オーケストレーションでは、フォールトの発行で使用されるスキーマには、依存関係はありません点で、修復と再送信のカスタム例外ハンドラーのサンプルとは異なります。オーケストレーション プロセス (EAIProcess.odx)。</span><span class="sxs-lookup"><span data-stu-id="c36ed-110">The Message Persisting Custom Exception Handler sample differs from the Repair and Resubmit Custom Exception Handler sample in that the EAIGenericHandler.odx orchestration used in this sample does not have a dependency on the schemas used in the fault publishing orchestration process (EAIProcess.odx).</span></span> <span data-ttu-id="c36ed-111">具体的には、EAIGenericHandler.odx オーケストレーションは、EAIProcess.odx オーケストレーションで使用されるスキーマに基づいて、型指定されたメッセージではなく System.Xml.XmlDocument インスタンスとして、エラー メッセージから元のメッセージを取得します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-111">Specifically, the EAIGenericHandler.odx orchestration retrieves the original messages from the fault message as System.Xml.XmlDocument instances instead of typed messages based on the schemas used in the EAIProcess.odx orchestration.</span></span> <span data-ttu-id="c36ed-112">また、コードを簡単に列挙するコレクションとして、メッセージを返します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-112">It also returns the messages as a collection that code can easily enumerate.</span></span>  
  
 <span data-ttu-id="c36ed-113">カスタム例外ハンドラー (EAIGenericHandler.odx) では、ファイル システムの場所 \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg に"Denied"と"Approved"メッセージの両方をし、書き込みます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-113">The custom exception handler (EAIGenericHandler.odx) then writes both the "Denied" and the "Approved" messages to the file system location \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg.</span></span>  
  
 <span data-ttu-id="c36ed-114">さらに、すべてをという名前の汎用的な送信ポートがあります。一部としてインストールされている、GlobalFaultProcessor パイプラインを使用するように構成 Exceptions_FILE、[!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)]例外管理フレームワーク。</span><span class="sxs-lookup"><span data-stu-id="c36ed-114">Additionally, there is a generic send port named ALL.Exceptions_FILE configured to use the GlobalFaultProcessor pipeline installed as part of the [!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)] Exception Management Framework.</span></span> <span data-ttu-id="c36ed-115">このポートが、システムではすべての例外をサブスクライブ、両方の BizTalk は、メッセージのメッセージをルーティングし、ESB エラー メッセージが失敗しました。</span><span class="sxs-lookup"><span data-stu-id="c36ed-115">This port subscribes to all exceptions in the system, both BizTalk failed message routing messages and ESB fault messages.</span></span> <span data-ttu-id="c36ed-116">例外管理フレームワークでは、それらすべてを 1 つの形式に正規化し、場所 \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions を Microsoft InfoPath 処理命令を使用してそれらをシリアル化します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-116">The Exception Management Framework normalizes them all to a single format and serializes them using a Microsoft InfoPath processing instruction to the location \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions.</span></span>  
  
## <a name="installation"></a><span data-ttu-id="c36ed-117">インストール</span><span class="sxs-lookup"><span data-stu-id="c36ed-117">Installation</span></span>  
 <span data-ttu-id="c36ed-118">すべての例外管理サンプルでは、同じコア サービスと BizTalk アプリケーションのアイテムのセットを使用します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-118">All the exception management samples use the same set of core services and BizTalk application artifacts.</span></span> <span data-ttu-id="c36ed-119">そのため、すべての例外管理サンプルを実行できる例外管理サンプル アイテム 1 回だけをインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="c36ed-119">Therefore, you have to install the exception management sample artifacts only once to be able to run all the exception management samples.</span></span> <span data-ttu-id="c36ed-120">例外管理サンプルをインストールする方法については、次を参照してください。[例外管理サンプルをインストールする](../esb-toolkit/installing-the-exception-management-samples.md)します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-120">For information about how to install the exception management samples, see [Installing the Exception Management Samples](../esb-toolkit/installing-the-exception-management-samples.md).</span></span>  
  
## <a name="running-the-sample-application"></a><span data-ttu-id="c36ed-121">サンプル アプリケーションを実行します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-121">Running the Sample Application</span></span>  
 <span data-ttu-id="c36ed-122">**メッセージの永続化カスタム例外ハンドラーのサンプルを実行するには**</span><span class="sxs-lookup"><span data-stu-id="c36ed-122">**To run the Message Persisting Custom Exception Handler sample**</span></span>  
  
1.  <span data-ttu-id="c36ed-123">最初にこのサンプルを実行する前に、受信場所と送信ポートの URL を指している \Source\Samples\Exception Handling\Test\Filedrop フォルダーに適切なディレクトリを確認します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-123">Before you run this sample for the first time, make sure that the receive location and send port URL point to the appropriate directories in the \Source\Samples\Exception Handling\Test\Filedrop folder.</span></span> <span data-ttu-id="c36ed-124">受信場所が EAIProcess.RequestPort、フォルダーを指定し、送信ポートの URL は EAIGenericHandler.PostTmpMsg フォルダーを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="c36ed-124">The receive location should specify the folder EAIProcess.RequestPort, and the send port URL should specify the folder EAIGenericHandler.PostTmpMsg.</span></span>  
  
2.  <span data-ttu-id="c36ed-125">GlobalBank.ESB アプリケーションが実行されていない場合は、BizTalk 管理コンソールを使用して開始します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-125">If the GlobalBank.ESB application is not already running, use the BizTalk Administration Console to start it.</span></span>  
  
3.  <span data-ttu-id="c36ed-126">\Source\Samples\Exception Handling\Test\Data フォルダーの EAIProcess.RequestPort_FILE 受信場所の指定したフォルダーにある Request_EAIGenericHandler.xml をという名前のサンプル ファイルをコピーして、サンプルを開始する: \Source\Samples\例外 Handling\Test\Filedrop\EAIProcess.RequestPort します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-126">Start the sample by copying the sample file named Request_EAIGenericHandler.xml, located in the \Source\Samples\Exception Handling\Test\Data folder, to the folder specified for the EAIProcess.RequestPort_FILE receive location: \Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.RequestPort.</span></span>  
  
4.  <span data-ttu-id="c36ed-127">(\Source\Samples\Exception Handling\Test\Filedrop\ フォルダー) 内の EAIGenericHandler.PostTmpMsg をという名前のフォルダーを開きます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-127">Open the folder named EAIGenericHandler.PostTmpMsg (in the \Source\Samples\Exception Handling\Test\Filedrop\ folder).</span></span> <span data-ttu-id="c36ed-128">元のメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-128">You will see the original message.</span></span>  
  
## <a name="how-the-sample-works"></a><span data-ttu-id="c36ed-129">サンプルのしくみ</span><span class="sxs-lookup"><span data-stu-id="c36ed-129">How the Sample Works</span></span>  
 <span data-ttu-id="c36ed-130">メッセージを送信するには、EAIProcess オーケストレーションがアクティブにします。</span><span class="sxs-lookup"><span data-stu-id="c36ed-130">The message you submit activates the EAIProcess orchestration.</span></span> <span data-ttu-id="c36ed-131">では、EAIProcess オーケストレーションでメッセージを処理するときに、単価で 1 を除算しようとします。</span><span class="sxs-lookup"><span data-stu-id="c36ed-131">When the EAIProcess orchestration processes the message, it attempts to divide 1 by the unit price.</span></span> <span data-ttu-id="c36ed-132">単価はゼロであるため、0 除算の例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-132">Because the unit price is zero, a divide-by-zero exception occurs.</span></span> <span data-ttu-id="c36ed-133">オーケストレーションのイベント ハンドラーのコードでは、この例外をキャッチし、エラー メッセージを作成します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-133">Code in the event handler of the orchestration catches this exception and creates a fault message.</span></span> <span data-ttu-id="c36ed-134">メッセージの注文数量は 10 未満、ビジネス ロジックでは、この例外にによって決まります、 **FaultCode**フィールドの値の**2000**します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-134">The order quantity in the message is less than 10, so the business logic dictates that this exception has a **FaultCode** field value of **2000**.</span></span>  
  
 <span data-ttu-id="c36ed-135">EAIProcess オーケストレーションをし、直接バインドされたポートを通じて BizTalk メッセージ ボックスに、エラー メッセージを発行し、オーケストレーションが終了します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-135">The EAIProcess orchestration then publishes the fault message to the BizTalk Message Box through a direct-bound port, and the orchestration ends.</span></span>  
  
 <span data-ttu-id="c36ed-136">メッセージにサブスクライブする、EAIGenericHandler という名前のカスタム エラー ハンドラー オーケストレーション、 **FaultCode**フィールドの値の**2000**、新しいエラー メッセージを取得します。</span><span class="sxs-lookup"><span data-stu-id="c36ed-136">A custom fault handler orchestration named EAIGenericHandler, which subscribes to messages with a **FaultCode** field value of **2000**, picks up the new fault message.</span></span> <span data-ttu-id="c36ed-137">オーケストレーション内のコードでは、例外 (フォールト) メッセージからすべてのメッセージを抽出し、ディスク ファイルに書き込みます。</span><span class="sxs-lookup"><span data-stu-id="c36ed-137">The code in the orchestration extracts all the messages from the exception (fault) message and writes them to disk files.</span></span>