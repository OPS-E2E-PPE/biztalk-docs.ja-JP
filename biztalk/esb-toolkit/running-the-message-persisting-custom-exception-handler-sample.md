---
title: カスタム例外ハンドラーのサンプルを保持するメッセージを実行している |Microsoft ドキュメント
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: a0a4c819-f6bd-4dea-8be9-e3006337665f
caps.latest.revision: 2
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: f6d7927357e4c2be03ecd8b2e77d45558b5bc692
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
ms.locfileid: "22295330"
---
# <a name="running-the-message-persisting-custom-exception-handler-sample"></a><span data-ttu-id="9573d-102">カスタム例外ハンドラーのサンプルを保持するメッセージを実行しています。</span><span class="sxs-lookup"><span data-stu-id="9573d-102">Running the Message Persisting Custom Exception Handler Sample</span></span>
<span data-ttu-id="9573d-103">メッセージの永続化のカスタム例外ハンドラーのサンプルでは、エラー メッセージを受信、これらの格納、およびファイル システムにディスク ファイルとして書き込みます Microsoft BizTalk メッセージを抽出する疎結合、ジェネリック ハンドラーを示します。</span><span class="sxs-lookup"><span data-stu-id="9573d-103">The Message Persisting Custom Exception Handler sample demonstrates a loosely coupled, generic handler that receives fault messages, extracts the Microsoft BizTalk messages they contain, and writes them as disk files to the file system.</span></span>  
  
 <span data-ttu-id="9573d-104">サンプルは、オーケストレーションでのカスタム例外ハンドラーを使用する方法を示します。</span><span class="sxs-lookup"><span data-stu-id="9573d-104">The sample shows how you can use a custom exception handler in an orchestration.</span></span> <span data-ttu-id="9573d-105">オーケストレーション (EAIProcess.odx) でプロセスには、エラーが発生すると、例外ハンドラーが生成し、ESB フォールト メッセージを公開します。</span><span class="sxs-lookup"><span data-stu-id="9573d-105">When a process in the orchestration (EAIProcess.odx) encounters an error, the exception handler generates and publishes an ESB fault message.</span></span> <span data-ttu-id="9573d-106">このエラー メッセージにはでそのペイロードに"インフライト"であった (と、BizTalk に関連するコンテキスト プロパティを含む) メッセージが含まれます、BizTalk オーケストレーション エンジンによってキャッチされた現在の System.Exception インスタンスだけでなく、例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="9573d-106">This fault message includes in its payload the messages (including their BizTalk-related context properties) that were "in flight" when the exception occurred, as well as the current System.Exception instance caught by the BizTalk Orchestration engine.</span></span> <span data-ttu-id="9573d-107">この問題が発生すると、「拒否」メッセージと"Approved"メッセージが、エラー メッセージに永続化されます。</span><span class="sxs-lookup"><span data-stu-id="9573d-107">When this occurs, a "Denied" message and an "Approved" message are persisted with the fault message.</span></span>  
  
 <span data-ttu-id="9573d-108">EAIGenericHandler.odx、分離された方法が展開されており、カスタム例外ハンドラーとして機能し、これをという名前の 2 番目のオーケストレーションは EAIGenericHandler.odx オーケストレーションで生成された特定のエラー コードをサブスクライブし、エラー メッセージを使用します。</span><span class="sxs-lookup"><span data-stu-id="9573d-108">A second orchestration named EAIGenericHandler.odx, which is deployed in a decoupled manner and acts as a custom exception handler, subscribes to the specific fault code generated in the EAIGenericHandler.odx orchestration and consumes the fault message.</span></span> <span data-ttu-id="9573d-109">この例外ハンドラーが (型のないドキュメント) として元のメッセージを抽出し、System.Exception インスタンスは当初、エラー メッセージに永続化します。</span><span class="sxs-lookup"><span data-stu-id="9573d-109">This exception handler extracts the original messages (as type-less documents) and the System.Exception instances originally persisted in the fault message.</span></span>  
  
 <span data-ttu-id="9573d-110">メッセージの永続化のカスタム例外ハンドラーのサンプルは、このサンプルで使用する EAIGenericHandler.odx オーケストレーションでは、フォールトの発行に使用されるスキーマには、依存関係はありません点で、修復と再送信のカスタム例外ハンドラーのサンプルとは異なります。オーケストレーション プロセス (EAIProcess.odx)。</span><span class="sxs-lookup"><span data-stu-id="9573d-110">The Message Persisting Custom Exception Handler sample differs from the Repair and Resubmit Custom Exception Handler sample in that the EAIGenericHandler.odx orchestration used in this sample does not have a dependency on the schemas used in the fault publishing orchestration process (EAIProcess.odx).</span></span> <span data-ttu-id="9573d-111">具体的には、EAIGenericHandler.odx オーケストレーションは、EAIProcess.odx オーケストレーションで使用されるスキーマに基づいて、型指定されたメッセージではなく System.Xml.XmlDocument インスタンスとして、エラー メッセージから元のメッセージを取得します。</span><span class="sxs-lookup"><span data-stu-id="9573d-111">Specifically, the EAIGenericHandler.odx orchestration retrieves the original messages from the fault message as System.Xml.XmlDocument instances instead of typed messages based on the schemas used in the EAIProcess.odx orchestration.</span></span> <span data-ttu-id="9573d-112">また、コードを簡単に列挙できるコレクションとしてメッセージを返します。</span><span class="sxs-lookup"><span data-stu-id="9573d-112">It also returns the messages as a collection that code can easily enumerate.</span></span>  
  
 <span data-ttu-id="9573d-113">カスタム例外ハンドラー (EAIGenericHandler.odx) では、ファイル システムの場所 \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg に"Denied"と"Approved"メッセージの両方をし、書き込みます。</span><span class="sxs-lookup"><span data-stu-id="9573d-113">The custom exception handler (EAIGenericHandler.odx) then writes both the "Denied" and the "Approved" messages to the file system location \Source\Samples\Exception Handling\Test\Filedrop\EAIGenericHandler.PostTmpMsg.</span></span>  
  
 <span data-ttu-id="9573d-114">さらに、ALL という名前の汎用的な送信ポートがあります。一部としてインストールされている、GlobalFaultProcessor パイプラインを使用するように構成 Exceptions_FILE、[!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)]例外管理フレームワーク。</span><span class="sxs-lookup"><span data-stu-id="9573d-114">Additionally, there is a generic send port named ALL.Exceptions_FILE configured to use the GlobalFaultProcessor pipeline installed as part of the [!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)] Exception Management Framework.</span></span> <span data-ttu-id="9573d-115">このポートは、システム内のすべての例外をサブスクライブ、両方の BizTalk は、メッセージをルーティングするメッセージと ESB エラー メッセージが失敗しました。</span><span class="sxs-lookup"><span data-stu-id="9573d-115">This port subscribes to all exceptions in the system, both BizTalk failed message routing messages and ESB fault messages.</span></span> <span data-ttu-id="9573d-116">例外管理フレームワークでは、それらをすべて 1 つの形式を正規化し、場所 \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions を Microsoft InfoPath 処理命令を使用してシリアル化します。</span><span class="sxs-lookup"><span data-stu-id="9573d-116">The Exception Management Framework normalizes them all to a single format and serializes them using a Microsoft InfoPath processing instruction to the location \Source\Samples\Exception Handling\Test\Filedrop\All_Exceptions.</span></span>  
  
## <a name="installation"></a><span data-ttu-id="9573d-117">インストール</span><span class="sxs-lookup"><span data-stu-id="9573d-117">Installation</span></span>  
 <span data-ttu-id="9573d-118">すべての例外管理サンプルは、同じコア サービスと BizTalk アプリケーションのアイテムのセットを使用します。</span><span class="sxs-lookup"><span data-stu-id="9573d-118">All the exception management samples use the same set of core services and BizTalk application artifacts.</span></span> <span data-ttu-id="9573d-119">そのため、すべての例外の管理のサンプルを実行するために例外管理サンプル アイテム 1 回だけをインストールする必要があります。</span><span class="sxs-lookup"><span data-stu-id="9573d-119">Therefore, you have to install the exception management sample artifacts only once to be able to run all the exception management samples.</span></span> <span data-ttu-id="9573d-120">例外の管理のサンプルをインストールする方法については、次を参照してください。[例外管理のサンプルをインストールする](../esb-toolkit/installing-the-exception-management-samples.md)です。</span><span class="sxs-lookup"><span data-stu-id="9573d-120">For information about how to install the exception management samples, see [Installing the Exception Management Samples](../esb-toolkit/installing-the-exception-management-samples.md).</span></span>  
  
## <a name="running-the-sample-application"></a><span data-ttu-id="9573d-121">サンプル アプリケーションの実行</span><span class="sxs-lookup"><span data-stu-id="9573d-121">Running the Sample Application</span></span>  
 <span data-ttu-id="9573d-122">**メッセージの永続化のカスタム例外ハンドラーのサンプルを実行するには**</span><span class="sxs-lookup"><span data-stu-id="9573d-122">**To run the Message Persisting Custom Exception Handler sample**</span></span>  
  
1.  <span data-ttu-id="9573d-123">最初にこのサンプルを実行する前に、受信場所と送信ポートの URL を指している \Source\Samples\Exception Handling\Test\Filedrop フォルダーに適切なディレクトリを確認します。</span><span class="sxs-lookup"><span data-stu-id="9573d-123">Before you run this sample for the first time, make sure that the receive location and send port URL point to the appropriate directories in the \Source\Samples\Exception Handling\Test\Filedrop folder.</span></span> <span data-ttu-id="9573d-124">受信場所が EAIProcess.RequestPort、フォルダーを指定する必要があり、送信ポートの URL は EAIGenericHandler.PostTmpMsg のフォルダーを指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="9573d-124">The receive location should specify the folder EAIProcess.RequestPort, and the send port URL should specify the folder EAIGenericHandler.PostTmpMsg.</span></span>  
  
2.  <span data-ttu-id="9573d-125">GlobalBank.ESB アプリケーションが既に実行されていない場合は、BizTalk 管理コンソールを使用して、開始します。</span><span class="sxs-lookup"><span data-stu-id="9573d-125">If the GlobalBank.ESB application is not already running, use the BizTalk Administration Console to start it.</span></span>  
  
3.  <span data-ttu-id="9573d-126">EAIProcess.RequestPort_FILE 受信場所の指定されたフォルダーに、\Source\Samples\Exception Handling\Test\Data フォルダーにある Request_EAIGenericHandler.xml をという名前のサンプル ファイルをコピーして、サンプルを開始する: \Source\Samples\例外 Handling\Test\Filedrop\EAIProcess.RequestPort です。</span><span class="sxs-lookup"><span data-stu-id="9573d-126">Start the sample by copying the sample file named Request_EAIGenericHandler.xml, located in the \Source\Samples\Exception Handling\Test\Data folder, to the folder specified for the EAIProcess.RequestPort_FILE receive location: \Source\Samples\Exception Handling\Test\Filedrop\EAIProcess.RequestPort.</span></span>  
  
4.  <span data-ttu-id="9573d-127">(フォルダーにある \Source\Samples\Exception Handling\Test\Filedrop\) EAIGenericHandler.PostTmpMsg をという名前のフォルダーを開きます。</span><span class="sxs-lookup"><span data-stu-id="9573d-127">Open the folder named EAIGenericHandler.PostTmpMsg (in the \Source\Samples\Exception Handling\Test\Filedrop\ folder).</span></span> <span data-ttu-id="9573d-128">元のメッセージが表示されます。</span><span class="sxs-lookup"><span data-stu-id="9573d-128">You will see the original message.</span></span>  
  
## <a name="how-the-sample-works"></a><span data-ttu-id="9573d-129">このサンプルのしくみ</span><span class="sxs-lookup"><span data-stu-id="9573d-129">How the Sample Works</span></span>  
 <span data-ttu-id="9573d-130">メッセージを送信するには、EAIProcess オーケストレーションがアクティブにします。</span><span class="sxs-lookup"><span data-stu-id="9573d-130">The message you submit activates the EAIProcess orchestration.</span></span> <span data-ttu-id="9573d-131">では、EAIProcess オーケストレーションでは、メッセージを処理するとき、単価で 1 を除算しようとします。</span><span class="sxs-lookup"><span data-stu-id="9573d-131">When the EAIProcess orchestration processes the message, it attempts to divide 1 by the unit price.</span></span> <span data-ttu-id="9573d-132">単価はゼロであるため、0 除算の例外が発生します。</span><span class="sxs-lookup"><span data-stu-id="9573d-132">Because the unit price is zero, a divide-by-zero exception occurs.</span></span> <span data-ttu-id="9573d-133">オーケストレーションのイベント ハンドラーのコードでは、この例外をキャッチし、エラー メッセージを作成します。</span><span class="sxs-lookup"><span data-stu-id="9573d-133">Code in the event handler of the orchestration catches this exception and creates a fault message.</span></span> <span data-ttu-id="9573d-134">ビジネス ロジックでこの例外があるために、メッセージの注文数量は 10 未満、 **FaultCode**フィールドの値の**2000**です。</span><span class="sxs-lookup"><span data-stu-id="9573d-134">The order quantity in the message is less than 10, so the business logic dictates that this exception has a **FaultCode** field value of **2000**.</span></span>  
  
 <span data-ttu-id="9573d-135">オーケストレーションが終了し、では、EAIProcess オーケストレーションが直接バインド ポートを通じて BizTalk メッセージ ボックスに、エラー メッセージを発行します。</span><span class="sxs-lookup"><span data-stu-id="9573d-135">The EAIProcess orchestration then publishes the fault message to the BizTalk Message Box through a direct-bound port, and the orchestration ends.</span></span>  
  
 <span data-ttu-id="9573d-136">メッセージをサブスクライブする EAIGenericHandler をという名前のカスタム エラー ハンドラー オーケストレーション、 **FaultCode**フィールドの値の**2000**、新しいエラー メッセージを取得します。</span><span class="sxs-lookup"><span data-stu-id="9573d-136">A custom fault handler orchestration named EAIGenericHandler, which subscribes to messages with a **FaultCode** field value of **2000**, picks up the new fault message.</span></span> <span data-ttu-id="9573d-137">オーケストレーション内のコードでは、例外 (フォールト) メッセージからのすべてのメッセージを抽出し、ディスク ファイルに書き込みます。</span><span class="sxs-lookup"><span data-stu-id="9573d-137">The code in the orchestration extracts all the messages from the exception (fault) message and writes them to disk files.</span></span>