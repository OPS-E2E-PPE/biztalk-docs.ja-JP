---
title: '方法: 動的にビジネス ルール ポリシーを使用して、メッセージ コンテキストに基づくメッセージのルーティング |Microsoft Docs'
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 9d3b68de-6b24-46fe-ae0d-91afb630bc19
caps.latest.revision: 3
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 7406b0daed4374241bb92fdcb4afcdcd5acd77b9
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2018
ms.locfileid: "36973891"
---
# <a name="how-to-dynamically-route-a-message-based-on-message-context-using-a-business-rules-policy"></a>方法: ビジネス ルール ポリシーを使用してメッセージのコンテキストに基づいてメッセージを動的にルーティング
## <a name="goal"></a>[目標]  
 このセクションでは、BizTalk Server ビジネス ルール エンジン (BRE) ポリシーを使用して、メッセージ コンテキスト プロパティに基づく、メッセージのエンドポイントを決定し、BizTalk Server ファイル アダプターを使用してメッセージをルーティングし、旅行プランを作成する方法を示します。  
  
 このトピックでは、次の手順を行います。  
  
-   メッセージの種類を評価するビジネス ルール ポリシーを作成します。  
  
-   ビジネス ルール ポリシーを使用して動的にルーティングするスケジュールの回覧先を作成します。  
  
-   旅行プランのテスト用クライアントのサンプル アプリケーションを使用して、旅行プランをテストします。  
  
## <a name="prerequisites"></a>前提条件  
 この操作方法に関するトピックの手順の完了が必要、[開発活動の前提条件](../esb-toolkit/prerequisites-for-the-development-activities.md)します。  
  
## <a name="steps"></a>手順  
 **メッセージ コンテキスト プロパティを使用してメッセージをルーティングする BRE ポリシーを作成するには**  
  
1. クリックして**開始**タスク バーで、をポイント**すべてのプログラム**、 をポイント**BizTalk Server**、順にクリックします**ビジネス ルール作成ツール**します。  
  
2. ポリシー エクスプ ローラーで右クリック**ポリシー**、 をクリックし、**新しいポリシーの追加**します。 ポリシーの名前**RouteBasedOnMessageType**します。  
  
   **北米地域の注文のルーティング規則を追加するには**  
  
3. **RouteBasedOnMessageType**ポリシーを右クリックして**バージョン 1.0 (未保存)**、順にクリックします**新しいルールの追加**します。 ルールの名前として**SetNAOrderEndpoint**します。  
  
4. ルール ウィンドウで、右クリック**条件**、 をポイント**述語**、 をクリックし、**等しい**。  
  
5. ファクト エクスプ ローラーで、 **ESB します。Contextinfo です**ボキャブラリ、展開**バージョン 1.0**、し、ドラッグ、**コンテキストのメッセージ型**ファクト、 **[引数 1]** ノードの下**条件**します。  
  
   > [!NOTE]
   >  [!INCLUDE[esbToolkit](../includes/esbtoolkit-md.md)]ルールを作成するために使用できるいくつかのボキャブラリが含まれています。 これらのいくつかは、置き換えをまたは独自のボキャブラリで補強します。 たとえば、 **DynamicRunTimeMaptypes**ポリシーで提供する地図の定義には、 **GlobalBank**サンプル。  
  
6. をクリックして、 **[引数 2]** ノード、および入力し、 **http://globalbank.esb.dynamicresolution.com/northamericanservices/#OrderDoc**  
  
7. ファクト エクスプ ローラーで、 **ESB します。EndPointInfo**ボキャブラリ、展開**バージョン 1.0**、し、ドラッグ、**終点の送信トランスポート場所の設定**の定義を**アクション**します。  
  
8. クリックして**\<空の文字列\>**、し、入力**C:\HowTos\Out\NorthAmerica%MessageID%.xml**  
  
9. ファクト エクスプ ローラーからドラッグして、**設定の終了点送信トランスポートの種類**の定義を**アクション**します。  
  
10. ファクト エクスプ ローラーで、 **ESB します。TansportTypes**ボキャブラリ、展開**バージョン 1.0**、し、ドラッグ、**アダプター プロバイダー**の定義を**\<空の文字列\>**.  
  
11. [操作] ウィンドウで、展開、**アダプター プロバイダー**ドロップダウン リスト、およびクリック**ファイル**。  
  
    **発行して、ポリシーをデプロイするには**  
  
12. ポリシー エクスプ ローラーで [、 **RouteBasedOnMessageType**ポリシーを右クリック**バージョン 1.0 (未保存)**、] をクリックし、**発行**します。  
  
13. ポリシー エクスプ ローラーで [、 **RouteBasedOnMessageType**ポリシーを右クリック**バージョン 1.0 - 公開済み**、] をクリックし、**デプロイ**。  
  
    **ESB スケジュール オンランプ ドメイン固有言語 (DSL) モデルを作成するには**  
  
14. Visual Studio で、C:\HowTos\Patterns\Patterns.sln を開きます。  
  
15. ソリューション エクスプ ローラーで右クリックし、 **ItineraryLibrary**プロジェクトをポイントして、**追加**、順にクリックします**新しい行程**します。  
  
16. **名前**ボックスに「 **MessageType**、 をクリックし、**追加**します。  
  
    **旅行プランのプロパティを構成するには**  
  
17. Visual Studio でのデザイン画面をクリックします。 **MessageType.itinerary**します。 **MessageType**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  **モデル エクスポーター**ドロップダウン リストでは、をクリックして**XML 行程エクスポーター**します。  
  
    2.  **エクステンダー設定**セクションで、次に、**旅行プラン XML ファイル**プロパティ、省略記号ボタン (…) をクリックします。  
  
    3.  **[XML ファイルの**] ダイアログ ボックスで、**ファイル名**ボックスに「 **C:\HowTos\Itineraries\MessageType**、順にクリックします**保存**します。  
  
        > [!NOTE]
        >  この手順では、旅行プランを XML としてローカル ファイルの場所にエクスポートすることができます。 行程データベースへの代わりにスケジュールをローカル ファイルの場所へのエクスポートは、ESB のテスト用クライアント アプリケーションを使用してスケジュールのテストを使用できます。 この操作方法に関するトピックの後半には、このプロセスを完了します。  
  
    **旅行プランの構造を定義するには**  
  
18. ツールボックスからドラッグ、**入口**デザイン サーフェイスにモデル要素。 **OnRamp1**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  をクリックして、**名前**プロパティ、および入力**ReceiveOrders**します。  
  
    2.  **エクステンダー**ドロップダウン リストでは、をクリックして**入口 ESB エクステンダー**します。  
  
    3.  **BizTalk アプリケーション**ドロップダウン リストでは、をクリックして**Microsoft.Practices.ESB**します。  
  
    4.  **受信ポート**ドロップダウン リストでは、をクリックして**OnRamp.Itinerary**します。  
  
19. ツールボックスからドラッグ、**行程サービス**の右側に配置し、デザイン画面に要素をモデル化し、**入口**モデル要素。 **ItineraryService1**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  をクリックして、**名前**プロパティ、および入力**BreRoute**します。  
  
    2.  **行程サービス エクステンダー**ドロップダウン リストでは、をクリックして**エクステンダーのメッセージング**します。  
  
        > [!NOTE]
        >  このプロパティは、プロセスが行われる (メッセージング) パイプラインで定義します。 または、プロセスはオーケストレーション内の場所を受け取らない場合は設定、**行程サービス エクステンダー**プロパティを**オーケストレーション エクステンダー**します。  
  
    3.  **コンテナー**ドロップダウン リストで、展開**ReceiveOrders**、 をクリックし、**受信ハンドラー**。  
  
    4.  **サービス名**ドロップダウン リストでは、をクリックして**Microsoft.Practices.ESB.Services.Routing**します。  
  
20. 右クリックし、**リゾルバー**のコレクション、 **BreRoute**モデル要素をクリックして**新しいリゾルバーを追加**します。 **Resolver1**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  をクリックして、**名前**プロパティ、および入力**ByMessageType**します。  
  
    2.  **リゾルバーの実装**ドロップダウン リストでは、をクリックして**Bre 競合回避モジュールの拡張機能**します。  
  
    3.  **ポリシー**ドロップダウン リストでは、をクリックして**RouteBasedOnMessageType v 1.0**します。  
  
21. ツールボックス、**コネクタ**します。 接続をドラッグして、 **ReceiveOrders**モデル要素に、 **BreRoute**モデル要素。  
  
22. ツールボックスからドラッグして、**傾斜オフ**の右側に配置し、デザイン画面に要素をモデル化し、 **BreRoute**モデル要素。 **OffRamp1**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  をクリックして、**名前**プロパティ、および入力**SendBasedOnType**します。  
  
    2.  **エクステンダー**ドロップダウン リストでは、をクリックして**傾斜オフ ESB エクステンダー**します。  
  
    3.  **BizTalk アプリケーション**ドロップダウン リストでは、をクリックして**GlobalBank.ESB**します。  
  
    4.  **送信ポート**ドロップダウン リストでは、をクリックして**DynamicResolutionOneWay**します。  
  
23. ツールボックスからドラッグ、**スケジュール サービス**モデルのデザイン画面に要素との間に配置し、 **BreRoute**モデル要素と**SendBasedOnType**モデル要素。 **ItineraryService1**プロパティ ウィンドウで、次のプロパティを構成します。  
  
    1.  をクリックして、**名前**プロパティ、および入力**SendPortFilter**します。  
  
    2.  **行程サービス エクステンダー**ドロップダウン リストでは、をクリックして**傾斜オフ エクステンダー**。  
  
    3.  **傾斜オフ**ドロップダウン リストで、展開**SendBasedOnType**、順にクリックします**送信ハンドラー**します。  
  
24. ツールボックス、**コネクタ**します。 接続をドラッグして、 **BreRoute**モデル要素に、 **SendPortFilter**モデル要素。  
  
25. ツールボックス、**コネクタ**します。 接続をドラッグして、 **SendPortFilter**モデル要素に、 **SendBasedOnType**モデル要素。  
  
    **旅行プランのテスト クライアントで使用するモデルをエクスポートするには**  
  
26. Visual Studio でのデザイン画面を右クリックし、 **MessageType**旅行プランをクリックして**モデルのエクスポート**します。  
  
    > [!NOTE]
    >  旅行プランの XML バージョンは、Visual Studio で開きます。  
  
27. すべてのプロジェクト成果物を保存します。  
  
28. Windows エクスプ ローラーでは、C:\HowTos\Itineraries を参照し、旅行プラン XML (MessageType.xml) の作成に注意してください。  
  
    **旅行プランをテストするには**  
  
29. 中に作成されたショートカットを使用してスケジュールのテスト用クライアントのサンプル アプリケーションを開く、[開発活動の前提条件](../esb-toolkit/prerequisites-for-the-development-activities.md)(C:\HowTos\ESB します。Itinerary.Test.exe - ショートカット)。  
  
30. 行程テスト クライアントでオフ、 **WCF サービスを使用して**チェック ボックスをオンにし**ロード行程**。  
  
31. **行程ファイルを開く** ダイアログ ボックスで、C:\HowTos\Itineraries を参照します。 選択**MessageType.xml**、順にクリックします**オープン**旅行プランを読み込めません。  
  
32. をクリックして**OK**をオフに、**旅行プランは正常に読み込まれる**メッセージ。  
  
33. 旅行プランのテスト クライアントで、横にある省略記号ボタン (…) をクリックします。、**ロード メッセージ**ボックス。  
  
34. **を読み込む XML ドキュメントの選択** ダイアログ ボックスで、C:\HowTos を参照します。 選択**NAOrderDoc.xml**、順にクリックします**オープン**テスト メッセージを読み込めません。  
  
35. をクリックして、**要求を提出**ボタンをクリックします。 テストが完了したら、クリックして**OK**表示される確認メッセージを無視します。  
  
36. Windows エクスプ ローラーで参照 C:\HowTos\Out\\します。 NorthAmerica%MessageID%.xml メッセージがディレクトリに書き込まれたことを確認します。  
  
## <a name="additional-resources"></a>その他のリソース  
 詳細については、次の関連項目を参照してください。  
  
-   [方法: ビジネス ルール ポリシーを使用して、日程を選択](../esb-toolkit/how-to-select-an-itinerary-using-a-business-rules-policy.md)  
  
-   [方法: メッセージを変換し、スケジュール ルーティング スリップを利用してファイルの場所に送信する](../esb-toolkit/transform-message-and-route-the-message-to-a-location-using-itinerary-routing.md)  
  
-   [方法: 既知のメッセージ タイプに関するビジネス ルール ポリシーを利用し、コンテンツベースのルーティングを実装する](../esb-toolkit/apply-content-based-routing-using-business-rules-policy-for-known-message-type.md)  
  
-   [開発アクティビティ](../esb-toolkit/development-activities.md)  
  
-   [メッセージ ルーティング パターン](../esb-toolkit/message-routing-patterns.md)  
  
-   [動的な解決とルーティングを利用する](../esb-toolkit/using-dynamic-resolution-and-routing.md)