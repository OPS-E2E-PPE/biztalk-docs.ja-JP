---
title: パフォーマンスの高いアダプターを設計する方法 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: b5a1f338-fd7c-41c8-a181-8da8b293c4cc
caps.latest.revision: 15
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 3cffe98459213d04e0746ed2ec125c7e704684ff
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2019
ms.locfileid: "65338495"
---
# <a name="how-to-design-a-performant-adapter"></a><span data-ttu-id="ccadf-102">パフォーマンスの高いアダプターを設計する方法</span><span class="sxs-lookup"><span data-stu-id="ccadf-102">How to Design a Performant Adapter</span></span>
<span data-ttu-id="ccadf-103">パフォーマンス向上のためのすべてのアダプターはメッセージのバッチを送信する、バッチの転送、および一般的にバッチのメッセージに対する操作の実行に関して、バッチに対応してください。</span><span class="sxs-lookup"><span data-stu-id="ccadf-103">For performance purposes all adapters should be batch-aware with regard to submitting batches of messages, transmitting batches, and generally performing operations on messages in batches.</span></span> <span data-ttu-id="ccadf-104">アダプターは、バッチまたはバッチでは、アダプターのデザイン時ユーザー インターフェイスから構成できるバイト数のサイズなど、構成可能なパフォーマンス関連の属性を公開しようとする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-104">Adapters should try to expose configurable performance-related attributes, such as the size of batches or the number of bytes in a batch, that are configurable from the adapter's design-time user interface.</span></span>  
  
 <span data-ttu-id="ccadf-105">前述のように、アダプターは、送信ホストのパフォーマンスの低下を避けるため、非ブロッキング送信を常に実行する必要がありますを送信します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-105">As mentioned earlier, send adapters should always perform non-blocking sends to avoid degrading the performance of the send host.</span></span> <span data-ttu-id="ccadf-106">メッセージング エンジン Api をさらにブロックすることは推奨されません。</span><span class="sxs-lookup"><span data-stu-id="ccadf-106">Further blocking of Messaging Engine APIs is not recommended.</span></span>  
  
 <span data-ttu-id="ccadf-107">書き込み、メッセージ コンテキストからの読み取りと実行時のパフォーマンスに影響します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-107">Writing to and reading from the message context affects run-time performance.</span></span> <span data-ttu-id="ccadf-108">一般に、アダプターでは、読み取り、書き込み、およびメッセージ コンテキスト プロパティの数が過剰に昇格を避ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-108">In general, adapters should avoid reading, writing, and promoting excessive numbers of message-context properties.</span></span> <span data-ttu-id="ccadf-109">プロパティの昇格は、実行時に昇格させたプロパティごとに発生するサブスクリプションの評価のため、追加のパフォーマンスのドレインを作成します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-109">Promoting properties creates an additional performance drain because of the subscription evaluation that occurs on each promoted property at run time.</span></span> <span data-ttu-id="ccadf-110">ただし、アダプターは膨大な数のパフォーマンスに著しく影響するプロパティを昇格させる必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-110">However, an adapter would need to promote a huge number of properties to noticeably impact performance.</span></span> <span data-ttu-id="ccadf-111">まだを昇格させるには、必要なプロパティのみを昇格させることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="ccadf-111">Still it is a good practice to promote only those properties that are required to be promoted.</span></span>  
  
## <a name="throttle-send-and-receive"></a><span data-ttu-id="ccadf-112">スロットルの送受信</span><span class="sxs-lookup"><span data-stu-id="ccadf-112">Throttle Send and Receive</span></span>  
 <span data-ttu-id="ccadf-113">BizTalk エンジンの負荷が、構成されたしきい値を超えると、エンジンは、最適なパフォーマンスを確保するには、アダプターとオーケストレーションを調整します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-113">When the load on the BizTalk engine exceeds the configured threshold, the engine throttles adapters and orchestrations to ensure optimum performance.</span></span> <span data-ttu-id="ccadf-114">エンジンのワークロードが、アダプターの呼び出しに指定されたしきい値を超えたときに、受信側で**IBTTransportBatch.Done**負荷が十分に減少するまでブロックされます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-114">On the receive side, when the workload on the engine exceeds a given threshold, the adapter's call to **IBTTransportBatch.Done** is blocked until the load has decreased sufficiently.</span></span> <span data-ttu-id="ccadf-115">これにより、エンジンが使用可能な場合にのみ、エンジンに新しい作業を送信するアダプターです。</span><span class="sxs-lookup"><span data-stu-id="ccadf-115">This forces the adapter to submit new work into the engine only when the engine is available.</span></span> <span data-ttu-id="ccadf-116">送信側では、エンジンがアダプター、送信メッセージの送信を制限するときに、エンジン配信しません、負荷が減少するまでに転送する新しいメッセージ。</span><span class="sxs-lookup"><span data-stu-id="ccadf-116">On the send side, when the engine is throttling adapters sending outbound messages, the engine does not deliver new messages to be transmitted until its load is reduced.</span></span>  
  
 <span data-ttu-id="ccadf-117">これらの理由から、たとえば、必要な場合を除き、制限を考慮する、バックエンド システムへの接続の数を制限、アダプターは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="ccadf-117">For these reasons, the adapter does not need to be concerned with throttling unless it is required, for example, to limit the number of connections to a back-end system.</span></span> <span data-ttu-id="ccadf-118">これらの種類のシナリオのエンジンでも、アダプター フレームワークのサポートを提供します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-118">For these types of scenarios, neither the engine nor the Adapter Framework provides any support.</span></span>  
  
 <span data-ttu-id="ccadf-119">アダプターのソース コードを制御するかどうかに応じていくつかの方法でカスタムの送信アダプターから送信されたメッセージの数を調整を処理することができます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-119">You can handle throttling the number of messages sent from a custom send adapter in several ways depending on whether you control the source code for the adapter.</span></span>  
  
### <a name="send-side-throttling-improves-performance"></a><span data-ttu-id="ccadf-120">送信側の制限によるパフォーマンスを向上します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-120">Send-Side Throttling Improves Performance</span></span>  
 <span data-ttu-id="ccadf-121">アダプターのソース コードを制御する場合は、いつでも送信するキューに配置するメッセージの最大数をヒューリスティックによって決定します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-121">If you control the source code for the adapter, you can determine from heuristics the maximum number of messages that you want to have in the queue to send at any time.</span></span> <span data-ttu-id="ccadf-122">メッセージング エンジンを呼び出すと、`TransmitMessage`メソッドを呼び出し、新しいメッセージを送信アダプターか、以前に決定した最大値よりも大きい場合は、キュー内のメッセージの数を表示するか、またはスレッドをブロックする選択できます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-122">When the Messaging Engine calls the `TransmitMessage` method and passes the send adapter a new message, you can choose to either block the thread or check to see if the number of messages in the queue is larger than the maximum value you determined previously.</span></span> <span data-ttu-id="ccadf-123">メッセージの最大数が超過した場合は使用できます、`Resubmit`メッセージング エンジンにメッセージを再送信する方法。</span><span class="sxs-lookup"><span data-stu-id="ccadf-123">If the maximum number of messages has been exceeded, you can use the `Resubmit` method to resubmit the message to the Messaging Engine.</span></span> <span data-ttu-id="ccadf-124">アダプターが同期の場合、メッセージが既にブロックされることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ccadf-124">Note that if the adapter is synchronous, the message would already be blocked.</span></span>  
  
 <span data-ttu-id="ccadf-125">変更することによってキューに置かれたメッセージの数を変更するには、アダプターのソース コードを制御しない場合、 **Highwatermark** BizTalk 管理データベースの Adm_serviceclass テーブル内の値。</span><span class="sxs-lookup"><span data-stu-id="ccadf-125">If you do not control the source code for the adapter, you can change the number of queued messages by changing the **Highwatermark** value in the Adm_serviceclass table in the BizTalk Management database.</span></span> <span data-ttu-id="ccadf-126">最大値、 **Highwatermark**プロパティは 200 です。</span><span class="sxs-lookup"><span data-stu-id="ccadf-126">The maximum value for the **Highwatermark** property is 200.</span></span> <span data-ttu-id="ccadf-127">値を変更することも、**低レベルのウォーターマーク**プロパティ値を小さくします。</span><span class="sxs-lookup"><span data-stu-id="ccadf-127">You can also change the value for the **Lowwatermark** property to a smaller value.</span></span>  
  
 <span data-ttu-id="ccadf-128">注意の値、 **Highwatermark**メッセージング エンジンがアダプターに指定されたメッセージの数のアカウントを非同期アダプターのプロパティ。</span><span class="sxs-lookup"><span data-stu-id="ccadf-128">Remember that the value of the **Highwatermark** property for asynchronous adapters accounts for the number of messages that the Messaging Engine has given to the adapter.</span></span> <span data-ttu-id="ccadf-129">メッセージング エンジンからアダプターに渡します、`TransmitMessage`メソッドでは、これらのメッセージを送信をまだ未処理になる可能性 — たとえば、アダプターが対応する呼び出しを行っていない場合、 `DeleteMessage`、 `Resubmit`、 `MoveToNextTransport`、または[Microsoft.BizTalk.TransportProxy.Interop.BatchOperationType.MoveToSuspendQ](http://msdn.microsoft.com/library/microsoft.biztalk.transportproxy.interop.batchoperationtype.aspx)メソッド。</span><span class="sxs-lookup"><span data-stu-id="ccadf-129">The Messaging Engine passes them to the adapter through the `TransmitMessage` method, These messages can be still outstanding in their transmission—for example, if the adapter has not made a corresponding call to the `DeleteMessage`, `Resubmit`, `MoveToNextTransport`, or [Microsoft.BizTalk.TransportProxy.Interop.BatchOperationType.MoveToSuspendQ](http://msdn.microsoft.com/library/microsoft.biztalk.transportproxy.interop.batchoperationtype.aspx) methods.</span></span> <span data-ttu-id="ccadf-130">同期アダプターの場合、 **Highwatermark**のみを使用してアダプターに渡すがメッセージング エンジンは、メッセージの数のアカウントのプロパティ、 **TransmitMessage**メソッドのため、この呼び出し呼び出し元のメッセージング エンジン スレッドをブロックして同期的に処理します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-130">For synchronous adapters, the **Highwatermark** property only accounts for the number of messages the Messaging Engine has passed to the adapter by using the **TransmitMessage** method because this call processes synchronously, blocking the calling Messaging Engine thread.</span></span>  
  
 <span data-ttu-id="ccadf-131">本質的にプロトコルの送信アダプターを作成する場合は、(HTTP、FTP、双方向の SOAP など) 低速な次を検討してください。</span><span class="sxs-lookup"><span data-stu-id="ccadf-131">If you are writing a send adapter for a protocol that is inherently slow in nature (such as HTTP, FTP, or two-way SOAP), consider the following:</span></span>  
  
- <span data-ttu-id="ccadf-132">このようなアダプター BizTalk メッセージング エンジンからは、送信されるメッセージを送信可能なよりも速く受信可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-132">Such an adapter might receive messages for transmission from the BizTalk Messaging Engine faster than it can transmit them.</span></span> <span data-ttu-id="ccadf-133">このような相違では、さまざまなレベルで問題が発生します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-133">This discrepancy causes problems at various levels.</span></span> <span data-ttu-id="ccadf-134">送信中のメッセージはメモリに保持され、全体のシステム パフォーマンスの低下、仮想メモリを占有します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-134">The messages under transmission remain in memory and take up the virtual memory, slowing down the entire system.</span></span>  
  
- <span data-ttu-id="ccadf-135">アダプターは、プロトコル固有のリソースをかかる場合があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-135">The adapter might take up protocol-specific resources.</span></span> <span data-ttu-id="ccadf-136">など、サーバーでは、リモート サーバーを中断させる可能性がへの多数の同時接続を開く、可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-136">For example, it might open too many concurrent connections to the server, which could disrupt the remote server.</span></span>  
  
- <span data-ttu-id="ccadf-137">他のアダプターはアダプターの影響を与える可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-137">The adapter might affect other adapters.</span></span> <span data-ttu-id="ccadf-138">たとえば特定のアダプターのキューにメッセージが多すぎる、メッセージング エンジンはこのプロセスでは他の送信アダプターに対する要求の発行を停止します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-138">For example, if too many messages queue up for a particular adapter, the Messaging Engine stops issuing requests to other send adapters in that process.</span></span>  
  
  <span data-ttu-id="ccadf-139">解決の方法では、低速で高速のアダプターを別の BizTalk ホストに配置して、"High Watermark"および"Low Watermark"の設定を使用してメッセージの数を制御します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-139">A solution is to put the slow and fast adapters in separate BizTalk Hosts and control the number of messages by using the "High Watermark" and "Low Watermark" settings.</span></span>  
  
### <a name="receive-side-throttling-improves-performance"></a><span data-ttu-id="ccadf-140">受信側の制限によるパフォーマンスを向上します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-140">Receive-Side Throttling Improves Performance</span></span>  
 <span data-ttu-id="ccadf-141">これで、受信アダプターがメッセージをシステムの残りの部分がメッセージを処理できる速度よりも高速も多数あります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-141">There are numerous situations in which a receive adapter receives messages faster than the rate at which the rest of the system can process the messages.</span></span> <span data-ttu-id="ccadf-142">このような状況が発生したときに、メッセージ ボックス データベースでバックログになります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-142">When such a situation occurs, the MessageBox database becomes backlogged.</span></span> <span data-ttu-id="ccadf-143">この場合、システム全体のパフォーマンスが大幅に低下します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-143">When this happens, the performance of the whole system drops dramatically.</span></span>  
  
 <span data-ttu-id="ccadf-144">この場合は、アダプターで、受信アダプターの速度を下げる、次の手法のいずれかを使用できます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-144">If this is happening with your adapter, you can use one of the following techniques to reduce the speed of the receive adapter:</span></span>  
  
- <span data-ttu-id="ccadf-145">メッセージング エンジン スレッドのプール サイズを減らします。</span><span class="sxs-lookup"><span data-stu-id="ccadf-145">Reduce the Messaging Engine thread pool size.</span></span> <span data-ttu-id="ccadf-146">メッセージング エンジンを使用して、メッセージ ボックスにメッセージを公開するスレッドの数を制御することができます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-146">You can control the number of threads that the Messaging Engine uses to publish messages into the MessageBox.</span></span> <span data-ttu-id="ccadf-147">スレッドの数を減らすことでは、受信アダプターがメッセージ ボックスにメッセージを受信する速度を低下します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-147">By reducing the number of threads, you reduce the rate at which the receive adapter receives messages into the MessageBox.</span></span> <span data-ttu-id="ccadf-148">のみ、この設定は、アダプターの受信ハンドラーに対応するホストを実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-148">This setting only needs to be done for the host corresponding to the receive handler for the adapter.</span></span> <span data-ttu-id="ccadf-149">設定しないでくださいこの、アダプターの送信ハンドラーに対応するホストの送信アダプターも速度が低下する場合を除き、します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-149">You should not set this for the host corresponding to the send handler for the adapter, unless you want to slow down the send adapter as well.</span></span>  
  
- <span data-ttu-id="ccadf-150">アダプターのバッチ サイズを削減します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-150">Reduce the adapter batch size.</span></span> <span data-ttu-id="ccadf-151">ほとんどの高速のアダプターの受信メッセージをバッチでメッセージ ボックス データベースに公開します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-151">Most fast receive adapters publish messages to the MessageBox in batches.</span></span> <span data-ttu-id="ccadf-152">これらのバッチのサイズは、受信場所のプロパティ ページで、通常は構成できます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-152">The size of these batches is usually configurable in the receive location property page.</span></span> <span data-ttu-id="ccadf-153">バッチ サイズを小さくして、システムに送信されるメッセージの全体的なスループットを減らすことができます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-153">By decreasing the batch size you can decrease the overall throughput of messages coming into the system.</span></span>  
  
- <span data-ttu-id="ccadf-154">その他のアダプターに固有の設定を変更します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-154">Change other adapter-specific settings.</span></span> <span data-ttu-id="ccadf-155">2 つの手順を完了すると、スループットをさらに軽減するには、その他のアダプター パラメーターを調整することもかまいません。</span><span class="sxs-lookup"><span data-stu-id="ccadf-155">After you complete the two previous steps, you can try adjusting other adapter parameters to further decrease throughput.</span></span> <span data-ttu-id="ccadf-156">一部のアダプターでは、スループットを減らすために使用できる内部のパラメーターを公開します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-156">Some adapters expose internal parameters that can be used to decrease throughput.</span></span> <span data-ttu-id="ccadf-157">たとえば、設定を「順番に配信します」は、MQSeries アダプター</span><span class="sxs-lookup"><span data-stu-id="ccadf-157">For example, the MQSeries adapter has a setting for “Ordered Delivery.”</span></span> <span data-ttu-id="ccadf-158">順次配送は、アダプターはメッセージのバッチの公開を完了するまで待機し、発行、次のバッチを指定します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-158">Ordered Delivery specifies that the adapter will publish a batch of messages, wait for it to complete, and then publish the next batch.</span></span> <span data-ttu-id="ccadf-159">この設定を有効にすると、基本的に、受信アダプターからすべての並列処理を削除します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-159">By enabling this setting, you essentially remove all parallelism from the receive adapter.</span></span> <span data-ttu-id="ccadf-160">逆に、受信アダプターの受信速度を向上させるには、反対の方向でパラメーターをチューニングを使用できます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-160">Conversely, tuning the parameters in the opposite way can be used to increase the receiving rate of a receive adapter.</span></span>  
  
  <span data-ttu-id="ccadf-161">アダプターは、トランスポート プロキシに必要な数だけバッチを送信できます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-161">An adapter can submit as many batches as required to the transport proxy.</span></span> <span data-ttu-id="ccadf-162">ときに、システム大きな負荷がかかってへの呼び出し、**完了**のメソッド、 **IBTTransportBatch**インターフェイス メッセージがシステムに必要なリソースが解放されるまでブロックされます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-162">When the system is heavily stressed, a call to the **Done** method of the **IBTTransportBatch** interface will block the message until the required resources are released to the system.</span></span>  
  
## <a name="plan-for-asynchronous-receive-and-send"></a><span data-ttu-id="ccadf-163">計画の非同期受信し、送信</span><span class="sxs-lookup"><span data-stu-id="ccadf-163">Plan for Asynchronous Receive and Send</span></span>  
 <span data-ttu-id="ccadf-164">豊富なが非同期プログラミングのサポート、BizTalk Server メッセージング Api にします。</span><span class="sxs-lookup"><span data-stu-id="ccadf-164">The BizTalk Server messaging APIs have rich support for asynchronous programming.</span></span> <span data-ttu-id="ccadf-165">スケーラブルなアダプターを記述する場合は、非同期モデルより優れた同時実行制御を提供するために、最初から非同期モデルを使用して計画します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-165">If you want to write a scalable adapter, plan on using the asynchronous model from the start because the asynchronous model provides better concurrency.</span></span>  
  
 <span data-ttu-id="ccadf-166">アダプターが BizTalk メッセージング エンジンにメッセージのバッチを送信すると、受信側で (を呼び出して**ibttransportbatch::done**)、メッセージング エンジンは、その内部スレッド プールを使用して作業をキューに配置しが直ちに返されます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-166">On the receive side, when an adapter submits a batch of messages to the BizTalk Messaging Engine (by calling **IBTTransportBatch::Done**), the Messaging Engine queues up the work using its internal thread pool and returns immediately.</span></span> <span data-ttu-id="ccadf-167">エンジンでは、完了する無料のソースからより多くのメッセージを読み取り、前のメッセージの処理を待たずに送信アダプターのまま、別のスレッドでメッセージを処理します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-167">The engine processes the messages on a separate thread, leaving the adapter free to read more messages from its source and submit them without waiting for the previous message processing to complete.</span></span>  
  
 <span data-ttu-id="ccadf-168">送信側で、アダプターは、非同期または同期することができます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-168">On the send side, your adapter can be either asynchronous or synchronous.</span></span> <span data-ttu-id="ccadf-169">ただし、プロトコルは、非同期操作をサポートする場合は、スケーラブルなアダプターを作成するこのサポートを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-169">However, if your protocol supports asynchronous operations, you should use this support to write a scalable adapter.</span></span> <span data-ttu-id="ccadf-170">たとえば、ファイル サービスおよび HTTP は、アダプターは完全に非同期と非常にいくつかのブロック/同期操作を実行を送信します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-170">For example, File and HTTP send adapters are fully asynchronous and they perform very few blocking/synchronous operations.</span></span>  
  
 <span data-ttu-id="ccadf-171">非同期操作では、メッセージング エンジンとアダプターの両方が並列で作業し、通常のメッセージ処理のため互いに待機しないし続けることを確認します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-171">Asynchronous operations ensure that both the Messaging Engine and your adapter will continue to do their respective work in parallel and not wait on each other for normal message processing.</span></span>  
  
## <a name="use-batching-to-improve-performance"></a><span data-ttu-id="ccadf-172">パフォーマンスを向上させるためにバッチ処理の使用</span><span class="sxs-lookup"><span data-stu-id="ccadf-172">Use Batching to Improve Performance</span></span>  
 <span data-ttu-id="ccadf-173">スケーラブルなアダプターを作成するための最適な開始点は、バッチ処理します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-173">Batching is the best starting point for writing a scalable adapter.</span></span> <span data-ttu-id="ccadf-174">これは、送信側と受信側の両方のアダプターの場合は true。</span><span class="sxs-lookup"><span data-stu-id="ccadf-174">This is true for both send-side and receive-side adapters.</span></span> <span data-ttu-id="ccadf-175">すべてのバッチは、アダプターが非トランザクションである場合でも、BizTalk Server 内のデータベース トランザクションを通過します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-175">Every batch goes through a database transaction within BizTalk Server even if your adapter is nontransactional.</span></span> <span data-ttu-id="ccadf-176">各トランザクションに関連付けられている一定の遅延があるため、1 つのバッチには、複数の操作を組み合わせることによってトランザクションの数を最小限にしようとする必要があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-176">Because there is a fixed delay associated with each transaction, you should try to minimize the number of transactions by combining more than one operation into a single batch.</span></span>  
  
## <a name="do-not-starve-the-net-thread-pool"></a><span data-ttu-id="ccadf-177">.NET スレッド プールの枯渇</span><span class="sxs-lookup"><span data-stu-id="ccadf-177">Do Not Starve the .NET Thread Pool</span></span>  
 <span data-ttu-id="ccadf-178">アダプターは .NET ランタイム コードを記述する練習を BizTalk の書き込み.NET ランタイムを作成するコードが可変の非同期プログラミングの課題です。</span><span class="sxs-lookup"><span data-stu-id="ccadf-178">Writing BizTalk adapters is an exercise in writing .NET runtime code; writing .NET runtime code is invariably an exercise in asynchronous programming.</span></span>  
  
 <span data-ttu-id="ccadf-179">.NET では、すべての非同期プログラミングのリスクは、.NET スレッド プールを枯渇させて、回避するために、BizTalk アダプターのプログラマにとって特に重要です。</span><span class="sxs-lookup"><span data-stu-id="ccadf-179">Starving the .NET thread pool is a risk to all asynchronous programming in .NET, and it is particularly important for the BizTalk adapter programmer to avoid.</span></span>  
  
 <span data-ttu-id="ccadf-180">.NET スレッド プールは、制限されていますが、広く共有リソースです。</span><span class="sxs-lookup"><span data-stu-id="ccadf-180">The .NET thread pool is a limited but widely shared resource.</span></span> <span data-ttu-id="ccadf-181">.NET スレッド プールのスレッドのいずれかを使用して保持し、時間の長いから実行されている場合は、他の作業項目をブロックするコードを記述は簡単です。</span><span class="sxs-lookup"><span data-stu-id="ccadf-181">It is easy to write code that uses one of the .NET thread pool threads and holds onto it for long time, blocking other work items from being executed.</span></span>  
  
 <span data-ttu-id="ccadf-182">使用するたびに**BeginInvoke**またはタイマーを使用して、.NET スレッド プールのスレッドを使用しています。</span><span class="sxs-lookup"><span data-stu-id="ccadf-182">Whenever you use **BeginInvoke** or use a timer, you are using a .NET thread pool thread.</span></span> <span data-ttu-id="ccadf-183">複数の処理を行うがある場合 (たとえば BizTalk Server にメッセージを MQSeries からをコピーする)、する必要があります実行 1 つの作業項目 (BizTalk Server にメッセージの 1 つのバッチ) し requeue スレッド プールで作業をすることがある場合します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-183">If you have multiple pieces of work to do (for example copying messages out of MQSeries into BizTalk Server), you should execute one work item (one batch of messages into BizTalk Server) and then requeue in the thread pool if there is more work to do.</span></span> <span data-ttu-id="ccadf-184">占有しないように、`while`スレッドでループします。</span><span class="sxs-lookup"><span data-stu-id="ccadf-184">Never sit in a `while` loop on the thread.</span></span>  
  
 <span data-ttu-id="ccadf-185">具体的に言うことを意味`while`ループを繰り返し呼び出すの**BeginInvoke**します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-185">In concrete terms this means replacing `while` loops with repeated calls to **BeginInvoke**.</span></span> <span data-ttu-id="ccadf-186">この単純な変更は、応答性と実装全体のスケール アウト機能が大幅に向上します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-186">This simple change can dramatically improve the responsiveness and scale-out ability for the whole implementation.</span></span>  
  
## <a name="choose-the-right-measurement-when-limiting-batch-size"></a><span data-ttu-id="ccadf-187">バッチ サイズを制限する場合に適した単位を選択します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-187">Choose the Right Measurement When Limiting Batch Size</span></span>  
 <span data-ttu-id="ccadf-188">BizTalk Server にメッセージをバッチを送信する場合は、メッセージ数のみに基づいてバッチ サイズは制限されません。</span><span class="sxs-lookup"><span data-stu-id="ccadf-188">If you are submitting messages to BizTalk Server in batches, do not limit the batch size based only on the message count.</span></span> <span data-ttu-id="ccadf-189">メッセージ数のみに基づくバッチをアダプターが構成されている場合の動作を考慮してください。2 つのバッチ サイズは、アダプターの 4 つのメッセージを取得する場合、それぞれ 4 KB、8 KB 1 MB 5 MB のサイズられる最初のバッチ サイズの 12 KB になり、2 つ目のバッチになります 6 MB のサイズを変更します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-189">Consider what happens when an adapter has been configured to batch based only on message count: If the batch size is two and the adapter gets four messages of size 4 KB, 8 KB, 1 MB, and 5MB respectively, the first batch will be of size 12 KB, and the second batch will be of size 6 MB.</span></span>  
  
 <span data-ttu-id="ccadf-190">BizTalk メッセージング エンジンが単一のバッチ内のすべてのメッセージを順番に処理するため、この例では、2 番目のバッチは最初のバッチに比べて大幅に低下処理されます。</span><span class="sxs-lookup"><span data-stu-id="ccadf-190">Because the BizTalk Messaging Engine processes all messages in a single batch sequentially, the second batch in this example will be processed much more slowly than the first batch.</span></span> <span data-ttu-id="ccadf-191">スループットを効果的に削減これです。</span><span class="sxs-lookup"><span data-stu-id="ccadf-191">This is effectively reducing throughput.</span></span> <span data-ttu-id="ccadf-192">この問題を処理する優れた方法では、メッセージ数とバッチ (バッチ サイズ (バイト単位) は、) の合計バイト数の両方に基づくバッチです。</span><span class="sxs-lookup"><span data-stu-id="ccadf-192">A better way to handle this problem is to batch based on both message count and total bytes in the batch (that is, batch size in bytes).</span></span> <span data-ttu-id="ccadf-193">合計バイト数のマジック ナンバーがありません。</span><span class="sxs-lookup"><span data-stu-id="ccadf-193">There is no magic number for total bytes.</span></span> <span data-ttu-id="ccadf-194">ただし、通常の処理のシナリオでバッチ サイズが 1 MB を超える場合が始まりますが低い同時実行性とスループット。</span><span class="sxs-lookup"><span data-stu-id="ccadf-194">However, in a normal processing scenario, if the batch size exceeds 1 MB, you will start seeing poor concurrency and throughput.</span></span>  
  
 <span data-ttu-id="ccadf-195">一般に、アダプターはメッセージに依存しないと、運用環境でメッセージのサイズがわからない。</span><span class="sxs-lookup"><span data-stu-id="ccadf-195">Generally adapters are message agnostic and they do not know the size of the messages in the production environment.</span></span> <span data-ttu-id="ccadf-196">受信メッセージのサイズが大きく異なる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ccadf-196">The sizes of the incoming messages are likely to vary significantly.</span></span> <span data-ttu-id="ccadf-197">このため、常にバッチを構築するのにメッセージの数と合計バイト数を使用します。</span><span class="sxs-lookup"><span data-stu-id="ccadf-197">Because of this, always use message count and total bytes to build the batch.</span></span>