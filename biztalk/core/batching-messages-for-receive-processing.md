---
title: 受信処理用メッセージをバッチ処理 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 32bf0b70-e9d1-4fab-9c74-160e51390700
caps.latest.revision: 8
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: e60bab7b9f6d41268bd60be0b1f37daf07019af1
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2019
ms.locfileid: "65358290"
---
# <a name="batching-messages-for-receive-processing"></a><span data-ttu-id="d2fa4-102">受信処理用メッセージのバッチ処理</span><span class="sxs-lookup"><span data-stu-id="d2fa4-102">Batching Messages for Receive Processing</span></span>
## <a name="batch-callbacks"></a><span data-ttu-id="d2fa4-103">バッチ コールバック</span><span class="sxs-lookup"><span data-stu-id="d2fa4-103">Batch Callbacks</span></span>  
 <span data-ttu-id="d2fa4-104">によって送信されたバッチの受信アダプターがメッセージング エンジンに非同期的に処理されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-104">Batches submitted by receive adapters to the Messaging Engine are processed asynchronously.</span></span> <span data-ttu-id="d2fa4-105">そのため、アダプターでは、成功または失敗の通知を受け取ることができ、必要なクリーンアップ操作を実行するために、アダプターのいくつかの状態にコールバックを関連付けるメカニズムが必要です。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-105">Therefore the adapter needs a mechanism to tie a callback to some state in the adapter so it can be notified of success or failure and perform any necessary cleanup actions.</span></span> <span data-ttu-id="d2fa4-106">アダプターが 1 つまたは 3 つのアプローチの組み合わせを使用できるように、コールバックのセマンティクスは柔軟です。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-106">The callback semantics are flexible such that adapters can use one or a combination of three approaches.</span></span> <span data-ttu-id="d2fa4-107">これらの数値は、次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-107">These are:</span></span>  
  
- <span data-ttu-id="d2fa4-108">すべてのコールバックが実装する同じオブジェクト インスタンスで行われた**IBTBatchCallBack**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-108">All callbacks are made on the same object instance that implements **IBTBatchCallBack**.</span></span>  
  
- <span data-ttu-id="d2fa4-109">Cookie は、新しいバッチの要求をアダプターの状態にコールバックを関連付けるために使用する場合に、エンジンに渡されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-109">The cookie passed into the engine when requesting a new batch is used to correlate the callback to the state in the adapters.</span></span>  
  
- <span data-ttu-id="d2fa4-110">実装する各バッチの異なるコールバック オブジェクトがある**IBTBatchCallBack**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-110">There is a different callback object for each batch that implements **IBTBatchCallBack**.</span></span> <span data-ttu-id="d2fa4-111">ここで各オブジェクトは、独自のプライベート状態を保持します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-111">Here each object holds its own private state.</span></span>  
  
  <span data-ttu-id="d2fa4-112">実装でアダプターがコールバックに機能して、バッチが処理されると、 **IBTBatchCallBack.BatchComplete**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-112">When the batch has been processed, the adapter is called back on its implementation of **IBTBatchCallBack.BatchComplete**.</span></span> <span data-ttu-id="d2fa4-113">バッチの全体的な状態は、最初のパラメーターでは、HRESULT の状態が表示されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-113">The overall status of the batch is indicated by the first parameter, the HRESULT status.</span></span> <span data-ttu-id="d2fa4-114">この値が 0 以上の場合は、バッチは、エンジンがデータの所有権をアダプターは、ネットワークからそのデータを削除する無料の意味では成功します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-114">If this value is greater than or equal to zero, then the batch was successful in the sense that the engine has ownership of the data and the adapter is free to delete that data from the wire.</span></span> <span data-ttu-id="d2fa4-115">負の状態は、バッチが失敗したことを示します。成功しなかったバッチ内の操作のいずれもと、アダプターは、エラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-115">A negative status indicates that the batch failed: None of the operations in the batch were successful and the adapter is responsible for handling the failure.</span></span>  
  
  <span data-ttu-id="d2fa4-116">バッチが失敗した場合は、アダプターを操作が失敗しました、どの項目を把握する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-116">If the batch failed, then the adapter needs to know which item in which operation failed.</span></span> <span data-ttu-id="d2fa4-117">たとえば、アダプターがディスクに送信すると 20 個のファイルを読み取りが[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]1 つのバッチを使用します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-117">For example, suppose that the adapter was reading 20 files from disk and submitting them into [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] using a single batch.</span></span> <span data-ttu-id="d2fa4-118">10 番目のファイルが破損している場合、アダプターはその 1 つのファイルを中断し、残りの 19 を再送信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-118">If the tenth file was corrupted, the adapter would need to suspend that one file and resubmit the remaining 19.</span></span> <span data-ttu-id="d2fa4-119">この情報は、2 番目と 3 番目のパラメーターでアダプターに使用可能な —`opCount` (操作数) short 型のおよび`operationStatus`btbatchoperationstatus[] 型のです。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-119">This information is available to the adapter in the second and third parameters—`opCount` (operation count) of type short and `operationStatus`, which is of type BTBatchOperationStatus[].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="d2fa4-120">1 つのバッチ オブジェクトでする必要がありますしないメッセージを送信した 2 回以上。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-120">On a single batch object you should never submit a message more than once.</span></span> <span data-ttu-id="d2fa4-121">同じバッチで複数回、同じメッセージ オブジェクトを送信すると、エンジンのエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-121">Submitting the same message object more than once on the same batch will result in engine errors.</span></span>  
  
 <span data-ttu-id="d2fa4-122">操作数は、操作の種類の数がバッチにあったことを示します (のサイズ、 **BTBatchOperationStatus**配列)。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-122">The operation count indicates how many types of operations were in the batch (the size of the **BTBatchOperationStatus** array).</span></span> <span data-ttu-id="d2fa4-123">操作の状態配列内の各要素は、特定の操作の種類に対応します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-123">Each element in the operation status array corresponds to a given operation type.</span></span> <span data-ttu-id="d2fa4-124">使用して、 **BTBatchOperationStatus**配列、アダプターは、調べることで失敗しました操作内の項目を特定できます、 **BTBatchOperationStatus.MessageStatus**負の値の HRESULT の配列。エラーを示す値。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-124">By using the **BTBatchOperationStatus** array, the adapter can determine which item in a given operation failed by looking at the **BTBatchOperationStatus.MessageStatus** array for negative HRESULT values signifying failure.</span></span> <span data-ttu-id="d2fa4-125">上記のシナリオでは、アダプターが 19 を含む新しいバッチを作成します。 メッセージを送信し、1 つのメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-125">In the scenario above, the adapter creates a new batch containing 19 message submits and one message suspend.</span></span>  
  
 <span data-ttu-id="d2fa4-126">次のコード フラグメントは、アダプターのトランスポート プロキシを経由して、エンジンから新しいバッチを要求し、クッキーのアプローチを使用してエンジンに 1 つのメッセージを送信、を示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-126">The following code fragment shows how an adapter requests a new batch from the engine through its transport proxy and submits a single message into the engine using the cookie approach.</span></span> <span data-ttu-id="d2fa4-127">メッセージング エンジンの呼び出し、 **BatchComplete**メソッドのバッチ全体の処理が完了すると、バッチ コールバックとしては、メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-127">The Messaging Engine calls the **BatchComplete** method as the batch callback when it has completed processing the entire batch of submitted messages.</span></span>  
  
```  
using Microsoft.BizTalk.TransportProxy.Interop;  
using Microsoft.BizTalk.Message.Interop;  
  
public class MyAdapter :   
                  IBTTransport,   
                  IBTTransportConfig,   
                  IBTTransportControl,  
                  IPersistPropertyBag,   
                  IBaseComponent,  
                  IBTBatchCallBack  
{  
      private IBTTransportProxy _tp;  
  
      public void BatchComplete(      
            Int32                         status,   
            Int16                         opCount,   
            BTBatchOperationStatus[]      operationStatus,   
            System.Object                 callbackCookie)  
      {  
            // Use cookie to correlate callback with work done,  
            // in this example the batch is to submit a single  
            // file the name of which will be in the  
            // callbackCookie  
            string fileName = (string)callbackCookie;  
            if ( status >= 0 )  
                  // DeleteFile from disc  
                  File.Delete(fileName);          
            else  
                  // Rename file to fileName.bad  
                  File.Move(fileName, fileName + ".bad");  
      }  
  
      private void SubmitMessage(  
            IBaseMessage                  msg,   
            string                        fileName)  
      {  
            // Note: Pass in the filename as the cookie  
            IBTTransportBatch batch =   
                  _tp.GetBatch(this, (object)fileName);  
  
            // Add msg to batch for submitting   
            batch.SubmitMessage(msg);   
  
            // Process this batch  
            batch.Done(null);  
      }  
}  
```  
  
 <span data-ttu-id="d2fa4-128">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK には、次のアダプターのサンプルが含まれています。ファイル、HTTP、MSMQ、およびトランザクション アダプター。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-128">The [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK includes samples for the following adapters: File, HTTP, MSMQ, and the Transactional Adapter.</span></span> <span data-ttu-id="d2fa4-129">すべてのこれらのアダプターは、BaseAdapter と呼ばれる共通のビルド ブロックの上に構築されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-129">All of these adapters are built on top of a common building block called the BaseAdapter.</span></span> <span data-ttu-id="d2fa4-130">バージョン 1.0.1 の BaseAdapter では、すべての操作の状態を解析し、送信する新しいバッチを再構築に関連するコードが含まれます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-130">Version 1.0.1 of the BaseAdapter includes all of the relevant code to parse the operation status and rebuild a new batch to submit.</span></span>  
  
## <a name="race-condition"></a><span data-ttu-id="d2fa4-131">競合状態</span><span class="sxs-lookup"><span data-stu-id="d2fa4-131">Race Condition</span></span>  
 <span data-ttu-id="d2fa4-132">エラーを解決して、送信されたバッチの最終結果を決定するは、2 つのタスクが、単純に見えますが、異なるスレッドからの情報に依存している実際。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-132">The two tasks of resolving errors and deciding the final outcome of a submitted batch seem simple enough, but in fact they rely on information from different threads:</span></span>  
  
- <span data-ttu-id="d2fa4-133">アダプターによって渡された情報に基づいてエラーを処理する[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]アダプターの**BatchComplete**コールバック メソッド。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-133">The adapter processes errors based on information passed by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] to the adapter's **BatchComplete** callback method.</span></span> <span data-ttu-id="d2fa4-134">このコールバックはアダプターのスレッドで実行します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-134">This callback executes on the adapter's thread.</span></span>  
  
- <span data-ttu-id="d2fa4-135">**DTCCommitConfirm**に、メソッドが、 **IBTDTCCommitConfirm**オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-135">**DTCCommitConfirm** is a method on the **IBTDTCCommitConfirm** object.</span></span> <span data-ttu-id="d2fa4-136">インスタンス、 **IBTDTCCommitConfirm**オブジェクトは、batch によって返される**ibttransportbatch::done**呼び出します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-136">An instance of the **IBTDTCCommitConfirm** object is returned by the batch **IBTTransportBatch::Done** call.</span></span> <span data-ttu-id="d2fa4-137">このインスタンスが同じスレッドでは、 **ibttransportbatch::done**呼び出すには、これは、アダプターのコールバック スレッドと異なる。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-137">This instance is on the same thread as the **IBTTransportBatch::Done** call, which is different from the adapter's callback thread.</span></span>  
  
  <span data-ttu-id="d2fa4-138">アダプターがすべての呼び出しに対して**ibttransportbatch::done**メッセージング エンジンはコールバック メソッドに対応する呼び出し**BatchComplete**の結果を報告する別のスレッドで、バッチ送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-138">For every call that the adapter makes to **IBTTransportBatch::Done** the Messaging Engine makes a corresponding call to the callback method **BatchComplete** in a separate thread to report the result of the batch submission.</span></span> <span data-ttu-id="d2fa4-139">**BatchComplete**アダプターのニーズをコミットまたはロールバック トランザクションかどうかに基づいて、バッチが成功または失敗します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-139">In **BatchComplete** the adapter needs to commit or roll back the transaction based on whether the batch passed or failed.</span></span> <span data-ttu-id="d2fa4-140">どちらの場合、アダプターは呼び出す必要がありますし、 **DTCCommitConfirm**トランザクションの状態を報告します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-140">In either case, the adapter should then call **DTCCommitConfirm** to report the status of the transaction.</span></span>  
  
  <span data-ttu-id="d2fa4-141">競合状態が存在するためのアダプターの実装**BatchComplete**を想定できます、 **IBTDTCCommitConfirm**によって返されるオブジェクト**ibttransportbatch::done**は常に利用可能な場合に**BatchComplete**を実行します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-141">A possible race condition exists because the adapter’s implementation of **BatchComplete** can assume that the **IBTDTCCommitConfirm** object returned by **IBTTransportBatch::Done** is always available when **BatchComplete** executes.</span></span> <span data-ttu-id="d2fa4-142">ただし、 **BatchComplete**前であってもに、、別のメッセージング エンジン スレッドで呼び出すこと**ibttransportbatch::done**を返します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-142">However, **BatchComplete** can be called in a separate Messaging Engine thread, even before **IBTTransportBatch::Done** returns.</span></span> <span data-ttu-id="d2fa4-143">できるアダプターがアクセスしようとしたときに、 **IBTDTCCommitConfirm**オブジェクトの一部として、 **BatchComplete**の実装を呼び出すスレッドを不要になったため、アクセス違反があります。存在します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-143">It is possible that when the adapter tries to access the **IBTDTCCommitConfirm** object as a part of the **BatchComplete** implementation, there is an access violation because that calling thread no longer exists.</span></span> <span data-ttu-id="d2fa4-144">この状況を回避するために、次のソリューションを使用します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-144">Use the following solution to avoid this condition.</span></span>  
  
  <span data-ttu-id="d2fa4-145">次の例では、イベントを使用して、問題を解決します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-145">In the following example, the problem is solved by using an event.</span></span> <span data-ttu-id="d2fa4-146">ここでインターフェイス ポインターは、イベントを使用するプロパティを通じてアクセスされます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-146">Here the interface pointer is accessed through a property that uses the event.</span></span> <span data-ttu-id="d2fa4-147">Get では、続行する前に完了するセットが常に待機します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-147">The get always waits for the set to complete before proceeding.</span></span>  
  
```  
protected IBTDTCCommitConfirm CommitConfirm  
{  
      set  
      {  
            this.commitConfirm = value;  
            this.commitConfirmEvent.Set();  
      }  
      get  
      {  
            this.commitConfirmEvent.WaitOne();  
            return this.commitConfirm;  
      }  
}  
protected IBTDTCCommitConfirm commitConfirm = null;  
private ManualResetEvent commitConfirmEvent = new ManualResetEvent(false);  
```  
  
## <a name="batch-status-codes"></a><span data-ttu-id="d2fa4-148">バッチの状態コード</span><span class="sxs-lookup"><span data-stu-id="d2fa4-148">Batch Status Codes</span></span>  
 <span data-ttu-id="d2fa4-149">バッチの全体的な状態コードでは、バッチの結果を示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-149">The overall batch status code indicates the outcome of the batch.</span></span> <span data-ttu-id="d2fa4-150">操作の状態は、個々 のメッセージの送信の状態コードを示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-150">The operation status gives the submission status code for individual message items.</span></span> <span data-ttu-id="d2fa4-151">バッチは、さまざまな理由で失敗します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-151">Batches can fail for various reasons.</span></span> <span data-ttu-id="d2fa4-152">セキュリティ関連のエラーがある可能性があります、メッセージが送信されているエンジンがシャット ダウン時にします。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-152">There might be a security-related failure, or the message might have been submitted when the engine was shutting down.</span></span> <span data-ttu-id="d2fa4-153">(通常、エンジンのシャット ダウン時に、新しい作業を受け入れませんが、インプロセスの作業を完了は許可)。次の表では、バッチの状態または操作の状態のいずれかに返される一般的な HRESULT 値を示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-153">(Typically when the engine shuts down it does not accept any new work but does allow in-process work to be completed.) The following table indicates some common HRESULT values that are returned either in the batch status or the operation status.</span></span> <span data-ttu-id="d2fa4-154">また、これらは、成功または失敗のコードであるかどうかを示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-154">It also indicates whether these are success or failure codes.</span></span> <span data-ttu-id="d2fa4-155">これらのコードの適切な処理はより完全での説明[アダプターの障害を処理する方法](../core/how-to-handle-adapter-failures.md)します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-155">The proper handling of these codes is described more fully in [How to Handle Adapter Failures](../core/how-to-handle-adapter-failures.md).</span></span>  
  
|<span data-ttu-id="d2fa4-156">コード (BTTransportProxy クラスで定義)</span><span class="sxs-lookup"><span data-stu-id="d2fa4-156">Code (defined in the class BTTransportProxy)</span></span>|<span data-ttu-id="d2fa4-157">成功/失敗コード</span><span class="sxs-lookup"><span data-stu-id="d2fa4-157">Success/failure code</span></span>|<span data-ttu-id="d2fa4-158">説明</span><span class="sxs-lookup"><span data-stu-id="d2fa4-158">Description</span></span>|  
|----------------------------------------------------|---------------------------|-----------------|  
|<span data-ttu-id="d2fa4-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span><span class="sxs-lookup"><span data-stu-id="d2fa4-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span></span>|<span data-ttu-id="d2fa4-160">成功</span><span class="sxs-lookup"><span data-stu-id="d2fa4-160">Success</span></span>|<span data-ttu-id="d2fa4-161">セキュリティ チェックを実行し、認証に失敗したメッセージをドロップは、ポートが構成されました。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-161">The port was configured to perform a security check and drop messages that failed authentication.</span></span> <span data-ttu-id="d2fa4-162">アダプターは、この状態コードを返すバッチを一時停止する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-162">Adapters should not suspend batches that return this status code.</span></span>|  
|<span data-ttu-id="d2fa4-163">BTS_S_EPM_MESSAGE_SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="d2fa4-163">BTS_S_EPM_MESSAGE_SUSPENDED</span></span>|<span data-ttu-id="d2fa4-164">成功</span><span class="sxs-lookup"><span data-stu-id="d2fa4-164">Success</span></span>|<span data-ttu-id="d2fa4-165">エンジンがデータの所有権、1 つまたは複数のメッセージが中断されたことを示します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-165">Indicates that one or more messages were suspended, and the engine has ownership of the data.</span></span> <span data-ttu-id="d2fa4-166">メッセージング エンジンがメッセージの送信を受け入れたことに成功コードになります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-166">It is a success code in that the Messaging Engine has accepted the message submission.</span></span>|  
|<span data-ttu-id="d2fa4-167">E_BTS_URL_DISALLOWED</span><span class="sxs-lookup"><span data-stu-id="d2fa4-167">E_BTS_URL_DISALLOWED</span></span>|<span data-ttu-id="d2fa4-168">失敗</span><span class="sxs-lookup"><span data-stu-id="d2fa4-168">Failure</span></span>|<span data-ttu-id="d2fa4-169">無効なメッセージが送信された**InboundTransportLocation**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-169">A message was submitted with an invalid **InboundTransportLocation**.</span></span>|  
  
## <a name="batch-operations"></a><span data-ttu-id="d2fa4-170">バッチ操作</span><span class="sxs-lookup"><span data-stu-id="d2fa4-170">Batch Operations</span></span>  
 <span data-ttu-id="d2fa4-171">次の表は、メンバー メソッドとの操作、 **IBTTransportBatch**特定のバッチに作業を追加するアダプターを使用するオブジェクトします。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-171">The following table details the member methods and operations of the **IBTTransportBatch** object that the adapter uses to add work to a given batch.</span></span>  
  
|<span data-ttu-id="d2fa4-172">メソッド名</span><span class="sxs-lookup"><span data-stu-id="d2fa4-172">Method name</span></span>|<span data-ttu-id="d2fa4-173">操作の種類</span><span class="sxs-lookup"><span data-stu-id="d2fa4-173">Operation type</span></span>|<span data-ttu-id="d2fa4-174">説明</span><span class="sxs-lookup"><span data-stu-id="d2fa4-174">Description</span></span>|  
|-----------------|--------------------|-----------------|  
|<span data-ttu-id="d2fa4-175">**SubmitMessage**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-175">**SubmitMessage**</span></span>|<span data-ttu-id="d2fa4-176">送信</span><span class="sxs-lookup"><span data-stu-id="d2fa4-176">Submit</span></span>|<span data-ttu-id="d2fa4-177">エンジンにメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-177">Submits a message into the engine.</span></span>|  
|<span data-ttu-id="d2fa4-178">**SubmitResponseMessage**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-178">**SubmitResponseMessage**</span></span>|<span data-ttu-id="d2fa4-179">送信</span><span class="sxs-lookup"><span data-stu-id="d2fa4-179">Submit</span></span>|<span data-ttu-id="d2fa4-180">応答メッセージをエンジンに送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-180">Submits a response message into the engine.</span></span> <span data-ttu-id="d2fa4-181">これは、送信請求-応答の組み合わせで応答メッセージです。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-181">This is the response message in a solicit-response pair.</span></span>|  
|<span data-ttu-id="d2fa4-182">**DeleteMessage**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-182">**DeleteMessage**</span></span>|<span data-ttu-id="d2fa4-183">DELETE</span><span class="sxs-lookup"><span data-stu-id="d2fa4-183">Delete</span></span>|<span data-ttu-id="d2fa4-184">アダプターが非ブロッキング送信を使用してネットワーク経由で正常に送信するメッセージを削除します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-184">Deletes a message that an adapter has successfully transmitted over the wire using a non-blocking send.</span></span> <span data-ttu-id="d2fa4-185">ブロッキング送信を使用するアダプターがメッセージング エンジンが削除されますが、アダプターの代わりに、アダプターが返された場合は、このメソッドを呼び出す必要はありません`true`から**TransmitMesssage**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-185">Adapters that use blocking sends do not need to call this method because the Messaging Engine will delete it on the adapter's behalf if the adapter returns `true` from **TransmitMesssage**.</span></span>|  
|<span data-ttu-id="d2fa4-186">**MoveToSuspendQ**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-186">**MoveToSuspendQ**</span></span>|<span data-ttu-id="d2fa4-187">MoveToSuspendQ</span><span class="sxs-lookup"><span data-stu-id="d2fa4-187">MoveToSuspendQ</span></span>|<span data-ttu-id="d2fa4-188">メッセージを保留キューに移動します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-188">Moves a message into the Suspended queue.</span></span>|  
|<span data-ttu-id="d2fa4-189">**再送信します。**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-189">**Resubmit**</span></span>|<span data-ttu-id="d2fa4-190">再送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-190">Resubmit</span></span>|<span data-ttu-id="d2fa4-191">要求は後で送信メッセージを再試行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-191">Requests that a message should be retried for transmission at a later time.</span></span> <span data-ttu-id="d2fa4-192">送信の試行が失敗した後、これは通常に呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-192">This is typically called after a transmission attempt has failed.</span></span>|  
|<span data-ttu-id="d2fa4-193">**MoveToNextTransport**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-193">**MoveToNextTransport**</span></span>|<span data-ttu-id="d2fa4-194">MoveToNextTransport</span><span class="sxs-lookup"><span data-stu-id="d2fa4-194">MoveToNextTransport</span></span>|<span data-ttu-id="d2fa4-195">要求メッセージをバックアップ トランスポートを使用して送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-195">Requests that a message be transmitted using its backup transport.</span></span> <span data-ttu-id="d2fa4-196">通常、すべての再試行が終了した後に呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-196">Typically called after all retries have been exhausted.</span></span> <span data-ttu-id="d2fa4-197">バックアップ トランスポートが存在しない場合、このメソッドは失敗します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-197">If no backup transport is present this method will fail</span></span>|  
|<span data-ttu-id="d2fa4-198">**SubmitRequestMessage**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-198">**SubmitRequestMessage**</span></span>|<span data-ttu-id="d2fa4-199">SubmitRequest</span><span class="sxs-lookup"><span data-stu-id="d2fa4-199">SubmitRequest</span></span>|<span data-ttu-id="d2fa4-200">要求メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-200">Submits a request message.</span></span> <span data-ttu-id="d2fa4-201">これは、要求-応答の組み合わせで要求メッセージです。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-201">This is a request message in a request-response pair.</span></span>|  
|<span data-ttu-id="d2fa4-202">**CancelRequestForResponse**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-202">**CancelRequestForResponse**</span></span>|<span data-ttu-id="d2fa4-203">CancelRequestForResponse</span><span class="sxs-lookup"><span data-stu-id="d2fa4-203">CancelRequestForResponse</span></span>|<span data-ttu-id="d2fa4-204">アダプターは、要求-応答の組み合わせで応答メッセージを待機する不要になったことを希望するエンジンに通知します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-204">Notifies the engine that the adapter no longer wishes to wait for the response message in a request-response pair.</span></span>|  
|<span data-ttu-id="d2fa4-205">**Clear**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-205">**Clear**</span></span>|<span data-ttu-id="d2fa4-206">NA</span><span class="sxs-lookup"><span data-stu-id="d2fa4-206">NA</span></span>|<span data-ttu-id="d2fa4-207">バッチのすべての操作をクリアします。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-207">Clears all work from the batch.</span></span>|  
|<span data-ttu-id="d2fa4-208">**完成です**</span><span class="sxs-lookup"><span data-stu-id="d2fa4-208">**Done**</span></span>|<span data-ttu-id="d2fa4-209">NA</span><span class="sxs-lookup"><span data-stu-id="d2fa4-209">NA</span></span>|<span data-ttu-id="d2fa4-210">処理エンジンへのメッセージのバッチを送信します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-210">Submits a batch of messages to the engine for processing.</span></span>|  
  
## <a name="batch-management"></a><span data-ttu-id="d2fa4-211">バッチの管理</span><span class="sxs-lookup"><span data-stu-id="d2fa4-211">Batch Management</span></span>  
 <span data-ttu-id="d2fa4-212">バッチは、メッセージング エンジンでネイティブ コードで実装されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-212">Batches are implemented in native code in the Messaging Engine.</span></span> <span data-ttu-id="d2fa4-213">そのためマネージ コードで作成されたアダプターはバッチが終了した後、バッチのランタイム呼び出し可能ラッパー (RCW) を解除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-213">For this reason an adapter written in managed code should release the runtime callable wrapper (RCW) for the batch after it has finished with the batch.</span></span> <span data-ttu-id="d2fa4-214">これは、マネージ コードの中でを使用して、 **Marshal.ReleaseComObject** API。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-214">This is done in managed code by using the **Marshal.ReleaseComObject** API.</span></span> <span data-ttu-id="d2fa4-215">しばらくの間でこの API を呼び出す必要がありますに注意してください。 返される参照カウントが 0 になるまでループします。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-215">It is important to remember that this API should be called in a while loop until the returned reference count reaches zero.</span></span>  
  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] <span data-ttu-id="d2fa4-216">バッチ内で同期的にメッセージを処理します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-216">processes messages synchronously within a batch.</span></span> <span data-ttu-id="d2fa4-217">多数のバッチがアプリケーション ドメイン内のバッチ サイズを調整することによって、アダプターで何らかの最適化の機会を提供することがありますが同時に処理できます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-217">Many batches may be processed concurrently, which may provide an opportunity for some optimization in the adapter by adjusting the batch size in the application domain.</span></span> <span data-ttu-id="d2fa4-218">たとえば、(いくつかの制限に達した) まで、FTP サイト上のすべてのファイルを処理する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-218">For example, you might process all the files on an FTP site (until some limit is hit).</span></span> <span data-ttu-id="d2fa4-219">SAP の場合、バッチとして送信されるメッセージの数に 1 つのストリームを処理する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-219">In the case of SAP you might process a single stream into a number of messages that are then submitted as a batch.</span></span>  
  
 <span data-ttu-id="d2fa4-220">操作を渡すために、アダプターによって使用されるバッチに[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]メッセージの一覧に正確に対応する必要はありませんを[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]アダプターを提供します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-220">The batch used by an adapter to pass operations back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] does not need to exactly correspond to the list of messages that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] gives to the adapter.</span></span> <span data-ttu-id="d2fa4-221">つまり、トランザクションの実行が送信する場合、再送信操作を分割する必要があります**MoveToNextTransport**と**MoveToSuspendQ**に別のバッチ。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-221">In other words, when doing transactional sends you must split the resubmit operations **MoveToNextTransport** and **MoveToSuspendQ** into separate batches.</span></span> <span data-ttu-id="d2fa4-222">多くのアダプターは、さらに処理するためのメッセージの個別の一覧に複数のエンドポイントに送信されたメッセージのバッチを並べ替えます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-222">Many adapters sort a batch of messages that have been submitted for multiple endpoints into separate lists of messages for further processing.</span></span>  
  
 <span data-ttu-id="d2fa4-223">ポイントは、(トランザクションに関連付けられているもの) 以外のルールがないことでメッセージのバッチ処理に関連付けられている[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-223">The point is that there are no rules (besides those associated with the transaction) associated with message batching in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="d2fa4-224">単に固有の実装方法の送受信メッセージをチャンクするアダプターのバッチ処理は[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-224">Batching is simply an implementation-specific way for the adapter to chunk messages into and out of [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
 <span data-ttu-id="d2fa4-225">アダプターからのメッセージをバッチできる複数の小さなバッチ[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]が特定のこと、大きなバッチからへの応答[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-225">An adapter can batch messages from multiple smaller batches that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has given it into a larger batch for the response to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="d2fa4-226">これには、多数の非常に小さいメッセージを処理するトランザクション アダプターで大幅な最適化があります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-226">This might be a significant optimization in transactional adapters that are dealing with large numbers of very small messages.</span></span> <span data-ttu-id="d2fa4-227">「メッセージあたりのトランザクションの合計数」の比率が最小限に抑えます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-227">It minimizes the "total number of transactions per message" ratio.</span></span>  
  
 <span data-ttu-id="d2fa4-228">通常[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]5 ~ 10 メッセージの送信側バッチが生成されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-228">Typically [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produces send-side batches of between 5 and 10 messages.</span></span> <span data-ttu-id="d2fa4-229">これらは、非常に小さいメッセージと、アダプターは、最大 100 個のメッセージをバッチ可能性がありますまたは削除のトランザクション バッチを送信する前に詳細にバックアップ[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-229">If these are very small messages, an adapter might batch up to 100 messages or more before it submits a transactional batch of deletes back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="d2fa4-230">このような最適化は; を実装する簡単ではありません。必ず必要がありますアダプター メモリにメッセージが停止しない取得際限なく待機しているいくつかのしきい値が満たされているのです。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-230">An optimization like this is not easy to implement; you must make sure that messages never get stuck in the adapter memory, waiting endlessly for some threshold to be met.</span></span>  
  
 <span data-ttu-id="d2fa4-231">バッチ処理の重要度のパフォーマンスの数値で確認できます[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]MQSeries などの高スループットのアダプター。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-231">The significance of batching can be seen in the performance numbers for [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] for the high-throughput adapters like MQSeries.</span></span> <span data-ttu-id="d2fa4-232">これらのアダプターで少なくとも 2 回、多くの場合、送信されるメッセージが受信されます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-232">In these adapters, messages are received at least twice as often as they are sent.</span></span> <span data-ttu-id="d2fa4-233">既定では、受信アダプターが 100 件のメッセージのバッチを使用し、送信アダプターは、既定値を使用して[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]バッチが与えられます。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-233">By default the receive adapter uses batches of 100 messages and the send adapter uses the default [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] batch it is given.</span></span>  
  
## <a name="transactional-batches"></a><span data-ttu-id="d2fa4-234">トランザクション バッチ</span><span class="sxs-lookup"><span data-stu-id="d2fa4-234">Transactional Batches</span></span>  
 <span data-ttu-id="d2fa4-235">トランザクション オブジェクトを作成しに渡すアダプターを記述するとき[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]、実行すると、次のコードの記述を担当することになります。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-235">When you write an adapter that creates a transaction object and hands it to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], you are accepting responsibility for writing code that does the following:</span></span>  
  
- <span data-ttu-id="d2fa4-236">バッチ操作の最終結果を決定します。 コミットまたはトランザクションの最後。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-236">Decides the final outcome of the batch operation: to either commit or end the transaction.</span></span> <span data-ttu-id="d2fa4-237">他のトランザクション分岐のスコープ内でこの 1 つのトランザクションのない時によって[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]によっては、メッセージ キュー (MSMQ) キューまたはトランザクション データベース操作への書き込みなど。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-237">This may depend upon other transactional branches within the scope of this one transaction that are not [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] dependent, such as writing to an Message Queuing (MSMQ) queue or a transactional database operation.</span></span>  
  
- <span data-ttu-id="d2fa4-238">通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]を呼び出して最終結果の**IBTDTCCommitConfirm.DTCCommitConfirm**メソッド。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-238">Informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the final outcome by calling the **IBTDTCCommitConfirm.DTCCommitConfirm** method.</span></span> <span data-ttu-id="d2fa4-239">返す`true`以外のトランザクションが正常にコミットを意味します。 返す`false`失敗して、トランザクションのロールバックします。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-239">Returning `true` indicates a successful commit of the transaction; returning `false` signifies failure and rollback of the transaction.</span></span>  
  
  <span data-ttu-id="d2fa4-240">アダプターに通知する必要があります[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]の内部で維持するために、トランザクションの最終的な結果に関するデータを追跡します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-240">The adapter must inform [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] about the final outcome of the transaction to maintain its internal tracking data.</span></span> <span data-ttu-id="d2fa4-241">通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]呼び出すことによって、結果の**DTCCommitConfirm**します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-241">The adapter informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the outcome by calling **DTCCommitConfirm**.</span></span> <span data-ttu-id="d2fa4-242">アダプターがこれにもいない場合は大量のメモリ リークが発生して、MSDTC トランザクション タイムアウトし、操作が正常に完了に関係なく失敗します。</span><span class="sxs-lookup"><span data-stu-id="d2fa4-242">If the adapter does not do this, a significant memory leak occurs and the MSDTC transaction could time out and fail despite its operations completing successfully.</span></span>