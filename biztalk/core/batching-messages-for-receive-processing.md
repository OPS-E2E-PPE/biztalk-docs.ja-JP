---
title: 受信処理用メッセージをバッチ処理 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 32bf0b70-e9d1-4fab-9c74-160e51390700
caps.latest.revision: 8
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 21ce691f51d6c389073c98dadc9ce0f5dfb68504
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2018
ms.locfileid: "36971059"
---
# <a name="batching-messages-for-receive-processing"></a><span data-ttu-id="2cee1-102">受信処理用メッセージのバッチ処理</span><span class="sxs-lookup"><span data-stu-id="2cee1-102">Batching Messages for Receive Processing</span></span>
## <a name="batch-callbacks"></a><span data-ttu-id="2cee1-103">バッチ コールバック</span><span class="sxs-lookup"><span data-stu-id="2cee1-103">Batch Callbacks</span></span>  
 <span data-ttu-id="2cee1-104">受信アダプターによってメッセージング エンジンに送信されるバッチは、非同期に処理されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-104">Batches submitted by receive adapters to the Messaging Engine are processed asynchronously.</span></span> <span data-ttu-id="2cee1-105">したがって、成功または失敗が通知されるように、また、必要なクリーンアップ処理が実行されるように、受信アダプターにはコールバックを受信アダプターの状態に関連付けるメカニズムが必要です。</span><span class="sxs-lookup"><span data-stu-id="2cee1-105">Therefore the adapter needs a mechanism to tie a callback to some state in the adapter so it can be notified of success or failure and perform any necessary cleanup actions.</span></span> <span data-ttu-id="2cee1-106">コールバックのセマンティクスは柔軟なので、アダプターには、3 つの方法のうちの 1 つまたはそれらの方法の組み合わせを使用できます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-106">The callback semantics are flexible such that adapters can use one or a combination of three approaches.</span></span> <span data-ttu-id="2cee1-107">これらの設定は、次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-107">These are:</span></span>  
  
- <span data-ttu-id="2cee1-108">すべてのコールバックが実装する同じオブジェクト インスタンスで行われた**IBTBatchCallBack**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-108">All callbacks are made on the same object instance that implements **IBTBatchCallBack**.</span></span>  
  
- <span data-ttu-id="2cee1-109">新しいバッチの要求時にエンジンに渡される Cookie を使用して、コールバックをアダプターの状態に関連付けます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-109">The cookie passed into the engine when requesting a new batch is used to correlate the callback to the state in the adapters.</span></span>  
  
- <span data-ttu-id="2cee1-110">実装する各バッチの異なるコールバック オブジェクトがある**IBTBatchCallBack**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-110">There is a different callback object for each batch that implements **IBTBatchCallBack**.</span></span> <span data-ttu-id="2cee1-111">各オブジェクトが、独自のプライベート状態を保持します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-111">Here each object holds its own private state.</span></span>  
  
  <span data-ttu-id="2cee1-112">実装でアダプターがコールバックに機能して、バッチが処理されると、 **IBTBatchCallBack.BatchComplete**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-112">When the batch has been processed, the adapter is called back on its implementation of **IBTBatchCallBack.BatchComplete**.</span></span> <span data-ttu-id="2cee1-113">このバッチの全体的な状態は、最初のパラメーターである HRESULT 値によって示されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-113">The overall status of the batch is indicated by the first parameter, the HRESULT status.</span></span> <span data-ttu-id="2cee1-114">この値がゼロ以上の場合、エンジンにデータの所有権があり、受信アダプターがそのデータを回線から自由に削除できるという意味で、バッチは成功です。</span><span class="sxs-lookup"><span data-stu-id="2cee1-114">If this value is greater than or equal to zero, then the batch was successful in the sense that the engine has ownership of the data and the adapter is free to delete that data from the wire.</span></span> <span data-ttu-id="2cee1-115">負の状態は、バッチが失敗したことを示します。 成功したバッチ内の操作のいずれもと、アダプターは、エラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-115">A negative status indicates that the batch failed: None of the operations in the batch were successful and the adapter is responsible for handling the failure.</span></span>  
  
  <span data-ttu-id="2cee1-116">バッチが失敗した場合、アダプターはどの操作のどの項目が失敗したのかを認識する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-116">If the batch failed, then the adapter needs to know which item in which operation failed.</span></span> <span data-ttu-id="2cee1-117">たとえば、アダプターが 1 つのバッチを使用してディスクから 20 ファイルを読み取り、それらを [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に送信したとします。</span><span class="sxs-lookup"><span data-stu-id="2cee1-117">For example, suppose that the adapter was reading 20 files from disk and submitting them into [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] using a single batch.</span></span> <span data-ttu-id="2cee1-118">10 番目のファイルが破損している場合、アダプターはその 1 つのファイルを中断し、残りの 19 を再送信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-118">If the tenth file was corrupted, the adapter would need to suspend that one file and resubmit the remaining 19.</span></span> <span data-ttu-id="2cee1-119">この情報は、2 番目と 3 番目のパラメーターでアダプターに使用可能な —`opCount` (操作数) short 型のおよび`operationStatus`btbatchoperationstatus[] 型のです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-119">This information is available to the adapter in the second and third parameters—`opCount` (operation count) of type short and `operationStatus`, which is of type BTBatchOperationStatus[].</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2cee1-120">1 つのバッチ オブジェクトで 1 つのメッセージを複数回送信しないでください。</span><span class="sxs-lookup"><span data-stu-id="2cee1-120">On a single batch object you should never submit a message more than once.</span></span> <span data-ttu-id="2cee1-121">同じメッセージ オブジェクトを同じバッチで複数回送信すると、エンジンでエラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-121">Submitting the same message object more than once on the same batch will result in engine errors.</span></span>  
  
 <span data-ttu-id="2cee1-122">操作数は、操作の種類の数がバッチにあったことを示します (のサイズ、 **BTBatchOperationStatus**配列)。</span><span class="sxs-lookup"><span data-stu-id="2cee1-122">The operation count indicates how many types of operations were in the batch (the size of the **BTBatchOperationStatus** array).</span></span> <span data-ttu-id="2cee1-123">操作の状態配列内の各要素は、バッチに含まれている操作の種類に対応しています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-123">Each element in the operation status array corresponds to a given operation type.</span></span> <span data-ttu-id="2cee1-124">使用して、 **BTBatchOperationStatus**配列、アダプターは、調べることで失敗しました操作内の項目を特定できます、 **BTBatchOperationStatus.MessageStatus**負の値の HRESULT の配列。エラーを示す値。</span><span class="sxs-lookup"><span data-stu-id="2cee1-124">By using the **BTBatchOperationStatus** array, the adapter can determine which item in a given operation failed by looking at the **BTBatchOperationStatus.MessageStatus** array for negative HRESULT values signifying failure.</span></span> <span data-ttu-id="2cee1-125">上記のシナリオのアダプターは、19 メッセージを送信し 1 メッセージを保留する新しいバッチを作成します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-125">In the scenario above, the adapter creates a new batch containing 19 message submits and one message suspend.</span></span>  
  
 <span data-ttu-id="2cee1-126">次のコードでは、アダプターが新しいバッチをトランスポート プロキシを使用してエンジンに要求し、Cookie を利用して 1 つのメッセージをエンジンに送信する方法を示しています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-126">The following code fragment shows how an adapter requests a new batch from the engine through its transport proxy and submits a single message into the engine using the cookie approach.</span></span> <span data-ttu-id="2cee1-127">メッセージング エンジンの呼び出し、 **BatchComplete**メソッドのバッチ全体の処理が完了すると、バッチ コールバックとしては、メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-127">The Messaging Engine calls the **BatchComplete** method as the batch callback when it has completed processing the entire batch of submitted messages.</span></span>  
  
```  
using Microsoft.BizTalk.TransportProxy.Interop;  
using Microsoft.BizTalk.Message.Interop;  
  
public class MyAdapter :   
                  IBTTransport,   
                  IBTTransportConfig,   
                  IBTTransportControl,  
                  IPersistPropertyBag,   
                  IBaseComponent,  
                  IBTBatchCallBack  
{  
      private IBTTransportProxy _tp;  
  
      public void BatchComplete(      
            Int32                         status,   
            Int16                         opCount,   
            BTBatchOperationStatus[]      operationStatus,   
            System.Object                 callbackCookie)  
      {  
            // Use cookie to correlate callback with work done,  
            // in this example the batch is to submit a single  
            // file the name of which will be in the  
            // callbackCookie  
            string fileName = (string)callbackCookie;  
            if ( status >= 0 )  
                  // DeleteFile from disc  
                  File.Delete(fileName);          
            else  
                  // Rename file to fileName.bad  
                  File.Move(fileName, fileName + ".bad");  
      }  
  
      private void SubmitMessage(  
            IBaseMessage                  msg,   
            string                        fileName)  
      {  
            // Note: Pass in the filename as the cookie  
            IBTTransportBatch batch =   
                  _tp.GetBatch(this, (object)fileName);  
  
            // Add msg to batch for submitting   
            batch.SubmitMessage(msg);   
  
            // Process this batch  
            batch.Done(null);  
      }  
}  
```  
  
 <span data-ttu-id="2cee1-128">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK には、ファイル アダプター、HTTP アダプター、MSMQ アダプター、およびトランザクション アダプターのサンプルが用意されています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-128">The [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] SDK includes samples for the following adapters: File, HTTP, MSMQ, and the Transactional Adapter.</span></span> <span data-ttu-id="2cee1-129">これらのアダプターはすべて BaseAdapter と呼ばれる共通のビルド ブロックに基づいて作成されています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-129">All of these adapters are built on top of a common building block called the BaseAdapter.</span></span> <span data-ttu-id="2cee1-130">バージョン 1.0.1 の BaseAdapter には、操作の状態を解析し、新しいバッチを再作成して送信するための関連コードがすべて含まれています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-130">Version 1.0.1 of the BaseAdapter includes all of the relevant code to parse the operation status and rebuild a new batch to submit.</span></span>  
  
## <a name="race-condition"></a><span data-ttu-id="2cee1-131">競合状態</span><span class="sxs-lookup"><span data-stu-id="2cee1-131">Race Condition</span></span>  
 <span data-ttu-id="2cee1-132">エラーを解決するタスクと、送信されたバッチの最終結果を決定するタスクは単純に見えますが、実際には、これらのタスクは次に示す異なるスレッドの情報に基づいています。</span><span class="sxs-lookup"><span data-stu-id="2cee1-132">The two tasks of resolving errors and deciding the final outcome of a submitted batch seem simple enough, but in fact they rely on information from different threads:</span></span>  
  
- <span data-ttu-id="2cee1-133">アダプターによって渡された情報に基づいてエラーを処理する[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]アダプターの**BatchComplete**コールバック メソッド。</span><span class="sxs-lookup"><span data-stu-id="2cee1-133">The adapter processes errors based on information passed by [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] to the adapter's **BatchComplete** callback method.</span></span> <span data-ttu-id="2cee1-134">このコールバックはアダプターのスレッドで実行されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-134">This callback executes on the adapter's thread.</span></span>  
  
- <span data-ttu-id="2cee1-135">**DTCCommitConfirm**に、メソッドが、 **IBTDTCCommitConfirm**オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="2cee1-135">**DTCCommitConfirm** is a method on the **IBTDTCCommitConfirm** object.</span></span> <span data-ttu-id="2cee1-136">インスタンス、 **IBTDTCCommitConfirm**オブジェクトは、batch によって返される**ibttransportbatch::done**呼び出します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-136">An instance of the **IBTDTCCommitConfirm** object is returned by the batch **IBTTransportBatch::Done** call.</span></span> <span data-ttu-id="2cee1-137">このインスタンスが同じスレッドでは、 **ibttransportbatch::done**呼び出すには、これは、アダプターのコールバック スレッドと異なる。</span><span class="sxs-lookup"><span data-stu-id="2cee1-137">This instance is on the same thread as the **IBTTransportBatch::Done** call, which is different from the adapter's callback thread.</span></span>  
  
  <span data-ttu-id="2cee1-138">アダプターがすべての呼び出しに対して**ibttransportbatch::done**メッセージング エンジンはコールバック メソッドに対応する呼び出し**BatchComplete**の結果を報告する別のスレッドで、バッチ送信します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-138">For every call that the adapter makes to **IBTTransportBatch::Done** the Messaging Engine makes a corresponding call to the callback method **BatchComplete** in a separate thread to report the result of the batch submission.</span></span> <span data-ttu-id="2cee1-139">**BatchComplete**アダプターのニーズをコミットまたはロールバック トランザクションかどうかに基づいて、バッチが成功または失敗します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-139">In **BatchComplete** the adapter needs to commit or roll back the transaction based on whether the batch passed or failed.</span></span> <span data-ttu-id="2cee1-140">どちらの場合、アダプターは呼び出す必要がありますし、 **DTCCommitConfirm**トランザクションの状態を報告します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-140">In either case, the adapter should then call **DTCCommitConfirm** to report the status of the transaction.</span></span>  
  
  <span data-ttu-id="2cee1-141">競合状態が存在するためのアダプターの実装**BatchComplete**を想定できます、 **IBTDTCCommitConfirm**によって返されるオブジェクト**ibttransportbatch::done**は常に利用可能な場合に**BatchComplete**を実行します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-141">A possible race condition exists because the adapter’s implementation of **BatchComplete** can assume that the **IBTDTCCommitConfirm** object returned by **IBTTransportBatch::Done** is always available when **BatchComplete** executes.</span></span> <span data-ttu-id="2cee1-142">ただし、 **BatchComplete**前であってもに、、別のメッセージング エンジン スレッドで呼び出すこと**ibttransportbatch::done**を返します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-142">However, **BatchComplete** can be called in a separate Messaging Engine thread, even before **IBTTransportBatch::Done** returns.</span></span> <span data-ttu-id="2cee1-143">できるアダプターがアクセスしようとしたときに、 **IBTDTCCommitConfirm**オブジェクトの一部として、 **BatchComplete**の実装を呼び出すスレッドを不要になったため、アクセス違反があります。存在します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-143">It is possible that when the adapter tries to access the **IBTDTCCommitConfirm** object as a part of the **BatchComplete** implementation, there is an access violation because that calling thread no longer exists.</span></span> <span data-ttu-id="2cee1-144">この状態を回避するには、次の解決方法を使用します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-144">Use the following solution to avoid this condition.</span></span>  
  
  <span data-ttu-id="2cee1-145">次の例では、イベントを使用してこの問題を解決します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-145">In the following example, the problem is solved by using an event.</span></span> <span data-ttu-id="2cee1-146">この例では、イベントを使用するプロパティを通じてインターフェイス ポインターにアクセスします。</span><span class="sxs-lookup"><span data-stu-id="2cee1-146">Here the interface pointer is accessed through a property that uses the event.</span></span> <span data-ttu-id="2cee1-147">get の処理は、必ず set が完了した後で行われます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-147">The get always waits for the set to complete before proceeding.</span></span>  
  
```  
protected IBTDTCCommitConfirm CommitConfirm  
{  
      set  
      {  
            this.commitConfirm = value;  
            this.commitConfirmEvent.Set();  
      }  
      get  
      {  
            this.commitConfirmEvent.WaitOne();  
            return this.commitConfirm;  
      }  
}  
protected IBTDTCCommitConfirm commitConfirm = null;  
private ManualResetEvent commitConfirmEvent = new ManualResetEvent(false);  
```  
  
## <a name="batch-status-codes"></a><span data-ttu-id="2cee1-148">バッチの状態コード</span><span class="sxs-lookup"><span data-stu-id="2cee1-148">Batch Status Codes</span></span>  
 <span data-ttu-id="2cee1-149">バッチの状態コード全体は、バッチの結果を示します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-149">The overall batch status code indicates the outcome of the batch.</span></span> <span data-ttu-id="2cee1-150">操作の状態からは、個々のメッセージ項目の送信の状態コードが得られます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-150">The operation status gives the submission status code for individual message items.</span></span> <span data-ttu-id="2cee1-151">バッチが失敗するのにはさまざまな理由があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-151">Batches can fail for various reasons.</span></span> <span data-ttu-id="2cee1-152">セキュリティ関連のエラーがある可能性があります、メッセージが送信されているエンジンがシャット ダウン時にします。</span><span class="sxs-lookup"><span data-stu-id="2cee1-152">There might be a security-related failure, or the message might have been submitted when the engine was shutting down.</span></span> <span data-ttu-id="2cee1-153">(通常、エンジンのシャット ダウン時に、新しい作業を受け入れませんが、インプロセスの作業を完了は許可)。次の表に、バッチの状態または操作の状態のいずれかで返される共通の HRESULT 値をいくつか示します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-153">(Typically when the engine shuts down it does not accept any new work but does allow in-process work to be completed.) The following table indicates some common HRESULT values that are returned either in the batch status or the operation status.</span></span> <span data-ttu-id="2cee1-154">また、それらの値が成功コードなのか失敗コードなのかも示します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-154">It also indicates whether these are success or failure codes.</span></span> <span data-ttu-id="2cee1-155">これらのコードの適切な処理はより完全での説明[アダプターの障害を処理する方法](../core/how-to-handle-adapter-failures.md)します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-155">The proper handling of these codes is described more fully in [How to Handle Adapter Failures](../core/how-to-handle-adapter-failures.md).</span></span>  
  
|<span data-ttu-id="2cee1-156">コード (BTTransportProxy クラスで定義)</span><span class="sxs-lookup"><span data-stu-id="2cee1-156">Code (defined in the class BTTransportProxy)</span></span>|<span data-ttu-id="2cee1-157">成功コード/失敗コード</span><span class="sxs-lookup"><span data-stu-id="2cee1-157">Success/failure code</span></span>|<span data-ttu-id="2cee1-158">説明</span><span class="sxs-lookup"><span data-stu-id="2cee1-158">Description</span></span>|  
|----------------------------------------------------|---------------------------|-----------------|  
|<span data-ttu-id="2cee1-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span><span class="sxs-lookup"><span data-stu-id="2cee1-159">BTS_S_EPM_SECURITY_CHECK_FAILED</span></span>|<span data-ttu-id="2cee1-160">成功</span><span class="sxs-lookup"><span data-stu-id="2cee1-160">Success</span></span>|<span data-ttu-id="2cee1-161">セキュリティ チェックを行うようにポートが構成されたので、認証に失敗したメッセージは削除されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-161">The port was configured to perform a security check and drop messages that failed authentication.</span></span> <span data-ttu-id="2cee1-162">アダプターでは、この状態コードを返すバッチを保留しないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-162">Adapters should not suspend batches that return this status code.</span></span>|  
|<span data-ttu-id="2cee1-163">BTS_S_EPM_MESSAGE_SUSPENDED</span><span class="sxs-lookup"><span data-stu-id="2cee1-163">BTS_S_EPM_MESSAGE_SUSPENDED</span></span>|<span data-ttu-id="2cee1-164">成功</span><span class="sxs-lookup"><span data-stu-id="2cee1-164">Success</span></span>|<span data-ttu-id="2cee1-165">1 つ以上のメッセージが保留され、エンジンにデータの所有権があることを示します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-165">Indicates that one or more messages were suspended, and the engine has ownership of the data.</span></span> <span data-ttu-id="2cee1-166">これは、メッセージ エンジンがメッセージの送信を受け入れたという点で、成功コードです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-166">It is a success code in that the Messaging Engine has accepted the message submission.</span></span>|  
|<span data-ttu-id="2cee1-167">E_BTS_URL_DISALLOWED</span><span class="sxs-lookup"><span data-stu-id="2cee1-167">E_BTS_URL_DISALLOWED</span></span>|<span data-ttu-id="2cee1-168">失敗</span><span class="sxs-lookup"><span data-stu-id="2cee1-168">Failure</span></span>|<span data-ttu-id="2cee1-169">無効なメッセージが送信された**InboundTransportLocation**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-169">A message was submitted with an invalid **InboundTransportLocation**.</span></span>|  
  
## <a name="batch-operations"></a><span data-ttu-id="2cee1-170">バッチ操作</span><span class="sxs-lookup"><span data-stu-id="2cee1-170">Batch Operations</span></span>  
 <span data-ttu-id="2cee1-171">次の表は、メンバー メソッドとの操作、 **IBTTransportBatch**特定のバッチに作業を追加するアダプターを使用するオブジェクトします。</span><span class="sxs-lookup"><span data-stu-id="2cee1-171">The following table details the member methods and operations of the **IBTTransportBatch** object that the adapter uses to add work to a given batch.</span></span>  
  
|<span data-ttu-id="2cee1-172">メソッド名</span><span class="sxs-lookup"><span data-stu-id="2cee1-172">Method name</span></span>|<span data-ttu-id="2cee1-173">操作の種類</span><span class="sxs-lookup"><span data-stu-id="2cee1-173">Operation type</span></span>|<span data-ttu-id="2cee1-174">説明</span><span class="sxs-lookup"><span data-stu-id="2cee1-174">Description</span></span>|  
|-----------------|--------------------|-----------------|  
|<span data-ttu-id="2cee1-175">**SubmitMessage**</span><span class="sxs-lookup"><span data-stu-id="2cee1-175">**SubmitMessage**</span></span>|<span data-ttu-id="2cee1-176">送信</span><span class="sxs-lookup"><span data-stu-id="2cee1-176">Submit</span></span>|<span data-ttu-id="2cee1-177">メッセージをエンジンに送信します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-177">Submits a message into the engine.</span></span>|  
|<span data-ttu-id="2cee1-178">**SubmitResponseMessage**</span><span class="sxs-lookup"><span data-stu-id="2cee1-178">**SubmitResponseMessage**</span></span>|<span data-ttu-id="2cee1-179">送信</span><span class="sxs-lookup"><span data-stu-id="2cee1-179">Submit</span></span>|<span data-ttu-id="2cee1-180">応答メッセージをエンジンに送信します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-180">Submits a response message into the engine.</span></span> <span data-ttu-id="2cee1-181">これは、送信請求 - 応答の組み合わせの応答メッセージです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-181">This is the response message in a solicit-response pair.</span></span>|  
|<span data-ttu-id="2cee1-182">**DeleteMessage**</span><span class="sxs-lookup"><span data-stu-id="2cee1-182">**DeleteMessage**</span></span>|<span data-ttu-id="2cee1-183">DELETE</span><span class="sxs-lookup"><span data-stu-id="2cee1-183">Delete</span></span>|<span data-ttu-id="2cee1-184">アダプターが非ブロッキング送信を使用して回線上で正常に送信したメッセージを削除します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-184">Deletes a message that an adapter has successfully transmitted over the wire using a non-blocking send.</span></span> <span data-ttu-id="2cee1-185">ブロッキング送信を使用するアダプターがメッセージング エンジンが削除されますが、アダプターの代わりに、アダプターが返された場合は、このメソッドを呼び出す必要はありません`true`から**TransmitMesssage**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-185">Adapters that use blocking sends do not need to call this method because the Messaging Engine will delete it on the adapter's behalf if the adapter returns `true` from **TransmitMesssage**.</span></span>|  
|<span data-ttu-id="2cee1-186">**MoveToSuspendQ**</span><span class="sxs-lookup"><span data-stu-id="2cee1-186">**MoveToSuspendQ**</span></span>|<span data-ttu-id="2cee1-187">MoveToSuspendQ</span><span class="sxs-lookup"><span data-stu-id="2cee1-187">MoveToSuspendQ</span></span>|<span data-ttu-id="2cee1-188">メッセージを保留キューに移動します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-188">Moves a message into the Suspended queue.</span></span>|  
|<span data-ttu-id="2cee1-189">**再送信します。**</span><span class="sxs-lookup"><span data-stu-id="2cee1-189">**Resubmit**</span></span>|<span data-ttu-id="2cee1-190">Resubmit</span><span class="sxs-lookup"><span data-stu-id="2cee1-190">Resubmit</span></span>|<span data-ttu-id="2cee1-191">後でメッセージの送信を再試行するように要求します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-191">Requests that a message should be retried for transmission at a later time.</span></span> <span data-ttu-id="2cee1-192">一般に、送信の試行が失敗した後にこのメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-192">This is typically called after a transmission attempt has failed.</span></span>|  
|<span data-ttu-id="2cee1-193">**MoveToNextTransport**</span><span class="sxs-lookup"><span data-stu-id="2cee1-193">**MoveToNextTransport**</span></span>|<span data-ttu-id="2cee1-194">MoveToNextTransport</span><span class="sxs-lookup"><span data-stu-id="2cee1-194">MoveToNextTransport</span></span>|<span data-ttu-id="2cee1-195">メッセージをバックアップ トランスポートを使用して送信することを要求します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-195">Requests that a message be transmitted using its backup transport.</span></span> <span data-ttu-id="2cee1-196">通常、すべての試行回数が完了した後にこのメソッドを呼び出します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-196">Typically called after all retries have been exhausted.</span></span> <span data-ttu-id="2cee1-197">バックアップ トランスポートが存在しない場合、このメソッドは失敗します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-197">If no backup transport is present this method will fail</span></span>|  
|<span data-ttu-id="2cee1-198">**SubmitRequestMessage**</span><span class="sxs-lookup"><span data-stu-id="2cee1-198">**SubmitRequestMessage**</span></span>|<span data-ttu-id="2cee1-199">SubmitRequest</span><span class="sxs-lookup"><span data-stu-id="2cee1-199">SubmitRequest</span></span>|<span data-ttu-id="2cee1-200">要求メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-200">Submits a request message.</span></span> <span data-ttu-id="2cee1-201">これは、要求 - 応答の組み合わせの要求メッセージです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-201">This is a request message in a request-response pair.</span></span>|  
|<span data-ttu-id="2cee1-202">**CancelRequestForResponse**</span><span class="sxs-lookup"><span data-stu-id="2cee1-202">**CancelRequestForResponse**</span></span>|<span data-ttu-id="2cee1-203">CancelRequestForResponse</span><span class="sxs-lookup"><span data-stu-id="2cee1-203">CancelRequestForResponse</span></span>|<span data-ttu-id="2cee1-204">エンジンに、アダプターが要求 - 応答の組み合わせの応答メッセージを待機しなくなったことを通知します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-204">Notifies the engine that the adapter no longer wishes to wait for the response message in a request-response pair.</span></span>|  
|<span data-ttu-id="2cee1-205">**Clear**</span><span class="sxs-lookup"><span data-stu-id="2cee1-205">**Clear**</span></span>|<span data-ttu-id="2cee1-206">NA</span><span class="sxs-lookup"><span data-stu-id="2cee1-206">NA</span></span>|<span data-ttu-id="2cee1-207">バッチからすべての作業を削除します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-207">Clears all work from the batch.</span></span>|  
|<span data-ttu-id="2cee1-208">**完成です**</span><span class="sxs-lookup"><span data-stu-id="2cee1-208">**Done**</span></span>|<span data-ttu-id="2cee1-209">NA</span><span class="sxs-lookup"><span data-stu-id="2cee1-209">NA</span></span>|<span data-ttu-id="2cee1-210">メッセージのバッチをエンジンに送信して処理します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-210">Submits a batch of messages to the engine for processing.</span></span>|  
  
## <a name="batch-management"></a><span data-ttu-id="2cee1-211">バッチ管理</span><span class="sxs-lookup"><span data-stu-id="2cee1-211">Batch Management</span></span>  
 <span data-ttu-id="2cee1-212">バッチは、メッセージ エンジンでネイティブ コードで実装されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-212">Batches are implemented in native code in the Messaging Engine.</span></span> <span data-ttu-id="2cee1-213">そのため、マネージド コードで記述されたアダプターは、バッチのランタイム呼び出し可能ラッパー (RCW) を、バッチの処理の終了後に解放する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-213">For this reason an adapter written in managed code should release the runtime callable wrapper (RCW) for the batch after it has finished with the batch.</span></span> <span data-ttu-id="2cee1-214">これは、マネージ コードの中でを使用して、 **Marshal.ReleaseComObject** API。</span><span class="sxs-lookup"><span data-stu-id="2cee1-214">This is done in managed code by using the **Marshal.ReleaseComObject** API.</span></span> <span data-ttu-id="2cee1-215">しばらくの間でこの API を呼び出す必要がありますに注意してください。 返される参照カウントが 0 になるまでループします。</span><span class="sxs-lookup"><span data-stu-id="2cee1-215">It is important to remember that this API should be called in a while loop until the returned reference count reaches zero.</span></span>  
  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]<span data-ttu-id="2cee1-216"> は、バッチ内でメッセージを同期して処理します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-216"> processes messages synchronously within a batch.</span></span> <span data-ttu-id="2cee1-217">多数のバッチが同時に処理されることがあるので、アプリケーション ドメイン内でバッチ サイズを調整することによって、アダプターで何らかの最適化を行うことになる場合があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-217">Many batches may be processed concurrently, which may provide an opportunity for some optimization in the adapter by adjusting the batch size in the application domain.</span></span> <span data-ttu-id="2cee1-218">たとえば、FTP サイトですべてのファイルを処理する場合が考えられます (何らかの制限に該当するまで)。</span><span class="sxs-lookup"><span data-stu-id="2cee1-218">For example, you might process all the files on an FTP site (until some limit is hit).</span></span> <span data-ttu-id="2cee1-219">SAP の場合は、1 つのストリームを多数のメッセージにし、後でそれらを 1 つのバッチとして送信することがあります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-219">In the case of SAP you might process a single stream into a number of messages that are then submitted as a batch.</span></span>  
  
 <span data-ttu-id="2cee1-220">[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に操作を渡すためにアダプターによって使用されるバッチは、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] がアダプターに提供するメッセージの一覧と正確に対応している必要はありません。</span><span class="sxs-lookup"><span data-stu-id="2cee1-220">The batch used by an adapter to pass operations back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] does not need to exactly correspond to the list of messages that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] gives to the adapter.</span></span> <span data-ttu-id="2cee1-221">つまり、トランザクションの実行が送信する場合、再送信操作を分割する必要があります**MoveToNextTransport**と**MoveToSuspendQ**に別のバッチ。</span><span class="sxs-lookup"><span data-stu-id="2cee1-221">In other words, when doing transactional sends you must split the resubmit operations **MoveToNextTransport** and **MoveToSuspendQ** into separate batches.</span></span> <span data-ttu-id="2cee1-222">多くのアダプターでは、その後の処理のために、複数のエンドポイントへ送信されたメッセージのバッチを別々のメッセージ一覧に振り分けます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-222">Many adapters sort a batch of messages that have been submitted for multiple endpoints into separate lists of messages for further processing.</span></span>  
  
 <span data-ttu-id="2cee1-223">注意が必要なのは、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] には、トランザクションに関連付けられた規則以外に、バッチ処理されているメッセージに関連付けられる規則がないことです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-223">The point is that there are no rules (besides those associated with the transaction) associated with message batching in [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="2cee1-224">バッチ処理は、アダプターが [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に対する送受信メッセージをまとめるための実装固有の方法にすぎません。</span><span class="sxs-lookup"><span data-stu-id="2cee1-224">Batching is simply an implementation-specific way for the adapter to chunk messages into and out of [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span>  
  
 <span data-ttu-id="2cee1-225">アダプターは、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] から渡された複数の小さなバッチのメッセージを、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] への応答として 1 つの大きなバッチにまとめることができます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-225">An adapter can batch messages from multiple smaller batches that [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] has given it into a larger batch for the response to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="2cee1-226">この処理では、非常に小さな多数のメッセージを処理するトランザクション アダプターで大幅な最適化が行われる場合があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-226">This might be a significant optimization in transactional adapters that are dealing with large numbers of very small messages.</span></span> <span data-ttu-id="2cee1-227">この最適化により、"メッセージごとの総トランザクション数" の比率が最小になります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-227">It minimizes the "total number of transactions per message" ratio.</span></span>  
  
 <span data-ttu-id="2cee1-228">通常、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] では、5 ～ 10 メッセージの送信側バッチが生成されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-228">Typically [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] produces send-side batches of between 5 and 10 messages.</span></span> <span data-ttu-id="2cee1-229">それらのメッセージが小さい場合、アダプターは削除のトランザクション バッチを [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に送信する前に、100 メッセージ以上を 1 つのバッチにする場合があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-229">If these are very small messages, an adapter might batch up to 100 messages or more before it submits a transactional batch of deletes back to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)].</span></span> <span data-ttu-id="2cee1-230">このような最適化を実装するのは困難です。メッセージがアダプター メモリにとどまらないようにする一方で、基準値を満たすまで無期限に待機する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="2cee1-230">An optimization like this is not easy to implement; you must make sure that messages never get stuck in the adapter memory, waiting endlessly for some threshold to be met.</span></span>  
  
 <span data-ttu-id="2cee1-231">バッチ処理の重要度は [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] の MQSeries などの高スループットのアダプターのパフォーマンス数値に表れます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-231">The significance of batching can be seen in the performance numbers for [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] for the high-throughput adapters like MQSeries.</span></span> <span data-ttu-id="2cee1-232">これらのアダプターでは、1 回のメッセージの送信で少なくとも 2 回、そのメッセージが受信されます。</span><span class="sxs-lookup"><span data-stu-id="2cee1-232">In these adapters, messages are received at least twice as often as they are sent.</span></span> <span data-ttu-id="2cee1-233">既定では、受信アダプターでは 100 メッセージのバッチを使用し、送信アダプターでは、提供された既定の [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] バッチを使用します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-233">By default the receive adapter uses batches of 100 messages and the send adapter uses the default [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] batch it is given.</span></span>  
  
## <a name="transactional-batches"></a><span data-ttu-id="2cee1-234">トランザクション バッチ</span><span class="sxs-lookup"><span data-stu-id="2cee1-234">Transactional Batches</span></span>  
 <span data-ttu-id="2cee1-235">トランザクション オブジェクトを作成して [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に渡すアダプターを記述する場合、次の操作を実行するコードを記述する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-235">When you write an adapter that creates a transaction object and hands it to [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)], you are accepting responsibility for writing code that does the following:</span></span>  
  
- <span data-ttu-id="2cee1-236">バッチ操作の最終結果として、トランザクションのコミットまたは終了のいずれかを決定します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-236">Decides the final outcome of the batch operation: to either commit or end the transaction.</span></span> <span data-ttu-id="2cee1-237">これは、メッセージ キュー (MSMQ) のキューへの書き込みやトランザクション データベース操作など、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] に依存しない特定のトランザクションに含まれている他のトランザクション分岐に依存する場合があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-237">This may depend upon other transactional branches within the scope of this one transaction that are not [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] dependent, such as writing to an Message Queuing (MSMQ) queue or a transactional database operation.</span></span>  
  
- <span data-ttu-id="2cee1-238">通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]を呼び出して最終結果の**IBTDTCCommitConfirm.DTCCommitConfirm**メソッド。</span><span class="sxs-lookup"><span data-stu-id="2cee1-238">Informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the final outcome by calling the **IBTDTCCommitConfirm.DTCCommitConfirm** method.</span></span> <span data-ttu-id="2cee1-239">`true` が返された場合は、トランザクションのコミットが成功したことを示し、`false` が返された場合は、トランザクションが失敗してロールバックしたことを示します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-239">Returning `true` indicates a successful commit of the transaction; returning `false` signifies failure and rollback of the transaction.</span></span>  
  
  <span data-ttu-id="2cee1-240">アダプターは、[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] にトランザクションの最終結果を知らせて内部の追跡データを維持する必要があります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-240">The adapter must inform [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] about the final outcome of the transaction to maintain its internal tracking data.</span></span> <span data-ttu-id="2cee1-241">通知[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]呼び出すことによって、結果の**DTCCommitConfirm**します。</span><span class="sxs-lookup"><span data-stu-id="2cee1-241">The adapter informs [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] of the outcome by calling **DTCCommitConfirm**.</span></span> <span data-ttu-id="2cee1-242">アダプターがこの呼び出しを行わない場合、重大なメモリ リークが発生して、操作が正常に完了した場合にも MSDTC トランザクションがタイムアウトして失敗することがあります。</span><span class="sxs-lookup"><span data-stu-id="2cee1-242">If the adapter does not do this, a significant memory leak occurs and the MSDTC transaction could time out and fail despite its operations completing successfully.</span></span>