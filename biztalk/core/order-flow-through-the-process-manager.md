---
title: 注文プロセス マネージャでフロー |Microsoft ドキュメント
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- process management solution tutorial, processing
- processing, processing logic
ms.assetid: e2b51eff-44b5-440f-a7d1-0872543e5f27
caps.latest.revision: 30
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 8556bce43ba4a951d0045d22f76d4bd222fcd8f2
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
ms.locfileid: "22266658"
---
# <a name="order-flow-through-the-process-manager"></a><span data-ttu-id="ea902-102">プロセス マネージャでの注文の流れ</span><span class="sxs-lookup"><span data-stu-id="ea902-102">Order Flow through the Process Manager</span></span>
<span data-ttu-id="ea902-103">このセクションでは、どのように、Southridge Video の注文プロセス マネージャ、について説明します、 **OrderManager**オーケストレーションで、注文が処理されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-103">This section describes how the Southridge Video order process manager, the **OrderManager** orchestration, processes orders.</span></span> <span data-ttu-id="ea902-104">順を追って、新しい注文のオーケストレーションでの処理過程を見ていきます。</span><span class="sxs-lookup"><span data-stu-id="ea902-104">This section follows a new order through the orchestration.</span></span> <span data-ttu-id="ea902-105">また、オーケストレーションによって注文の更新がどのように処理されるかについても説明します。</span><span class="sxs-lookup"><span data-stu-id="ea902-105">The section also discusses how the orchestration handles updates to orders.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="ea902-106">ビジネス プロセス マネージャ ソリューションは、複数の種類のマネージャを使用できるように記述されていますが、実際に使用されているのは 1 つのプロセス マネージャのみです。</span><span class="sxs-lookup"><span data-stu-id="ea902-106">The business process manager solution includes only one process manager although it is written so that it can use more than one type of manager.</span></span>  
  
 <span data-ttu-id="ea902-107">**OrderManager**オーケストレーションが注文を処理するビジネス プロセスを実装している下位オーケストレーションを調整します。</span><span class="sxs-lookup"><span data-stu-id="ea902-107">The **OrderManager** orchestration coordinates subordinate orchestrations that implement the business process to handle the order.</span></span> <span data-ttu-id="ea902-108">**OrderManager**注文を 2 つのステージを送信、注文の検証、機能グループに情報を送信、リモート処理コンポーネントを介した注文システムに注文を送信および注文履歴を更新組み合わせることで、します。</span><span class="sxs-lookup"><span data-stu-id="ea902-108">The **OrderManager** sends the order through two stages which, combined, validate the order, send the information to the facilities group, send the order to the order system through remoting components, and update the order history.</span></span> <span data-ttu-id="ea902-109">追加、削除、または変更することがなくこれらのステージを変更することができます、 **OrderManager**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-109">You can add, delete, or modify these stages without having to change the **OrderManager**.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="ea902-110">規模のスコープであるため、 **OrderManager**オーケストレーション、オーケストレーションを Microsoft Visual Studio で開いてこのセクションを参照する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="ea902-110">Because of the size and scope of the **OrderManager** orchestration, you may want to read this section with the orchestration open in Microsoft Visual Studio.</span></span>  
  
## <a name="order-manager-structure"></a><span data-ttu-id="ea902-111">注文マネージャの構造</span><span class="sxs-lookup"><span data-stu-id="ea902-111">Order Manager Structure</span></span>  
 <span data-ttu-id="ea902-112">**OrderManager**オーケストレーションをアクティブにする受信図形でオーケストレーションを開始します。</span><span class="sxs-lookup"><span data-stu-id="ea902-112">The **OrderManager** orchestration begins with a receive shape that activates the orchestration.</span></span> <span data-ttu-id="ea902-113">次の図の一般的な構造を示しています、 **OrderManager**オーケストレーションです。</span><span class="sxs-lookup"><span data-stu-id="ea902-113">The following diagram shows the general structure of the **OrderManager** orchestration.</span></span>  
  
 <span data-ttu-id="ea902-114">![注文マネージャーの図をブロック](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span><span class="sxs-lookup"><span data-stu-id="ea902-114">![Block Diagram of Order Manager](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span></span>  
  
 <span data-ttu-id="ea902-115">最初の受信図形から 2 つの主要分岐が出ています。</span><span class="sxs-lookup"><span data-stu-id="ea902-115">The first receive shape leads to two main branches.</span></span> <span data-ttu-id="ea902-116">右側の分岐は新しい注文を処理します。</span><span class="sxs-lookup"><span data-stu-id="ea902-116">One branch, the right one, processes new orders.</span></span> <span data-ttu-id="ea902-117">左側の分岐は注文のキャンセルを処理します。</span><span class="sxs-lookup"><span data-stu-id="ea902-117">The left branch, handles order cancellations.</span></span> <span data-ttu-id="ea902-118">ユーザー入力を受け付けることはための**OrderManager**注文が既に完了した後に、取り消しを受信します。</span><span class="sxs-lookup"><span data-stu-id="ea902-118">Because it accepts user input, it is possible for the **OrderManager** to receive an order cancellation after an order has already completed.</span></span> <span data-ttu-id="ea902-119">そのようなケースを扱うのが左側の主分岐です。</span><span class="sxs-lookup"><span data-stu-id="ea902-119">This is the case the left main branch handles.</span></span> <span data-ttu-id="ea902-120">左側の分岐では、処理中止のフラグを設定し、イベント ログに警告を追加して、これらのキャンセルを処理します。</span><span class="sxs-lookup"><span data-stu-id="ea902-120">The branch handles the isolated cancellation by setting flags for terminating processing and by adding a warning to the event log.</span></span> <span data-ttu-id="ea902-121">右側の分岐で注文が処理されている間に到着した注文のキャンセルも、このオーケストレーションで処理されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-121">The orchestration handles order cancellations that arrive while an order is being processed inside the right-hand branch.</span></span>  
  
 <span data-ttu-id="ea902-122">注文処理の分岐は初期化の後に、入れ子構造になった 2 つのループに入ります。</span><span class="sxs-lookup"><span data-stu-id="ea902-122">The order processing branch does some initialization and then enters two nested loops.</span></span> <span data-ttu-id="ea902-123">外側のループは、注文処理の各ステージで 1 回実行されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-123">The outer loop runs once for each stage in the order processing.</span></span> <span data-ttu-id="ea902-124">内側のループはステージが処理される間、実行されています。</span><span class="sxs-lookup"><span data-stu-id="ea902-124">The inner loop runs while the stage is processing.</span></span> <span data-ttu-id="ea902-125">内側のループの中で、注文マネージャは注文の更新に対しても待機します。</span><span class="sxs-lookup"><span data-stu-id="ea902-125">The order manager also listens for possible updates to the order inside the inner loop.</span></span> <span data-ttu-id="ea902-126">ループが終了すると、注文マネージャは完了メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="ea902-126">After the loops terminate, the order manager sends a completion message.</span></span>  
  
 <span data-ttu-id="ea902-127">注文処理ステージへの通信、自己関連付けを行う動的なポートを使用して、 **OrderManager**オーケストレーションです。</span><span class="sxs-lookup"><span data-stu-id="ea902-127">The order processing stages use dynamic, self-correlating ports to communicate back to the **OrderManager** orchestration.</span></span> <span data-ttu-id="ea902-128">これが簡略化の相関関係、 **OrderManager**とステージ インスタンスの関連付けセットを使用する必要がなくなるためです。</span><span class="sxs-lookup"><span data-stu-id="ea902-128">This simplifies correlation of the **OrderManager** with the stage instances because it eliminates the need to use a correlation set.</span></span> <span data-ttu-id="ea902-129">自己関連付けを行うポートの詳細については、次を参照してください。[ポートのバインド](../core/port-bindings.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-129">For more information about self-correlating ports, see [Port Bindings](../core/port-bindings.md).</span></span>  
  
## <a name="receiving-orders"></a><span data-ttu-id="ea902-130">注文の受信</span><span class="sxs-lookup"><span data-stu-id="ea902-130">Receiving Orders</span></span>  
 <span data-ttu-id="ea902-131">**OrderManager**からの注文メッセージを受信、 **OrderBroker**を介してオーケストレーション、 **FromBrokerPort**ポートです。</span><span class="sxs-lookup"><span data-stu-id="ea902-131">The **OrderManager** receives order messages from the **OrderBroker** orchestration through the **FromBrokerPort** port.</span></span> <span data-ttu-id="ea902-132">このポートは直接メッセージ ボックス データベースにバインドされています。</span><span class="sxs-lookup"><span data-stu-id="ea902-132">This port is bound directly to the MessageBox database.</span></span> <span data-ttu-id="ea902-133">2 つのオーケストレーションが**受信**図形をポートに接続されている: 新しい注文のいずれかとの 1 つの注文を更新します。</span><span class="sxs-lookup"><span data-stu-id="ea902-133">The orchestration has two **Receive** shapes connected to the port: one for new orders and one for updated orders.</span></span>  
  
 <span data-ttu-id="ea902-134">**OrderManger**フィルター式に基づくプロセスへのメッセージを決定します。</span><span class="sxs-lookup"><span data-stu-id="ea902-134">The **OrderManger** determines which messages to process based on a filter expression.</span></span> <span data-ttu-id="ea902-135">フィルター式は、メッセージの状態フィールドと注文マネージャの種類フィールドの値をテスト**OrderMgrType**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-135">The filter expression tests the value in the message status field and the order manager type field, **OrderMgrType**.</span></span> <span data-ttu-id="ea902-136">場合は、ステータス フィールドが ACCEPTED、および**OrderMgrType**が CABLEORDER、順序は、新しいと、このプロセス マネージャを目的としました。</span><span class="sxs-lookup"><span data-stu-id="ea902-136">If the status field is equal to ACCEPTED, and the **OrderMgrType** is CABLEORDER, the order is new and intended for this process manager.</span></span>  
  
 <span data-ttu-id="ea902-137">新しい注文が到着すると、このオーケストレーションの新しいインスタンスがアクティブになります。</span><span class="sxs-lookup"><span data-stu-id="ea902-137">The new order activates a new instance of the orchestration.</span></span> <span data-ttu-id="ea902-138">**OrderManager**の要求の種類を次にチェック、**デシジョン**図形です。</span><span class="sxs-lookup"><span data-stu-id="ea902-138">The **OrderManager** next checks the type of the request in a **Decision** shape.</span></span> <span data-ttu-id="ea902-139">種類が TERMINATE の場合は、オーケストレーションは左側の分岐を実行して注文を終了します。</span><span class="sxs-lookup"><span data-stu-id="ea902-139">If the type is Terminate, the orchestration executes the left-hand branch and terminates the order.</span></span> <span data-ttu-id="ea902-140">それ以外の場合は、オーケストレーションは注文の処理を進めます。</span><span class="sxs-lookup"><span data-stu-id="ea902-140">Otherwise, the orchestration proceeds with processing the order.</span></span> <span data-ttu-id="ea902-141">これには、この注文に関連する後続メッセージの待機も含まれることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ea902-141">Notice that this includes listening for subsequent messages related to this particular order.</span></span>  
  
## <a name="initialization-for-new-orders"></a><span data-ttu-id="ea902-142">新しい注文の初期化</span><span class="sxs-lookup"><span data-stu-id="ea902-142">Initialization for New Orders</span></span>  
 <span data-ttu-id="ea902-143">後に、 **OrderManager**から構成情報を取得、オーケストレーションは、最初のメッセージを受信し、右側の主分岐が開始、 **SSOConfigStore**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-143">After the **OrderManager** orchestration receives an initial message and begins the main right-hand branch, it gets its configuration information from the **SSOConfigStore**.</span></span> <span data-ttu-id="ea902-144">これはで定義されているシングルトン オブジェクトを介して、**ユーティリティ**アセンブリ。</span><span class="sxs-lookup"><span data-stu-id="ea902-144">It does this through a singleton object defined in the **Utilities** assembly.</span></span> <span data-ttu-id="ea902-145">構成値はこのオブジェクトのプロパティです。</span><span class="sxs-lookup"><span data-stu-id="ea902-145">The configuration values are properties of the object.</span></span> <span data-ttu-id="ea902-146">このオブジェクトは、構成値のローカル キャッシュをサービス指向のアーキテクチャ ソリューションと同様の方法で管理します。</span><span class="sxs-lookup"><span data-stu-id="ea902-146">The object manages a local cache of the configuration values similar to the Service Oriented Architecture solution.</span></span> <span data-ttu-id="ea902-147">シングルトン オブジェクトの詳細については、次を参照してください。[を使用して SSO の効率的なビジネス プロセス管理ソリューションで](../core/using-sso-efficiently-in-the-business-process-management-solution.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-147">For more information about the singleton object, see [Using SSO Efficiently in the Business Process Management Solution](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span></span>  
  
 <span data-ttu-id="ea902-148">サービス指向ソリューションと同様、ビジネス プロセス管理ソリューションでも、シークレット ストアが使用されます。シークレット ストアは、BizTalk がインストールされていれば常に存在するものであり、SSO は値をすぐに使用できるように構成情報をキャッシュできます。さらに、データベース接続文字列やパスワードなどの情報の保護も可能になります。</span><span class="sxs-lookup"><span data-stu-id="ea902-148">Like the Service Oriented solution, the Business Process Management solution uses the secret store because it is present whenever BizTalk is installed, SSO caches the configuration information so that the values are readily available, and it can protect information such as database connection strings and passwords.</span></span> <span data-ttu-id="ea902-149">これらの理由により、シングル サインオン (SSO) がバックエンド アプリケーションの接続管理に使用されていなくても、シークレット ストアは構成情報を保存する場所として適しています。</span><span class="sxs-lookup"><span data-stu-id="ea902-149">For all of these reasons, the secret store would be a good place for the configuration information even if Single Sign-On weren't being used for managing connections to the backend applications.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="ea902-150">オーケストレーションは処理を開始する前に構成情報を取得します。</span><span class="sxs-lookup"><span data-stu-id="ea902-150">The orchestration retrieves configuration information before starting processing.</span></span> <span data-ttu-id="ea902-151">これによって、オーケストレーションが退避されて後で復元するときも同じ構成の使用が可能になります。</span><span class="sxs-lookup"><span data-stu-id="ea902-151">This ensures the orchestration uses the same configuration if it is dehydrated and, later, rehydrated.</span></span> <span data-ttu-id="ea902-152">退避の詳細については、次を参照してください。[オーケストレーションの退避と復元](../core/orchestration-dehydration-and-rehydration.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-152">For more information about dehydration, see [Orchestration Dehydration and Rehydration](../core/orchestration-dehydration-and-rehydration.md).</span></span>  
  
 <span data-ttu-id="ea902-153">注文マネージャは、構成データから 1 つの値を使用: **TotalStages**、注文プロセスを処理中のステージの合計数。</span><span class="sxs-lookup"><span data-stu-id="ea902-153">The order manager uses one value from the configuration data: **TotalStages**, the total number of stages in the order handling process.</span></span> <span data-ttu-id="ea902-154">マネージャーが、ローカル変数にこの値を割り当てます**numStages**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-154">The manager assigns this value to a local variable, **numStages**.</span></span> <span data-ttu-id="ea902-155">また、外側のループに接続されている 2 つの変数を設定**ステージ**と**停止**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-155">It also sets two more variables connected to the outer loop, **stage** and **stop**.</span></span> <span data-ttu-id="ea902-156">**ステージ**現在のステージを示し、外側のループのカウンターは、**停止**停止の値。</span><span class="sxs-lookup"><span data-stu-id="ea902-156">The **stage** indicates the current stage and is the counter for the outer loop; **stop** the stopping value.</span></span>  
  
 <span data-ttu-id="ea902-157">マネージャーが最後に、設定、 **orderStatus**変数を STARTED に外側の処理ループに入ります。</span><span class="sxs-lookup"><span data-stu-id="ea902-157">Finally, the manager sets the **orderStatus** variable to STARTED and enters the outer processing loop.</span></span>  
  
## <a name="new-order-processing-loops"></a><span data-ttu-id="ea902-158">新しい注文の処理ループ</span><span class="sxs-lookup"><span data-stu-id="ea902-158">New Order Processing Loops</span></span>  
 <span data-ttu-id="ea902-159">外側のループを実行している間の値、**ステージ**変数がの値より小さい、 **numStages**変数。</span><span class="sxs-lookup"><span data-stu-id="ea902-159">The outer loop runs as long as the value of the **stage** variable is less than the value of the **numStages** variable.</span></span> <span data-ttu-id="ea902-160">つまり各ステージの処理は、外側のループによって進行されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-160">The outer loops drives the processing for each stage.</span></span> <span data-ttu-id="ea902-161">内側のループはステージが処理されている限り実行され、</span><span class="sxs-lookup"><span data-stu-id="ea902-161">The inner loop runs so long as a stage is still being processed.</span></span> <span data-ttu-id="ea902-162">注文の変更があった場合にも備えて待機します。</span><span class="sxs-lookup"><span data-stu-id="ea902-162">It also listens for possible changes to the order.</span></span>  
  
### <a name="outer-loop"></a><span data-ttu-id="ea902-163">外側のループ</span><span class="sxs-lookup"><span data-stu-id="ea902-163">Outer Loop</span></span>  
 <span data-ttu-id="ea902-164">オーケストレーションが受信したメッセージを割り当てることによって、外側のループを開始 (**NewOrderMgrMsg**) の変数に**OrderMgrMsg**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-164">The orchestration begins the outer loop by assigning the received message (**NewOrderMgrMsg**) to a variable, **OrderMgrMsg**.</span></span> <span data-ttu-id="ea902-165">次にメッセージのルーティングの部分にステージと状態がコピーされます。</span><span class="sxs-lookup"><span data-stu-id="ea902-165">It then copies the stage and status to the routing part of the message.</span></span> <span data-ttu-id="ea902-166">オーケストレーションは、メッセージのアドレスをリターン アドレスを設定するも、 **StageCompletionPort**:</span><span class="sxs-lookup"><span data-stu-id="ea902-166">The orchestration also sets the return address in the message to the address of the **StageCompletionPort**:</span></span>  
  
```  
OrderMgrMsg.RoutingPart.OrderMgrReturnAddress =   
       StageCompletionPort(Microsoft.XLANGs.BaseTypes.Address);  
```  
  
 <span data-ttu-id="ea902-167">オーケストレーションに送信するように順序、 **StagePort**、送信請求-応答ポートです。</span><span class="sxs-lookup"><span data-stu-id="ea902-167">The orchestration then sends the order to the **StagePort**, a solicit-response port.</span></span> <span data-ttu-id="ea902-168">注文の処理が開始されたこと示す、ステージからの確認メッセージを待ちます。</span><span class="sxs-lookup"><span data-stu-id="ea902-168">The orchestration then waits for an acknowledgement from the stage that order processing has started.</span></span> <span data-ttu-id="ea902-169">ステージの送信、 **OrderAck**注文の処理を開始するときのメッセージします。</span><span class="sxs-lookup"><span data-stu-id="ea902-169">The stage sends an **OrderAck** message when it starts processing the order.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="ea902-170">**OrderAck**メッセージは、スキーマではなく .NET クラスによって定義されているソリューション内のいくつかのいずれか。</span><span class="sxs-lookup"><span data-stu-id="ea902-170">The **OrderAck** message is one of several in the solution defined by .NET classes rather than a schema.</span></span> <span data-ttu-id="ea902-171">.NET クラスを使用してメッセージを定義する方法の詳細については、次を参照してください。[ユーザー コードでメッセージを構築する](../core/constructing-messages-in-user-code.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-171">For more information about using .NET classes to define messages, see [Constructing Messages in User Code](../core/constructing-messages-in-user-code.md).</span></span>  
  
 <span data-ttu-id="ea902-172">オーケストレーションは受信確認を受け取る、ステージが割り当てられます、 **currentStage**変数内側のループに入ります。</span><span class="sxs-lookup"><span data-stu-id="ea902-172">When the orchestration receives the acknowledgement, it assigns the stage to the **currentStage** variable and enters the inner loop.</span></span>  
  
### <a name="inner-loop"></a><span data-ttu-id="ea902-173">内側のループ</span><span class="sxs-lookup"><span data-stu-id="ea902-173">Inner Loop</span></span>  
 <span data-ttu-id="ea902-174">限り、内側のループの実行、 **currentStage**変数と等しい、**ステージ**; 変数が、現在のステージが処理されている限り、します。</span><span class="sxs-lookup"><span data-stu-id="ea902-174">The inner loop runs as long as the **currentStage** variable is equal to the **stage** variable; that is, as long as the current stage is being processed.</span></span> <span data-ttu-id="ea902-175">ループの本体は、**リッスン**図形と 3 つ**受信**図形です。</span><span class="sxs-lookup"><span data-stu-id="ea902-175">The body of the loop is a **Listen** shape with three **Receive** shapes.</span></span> <span data-ttu-id="ea902-176">オーケストレーションで、左端のシェイプ**発注要求**、次のセクションで説明されている注文更新メカニズムの一部です。</span><span class="sxs-lookup"><span data-stu-id="ea902-176">The leftmost shape in the orchestration, **Order Request**, is part of the order update mechanism, described in the next section.</span></span>  
  
 <span data-ttu-id="ea902-177">ときに注文処理ステージが完了すると、そのメッセージを送信する、 **StageCompletion**のポート、 **OrderManager**オーケストレーションです。</span><span class="sxs-lookup"><span data-stu-id="ea902-177">When an order processing stage finishes, it sends a message to the **StageCompletion** port of the **OrderManager** orchestration.</span></span> <span data-ttu-id="ea902-178">ステージ突然終了した場合、エラーのため、送信、 **TerminatedMessage**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-178">If the stage abruptly terminates due to an error, it sends a **TerminatedMessage**.</span></span> <span data-ttu-id="ea902-179">ここで、 **OrderManager**例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="ea902-179">In this case, the **OrderManager** throws an exception.</span></span> <span data-ttu-id="ea902-180">最も外側の例外ハンドラーが例外をキャッチし、エラー メッセージを送信、 **OperatorPort**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-180">The outermost exception handler catches the exception and sends an error message to the **OperatorPort**.</span></span>  
  
 <span data-ttu-id="ea902-181">ステージを送信する場合、 **OrderMgrMsg**、 **OrderManager**インクリメント、**ステージ**変数。</span><span class="sxs-lookup"><span data-stu-id="ea902-181">If the stage sends an **OrderMgrMsg**, the **OrderManager** increments the **stage** variable.</span></span> <span data-ttu-id="ea902-182">オーケストレーションが注文ステータスを設定 (stage の値以上に numStages) の段階がある場合は、 **OrderMgrMsg** STAGE_n_COMPLETED n は、現在のステージの数にします。</span><span class="sxs-lookup"><span data-stu-id="ea902-182">If there are more stages (stage less than or equal to numStages), the orchestrations sets the order status in **OrderMgrMsg** to STAGE_n_COMPLETED where n is the number of the current stage.</span></span> <span data-ttu-id="ea902-183">処理するステージがなくなると、注文の状態を COMPLETED に設定して両方のループから出ます。</span><span class="sxs-lookup"><span data-stu-id="ea902-183">If there are no more stages, it sets the order status to COMPLETED and exits both loops.</span></span>  
  
## <a name="order-updates"></a><span data-ttu-id="ea902-184">注文の更新</span><span class="sxs-lookup"><span data-stu-id="ea902-184">Order Updates</span></span>  
 <span data-ttu-id="ea902-185">**OrderManager**オーケストレーションは、内部処理ループ内の注文の更新を待機します。</span><span class="sxs-lookup"><span data-stu-id="ea902-185">The **OrderManager** orchestration listens for order updates inside the inner processing loop.</span></span> <span data-ttu-id="ea902-186">注意して、**受信**これは、使用を図形**OrderRequest**も使用して、 **FromBrokerPort**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-186">Notice that the **Receive** shape it uses for this, **OrderRequest**, also uses the **FromBrokerPort**.</span></span> <span data-ttu-id="ea902-187">ループ内の同じポートで、関連付けセットと組み合わせて受信図形をもう 1 つ使用することにより、BizTalk Server 共通パターンであるコンボイ パターンが形成されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-187">The use of a second receive shape on the same port inside a loop, combined with correlation sets, forms a common BizTalk Server pattern, the convoy pattern.</span></span> <span data-ttu-id="ea902-188">オーケストレーションの同じインスタンスが、特定の操作に接続された最初およびその後のメッセージを処理することを確認するのにには、コンボイ パターンを使用します。</span><span class="sxs-lookup"><span data-stu-id="ea902-188">You use the convoy pattern to ensure that the same instance of an orchestration processes the first and subsequent messages connected with a particular operation.</span></span>  
  
 <span data-ttu-id="ea902-189">注文マネージャが注文に接続されている最初のメッセージを受け取ると、2 つの関連付けセットが初期化されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-189">When the order manager receives the first message connected to an order, it initializes two correlation sets.</span></span> <span data-ttu-id="ea902-190">最初、 **OrderCorrelation**、顧客 ID を使用して (**CustID**) と注文 ID (**OrderID**)。</span><span class="sxs-lookup"><span data-stu-id="ea902-190">The first, **OrderCorrelation**, uses the customer ID (**CustID**) and order ID (**OrderID**).</span></span> <span data-ttu-id="ea902-191">注文マネージャはこの関連付けを注文処理ステージと共有します。</span><span class="sxs-lookup"><span data-stu-id="ea902-191">The order manager shares this correlation with the order processing stages.</span></span> <span data-ttu-id="ea902-192">2 番目の相関関係は、コンボイ関連付け**OrderConvoyCorrelation**、注文ステータスを使用する (**ステータス**) に加えて、顧客 ID と注文 ID</span><span class="sxs-lookup"><span data-stu-id="ea902-192">The second correlation is the convoy correlation, **OrderConvoyCorrelation**, which uses the order status (**Status**) in addition to the customer ID and order ID.</span></span> <span data-ttu-id="ea902-193">**OrderRequestReceive**図形の使用**OrderConvoyCorrelation**フォロー関連付けセットとして。</span><span class="sxs-lookup"><span data-stu-id="ea902-193">The **OrderRequestReceive** shape uses **OrderConvoyCorrelation** as a Following Correlation Set.</span></span> <span data-ttu-id="ea902-194">関連付けセットをこのように設定することによって、注文に変更があれば、その注文を処理している注文マネージャのインスタンスが変更内容を受信できるようになります。</span><span class="sxs-lookup"><span data-stu-id="ea902-194">Setting the correlation set up this way ensures that the instance of the order manager working on a particular order receives any changes.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="ea902-195">関連付けセットは、個々のメッセージがオーケストレーションのどのインスタンスに所属するかを決定するために使用するメッセージ プロパティをグループ化したものであることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="ea902-195">Recall that a correlation set is a grouping of message properties used to determine whether or not a message belongs to a given instance of an orchestration.</span></span> <span data-ttu-id="ea902-196">詳細については、次を参照してください。[オーケストレーションでの相関関係を使用して](../core/using-correlations-in-orchestrations.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-196">For more information, see [Using Correlations in Orchestrations](../core/using-correlations-in-orchestrations.md).</span></span>  
  
 <span data-ttu-id="ea902-197">ときに、 **OrderManager**後続のメッセージを受信、注文、最初のテストの要求の種類。</span><span class="sxs-lookup"><span data-stu-id="ea902-197">When the **OrderManager** receives a subsequent message for an order, it first tests the type of request.</span></span> <span data-ttu-id="ea902-198">要求の種類が TERMINATE の場合は、決定図形が終了分岐を実行します。</span><span class="sxs-lookup"><span data-stu-id="ea902-198">If the request type is TERMINATE, the Decision shape executes the terminate branch.</span></span> <span data-ttu-id="ea902-199">それ以外の場合、オーケストレーションは新しいメッセージが更新に関するものかどうかをテストします。</span><span class="sxs-lookup"><span data-stu-id="ea902-199">Otherwise, the orchestration tests the new message to see if it is an update.</span></span> <span data-ttu-id="ea902-200">更新メッセージが大きいシーケンス番号 (**SeqNum**)、元の要求よりもします。</span><span class="sxs-lookup"><span data-stu-id="ea902-200">An update message has a higher sequence number (**SeqNum**) than the original request.</span></span> <span data-ttu-id="ea902-201">新しいメッセージのシーケンス番号が大きければ、オーケストレーションはそのメッセージで注文処理をやり直します。</span><span class="sxs-lookup"><span data-stu-id="ea902-201">If the new message's sequence number is higher, the orchestration starts the order processing over with the new message.</span></span> <span data-ttu-id="ea902-202">更新メッセージのシーケンス番号が元のメッセージのものより大きくない場合は、シーケンス エラーが生じます。</span><span class="sxs-lookup"><span data-stu-id="ea902-202">If the original and update message have the same or a lower sequence number, there is a sequence error.</span></span> <span data-ttu-id="ea902-203">シーケンス番号が等しい場合は、重複注文なので重複エラーのフラグが付きます。</span><span class="sxs-lookup"><span data-stu-id="ea902-203">If the sequence numbers are equal, it is a duplicate order and flagged as a duplicate error.</span></span>  
  
 <span data-ttu-id="ea902-204">詳細については**SeqNum**を参照してください[キー メッセージおよびフィールド](../core/key-messages-and-fields.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-204">For more information about **SeqNum**, see [Key Messages and Fields](../core/key-messages-and-fields.md).</span></span>  
  
## <a name="final-steps"></a><span data-ttu-id="ea902-205">最終ステップ</span><span class="sxs-lookup"><span data-stu-id="ea902-205">Final Steps</span></span>  
 <span data-ttu-id="ea902-206">注文マネージャが動的ポートに返信アドレスを割り当てます、ループを終了するには、後も**CSRCompletionPort**です。</span><span class="sxs-lookup"><span data-stu-id="ea902-206">After exiting the loops, the order manager assigns the reply address to the dynamic port **CSRCompletionPort**.</span></span> <span data-ttu-id="ea902-207">次に、完了状態メッセージを作成して送信し、エラーがなかったかどうかをテストします。</span><span class="sxs-lookup"><span data-stu-id="ea902-207">The manager then constructs the completion status message, sends it, and then tests if there was an error.</span></span> <span data-ttu-id="ea902-208">エラーがあった場合は、オーケストレーションが終了図形を実行します。それ以外の場合は処理が完了します。</span><span class="sxs-lookup"><span data-stu-id="ea902-208">If there was an error, the orchestration exectues a Terminate shape; otherwise, it simply ends.</span></span>  
  
## <a name="coordinating-with-the-stages"></a><span data-ttu-id="ea902-209">ステージとの調整</span><span class="sxs-lookup"><span data-stu-id="ea902-209">Coordinating with the Stages</span></span>  
 <span data-ttu-id="ea902-210">両方の**OrderBroker**オーケストレーションと 2 つ目の処理ステージ オーケストレーション (**CableOrder2**)、履歴データベースにエントリを作成します。</span><span class="sxs-lookup"><span data-stu-id="ea902-210">Both the **OrderBroker** orchestration and the second processing stage orchestration (**CableOrder2**) make entries in the history database.</span></span> <span data-ttu-id="ea902-211">CableOrder2 オーケストレーションによって記入された履歴情報を更新する、 **OrderBroker**オーケストレーションです。</span><span class="sxs-lookup"><span data-stu-id="ea902-211">The CableOrder2 orchestration updates the history information entered by the **OrderBroker** orchestration.</span></span> <span data-ttu-id="ea902-212">更新するには、データベース内のエントリがあることを確認するために、 **OrderBroker**データベースを使用するポートの配信通知を使用します。</span><span class="sxs-lookup"><span data-stu-id="ea902-212">In order to ensure there is an entry in the database to update, the **OrderBroker** uses delivery notification on the port it uses for the database.</span></span>  
  
 <span data-ttu-id="ea902-213">構成をマッピング、 **OrderBroker** 2 つのポートを含む送信ポート グループに、履歴データベース用のポートを送信: テスト構成の 1 つのポート (**HISTORYINSERT-SP テスト**)、1 つずつ、通常構成 (**HISTORYINSERT-SP**)。</span><span class="sxs-lookup"><span data-stu-id="ea902-213">Configuration maps the **OrderBroker** send port for the history database to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="ea902-214">グループの両方のポートをアクティブにしておいた場合は、両方にメッセージが送信されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-214">If you leave both ports in the group active, the solution sends messages on both ports.</span></span> <span data-ttu-id="ea902-215">したがって、2 つの配信通知が要求されますが、処理されるのは 1 つだけです。</span><span class="sxs-lookup"><span data-stu-id="ea902-215">It thus requests two delivery notifications but processes only one.</span></span>  
  
 <span data-ttu-id="ea902-216">このような状況を避けるためには、テスト ポートを参加解除 (**HISTORYINSERT-SP テスト**)、またはアプリケーションのテスト版を停止します。</span><span class="sxs-lookup"><span data-stu-id="ea902-216">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application.</span></span> <span data-ttu-id="ea902-217">配信通知の詳細については、次を参照してください。[を使用して受信確認](../core/using-acknowledgments.md)です。</span><span class="sxs-lookup"><span data-stu-id="ea902-217">For more information about delivery notification, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
## <a name="errors-and-routing-repaired-messagesdesign-choices"></a><span data-ttu-id="ea902-218">エラーおよびルーティングの修復済みメッセージ: デザインの選択</span><span class="sxs-lookup"><span data-stu-id="ea902-218">Errors and Routing Repaired Messages—Design Choices</span></span>  
 <span data-ttu-id="ea902-219">例外ハンドラ オーケストレーションと注文処理ステージで使用されるオーケストレーションは、エラー処理オーケストレーションを使用して (**ErrorHandlerOrch**) 修復のための不適切な注文をルーティングします。</span><span class="sxs-lookup"><span data-stu-id="ea902-219">The exception handler orchestration and orchestrations used by the order processing stages use an error handling orchestration (**ErrorHandlerOrch**) to route bad orders for repair.</span></span> <span data-ttu-id="ea902-220">このデザインでは、必要とされているフォームで注文を訂正する部署またはグループがあることが前提となっています。</span><span class="sxs-lookup"><span data-stu-id="ea902-220">The design supposes that there is a department or group that will fix the order in the form needed.</span></span> <span data-ttu-id="ea902-221">注文ブローカのオーケストレーションから修復された注文が再送信されていない (**OrderBroker**)。</span><span class="sxs-lookup"><span data-stu-id="ea902-221">The repaired order is not resubmitted through the order broker orchestration (**OrderBroker**).</span></span> <span data-ttu-id="ea902-222">注文は正規化されたフォームで修復されます。</span><span class="sxs-lookup"><span data-stu-id="ea902-222">Rather, the normalized order is repaired in its normalized form.</span></span> <span data-ttu-id="ea902-223">ソリューションの現在のデザインでは、処理オーケストレーションが元の注文の送信元へエラー メッセージを回送します。</span><span class="sxs-lookup"><span data-stu-id="ea902-223">The current design of the solution has the handler orchestration route the error message back to the source of the original order.</span></span> <span data-ttu-id="ea902-224">ただし、修復された注文は、エラー処理オーケストレーションの MSMQ ポートに回送される必要があります</span><span class="sxs-lookup"><span data-stu-id="ea902-224">Repaired orders, however, have to be routed to an MSMQ port on the error handler orchestration.</span></span> <span data-ttu-id="ea902-225">(ソリューションのテスト バージョンはファイル フォルダを使用します)。その後、エラー処理オーケストレーションは修復されたメッセージを呼び出し元のオーケストレーションに返します。</span><span class="sxs-lookup"><span data-stu-id="ea902-225">(The test version of the solution uses a file folder.) The error handler then returns the repaired message to the calling orchestration.</span></span>  
  
 <span data-ttu-id="ea902-226">このようなデザインが使用されている理由は、注文ブローカが注文メッセージの検証と正規化を行う重要な役割を担っているからです。</span><span class="sxs-lookup"><span data-stu-id="ea902-226">This solution uses this design, because the order broker does significant validation and normalization of the order message.</span></span> <span data-ttu-id="ea902-227">修復を必要とする注文メッセージも正規化されたフォームです。</span><span class="sxs-lookup"><span data-stu-id="ea902-227">In turn, the order message requiring repair is also in the normalized form.</span></span> <span data-ttu-id="ea902-228">メッセージの正規化されたフォームを維持することによって、メッセージの送信フォームと正規化フォームの違いに煩わされずに済みます。</span><span class="sxs-lookup"><span data-stu-id="ea902-228">Maintaining the normalized form of the message prevents having to work around the difference between the submitted and normalized forms of the messages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="ea902-229">参照</span><span class="sxs-lookup"><span data-stu-id="ea902-229">See Also</span></span>  
 <span data-ttu-id="ea902-230">[プロセス マネージャのロジック](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="ea902-230">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 [<span data-ttu-id="ea902-231">キー メッセージおよびフィールド</span><span class="sxs-lookup"><span data-stu-id="ea902-231">Key Messages and Fields</span></span>](../core/key-messages-and-fields.md)