---
title: 注文プロセス マネージャでフロー |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- process management solution tutorial, processing
- processing, processing logic
ms.assetid: e2b51eff-44b5-440f-a7d1-0872543e5f27
caps.latest.revision: 30
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: a9c272f8b9aaf179a7d9db395a1ad1e884567c3f
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2019
ms.locfileid: "65262907"
---
# <a name="order-flow-through-the-process-manager"></a><span data-ttu-id="2e48b-102">プロセス マネージャでの注文の流れ</span><span class="sxs-lookup"><span data-stu-id="2e48b-102">Order Flow through the Process Manager</span></span>
<span data-ttu-id="2e48b-103">このセクションでは、Southridge Video の注文プロセス マネージャの場合は、する方法について説明します、 **OrderManager**オーケストレーションで、注文が処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-103">This section describes how the Southridge Video order process manager, the **OrderManager** orchestration, processes orders.</span></span> <span data-ttu-id="2e48b-104">このセクションでは、オーケストレーションを新しい順序に従います。</span><span class="sxs-lookup"><span data-stu-id="2e48b-104">This section follows a new order through the orchestration.</span></span> <span data-ttu-id="2e48b-105">セクションでは、オーケストレーションが注文の更新を処理する方法についても説明します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-105">The section also discusses how the orchestration handles updates to orders.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2e48b-106">ビジネス プロセス マネージャのソリューションには、マネージャーの 1 つ以上の型を使用できるように記述されていますが、1 つだけのプロセス マネージャが含まれています。</span><span class="sxs-lookup"><span data-stu-id="2e48b-106">The business process manager solution includes only one process manager although it is written so that it can use more than one type of manager.</span></span>  
  
 <span data-ttu-id="2e48b-107">**OrderManager**オーケストレーションが注文を処理するために、ビジネス プロセスを実装する下位のオーケストレーションを調整します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-107">The **OrderManager** orchestration coordinates subordinate orchestrations that implement the business process to handle the order.</span></span> <span data-ttu-id="2e48b-108">**OrderManager**注文を 2 つのステージに送信順序を検証、機能グループに、情報を送信、リモート処理コンポーネントを介した注文システムに注文を送信および注文履歴を更新、します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-108">The **OrderManager** sends the order through two stages which, combined, validate the order, send the information to the facilities group, send the order to the order system through remoting components, and update the order history.</span></span> <span data-ttu-id="2e48b-109">追加、削除、または変更することがなくこれらのステージを変更することができます、 **OrderManager**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-109">You can add, delete, or modify these stages without having to change the **OrderManager**.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2e48b-110">サイズとスコープのため、 **OrderManager**オーケストレーション、オーケストレーションを Microsoft Visual Studio で開いてこのセクションを参照する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="2e48b-110">Because of the size and scope of the **OrderManager** orchestration, you may want to read this section with the orchestration open in Microsoft Visual Studio.</span></span>  
  
## <a name="order-manager-structure"></a><span data-ttu-id="2e48b-111">注文マネージャの構造</span><span class="sxs-lookup"><span data-stu-id="2e48b-111">Order Manager Structure</span></span>  
 <span data-ttu-id="2e48b-112">**OrderManager**受信図形をオーケストレーションをアクティブにするオーケストレーションを開始します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-112">The **OrderManager** orchestration begins with a receive shape that activates the orchestration.</span></span> <span data-ttu-id="2e48b-113">次の図の一般的な構造を示しています、 **OrderManager**オーケストレーションします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-113">The following diagram shows the general structure of the **OrderManager** orchestration.</span></span>  
  
 <span data-ttu-id="2e48b-114">![注文マネージャーの図の block](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span><span class="sxs-lookup"><span data-stu-id="2e48b-114">![Block Diagram of Order Manager](../core/media/ordermanagerblockdiagram.gif "OrderManagerBlockDiagram")</span></span>  
  
 <span data-ttu-id="2e48b-115">最初の受信図形は、2 つのメイン分岐につながります。</span><span class="sxs-lookup"><span data-stu-id="2e48b-115">The first receive shape leads to two main branches.</span></span> <span data-ttu-id="2e48b-116">1 つの分岐では、右側の 1 つは、新しい注文を処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-116">One branch, the right one, processes new orders.</span></span> <span data-ttu-id="2e48b-117">左の分岐では、注文のキャンセルを処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-117">The left branch, handles order cancellations.</span></span> <span data-ttu-id="2e48b-118">ことは、ユーザー入力を受け入れるため、 **OrderManager**注文が既に完了した後に、注文のキャンセルを受信します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-118">Because it accepts user input, it is possible for the **OrderManager** to receive an order cancellation after an order has already completed.</span></span> <span data-ttu-id="2e48b-119">これは、ような場合、左側のメイン ブランチのハンドル。</span><span class="sxs-lookup"><span data-stu-id="2e48b-119">This is the case the left main branch handles.</span></span> <span data-ttu-id="2e48b-120">分岐は、処理中止のフラグを設定し、イベント ログに警告を追加することで、独立したキャンセルを処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-120">The branch handles the isolated cancellation by setting flags for terminating processing and by adding a warning to the event log.</span></span> <span data-ttu-id="2e48b-121">オーケストレーションでは、右側の分岐で注文の処理中に到着した注文の取り消しを処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-121">The orchestration handles order cancellations that arrive while an order is being processed inside the right-hand branch.</span></span>  
  
 <span data-ttu-id="2e48b-122">注文処理の分岐は、なんらかの初期化を行い、2 つの入れ子になったループを次に、入力します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-122">The order processing branch does some initialization and then enters two nested loops.</span></span> <span data-ttu-id="2e48b-123">外側のループは、注文処理の各ステージに 1 回実行します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-123">The outer loop runs once for each stage in the order processing.</span></span> <span data-ttu-id="2e48b-124">内側のループはステージが処理中に実行されます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-124">The inner loop runs while the stage is processing.</span></span> <span data-ttu-id="2e48b-125">注文マネージャは、内側のループ内で注文の更新に対してもリッスンします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-125">The order manager also listens for possible updates to the order inside the inner loop.</span></span> <span data-ttu-id="2e48b-126">ループが終了した後、注文マネージャは、完了のメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-126">After the loops terminate, the order manager sends a completion message.</span></span>  
  
 <span data-ttu-id="2e48b-127">注文処理ステージが通信するために、自己関連付けを行う動的なポートを使用して、 **OrderManager**オーケストレーションします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-127">The order processing stages use dynamic, self-correlating ports to communicate back to the **OrderManager** orchestration.</span></span> <span data-ttu-id="2e48b-128">こうことの相関関係、 **OrderManager**とステージ インスタンスが、関連付けセットを使用する必要があるためです。</span><span class="sxs-lookup"><span data-stu-id="2e48b-128">This simplifies correlation of the **OrderManager** with the stage instances because it eliminates the need to use a correlation set.</span></span> <span data-ttu-id="2e48b-129">自己関連付けを行うポートの詳細については、次を参照してください。[ポートのバインド](../core/port-bindings.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-129">For more information about self-correlating ports, see [Port Bindings](../core/port-bindings.md).</span></span>  
  
## <a name="receiving-orders"></a><span data-ttu-id="2e48b-130">注文の受信</span><span class="sxs-lookup"><span data-stu-id="2e48b-130">Receiving Orders</span></span>  
 <span data-ttu-id="2e48b-131">**OrderManager**からの注文メッセージを受信、 **OrderBroker**を介してオーケストレーション、 **FromBrokerPort**ポート。</span><span class="sxs-lookup"><span data-stu-id="2e48b-131">The **OrderManager** receives order messages from the **OrderBroker** orchestration through the **FromBrokerPort** port.</span></span> <span data-ttu-id="2e48b-132">このポートは、メッセージ ボックス データベースに直接バインドされます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-132">This port is bound directly to the MessageBox database.</span></span> <span data-ttu-id="2e48b-133">オーケストレーションが 2 つあります**受信**図形をポートに接続されている: 新しい注文のいずれかとに 1 つは注文を更新します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-133">The orchestration has two **Receive** shapes connected to the port: one for new orders and one for updated orders.</span></span>  
  
 <span data-ttu-id="2e48b-134">**OrderManger**フィルター式に基づくプロセスへのメッセージを決定します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-134">The **OrderManger** determines which messages to process based on a filter expression.</span></span> <span data-ttu-id="2e48b-135">フィルター式は、メッセージの状態フィールドと注文マネージャの種類フィールドの値をテスト**OrderMgrType**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-135">The filter expression tests the value in the message status field and the order manager type field, **OrderMgrType**.</span></span> <span data-ttu-id="2e48b-136">状態フィールドが ACCEPTED でに等しい場合、 **OrderMgrType**が CABLEORDER、順序は、新しいと、このプロセス マネージャーの目的です。</span><span class="sxs-lookup"><span data-stu-id="2e48b-136">If the status field is equal to ACCEPTED, and the **OrderMgrType** is CABLEORDER, the order is new and intended for this process manager.</span></span>  
  
 <span data-ttu-id="2e48b-137">新しい順序は、オーケストレーションの新しいインスタンスをアクティブにします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-137">The new order activates a new instance of the orchestration.</span></span> <span data-ttu-id="2e48b-138">**OrderManager**で要求の種類を次にチェックを**デシジョン**図形。</span><span class="sxs-lookup"><span data-stu-id="2e48b-138">The **OrderManager** next checks the type of the request in a **Decision** shape.</span></span> <span data-ttu-id="2e48b-139">種類が Terminate の場合は、オーケストレーションは左側の分岐を実行し、順序を終了します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-139">If the type is Terminate, the orchestration executes the left-hand branch and terminates the order.</span></span> <span data-ttu-id="2e48b-140">それ以外の場合、オーケストレーションは、注文の処理を続行します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-140">Otherwise, the orchestration proceeds with processing the order.</span></span> <span data-ttu-id="2e48b-141">この特定の順序に関連する後続のメッセージの待機を含むことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="2e48b-141">Notice that this includes listening for subsequent messages related to this particular order.</span></span>  
  
## <a name="initialization-for-new-orders"></a><span data-ttu-id="2e48b-142">新しい注文の初期化</span><span class="sxs-lookup"><span data-stu-id="2e48b-142">Initialization for New Orders</span></span>  
 <span data-ttu-id="2e48b-143">後に、 **OrderManager**から構成情報を取得、オーケストレーションが最初のメッセージを受信し、右側の主分岐を開始、 **SSOConfigStore**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-143">After the **OrderManager** orchestration receives an initial message and begins the main right-hand branch, it gets its configuration information from the **SSOConfigStore**.</span></span> <span data-ttu-id="2e48b-144">これはで定義されているシングルトン オブジェクトを介して、**ユーティリティ**アセンブリ。</span><span class="sxs-lookup"><span data-stu-id="2e48b-144">It does this through a singleton object defined in the **Utilities** assembly.</span></span> <span data-ttu-id="2e48b-145">構成値は、オブジェクトのプロパティです。</span><span class="sxs-lookup"><span data-stu-id="2e48b-145">The configuration values are properties of the object.</span></span> <span data-ttu-id="2e48b-146">オブジェクトは、サービス指向アーキテクチャ ソリューションのような構成値のローカル キャッシュを管理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-146">The object manages a local cache of the configuration values similar to the Service Oriented Architecture solution.</span></span> <span data-ttu-id="2e48b-147">シングルトン オブジェクトの詳細については、次を参照してください。[を使用して SSO の効率的なビジネス プロセス管理ソリューションで](../core/using-sso-efficiently-in-the-business-process-management-solution.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-147">For more information about the singleton object, see [Using SSO Efficiently in the Business Process Management Solution](../core/using-sso-efficiently-in-the-business-process-management-solution.md).</span></span>  
  
 <span data-ttu-id="2e48b-148">値はすぐに使用して保護できますように BizTalk がインストールされているときに存在するために、シークレットが格納するビジネス プロセス管理ソリューションは、サービス指向ソリューションと同様に SSO が構成情報をキャッシュします。データベース接続文字列やパスワードなどの情報。</span><span class="sxs-lookup"><span data-stu-id="2e48b-148">Like the Service Oriented solution, the Business Process Management solution uses the secret store because it is present whenever BizTalk is installed, SSO caches the configuration information so that the values are readily available, and it can protect information such as database connection strings and passwords.</span></span> <span data-ttu-id="2e48b-149">これらの理由からすべてのシークレット ストアなる適切な場所の構成情報でシングル サインオンでした。 バックエンド アプリケーションへの接続を管理するため使用されている場合でもです。</span><span class="sxs-lookup"><span data-stu-id="2e48b-149">For all of these reasons, the secret store would be a good place for the configuration information even if Single Sign-On weren't being used for managing connections to the backend applications.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2e48b-150">オーケストレーションでは、処理を開始する前に構成情報を取得します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-150">The orchestration retrieves configuration information before starting processing.</span></span> <span data-ttu-id="2e48b-151">これにより、オーケストレーションが退避され、後で、リハイド レートする場合、同じ構成を使用します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-151">This ensures the orchestration uses the same configuration if it is dehydrated and, later, rehydrated.</span></span> <span data-ttu-id="2e48b-152">退避の詳細については、次を参照してください。[オーケストレーションの退避と復元](../core/orchestration-dehydration-and-rehydration.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-152">For more information about dehydration, see [Orchestration Dehydration and Rehydration](../core/orchestration-dehydration-and-rehydration.md).</span></span>  
  
 <span data-ttu-id="2e48b-153">注文マネージャは、構成データから 1 つの値を使用します。**TotalStages**、注文処理過程で、ステージの合計数。</span><span class="sxs-lookup"><span data-stu-id="2e48b-153">The order manager uses one value from the configuration data: **TotalStages**, the total number of stages in the order handling process.</span></span> <span data-ttu-id="2e48b-154">マネージャーは、ローカル変数にこの値を割り当てます**numStages**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-154">The manager assigns this value to a local variable, **numStages**.</span></span> <span data-ttu-id="2e48b-155">また、外側のループに接続されている 2 つの変数を設定**ステージ**と**停止**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-155">It also sets two more variables connected to the outer loop, **stage** and **stop**.</span></span> <span data-ttu-id="2e48b-156">**ステージ**外側のループのカウンターを現在のステージを示します**停止**"stopping"の値。</span><span class="sxs-lookup"><span data-stu-id="2e48b-156">The **stage** indicates the current stage and is the counter for the outer loop; **stop** the stopping value.</span></span>  
  
 <span data-ttu-id="2e48b-157">マネージャーが最後に、設定、 **orderStatus**変数を STARTED 外側の処理ループに入るとします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-157">Finally, the manager sets the **orderStatus** variable to STARTED and enters the outer processing loop.</span></span>  
  
## <a name="new-order-processing-loops"></a><span data-ttu-id="2e48b-158">新しい注文の処理ループ</span><span class="sxs-lookup"><span data-stu-id="2e48b-158">New Order Processing Loops</span></span>  
 <span data-ttu-id="2e48b-159">外側のループの実行の値として long、**ステージ**変数がの値より小さい、 **numStages**変数。</span><span class="sxs-lookup"><span data-stu-id="2e48b-159">The outer loop runs as long as the value of the **stage** variable is less than the value of the **numStages** variable.</span></span> <span data-ttu-id="2e48b-160">外側のループでは、各ステージの処理をドライブします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-160">The outer loops drives the processing for each stage.</span></span> <span data-ttu-id="2e48b-161">ステージがまだ処理されている限り、内側のループが実行されます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-161">The inner loop runs so long as a stage is still being processed.</span></span> <span data-ttu-id="2e48b-162">また、順序変更があった場合もリッスンします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-162">It also listens for possible changes to the order.</span></span>  
  
### <a name="outer-loop"></a><span data-ttu-id="2e48b-163">外側のループ</span><span class="sxs-lookup"><span data-stu-id="2e48b-163">Outer Loop</span></span>  
 <span data-ttu-id="2e48b-164">オーケストレーションが受信したメッセージを割り当てることで、外側のループを開始 (**NewOrderMgrMsg**)、変数に**OrderMgrMsg**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-164">The orchestration begins the outer loop by assigning the received message (**NewOrderMgrMsg**) to a variable, **OrderMgrMsg**.</span></span> <span data-ttu-id="2e48b-165">また、メッセージのルーティングの部分には、ステージと状態のコピーされます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-165">It then copies the stage and status to the routing part of the message.</span></span> <span data-ttu-id="2e48b-166">オーケストレーションがメッセージのアドレスにもリターン アドレスを設定、 **StageCompletionPort**:</span><span class="sxs-lookup"><span data-stu-id="2e48b-166">The orchestration also sets the return address in the message to the address of the **StageCompletionPort**:</span></span>  
  
```  
OrderMgrMsg.RoutingPart.OrderMgrReturnAddress =   
       StageCompletionPort(Microsoft.XLANGs.BaseTypes.Address);  
```  
  
 <span data-ttu-id="2e48b-167">次にオーケストレーションは注文を送信する、 **StagePort**、送信請求-応答ポート。</span><span class="sxs-lookup"><span data-stu-id="2e48b-167">The orchestration then sends the order to the **StagePort**, a solicit-response port.</span></span> <span data-ttu-id="2e48b-168">オーケストレーションは注文処理が開始されたステージからの受信確認を待機します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-168">The orchestration then waits for an acknowledgement from the stage that order processing has started.</span></span> <span data-ttu-id="2e48b-169">ステージの送信、 **OrderAck**注文の処理を開始するときのメッセージします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-169">The stage sends an **OrderAck** message when it starts processing the order.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2e48b-170">**OrderAck**メッセージは、スキーマではなく .NET クラスによって定義されているソリューションでいくつかのいずれか。</span><span class="sxs-lookup"><span data-stu-id="2e48b-170">The **OrderAck** message is one of several in the solution defined by .NET classes rather than a schema.</span></span> <span data-ttu-id="2e48b-171">.NET クラスを使用してメッセージを定義する方法の詳細については、次を参照してください。[ユーザー コードでのメッセージの構築](../core/constructing-messages-in-user-code.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-171">For more information about using .NET classes to define messages, see [Constructing Messages in User Code](../core/constructing-messages-in-user-code.md).</span></span>  
  
 <span data-ttu-id="2e48b-172">オーケストレーションは受信確認を受け取る、ステージが割り当てられます、 **currentStage**変数と、内側のループに入ります。</span><span class="sxs-lookup"><span data-stu-id="2e48b-172">When the orchestration receives the acknowledgement, it assigns the stage to the **currentStage** variable and enters the inner loop.</span></span>  
  
### <a name="inner-loop"></a><span data-ttu-id="2e48b-173">内側のループ</span><span class="sxs-lookup"><span data-stu-id="2e48b-173">Inner Loop</span></span>  
 <span data-ttu-id="2e48b-174">限り、内側のループの実行、 **currentStage**変数と等しい、**ステージ**; 変数は、現在のステージが処理されている限り、します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-174">The inner loop runs as long as the **currentStage** variable is equal to the **stage** variable; that is, as long as the current stage is being processed.</span></span> <span data-ttu-id="2e48b-175">ループの本体は、**リッスン**図形と 3 つ**受信**図形。</span><span class="sxs-lookup"><span data-stu-id="2e48b-175">The body of the loop is a **Listen** shape with three **Receive** shapes.</span></span> <span data-ttu-id="2e48b-176">オーケストレーションで、左端の図形**発注要求**は、次のセクションで説明されている注文更新メカニズムの一部です。</span><span class="sxs-lookup"><span data-stu-id="2e48b-176">The leftmost shape in the orchestration, **Order Request**, is part of the order update mechanism, described in the next section.</span></span>  
  
 <span data-ttu-id="2e48b-177">ときに注文処理ステージが完了すると、そのメッセージを送信する、 **StageCompletion**のポート、 **OrderManager**オーケストレーションします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-177">When an order processing stage finishes, it sends a message to the **StageCompletion** port of the **OrderManager** orchestration.</span></span> <span data-ttu-id="2e48b-178">ステージは、エラーのため突然終了する場合は、送信、 **TerminatedMessage**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-178">If the stage abruptly terminates due to an error, it sends a **TerminatedMessage**.</span></span> <span data-ttu-id="2e48b-179">ここで、 **OrderManager**例外をスローします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-179">In this case, the **OrderManager** throws an exception.</span></span> <span data-ttu-id="2e48b-180">最も外側の例外ハンドラーが例外をキャッチし、エラー メッセージを送信、 **OperatorPort**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-180">The outermost exception handler catches the exception and sends an error message to the **OperatorPort**.</span></span>  
  
 <span data-ttu-id="2e48b-181">ステージを送信する場合、 **OrderMgrMsg**、 **OrderManager**インクリメント、**ステージ**変数。</span><span class="sxs-lookup"><span data-stu-id="2e48b-181">If the stage sends an **OrderMgrMsg**, the **OrderManager** increments the **stage** variable.</span></span> <span data-ttu-id="2e48b-182">オーケストレーションが注文の状態を設定 (stage の値以下に numStages) の段階がある場合は、 **OrderMgrMsg**を STAGE_n_COMPLETED n は現在のステージの数です。</span><span class="sxs-lookup"><span data-stu-id="2e48b-182">If there are more stages (stage less than or equal to numStages), the orchestrations sets the order status in **OrderMgrMsg** to STAGE_n_COMPLETED where n is the number of the current stage.</span></span> <span data-ttu-id="2e48b-183">なしの段階がある場合を完了、注文ステータスを設定して、両方のループを終了します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-183">If there are no more stages, it sets the order status to COMPLETED and exits both loops.</span></span>  
  
## <a name="order-updates"></a><span data-ttu-id="2e48b-184">注文の更新プログラム</span><span class="sxs-lookup"><span data-stu-id="2e48b-184">Order Updates</span></span>  
 <span data-ttu-id="2e48b-185">**OrderManager**オーケストレーションは内側の処理ループで注文の更新をリッスンします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-185">The **OrderManager** orchestration listens for order updates inside the inner processing loop.</span></span> <span data-ttu-id="2e48b-186">注意して、**受信**これは、使用を図形**OrderRequest**を使用しても、 **FromBrokerPort**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-186">Notice that the **Receive** shape it uses for this, **OrderRequest**, also uses the **FromBrokerPort**.</span></span> <span data-ttu-id="2e48b-187">関連付けセットと組み合わせて、ループ内で同じポート上の 2 番目の受信図形の使用は、一般的な BizTalk Server パターンでは、コンボイ パターンを形成します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-187">The use of a second receive shape on the same port inside a loop, combined with correlation sets, forms a common BizTalk Server pattern, the convoy pattern.</span></span> <span data-ttu-id="2e48b-188">オーケストレーションの同じインスタンスが、特定の操作で接続されている最初と後続のメッセージを処理することを確認するのにには、コンボイ パターンを使用します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-188">You use the convoy pattern to ensure that the same instance of an orchestration processes the first and subsequent messages connected with a particular operation.</span></span>  
  
 <span data-ttu-id="2e48b-189">注文マネージャは、注文に接続されている最初のメッセージを受信した場合は、2 つの関連付けセットを初期化します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-189">When the order manager receives the first message connected to an order, it initializes two correlation sets.</span></span> <span data-ttu-id="2e48b-190">まず、 **OrderCorrelation**、顧客 ID を使用して (**CustID**) と注文 ID (**OrderID**)。</span><span class="sxs-lookup"><span data-stu-id="2e48b-190">The first, **OrderCorrelation**, uses the customer ID (**CustID**) and order ID (**OrderID**).</span></span> <span data-ttu-id="2e48b-191">注文マネージャは、この関連付けを注文処理ステージと共有します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-191">The order manager shares this correlation with the order processing stages.</span></span> <span data-ttu-id="2e48b-192">2 番目の相関関係はコンボイ関連付けの**OrderConvoyCorrelation**、注文ステータスを使用する (**状態**) だけでなく、顧客 ID と注文 ID</span><span class="sxs-lookup"><span data-stu-id="2e48b-192">The second correlation is the convoy correlation, **OrderConvoyCorrelation**, which uses the order status (**Status**) in addition to the customer ID and order ID.</span></span> <span data-ttu-id="2e48b-193">**OrderRequestReceive**図形の使用**OrderConvoyCorrelation**フォロー関連付けセットとして。</span><span class="sxs-lookup"><span data-stu-id="2e48b-193">The **OrderRequestReceive** shape uses **OrderConvoyCorrelation** as a Following Correlation Set.</span></span> <span data-ttu-id="2e48b-194">関連付けセットをこのように設定により、特定の順序で作業注文マネージャのインスタンスがすべての変更を受信します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-194">Setting the correlation set up this way ensures that the instance of the order manager working on a particular order receives any changes.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="2e48b-195">関連付けセットは、メッセージがオーケストレーションの特定のインスタンスに属するかどうかを判断するために使用するメッセージ プロパティのグループを思い出してください。</span><span class="sxs-lookup"><span data-stu-id="2e48b-195">Recall that a correlation set is a grouping of message properties used to determine whether or not a message belongs to a given instance of an orchestration.</span></span> <span data-ttu-id="2e48b-196">詳細については、次を参照してください。[オーケストレーションでの相関関係を使用して](../core/using-correlations-in-orchestrations.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-196">For more information, see [Using Correlations in Orchestrations](../core/using-correlations-in-orchestrations.md).</span></span>  
  
 <span data-ttu-id="2e48b-197">ときに、 **OrderManager**後続のメッセージを受信する注文が最初のテストの要求の種類。</span><span class="sxs-lookup"><span data-stu-id="2e48b-197">When the **OrderManager** receives a subsequent message for an order, it first tests the type of request.</span></span> <span data-ttu-id="2e48b-198">要求の種類が TERMINATE の場合は、判断図形は終了分岐を実行します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-198">If the request type is TERMINATE, the Decision shape executes the terminate branch.</span></span> <span data-ttu-id="2e48b-199">それ以外の場合、オーケストレーションは、更新プログラムが新しいメッセージをテストします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-199">Otherwise, the orchestration tests the new message to see if it is an update.</span></span> <span data-ttu-id="2e48b-200">更新メッセージが大きいシーケンス番号 (**SeqNum**) 元の要求よりもします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-200">An update message has a higher sequence number (**SeqNum**) than the original request.</span></span> <span data-ttu-id="2e48b-201">新しいメッセージのシーケンス番号が大きい場合は、オーケストレーションは注文に新しいメッセージが経由で処理を開始します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-201">If the new message's sequence number is higher, the orchestration starts the order processing over with the new message.</span></span> <span data-ttu-id="2e48b-202">場合、元の更新メッセージは、同じまたは低いシーケンス番号があるとは、シーケンス エラーが発生します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-202">If the original and update message have the same or a lower sequence number, there is a sequence error.</span></span> <span data-ttu-id="2e48b-203">シーケンス番号が等しい場合は重複する注文と、重複エラー フラグが設定されます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-203">If the sequence numbers are equal, it is a duplicate order and flagged as a duplicate error.</span></span>  
  
 <span data-ttu-id="2e48b-204">詳細については**SeqNum**を参照してください[キーのメッセージとフィールド](../core/key-messages-and-fields.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-204">For more information about **SeqNum**, see [Key Messages and Fields](../core/key-messages-and-fields.md).</span></span>  
  
## <a name="final-steps"></a><span data-ttu-id="2e48b-205">最後の手順</span><span class="sxs-lookup"><span data-stu-id="2e48b-205">Final Steps</span></span>  
 <span data-ttu-id="2e48b-206">注文マネージャが動的ポートに応答アドレスを割り当てます、ループを終了した後**CSRCompletionPort**します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-206">After exiting the loops, the order manager assigns the reply address to the dynamic port **CSRCompletionPort**.</span></span> <span data-ttu-id="2e48b-207">マネージャーには、完了状態メッセージを作成、送信にエラーが発生する場合をテストします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-207">The manager then constructs the completion status message, sends it, and then tests if there was an error.</span></span> <span data-ttu-id="2e48b-208">終了図形。 オーケストレーションのあった、エラーが発生した場合それ以外の場合、単純に終了します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-208">If there was an error, the orchestration exectues a Terminate shape; otherwise, it simply ends.</span></span>  
  
## <a name="coordinating-with-the-stages"></a><span data-ttu-id="2e48b-209">ステージとの調整</span><span class="sxs-lookup"><span data-stu-id="2e48b-209">Coordinating with the Stages</span></span>  
 <span data-ttu-id="2e48b-210">両方の**OrderBroker**オーケストレーションと 2 つ目の処理ステージ オーケストレーション (**CableOrder2**) 履歴データベースにエントリを作成します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-210">Both the **OrderBroker** orchestration and the second processing stage orchestration (**CableOrder2**) make entries in the history database.</span></span> <span data-ttu-id="2e48b-211">CableOrder2 オーケストレーションが入力した履歴情報を更新する、 **OrderBroker**オーケストレーションします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-211">The CableOrder2 orchestration updates the history information entered by the **OrderBroker** orchestration.</span></span> <span data-ttu-id="2e48b-212">更新するには、データベース内のエントリがあることを確認するには、 **OrderBroker**データベース用に使用するポートの配信通知を使用します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-212">In order to ensure there is an entry in the database to update, the **OrderBroker** uses delivery notification on the port it uses for the database.</span></span>  
  
 <span data-ttu-id="2e48b-213">マップの構成、 **OrderBroker** 2 つのポートを含む送信ポート グループに、履歴データベース用のポートを送信: テスト構成の 1 つのポート (**HISTORYINSERT-SP テスト**)、1 つずつ、通常構成 (**HISTORYINSERT-SP**)。</span><span class="sxs-lookup"><span data-stu-id="2e48b-213">Configuration maps the **OrderBroker** send port for the history database to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="2e48b-214">グループの両方のポートをアクティブのままにした場合、ソリューションは、両方のポートでメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-214">If you leave both ports in the group active, the solution sends messages on both ports.</span></span> <span data-ttu-id="2e48b-215">したがって、2 つの配信通知を要求する、1 つのみを処理します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-215">It thus requests two delivery notifications but processes only one.</span></span>  
  
 <span data-ttu-id="2e48b-216">このような状況を避けるためには、テスト ポートを参加解除 (**HISTORYINSERT-SP テスト**)、またはアプリケーションのテスト バージョンを停止します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-216">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application.</span></span> <span data-ttu-id="2e48b-217">配信通知の詳細については、次を参照してください。[を使用して受信確認](../core/using-acknowledgments.md)します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-217">For more information about delivery notification, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
## <a name="errors-and-routing-repaired-messagesdesign-choices"></a><span data-ttu-id="2e48b-218">エラーおよびルーティングの修復済みメッセージ: デザインの選択</span><span class="sxs-lookup"><span data-stu-id="2e48b-218">Errors and Routing Repaired Messages—Design Choices</span></span>  
 <span data-ttu-id="2e48b-219">エラー処理オーケストレーションを使用して、例外ハンドラ オーケストレーションと注文処理ステージで使用されるオーケストレーション (**ErrorHandlerOrch**) 修復の不正な注文をルーティングします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-219">The exception handler orchestration and orchestrations used by the order processing stages use an error handling orchestration (**ErrorHandlerOrch**) to route bad orders for repair.</span></span> <span data-ttu-id="2e48b-220">デザインは supposes は部署またはグループに必要な形式で順序を修正します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-220">The design supposes that there is a department or group that will fix the order in the form needed.</span></span> <span data-ttu-id="2e48b-221">修復された注文が注文ブローカのオーケストレーションを再送信されていない (**OrderBroker**)。</span><span class="sxs-lookup"><span data-stu-id="2e48b-221">The repaired order is not resubmitted through the order broker orchestration (**OrderBroker**).</span></span> <span data-ttu-id="2e48b-222">代わりに、正規化された注文は正規化されたフォームで修復されます。</span><span class="sxs-lookup"><span data-stu-id="2e48b-222">Rather, the normalized order is repaired in its normalized form.</span></span> <span data-ttu-id="2e48b-223">現在のソリューションのデザインでは、元の順序のソースに、エラー メッセージをルーティング ハンドラー オーケストレーションがあります。</span><span class="sxs-lookup"><span data-stu-id="2e48b-223">The current design of the solution has the handler orchestration route the error message back to the source of the original order.</span></span> <span data-ttu-id="2e48b-224">ただし、修復された注文は、エラー ハンドラー オーケストレーションの MSMQ ポートにルーティングする必要があります。</span><span class="sxs-lookup"><span data-stu-id="2e48b-224">Repaired orders, however, have to be routed to an MSMQ port on the error handler orchestration.</span></span> <span data-ttu-id="2e48b-225">(ソリューションのテスト バージョンは、ファイルのフォルダーを使用します)。エラー ハンドラーは、呼び出し元オーケストレーションに修復されたメッセージを返します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-225">(The test version of the solution uses a file folder.) The error handler then returns the repaired message to the calling orchestration.</span></span>  
  
 <span data-ttu-id="2e48b-226">このソリューションは、注文ブローカは注文メッセージの重要な検証と正規化するためにこの設計を使用します。</span><span class="sxs-lookup"><span data-stu-id="2e48b-226">This solution uses this design, because the order broker does significant validation and normalization of the order message.</span></span> <span data-ttu-id="2e48b-227">一方、修復を必要とする注文メッセージは、正規化された形式でも。</span><span class="sxs-lookup"><span data-stu-id="2e48b-227">In turn, the order message requiring repair is also in the normalized form.</span></span> <span data-ttu-id="2e48b-228">メッセージの正規化されたフォームを維持するには、メッセージの送信済みおよび正規化された形式間の違いを回避することができないようにします。</span><span class="sxs-lookup"><span data-stu-id="2e48b-228">Maintaining the normalized form of the message prevents having to work around the difference between the submitted and normalized forms of the messages.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2e48b-229">参照</span><span class="sxs-lookup"><span data-stu-id="2e48b-229">See Also</span></span>  
 <span data-ttu-id="2e48b-230">[プロセス マネージャのロジック](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="2e48b-230">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 [<span data-ttu-id="2e48b-231">主要メッセージとフィールド</span><span class="sxs-lookup"><span data-stu-id="2e48b-231">Key Messages and Fields</span></span>](../core/key-messages-and-fields.md)