---
title: "WCF アダプター FAQ: メッセージのフローとマッピング |Microsoft ドキュメント"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 907e5c6a-a095-4b3a-9362-506832b6bc8c
caps.latest.revision: "4"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: e58b11cff00d4b235a5c14e75663fdf7e581f782
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
---
# <a name="wcf-adapter-faq-message-flow-and-mapping"></a>WCF アダプター FAQ: メッセージのフローとマッピング
## <a name="what-is-the-message-flow-within-the-wcf-and-biztalk-systems"></a>WCF と BizTalk システム内のメッセージ フローとはどのようなものですか。  
 次に、受信 WCF メッセージから BizTalk Server へのフローについて説明します。  
  
1.  WCF メッセージは受信場所で受信され、BizTalk Server はホストされた WCF サービスをインスタンス化します。  
  
2.  WCF ランタイムはサービスのチャネル スタックとそのチャネル リスナーをインスタンス化します。 チャネル スタックは異なる処理タスクを処理する一連のステージです。 各チャネル スタックは少なくとも 1 つのトランスポート チャネル、多くの場合は 1 つのメッセージ エンコーダー、および 0 個以上のプロトコル チャネルから構成されます。 トランスポート チャネルでは受信メッセージ ストリームを受信時に読み取ります。 トランスポート チャネルではエンコーダーを呼び出してメッセージを解釈し、WCF メッセージ オブジェクトを生成します。 この時点で、各プロトコル チャネルでは順に WCF メッセージを操作する機会があります。  
  
3.  WCF メッセージはリスナーにより受信され、構成済みの WCF チャネル スタックを介して転送され、適切なサービス インスタンスにディスパッチされます。 この時点で、WCF メッセージは BizTalk メッセージに変換 (マップ) されます。 簡単に説明すると、WCF メッセージ ヘッダーは BizTalk メッセージ コンテキストに書き込まれ、WCF メッセージ本文は BizTalk メッセージのボディ部に書き込まれます。 マッピングは、WCF メッセージのどの部分が BizTalk メッセージ本文を制御します。 エンベロープ、本文、またはそのサブ要素です。  
  
4.  受信場所に構成されたパイプライン コンポーネントで BizTalk メッセージが処理されます。  
  
5.  BizTalk メッセージはメッセージ ボックス データベースに保存されます。  
  
 次に、BizTalk Server から送信 WCF メッセージへのフローについて説明します。  
  
1.  BizTalk メッセージはサブスクリプションに従って送信ポートで受信されます。  
  
2.  送信ポートに構成されたパイプライン コンポーネントで BizTalk メッセージが処理されます。  
  
3.  WCF チャネル スタックはインスタンス化され、BizTalk メッセージはサービスの外部表示コントラクトに基づいて変換 (マップ) されます。  
  
4.  WCF チャネル スタックにより WCF メッセージは外部 WCF サービスに送信されます。  
  
## <a name="how-is-a-wcf-message-converted-mapped-into-a-biztalk-message"></a>WCF メッセージはどのように BizTalk メッセージに変換 (マップ) されますか。  
 マッピングを理解するには、WCF メッセージと BizTalk メッセージの構造を調べる必要があります。  
  
 WCF メッセージは SOAP メッセージ構造をモデルとして作成されており、メッセージ プロパティ、メッセージ ヘッダー、および 1 つのメッセージ本文から構成されます。  
  
-   **メッセージ プロパティ**メッセージ オブジェクトにアタッチされている共通言語ランタイム (CLR) オブジェクトです。 プロパティは通信の両端にある WCF スタックとユーザーのアプリケーションの内部にあり、 クライアントとサーバー間で直接転送されることはありません。  
  
-   **メッセージ ヘッダー**、ただし、クライアントとサーバー間で転送されます。 1 つのメッセージで複数のヘッダーを使用できますが、メッセージ本文は 1 つだけです。ヘッダーと異なり、メッセージ本文はストリーム化されます。 メッセージ ヘッダーとメッセージ本文は XML Infoset として定義されます。  
  
-   **本文**WCF のメッセージが対象のプロパティとヘッダーは詳細については、メッセージのメイン コンテンツ。  
  
 BizTalk メッセージの構造は異なります。  
  
-   各メッセージには 1 組のコンテキスト プロパティがあります。 各コンテキスト プロパティは名前空間名と値のペアから構成されます。 コンテキスト プロパティは昇格または書き込みが可能です。 昇格させると、BizTalk Server 内で実行されるルーティング ルールに加えることができます。  
  
-   BizTalk Server のメッセージのデータは複数のストリームで構成することができます。 各ストリームは独立して読み取ることができるため、BizTalk メッセージはマルチパートです。 メッセージ部の 1 つは特別であり、ボディ部と呼ばれます。  
  
 通信は双方向になることがあるため、WCF アダプターを使用すると、メッセージ交換の送信と受信の両方向に特定の変換またはマッピングを構成できます。 この構成は、BizTalk Server 内の受信場所と送信ポートの両方に行うことができます。  
  
 BizTalk WCF アダプターでは、これら 2 つのメッセージ構造間の実行時変換について、さまざまな組み合わせをサポートしています。 マッピングはによって制御されます、**メッセージ** タブで、**トランスポートのプロパティ**WCF アダプターのダイアログ ボックス。 たとえば、最も基本的な変換 (既定値) は、受信 WCF メッセージの本文が BizTalk メッセージの本文になるときです。 マップ モードの詳細については、次を参照してください。 [http://go.microsoft.com/fwlink/?LinkID=119792](http://go.microsoft.com/fwlink/?LinkID=119792)です。  
  
## <a name="how-can-you-preserve-the-complete-incoming-wcf-message-inside-the-biztalk-message"></a>受信 WCF メッセージ全体を BizTalk メッセージ内に保存する方法  
 受信 BizTalk メッセージ本文オプションの 1 つは、**エンベロープ**オプション。 このオプションを選択すると、soap:Envelope 要素内に含まれている SOAP メッセージ全体が受信 BizTalk メッセージ本文に入ります。 生成される BizTalk メッセージにはエンベロープ タグ、すべてのヘッダー、および本文が含まれます。  
  
## <a name="how-can-you-extract-specific-elements-of-the-incoming-wcf-message-into-a-biztalk-message-or-map-elements-of-an-outgoing-biztalk-message-to-an-outgoing-wcf-message"></a>受信 WCF メッセージの特定要素を BizTalk メッセージに抽出するか、送信 BizTalk メッセージの要素を送信 WCF メッセージにマップする方法  
 WCF または BizTalk のメッセージ本文の一部をマップするには、パスまたはテンプレート オプションを使用します。 XPath 式を入力して、メッセージ本文の特定部分を抽出できます。 この場合、XPath 構文全体はサポートされていません。これは、抽出がストリーム化されており、したがってリーダーは常に前進する必要があるためです。 これは、理由、**メッセージ**[xpath--本文のパスで見つかったコンテンツです"[パス--本文のパスで見つかったコンテンツ]"と呼びます] タブ。  
  
 受信側では、WCF メッセージからデータを読み取る方法を示すパス式を使用します。 受信メッセージの場合、Path ステートメントにより抽出される特定要素は BizTalk メッセージのコンテンツの代わりとして使用されます。 アダプターではこのパス式を使用して BizTalk メッセージの必要なデータを検索し、抽出します。  
  
 送信側では、テンプレートを使用して BizTalk メッセージから WCF メッセージを作成します。 送信メッセージのテンプレート オプションは XPath オプションの正反対のことを可能にするよう設計されています。 WCF アダプター構成で、XML のスニペットは送信メッセージの構造の基本部分として使用されます。 BizTalk メッセージのコンテンツは実行時にこの構造に挿入されます。  
  
 また、送信メッセージの場合、ノード エンコード設定を使用して書き込む要素の種類を XML、Base64、文字列、16 進のうちから選択する必要もあります。 WCF メッセージに含まれたバイナリ データ ストリームを抽出する場合、このオプションは役立ちます。 この機能を使用すると、WCF アダプターは WCF メッセージの本文リーダーに ReadContextAsBase64 呼び出しを使用するよう指示されます。 この呼び出しではバイナリ データは XmlReader API を介して直接読み取ることができるため、この機能を使用すると、バイナリ データを WCF トランスポートから BizTalk メッセージボックス データベースに直接移動できます。 バイナリ データが入ったノードへのパスを書き込むことで、バイナリ データを取り出し、BizTalk メッセージに入れることができます。  
  
## <a name="how-do-you-access-wcf-message-properties-within-an-incoming-wcf-message"></a>受信 WCF メッセージ内の WCF メッセージ プロパティにアクセスする方法  
 受信 WCF メッセージが BizTalk メッセージに変換される前に WCF メッセージ内のプロパティにアクセスする場合、WCF ビヘイビアーでカスタム WCF チャネル コンポーネントまたはサービス モデル機能拡張ポイントを使用できます。 たとえば、 **IDispatchMessageInspector**オブジェクト。 BizTalk Wcf-custom および Wcf-customisolated アダプターは、アプリケーションを使用して WCF 動作の電源に接続するための簡単な方法を提供、**動作** タブで、**トランスポートのプロパティ**のダイアログ ボックスこれらのアダプターです。  
  
 WCF メッセージのプロパティが WCF アダプターで利用できるようにするには、最初にこれらのプロパティをメッセージ本文またはヘッダーのコンテンツとして書き込む必要があります。 ヘッダーは自動的に BizTalk メッセージ コンテキストにコピーされます。 プロパティ値を昇格する場合は、内から WCF メッセージ プロパティを BizTalk メッセージ コンテキストに昇格するカスタム BizTalk パイプライン コンポーネントを使用することができます、 **IComponent: 実行**メソッドです。 WCF カスタム アダプターと共にカスタム WCF ビヘイビアーを使用すると、WCF と BizTalk の拡張機能を利用してより高性能で柔軟性の高いソリューションを作成できます。 WCF アダプターを使用すると、既存の BizTalk と WCF の拡張機能を組み合わせて問題を解決できます。  
  
 一般的なプロパティの場合、WCF アダプターには簡単な方法があります。 両方の拡張機能に書き込む代わりに、WCF 拡張機能により WCF アダプターで認識される新しい "既知の" プロパティを作成できます。  
  
 SOAP ヘッダー値を BizTalk メッセージ コンテキストに書き込むか昇格させるには、プロパティ名と名前空間から構成される値ペアのコレクションが WCF メッセージに含まれている必要があります。 これによって、WCF アダプターではヘッダー値が書き込まれるか昇格されるかを認識できます。  
  
 WCF アダプターで SOAP ヘッダーの値を BizTalk メッセージ コンテキストに書き込む、または昇格させるには、WCF メッセージで次のメッセージ プロパティを指定する必要があります。  
  
-   BizTalk メッセージ コンテキストに SOAP ヘッダーの値を昇格するには、WCF アダプタを探しているキーのペアは、 **http://schemas.microsoft.com/BizTalk/2006/01/Adapters/WCF-properties/Promote**および値**リスト <KeyValuePair\<XmlQualifiedName、オブジェクト >>**です。 このペアを使用して、WCF アダプタを実行し、名前空間、名前からの値、 **XmlQualifiedName**オブジェクトおよびヘッダーの値を昇格させるために使用します。  
  
-   キーのペアを探している WCF アダプタになりますが、BizTalk メッセージ コンテキストに SOAP ヘッダーの値を昇格しません**http://schemas.microsoft.com/BizTalk/2006/01/Adapters/WCF-properties/WriteToContext**と値**一覧 < KeyValuePair\<XmlQualifiedName、オブジェクト >> です。** WCF アダプターは、このペアを使用して、値をメッセージ コンテキストに書き込みます。  
  
> [!NOTE]
>  昇格されたプロパティは、BizTalk ランタイムで受け付けられるようにするため、BizTalk プロパティ スキーマにも指定する必要があります。  
  
## <a name="you-have-an-existing-orchestration-or-send-port-etc-that-expects-a-biztalk-multipart-message-how-can-you-get-a-multipart-message-in-the-wcf-scenario"></a>BizTalk マルチパート メッセージを想定している既存のオーケストレーション (または送信ポートなど) があります。 どのようにすれば WCF シナリオでマルチパート メッセージを取得できますか。  
 BizTalk マルチパート メッセージは 1 つ以上のメッセージ部分から構成されます。 しかし、WCF にはマルチパート メッセージの概念がありません。 WCF ではマルチパート メッセージを使用しないため、BizTalk WCF アダプターでもマルチパート メッセージを使用しません。 問題は、マルチパート メッセージを作成するか使用するよう書かれた既存の BizTalk オーケストレーションまたはパイプラインがある場合です。  
  
 受信 WCF メッセージと WCF アダプターを使用してマルチパート メッセージを BizTalk Server で取得する必要がある場合、WCF メッセージではマルチパート データを XML にします。 受信 XML ストリーム (WCF メッセージ) を処理し、アプリケーションに適した BizTalk マルチパート メッセージを作成するカスタム BizTalk パイプライン コンポーネントを開発します。 必要に応じて、送信側でこの手順を逆にして行うことができます。