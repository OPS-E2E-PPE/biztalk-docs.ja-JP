---
title: アダプターの障害を処理する方法 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: bdceb364-38d6-4aab-a176-bf751da1be25
caps.latest.revision: 12
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 863ad82ce429bebb6bb5eb3ce671ca493830e8f4
ms.sourcegitcommit: 381e83d43796a345488d54b3f7413e11d56ad7be
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2019
ms.locfileid: "65337535"
---
# <a name="how-to-handle-adapter-failures"></a><span data-ttu-id="4f04f-102">アダプターの障害を処理する方法</span><span class="sxs-lookup"><span data-stu-id="4f04f-102">How to Handle Adapter Failures</span></span>
<span data-ttu-id="4f04f-103">一般に、アダプターは処理できないメッセージを中断する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-103">In general, adapters should suspend messages that they cannot process.</span></span> <span data-ttu-id="4f04f-104">たとえば、この決定は、アダプターの目的によって異なりますが、送信エラーが発生している受信アダプターは、メッセージを中断通常必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-104">For example, a receive adapter that experiences a submit failure should typically suspend the messages, although this decision depends upon the purpose of the adapter.</span></span> <span data-ttu-id="4f04f-105">エラー処理に関するセキュリティの考慮事項もあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-105">There are also security considerations around handling failures.</span></span> <span data-ttu-id="4f04f-106">たとえば、アダプターは、すべての失敗したメッセージを自動的に停止する場合、アダプターは BizTalk Server の保留キューがいっぱいの原因となるサービス拒否攻撃を開くのようにあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-106">For example, if an adapter automatically suspends all failed messages, the adapter might be open to a denial-of-service attack that causes the BizTalk Server Suspended queue to fill up.</span></span>  <span data-ttu-id="4f04f-107">HTTP など、一部のアダプターは、エラー コードを要求が拒否されていることを示すクライアントに返すことができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-107">Some adapters, such as HTTP, can return a failure code to the client indicating that the request has been rejected.</span></span> <span data-ttu-id="4f04f-108">これらの種類のアダプターの多くの場合、理にかなってメッセージを中断するのではなく、エラー コードが返されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-108">For these types of adapters it often makes sense to return a failure code rather than suspend the message.</span></span> <span data-ttu-id="4f04f-109">通常、アダプターは、プライマリとセカンダリの両方のトランスポートの再試行がすべてが終了された後にのみメッセージを中断も送信されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-109">Typically send adapters only suspend messages after all of the retries have been exhausted for both primary and secondary transports.</span></span>  
  
## <a name="associate-error-processing-with-an-individual-operation-and-not-with-the-batch-that-contains-the-operation"></a><span data-ttu-id="4f04f-110">個々 の操作とは、操作を含むバッチではなくを処理中にエラーを関連付ける</span><span class="sxs-lookup"><span data-stu-id="4f04f-110">Associate Error Processing with an Individual Operation and Not with the Batch That Contains the Operation</span></span>  
 <span data-ttu-id="4f04f-111">アダプターでのメッセージのバッチ処理はできません、アダプターのユーザーに表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-111">The batching of messages within an adapter should be invisible to the user of the adapter.</span></span> <span data-ttu-id="4f04f-112">つまり、バッチ内での 1 つの操作の失敗が何らかの方法で他の操作に影響はありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-112">This means that the failure of one operation in a batch should not affect any other operation in any way.</span></span> <span data-ttu-id="4f04f-113">ただし、バッチはアトミックで、エラー メッセージが 1 つのバッチのエラーが発生し、操作が処理されません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-113">However, batches are atomic, so the failure of one message results in an error for the batch, and no operations are processed.</span></span>  
  
 <span data-ttu-id="4f04f-114">エラーの処理、成功したメッセージを再送信および失敗したものの中断を担当するコードを記述するとします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-114">You write the code that is responsible for handling the error, resubmitting the successful messages, and suspending the unsuccessful ones.</span></span> <span data-ttu-id="4f04f-115">さいわい、BizTalk Server は、失敗した操作を特定するようにアダプターをできるようにする詳細なエラー構造を提供します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-115">Fortunately, BizTalk Server provides a detailed error structure that enables your adapter to determine the specific operation that failed.</span></span> <span data-ttu-id="4f04f-116">バッチをさらに成功した操作を再実行し、失敗したものの中断の構築が許可されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-116">It permits construction of further batches in which the successful operations are resubmitted and the unsuccessful ones suspended.</span></span>  
  
 <span data-ttu-id="4f04f-117">アダプター内のバッチ処理して、操作の最終的な状態は受けませんする必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-117">The final state of the operation should not be affected by the batching within the adapter.</span></span>  
  
## <a name="use-seterrorinfo-to-report-failure-to-biztalk-server"></a><span data-ttu-id="4f04f-118">BizTalk Server にエラーをレポートする SetErrorInfo を使用してください。</span><span class="sxs-lookup"><span data-stu-id="4f04f-118">Use SetErrorInfo to Report Failure to BizTalk Server</span></span>  
 <span data-ttu-id="4f04f-119">メッセージを中断する場合は、前のメッセージ コンテキストから BizTalk Server にエラーに関する情報を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-119">If you are suspending a message, you must provide failure information to BizTalk Server from the previous message context.</span></span> <span data-ttu-id="4f04f-120">BizTalk Server は、エラー レポート機能を使用して、 **SetErrorInfo**両方のメソッド、 **IBaseMessage**と**ITransportProxy**インターフェイス。</span><span class="sxs-lookup"><span data-stu-id="4f04f-120">BizTalk Server provides error reporting capabilities using the **SetErrorInfo** method on both the **IBaseMessage** and **ITransportProxy** interfaces.</span></span> <span data-ttu-id="4f04f-121">次のようにエラーを報告できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-121">You can report errors as follows:</span></span>  
  
- <span data-ttu-id="4f04f-122">メッセージの処理中に失敗したとき、設定を使用して例外**SetErrorInfo (Exception e)** メッセージ (**IBaseMessage**) を中断します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-122">When a failure occurs while processing a message, set the exception using **SetErrorInfo(Exception e)** on the message (**IBaseMessage**) to be suspended.</span></span> <span data-ttu-id="4f04f-123">これにより、エンジンは、エラーの後の診断メッセージを保持するために、管理者に警告をイベント ログに記録します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-123">This allows the engine to preserve the error with the message for later diagnosis and logs it to the event log to alert the administrator.</span></span>  
  
- <span data-ttu-id="4f04f-124">呼び出す必要があります (メッセージの処理) 中ではなく初期化または内部ブックキーピング中にエラーが発生した場合**SetErrorInfo (Exception e)** 上、 **ITransportProxy**に渡されたポインター初期化中にします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-124">If you encounter an error during initialization or internal bookkeeping (not during message processing) you should call **SetErrorInfo(Exception e)** on the **ITransportProxy** pointer that was passed to you during initialization.</span></span> <span data-ttu-id="4f04f-125">場合は、アダプターが BaseAdapter 実装に基づいて、このポインターへのアクセスを常が必要です。</span><span class="sxs-lookup"><span data-stu-id="4f04f-125">If your adapter is based on the BaseAdapter implementation, you should always have access to this pointer.</span></span> <span data-ttu-id="4f04f-126">それ以外の場合、することがそれをキャッシュします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-126">Otherwise, you should be certain that you cache it.</span></span>  
  
  <span data-ttu-id="4f04f-127">イベント ログに書き込まれるエラー メッセージにこれらのメソッドの結果のいずれかでエラーを報告します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-127">Reporting an error with either of these methods results in the error message being written to the event log.</span></span> <span data-ttu-id="4f04f-128">これを行うことができる場合、エラーを関連するメッセージと関連付けることが重要です。</span><span class="sxs-lookup"><span data-stu-id="4f04f-128">It is important that you associate the error with the related message if you are able to do so.</span></span>  
  
## <a name="handle-a-database-offline-condition"></a><span data-ttu-id="4f04f-129">データベースがオフラインの状態を処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-129">Handle a Database-Offline Condition</span></span>  
 <span data-ttu-id="4f04f-130">BizTalk Server データベースの 1 つがオフラインになった場合、BizTalk サービスでは、自体がリサイクルされます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-130">If one of the BizTalk Server databases goes offline, the BizTalk service recycles itself.</span></span> <span data-ttu-id="4f04f-131">メッセージング エンジンは、サービスのリサイクルの前に、すべての受信場所をシャット ダウンするために最適な努力します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-131">The Messaging Engine makes a best effort to shut down all of the receive locations before recycling the service.</span></span> <span data-ttu-id="4f04f-132">この時間が 60 秒を超える、サービスが終了します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-132">If this takes longer than 60 seconds, the service terminates.</span></span> <span data-ttu-id="4f04f-133">エンジンのトランザクションはために、データの損失は発生しません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-133">Because the engine is transacted, this does not cause data loss.</span></span>  
  
 <span data-ttu-id="4f04f-134">このタイムアウトは、キーを使用してレジストリに調整できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-134">This time-out can be tuned in the registry by using the key:</span></span>  
  
```  
DWORD   
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\BTSSvc{Host Guid}\MessagingDBFailoverShutdownTimeLimit  
```  
  
 <span data-ttu-id="4f04f-135">分離アダプターの場合は BizTalk Server は、プロセスを所有していないため、受信場所が無効に BizTalk Server データベースの 1 つがオフラインになったときです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-135">For isolated adapters, because BizTalk Server does not own the process, the receive locations are disabled when one of the BizTalk Server databases goes offline.</span></span> <span data-ttu-id="4f04f-136">これらの受信場所、データベースがオンラインに戻った後に再び有効にします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-136">After the database comes back online those receive locations are re-enabled.</span></span>  
  
## <a name="write-to-the-event-log"></a><span data-ttu-id="4f04f-137">イベント ログに書き込む</span><span class="sxs-lookup"><span data-stu-id="4f04f-137">Write to the Event Log</span></span>  
 <span data-ttu-id="4f04f-138">使用して、アダプターがイベント ログ エントリを書き込むことができます、 **IBTTransportProxy**例外で渡すインターフェイス。</span><span class="sxs-lookup"><span data-stu-id="4f04f-138">The adapter can write event log entries by using the **IBTTransportProxy** interface passing in an exception.</span></span> <span data-ttu-id="4f04f-139">ネイティブ コードで開発されたアダプターを渡す必要があります、 **IErrorInfo**インターフェイス、 **IBTTransportProxy.SetErrorInfo (例外** `e` **)** します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-139">Adapters developed in native code need to pass in an **IErrorInfo** interface, **IBTTransportProxy.SetErrorInfo( Exception** `e` **)**.</span></span>  
  
 <span data-ttu-id="4f04f-140">メッセージング エンジンでは、アダプターに代わってイベントのイベント ログに書き込みます送信の失敗後のメッセージが、バックアップ トランスポートにメッセージを移動します。 または、メッセージを中断するアダプターの再試行時になど。</span><span class="sxs-lookup"><span data-stu-id="4f04f-140">The Messaging Engine writes to the event log on behalf of the adapter for events such as when an adapter retries a message after transmission failure, moves a message to its backup transport, or suspends a message.</span></span> <span data-ttu-id="4f04f-141">など、これらの操作、アダプターは、API を呼び出す前に、メッセージで例外を設定するだけ済みます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-141">For operations such as these the adapter only needs to set the exception on the message before calling the API.</span></span> <span data-ttu-id="4f04f-142">次のコード フラグメントでは、これを示しています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-142">The following code fragment demonstrates this:</span></span>  
  
```  
IBaseMessage msg;  
...  
// Set exception on msg to indicate why transmission failed...  
msg.SetErrorInfo(  
 new ApplicationException(  
 "The TCP connection was closed by the destination"));  
```  
  
## <a name="handle-receive-specific-batch-errors"></a><span data-ttu-id="4f04f-143">受信に固有のバッチ エラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-143">Handle Receive-Specific Batch Errors</span></span>  
  
### <a name="handle-receive-failures"></a><span data-ttu-id="4f04f-144">ハンドルの受信エラー数</span><span class="sxs-lookup"><span data-stu-id="4f04f-144">Handle Receive Failures</span></span>  
 <span data-ttu-id="4f04f-145">アダプター操作 (または操作のバッチ) を BizTalk Server に送信するときは、障害のさまざまな理由があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-145">When an adapter submits an operation (or batch of operations) to BizTalk Server there can be various reasons for failure.</span></span> <span data-ttu-id="4f04f-146">最も重要な 2 つは次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-146">The two most significant are:</span></span>  
  
- <span data-ttu-id="4f04f-147">受信パイプラインが失敗しました。</span><span class="sxs-lookup"><span data-stu-id="4f04f-147">The receive pipeline failed.</span></span>  
  
- <span data-ttu-id="4f04f-148">メッセージの発行中に、ルーティングの障害が発生しました。</span><span class="sxs-lookup"><span data-stu-id="4f04f-148">A routing failure occurred while publishing a message.</span></span>  
  
  <span data-ttu-id="4f04f-149">メッセージング エンジンは、受信パイプラインが失敗した場合、メッセージの中断を自動的に試みます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-149">The Messaging Engine automatically tries to suspend the message when it gets a receive pipeline failure.</span></span> <span data-ttu-id="4f04f-150">中断操作は常に失敗します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-150">The suspend operation may not always be successful.</span></span> <span data-ttu-id="4f04f-151">など、メッセージング エンジンでは、メッセージの発行中にルーティング エラーが発生する場合、エンジンも行われませんメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-151">For example, if the Messaging Engine hits a routing failure while publishing a message, then the engine does not even try to suspend the message.</span></span>  
  
  <span data-ttu-id="4f04f-152">メッセージが失敗する可能性が常にあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-152">It is always possible that a message will fail.</span></span> <span data-ttu-id="4f04f-153">このような場合は、アダプターは呼び出す必要があります明示的に、 **MoveToSuspendQ** API と、メッセージの中断を試行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-153">In such a situation, the adapter should explicitly call the **MoveToSuspendQ** API and should try to suspend the message.</span></span> <span data-ttu-id="4f04f-154">アダプターがメッセージを保留しようとすると、次のいずれかが該当します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-154">When an adapter tries to suspend a message, one of the following should be true:</span></span>  
  
- <span data-ttu-id="4f04f-155">同じメッセージ オブジェクトをアダプターの送信 (推奨) を中断する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-155">The same message object that the adapter submitted (recommended) should be suspended.</span></span>  
  
- <span data-ttu-id="4f04f-156">場合は、アダプターは、新しいメッセージを作成するには、最初に送信されたメッセージのメッセージ コンテキストにポインターを含む新しいメッセージのメッセージ コンテキストを設定があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-156">If the adapter has to create a new message, then it should set the message context of the new message with the pointer to the message context of the message that was originally submitted.</span></span> <span data-ttu-id="4f04f-157">これは、メッセージのメッセージ コンテキストに、メッセージとエラーに関する有用な情報の多くがあるためにです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-157">This is because the message context of a message has a lot of valuable information about the message and the failure.</span></span> <span data-ttu-id="4f04f-158">失敗したメッセージをデバッグするには、この情報が必要です。</span><span class="sxs-lookup"><span data-stu-id="4f04f-158">This information is required to debug the failed message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="4f04f-159">アダプターが新しいメッセージ オブジェクトを作成して、中断した場合、アダプターする必要がありますオブジェクトにコピー エラー情報、古いメッセージ オブジェクトから新しいメッセージ。</span><span class="sxs-lookup"><span data-stu-id="4f04f-159">If the adapter creates a new message object and suspends it, the adapter should copy the error information from the old message object to the new message object.</span></span>  
  
 <span data-ttu-id="4f04f-160">BizTalk Server で提供される HTTP アダプターなど、一部のアダプターでは、メッセージが中断されますは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-160">Some adapters, such as the HTTP adapter provided with BizTalk Server, do not require that the message be suspended.</span></span> <span data-ttu-id="4f04f-161">これらのアダプターをクライアントにエラーを返すことができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-161">These adapters can return an error back to their client.</span></span>  
  
#### <a name="causes-of-failure"></a><span data-ttu-id="4f04f-162">エラーの原因</span><span class="sxs-lookup"><span data-stu-id="4f04f-162">Causes of failure</span></span>  
 <span data-ttu-id="4f04f-163">エラーの簡単な原因は次のように、バッチを構築、またはときに発生するエラー **ibttransportbatch::done**が呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-163">Simple causes of failure are the errors that can occur as the batch is constructed or when **IBTTransportBatch::Done** is called.</span></span>  
  
-   <span data-ttu-id="4f04f-164">**発信に失敗しました。**</span><span class="sxs-lookup"><span data-stu-id="4f04f-164">**Submit failure.**</span></span> <span data-ttu-id="4f04f-165">**送信**呼び出しが失敗の理由の数を制限して、そのすべてが致命的な。</span><span class="sxs-lookup"><span data-stu-id="4f04f-165">The **Submit** call can fail for a limited number of reasons, and all of them are fatal.</span></span> <span data-ttu-id="4f04f-166">これらの理由は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-166">These reasons include:</span></span>  
  
-   <span data-ttu-id="4f04f-167">BizTalk Server のプロセス領域で発生するメモリ不足のエラー。</span><span class="sxs-lookup"><span data-stu-id="4f04f-167">Out-of-memory errors occurring in the BizTalk Server process space.</span></span>  
  
-   <span data-ttu-id="4f04f-168">展開から、スキーマ アセンブリが削除されました。</span><span class="sxs-lookup"><span data-stu-id="4f04f-168">The schema assembly has been dropped from the deployment.</span></span> <span data-ttu-id="4f04f-169">ここで、**送信**わかりにくいエラーで失敗します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-169">In this case, the **Submit** fails with a cryptic error.</span></span> <span data-ttu-id="4f04f-170">MQSeries アダプターで、BizTalk Server から一般的なエラー例外をキャッチすると、および拡張エラー メッセージが、システム イベント ログに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-170">In the MQSeries adapter, the generic failure exception from BizTalk Server is caught, and an extended error message is written in the system event log.</span></span> <span data-ttu-id="4f04f-171">このメッセージは、スキーマ アセンブリが何らかの方法で、展開から削除されたことには、エラーの考えられる原因の 1 つをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-171">This message suggests that one of the possible causes of the error is that the schema assembly has somehow been dropped from the deployment.</span></span>  
  
     <span data-ttu-id="4f04f-172">一般的で**送信**が失敗したのと同じトランザクションを使用してメッセージを中断しようとする必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-172">In general, if **Submit** fails you should try to suspend the message using the same transaction.</span></span>  
  
-   <span data-ttu-id="4f04f-173">**Ibttransportbatch::done の失敗。**</span><span class="sxs-lookup"><span data-stu-id="4f04f-173">**IBTTransportBatch::Done failure.**</span></span> <span data-ttu-id="4f04f-174">**Ibttransportbatch::done**いくつかの理由の 1 つの呼び出しが失敗します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-174">The **IBTTransportBatch::Done** call can fail for one of several reasons.</span></span> <span data-ttu-id="4f04f-175">一般に、常に 1 回試行する必要があり、中断操作が失敗した場合にのみ、トランザクションを終了します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-175">In general, you should always attempt one suspend operation and end the transaction only if that fails.</span></span> <span data-ttu-id="4f04f-176">いずれかのエラー コードの障害から受信する可能性があります**ibttransportbatch::done** BizTalk Server がシャット ダウンしようとしていることができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-176">One of the error codes you might receive from the failure of **IBTTransportBatch::Done** is that BizTalk Server is trying to shut down.</span></span> <span data-ttu-id="4f04f-177">ここでは、どうかだけにトランザクションを終了し、ためにのままに、 **Terminate**呼び出しが同時に行われている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-177">In this case, you should just end the transaction and leave it because the **Terminate** call is probably happening concurrently.</span></span> <span data-ttu-id="4f04f-178">バッチを適切に構築して正常に実行されるときに、その他のシナリオが発生する**ibttransportbatch::done**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-178">Other scenarios occur when you have successfully constructed the batch and successfully executed **IBTTransportBatch::Done**.</span></span> <span data-ttu-id="4f04f-179">このような場合、エラーが返される**BatchComplete**とアダプターは、それらの処理方法を決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-179">In these cases, the errors are returned in **BatchComplete** and the adapter must determine what to do with them.</span></span> <span data-ttu-id="4f04f-180">このセクションの残りの部分は、このケースを処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-180">The rest of this section deals with this case.</span></span>  
  
#### <a name="processing-batchcomplete-errors"></a><span data-ttu-id="4f04f-181">BatchComplete エラーの処理</span><span class="sxs-lookup"><span data-stu-id="4f04f-181">Processing BatchComplete errors</span></span>  
 <span data-ttu-id="4f04f-182">**BatchComplete**をバッチ操作の完了状態を示すために BizTalk Server によって呼び出されるアダプターによって提供されるコールバックです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-182">**BatchComplete** is a callback provided by the adapter that is invoked by BizTalk Server to indicate the completion status of a batch operation.</span></span>  
  
 <span data-ttu-id="4f04f-183">渡される最も重要なパラメーター **BatchComplete** 、バッチの状態は、`hResult`します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-183">The most important parameter passed to **BatchComplete** is the batch status `hResult`.</span></span> <span data-ttu-id="4f04f-184">これは、バッチの成功または失敗を示します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-184">This indicates success or failure for the batch.</span></span> <span data-ttu-id="4f04f-185">バッチが失敗した場合は、none、バッチ内の操作の成功したことを意味します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-185">If the batch failed, it means that none of the operations in the batch succeeded.</span></span> <span data-ttu-id="4f04f-186">アダプターがバッチの状態の構造を通過し、メッセージの失敗を判断します (これと呼ばれます*バッチのフィルター処理*)。</span><span class="sxs-lookup"><span data-stu-id="4f04f-186">The adapter goes through the batch status structure and determines which messages failed (this is known as *filtering the batch*).</span></span>  
  
#### <a name="nontransactional-batchcomplete-errors"></a><span data-ttu-id="4f04f-187">非トランザクション BatchComplete エラー</span><span class="sxs-lookup"><span data-stu-id="4f04f-187">Nontransactional BatchComplete errors</span></span>  
 <span data-ttu-id="4f04f-188">非トランザクション アダプターの場合のエラーが発生した場合、応答を選択する必要があります、 **SubmitMessage**/**SubmitRequestMessage**または**SubmitResponseMessage**操作。</span><span class="sxs-lookup"><span data-stu-id="4f04f-188">For nontransactional adapters, you must choose your response if a failure occurs for a **SubmitMessage**/**SubmitRequestMessage** or **SubmitResponseMessage** operation.</span></span> <span data-ttu-id="4f04f-189">アダプターが呼び出すことによって、メッセージを中断する通常**MoveToSuspendQ**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-189">Typically adapters suspend the message by calling **MoveToSuspendQ**.</span></span>  
  
 <span data-ttu-id="4f04f-190">次の操作は常に渡すことが。**DeleteMessage**、 **MoveToSuspendQ**、 **ResubmitMessage**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-190">The following operations are always expected to pass: **DeleteMessage**, **MoveToSuspendQ**, **ResubmitMessage**.</span></span> <span data-ttu-id="4f04f-191">これらの操作が失敗した場合は、通常、アダプターにバグがあることを意味します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-191">If these operations fail, it typically means that there is a bug in the adapter.</span></span> <span data-ttu-id="4f04f-192">このような場合の障害に対処するコードを記述する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-192">You do not have to write code to handle a failure in these cases.</span></span> <span data-ttu-id="4f04f-193">ただし別の操作が失敗したため、バッチが失敗した場合、これらの操作があります、新しいバッチで再実行します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-193">However if the batch failed because another operation failed, then these operations must be re-executed in a fresh batch.</span></span>  
  
 <span data-ttu-id="4f04f-194">アダプターが呼び出す場合**MovetoBackupTransport** (バックアップ トランスポートがないため) 失敗すると、アダプターが呼び出す必要があります**MoveToSuspendQ**にメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-194">If the adapter calls **MovetoBackupTransport** and that fails (because there was no backup transport), then the adapter should call **MoveToSuspendQ** to suspend the message.</span></span>  
  
#### <a name="transactional-batchcomplete-errors"></a><span data-ttu-id="4f04f-195">トランザクション BatchComplete エラー</span><span class="sxs-lookup"><span data-stu-id="4f04f-195">Transactional BatchComplete errors</span></span>  
 <span data-ttu-id="4f04f-196">アダプターによって作成されたトランザクションを使用して BizTalk Server にバッチを送信するときにこれら 2 つのシナリオのいずれかに従う必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-196">When you submit batches to BizTalk Server using a transaction created by the adapter, you should follow one of these two scenarios:</span></span>  
  
-   <span data-ttu-id="4f04f-197">**単一メッセージのバッチを使用します。**</span><span class="sxs-lookup"><span data-stu-id="4f04f-197">**Use single-message batches.**</span></span> <span data-ttu-id="4f04f-198">BizTalk Server には、単一メッセージ バッチを送信します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-198">Send a single-message batch to BizTalk Server.</span></span> <span data-ttu-id="4f04f-199">その 1 つのメッセージが失敗した場合、し、合法的に送信できます BizTalk Server で、同じトランザクションで 2 番目のバッチが問題のあるメッセージを再送信するのではなく、保留キューに移動する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-199">If that single message fails, then you can legally send BizTalk Server a second batch under the same transaction, but you must move the offending message to the Suspended queue rather than resubmitting it.</span></span> <span data-ttu-id="4f04f-200">失敗したメッセージが削除されると、2 番目のバッチの送信は成功します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-200">After the failed message is removed, the submission of the second batch should succeed.</span></span> <span data-ttu-id="4f04f-201">トランザクションをコミットするには、BizTalk Server では、ことを確認するときに発生した後は、2 番目のバッチが成功しました。</span><span class="sxs-lookup"><span data-stu-id="4f04f-201">After that occurs you can commit the transaction when BizTalk Server confirms that the second batch was successful.</span></span> <span data-ttu-id="4f04f-202">2 番目のバッチが失敗した場合、アダプターが、トランザクションを中止またはそのメッセージを配置する他の場所を検索する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-202">If the second batch fails, the adapter must abort the transaction, or find somewhere else to place that message.</span></span> <span data-ttu-id="4f04f-203">このシナリオでは、すぐにパフォーマンスに大きなトランザクションのロールバック処理が原因の影響を有効します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-203">In this scenario, you immediately take a significant performance hit due to transaction rollback processing.</span></span>  
  
     <span data-ttu-id="4f04f-204">アダプターのパフォーマンスを向上させるために使用できるいくつかの方法はあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-204">There are some techniques that you can use to improve the performance of the adapter.</span></span> <span data-ttu-id="4f04f-205">たとえば、MQSeries アダプターは実行時にその手法を動的に調整します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-205">For example, the MQSeries adapter adjusts its approach dynamically at run time.</span></span> <span data-ttu-id="4f04f-206">これは、100 メッセージのバッチを実行します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-206">It runs with 100-message batches.</span></span> <span data-ttu-id="4f04f-207">エラーが発生すると、バッチを終了する必要がありますが、過去の問題のあるメッセージの取得に短時間の単一メッセージのバッチに切り替わります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-207">If it hits an error, it must end the batch, but it switches to single-message batches for a short time as it gets past the bad message.</span></span> <span data-ttu-id="4f04f-208">後、100 メッセージのバッチに戻されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-208">It then reverts to 100-message batches.</span></span> <span data-ttu-id="4f04f-209">もう一度、エラーが発生する場合は、もう一度ダウンを低下します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-209">If it hits the error again, it slows down again.</span></span>  
  
-   <span data-ttu-id="4f04f-210">**プリエンプティブ中断を使用します。**</span><span class="sxs-lookup"><span data-stu-id="4f04f-210">**Use preemptive suspension.**</span></span> <span data-ttu-id="4f04f-211">エラーがあるメッセージは中断されて事前複数メッセージのバッチを構築します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-211">Construct a multi-message batch in which the erroneous messages are preemptively suspended.</span></span> <span data-ttu-id="4f04f-212">バッチが混在**送信**と**MoveToSuspendQ**操作では、最初で唯一のバッチ、トランザクションとします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-212">The batch contains a mix of **Submit** and **MoveToSuspendQ** operations, and is the first and only batch under the transaction.</span></span> <span data-ttu-id="4f04f-213">それは、不適切なデータが中断された事前 (BizTalk Server から、確認を待っている) した後、トランザクションをコミットできるために成功する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-213">It should succeed because the bad data was preemptively suspended, and the transaction can be committed (after waiting to receive the confirmation from BizTalk Server).</span></span>  
  
     <span data-ttu-id="4f04f-214">要求するように見えるかもしれませんが、この手法は、MSMQ アダプターで使用されています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-214">This might seem to require looking into the future, but this technique has been used in the MSMQ adapter.</span></span> <span data-ttu-id="4f04f-215">確実に一意のメッセージ Id があることに依存します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-215">It depends on having reliably unique message IDs.</span></span> <span data-ttu-id="4f04f-216">このアダプターは、メッセージのバッチを構築します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-216">This adapter constructs a batch of messages.</span></span> <span data-ttu-id="4f04f-217">エラーが発生した場合、ロールはトランザクション (およびそのため、バッチ) をバックアップが、一時的なデータ構造内のメッセージ ID を記憶します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-217">If anything fails it rolls back the transaction (and therefore the batch), but remembers the message ID in a temporary data structure.</span></span> <span data-ttu-id="4f04f-218">(この構造体が、無制限に大きくをするを防ぐために項目が削除されます一定の遅延時間。)各バッチが送信される前に、アダプターは不適切なメッセージ Id の一覧を確認します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-218">(To prevent this structure from growing indefinitely, items in it are removed after some fixed time delay.) Before each batch is submitted, the adapter checks the list of bad message IDs.</span></span> <span data-ttu-id="4f04f-219">いずれかの場合、そのメッセージが失敗 (エラーのため、これまでに 1 回) し、プリエンプティブ中断ことがなく送信しようとしています。 を認識します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-219">If it sees one, it knows that message will fail (because it failed once in the past), and preemptively suspends it rather than trying to submit it.</span></span>  
  
     <span data-ttu-id="4f04f-220">すべてのアダプターが確実に一意のメッセージ ID を持つし、トランザクション ストアが 1 つの可能性は低くします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-220">Not every adapter has a reliably unique message ID, and a transactional store is less likely to have one.</span></span> <span data-ttu-id="4f04f-221">このため、多くのトランザクション アダプターでは、単一メッセージ バッチの送信に制限されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-221">Because of this, many transactional adapters are restricted to sending single-message batches.</span></span>  
  
#### <a name="processing-other-errors"></a><span data-ttu-id="4f04f-222">その他のエラーの処理</span><span class="sxs-lookup"><span data-stu-id="4f04f-222">Processing other errors</span></span>  
 <span data-ttu-id="4f04f-223">メッセージ中断中のエラー) などの他のすべての場合、アダプターは、トランザクションを終了する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-223">In all other cases (such as failures in suspending messages), the adapter must end the transaction.</span></span> <span data-ttu-id="4f04f-224">その他の結果は、重複するか、破棄されたメッセージで発生します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-224">Any other outcome results in either duplicate or dropped messages.</span></span>  
  
 <span data-ttu-id="4f04f-225">アダプターができるたびに、バッチが失敗した場合、トランザクションを中止する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-225">Whenever the adapter can, it should abort the transaction if a batch fails.</span></span> <span data-ttu-id="4f04f-226">ただし、アダプターがトランザクションを中止できないシナリオがあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-226">However there are scenarios where the adapter cannot abort the transaction.</span></span> <span data-ttu-id="4f04f-227">このようなシナリオで同じトランザクションを使用してメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-227">In such a scenario it should suspend the message using the same transaction.</span></span>  
  
#### <a name="processing-errors-on-transactional-receive"></a><span data-ttu-id="4f04f-228">トランザクションで処理エラーが表示されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-228">Processing errors on transactional receive</span></span>  
 <span data-ttu-id="4f04f-229">トランザクション処理の一般的なパターンでは、エラーが発生したときにトランザクションを終了します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-229">A common transactional processing pattern is to end a transaction when an error occurs.</span></span> <span data-ttu-id="4f04f-230">ここですべてのものを返しますを以前の状態とデータは失われません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-230">In this case everything returns to its previous state and no data is lost.</span></span> <span data-ttu-id="4f04f-231">ただし、(データベースでは、ステージング テーブルから一度に 1 行を取得または MQSeries または MSMQ などのキューイング製品から一度に 1 つのメッセージをプルなど) のトランザクションのフィードからデータを利用する場合、この可能性がありますできません十分です。</span><span class="sxs-lookup"><span data-stu-id="4f04f-231">However, if you are consuming data from a transactional feed (for example, pulling a row at a time from a staging table in a database, or pulling one message at a time from a queuing product like MQSeries or MSMQ), then this might not be enough.</span></span> <span data-ttu-id="4f04f-232">単に、トランザクションを終了する戻るし、同じデータを取得、同じエラーが発生する可能性が、もう一度と、ループの繰り返しでシステムが停止します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-232">If you simply end the transaction and go back and pick up the same data again, the same error is likely to occur and the system becomes stuck in a repeated loop.</span></span>  
  
 <span data-ttu-id="4f04f-233">BizTalk Server の以前のバージョンの SQL アダプターは、この動作で付属しています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-233">The SQL adapter in an earlier version of BizTalk Server shipped with this behavior.</span></span> <span data-ttu-id="4f04f-234">ただし、リリース後間もなく、アダプターの動作が失敗したメッセージを中断し、トランザクションをコミットしようとする変更されました。</span><span class="sxs-lookup"><span data-stu-id="4f04f-234">However, soon after release the adapter behavior was changed to attempt to suspend a failed message and commit the transaction.</span></span> <span data-ttu-id="4f04f-235">同じトランザクションで保留キューにメッセージを移動し、トランザクションをコミットは、損失を防止データが保存され、アダプターが過去の不適切なデータを取得することができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-235">Moving a message to the Suspended queue under the same transaction and then committing the transaction saves the data from being lost and also allows the adapter to get past bad data.</span></span>  
  
 <span data-ttu-id="4f04f-236">アダプターの受信部分が渡された場合、エラー メッセージに応答を**送信**メッセージ操作では、アダプターがそのエラーを処理し、メッセージを保留キューに移動する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-236">When the receive portion of an adapter is passed an error message in response to a **Submit** message operation, the adapter should process that error and move the message to the Suspended queue.</span></span>  
  
 <span data-ttu-id="4f04f-237">トランザクション オブジェクトが作成し、トランザクションでメッセージを送信アダプターのトランザクション バッチは、の場合、アダプター論理的に移動メッセージ同じトランザクションで保留キューにエラー発生時にします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-237">In the case of transactional batches in which the adapter has created the transaction object and submits messages under the transaction, the adapter should logically move the message to the Suspended queue under the same transaction when failures occur.</span></span> <span data-ttu-id="4f04f-238">トランザクションにより、データが削除されないことと、エラーの原因となっているものデータを削除することはありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-238">The transaction ensures that data is not dropped, and even data that is causing an error should never be dropped.</span></span>  
  
### <a name="handle-messages-without-subscriptions"></a><span data-ttu-id="4f04f-239">サブスクリプションを使用しないメッセージを処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-239">Handle Messages without Subscriptions</span></span>  
 <span data-ttu-id="4f04f-240">BizTalk Server では、それを受け入れるように定義されたサブスクリプションがない場合、メッセージ ボックス データベースに発行されるメッセージは受け入れられません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-240">BizTalk Server does not accept a message to be published in its MessageBox database if there are no subscriptions defined to accept it.</span></span> <span data-ttu-id="4f04f-241">サブスクリプションは、いずれかのオーケストレーションによって登録されているまたは送信ポート。</span><span class="sxs-lookup"><span data-stu-id="4f04f-241">Subscriptions are registered by either orchestrations or send ports.</span></span> <span data-ttu-id="4f04f-242">複数の送信先にメッセージを送信する場合、複数のサブスクリプションを定義できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-242">Multiple subscriptions can be defined, in which case the message is sent to multiple destinations.</span></span> <span data-ttu-id="4f04f-243">サブスクリプションが存在しない場合、BizTalk Server はメッセージを拒否し、中断を試行しません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-243">If there are no subscriptions, BizTalk Server rejects the message and does not attempt to suspend it.</span></span> <span data-ttu-id="4f04f-244">アダプターはいないこのエラーを処理し、明示的にメッセージを中断する場合、は、メッセージを削除し、データが失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-244">If the adapter does not handle this error and explicitly suspend the message, then the message is dropped and its data is potentially lost.</span></span> <span data-ttu-id="4f04f-245">もちろんトランザクション アダプターは、トランザクションを終了し、その宛先にメッセージが返される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-245">Of course a transactional adapter may end the transaction and return the message to its destination.</span></span>  
  
### <a name="support-seek-with-your-receive-stream"></a><span data-ttu-id="4f04f-246">シーク、受信 Stream のサポート</span><span class="sxs-lookup"><span data-stu-id="4f04f-246">Support Seek with Your Receive Stream</span></span>  
 <span data-ttu-id="4f04f-247">受信側ストリームをサポートする必要があります、**シーク**のパイプライン エラー メッセージを中断できる BizTalk Server 用のメソッド。</span><span class="sxs-lookup"><span data-stu-id="4f04f-247">The receive-side stream must support the **Seek** method for BizTalk Server to be able to suspend the message on a pipeline failure.</span></span> <span data-ttu-id="4f04f-248">メッセージ ストリームはシーク不可能としている場合、BizTalk Server を実行する際にエラーが発生**シーク**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-248">If the message stream is not seekable, then BizTalk Server generates an error when it tries to run **Seek**.</span></span>  
  
 <span data-ttu-id="4f04f-249">多くの場合をサポートしている**シーク**簡単ではありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-249">In many cases supporting **Seek** is not easy.</span></span> <span data-ttu-id="4f04f-250">ネットワークからデータをストリーミングする場合などがあります、ネットワーク リソースに戻るし、データを再度要求が困難。</span><span class="sxs-lookup"><span data-stu-id="4f04f-250">When streaming data from a network, for example, it may be difficult to go back to the network resource and request the data again.</span></span>  
  
 <span data-ttu-id="4f04f-251">BizTalk Server に付属している複数のアダプターは、BizTalk Server には、データが読み取られると、ディスク上のファイルにメッセージ データを同時にスプールされます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-251">Several adapters that ship with BizTalk Server spool the message data onto a file on disk at the same time as BizTalk Server reads the data.</span></span> <span data-ttu-id="4f04f-252">これにより、使用するアダプター**シーク**(たとえば、メッセージ データのパイプライン処理) でエラーが発生した場合は、そのファイルにします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-252">This allows the adapter to use **Seek** on that file if it encounters an error (in the pipeline processing of the message data, for example).</span></span> <span data-ttu-id="4f04f-253">内部的には、アダプターを使用して、 **ReadOnlySeekableStream**クラスを着信シーク可能ではないストリームをラップし、構成可能なサイズのしきい値に達したときに、ディスクにオーバーフローが発生します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-253">Internally the adapter uses the **ReadOnlySeekableStream** class that wraps an incoming non-seekable stream and overflows to disk when a configurable size threshold is reached.</span></span> <span data-ttu-id="4f04f-254">メッセージのしきい値のサイズより小さい場合は、ディスクに保存されません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-254">For messages smaller than the threshold size, the disk is never hit.</span></span>  
  
### <a name="consider-user-configurable-error-handling-options"></a><span data-ttu-id="4f04f-255">ユーザー構成可能なエラー処理オプションを検討してください。</span><span class="sxs-lookup"><span data-stu-id="4f04f-255">Consider User-Configurable Error-Handling Options</span></span>  
 <span data-ttu-id="4f04f-256">エラーに 1 つ正しい応答がありませんがある場合があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-256">Sometimes there is no one correct response to an error.</span></span> <span data-ttu-id="4f04f-257">この場合、動作の間で選択するユーザー構成可能なオプションを検討してください。</span><span class="sxs-lookup"><span data-stu-id="4f04f-257">In this case, you should consider a user-configurable option to choose between behaviors.</span></span> <span data-ttu-id="4f04f-258">MQSeries アダプターで行われます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-258">The MQSeries adapter does this.</span></span>  
  
 <span data-ttu-id="4f04f-259">エラーが発生したときにメッセージを中断するアダプターを装着問題は、BizTalk Server の保留キューは、「ブラック ホール」のものです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-259">The problem with having the adapter suspend messages when it sees an error is that the Suspended queue in BizTalk Server is something of a "black hole."</span></span> <span data-ttu-id="4f04f-260">取り出すことが困難になりますが、キューにメッセージを取得するは比較的簡単になります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-260">It is relatively easy to get messages into the queue, but harder to get them out again.</span></span>  
  
 <span data-ttu-id="4f04f-261">アダプターの一部のユーザーが保留キューにまったく必要としません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-261">Some users of the adapter might not want anything in the Suspended queue.</span></span> <span data-ttu-id="4f04f-262">など、MQSeries アダプターの場合、ユーザーでは、次のいずれかを実行するオプションが提供されます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-262">For example, in the case of the MQSeries adapter, the user is offered a configuration option to do one of the following:</span></span>  
  
-   <span data-ttu-id="4f04f-263">現在のトランザクションを終了し、エラーを見つけた場合自体が無効にするアダプターを設定します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-263">Set the adapter to end the current transaction and disable itself when it sees an error.</span></span>  
  
-   <span data-ttu-id="4f04f-264">失敗したメッセージを中断し、トランザクションをコミットします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-264">Suspend the failed message and commit the transaction.</span></span> <span data-ttu-id="4f04f-265">アダプターは BizTalk Server がメッセージを正常に中断された場合でも、します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-265">The adapter does this even when BizTalk Server has successfully suspended the message.</span></span> <span data-ttu-id="4f04f-266">このアクションは、イベント ログが厳密に正しくないが発生する場合でも、顧客の要件を満たしています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-266">This action meets the requirements of the customer even if it causes the event log to not be strictly correct.</span></span>  
  
### <a name="implement-receive-ordering-by-using-a-single-thread-and-waiting-on-batchcomplete"></a><span data-ttu-id="4f04f-267">受信を 1 つを使用して順序スレッドと BatchComplete を待機しています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-267">Implement Receive Ordering by Using a Single Thread and Waiting on BatchComplete</span></span>  
 <span data-ttu-id="4f04f-268">BizTalk Server へのインターフェイスは、パフォーマンスと、同時実行をサポートすることでスケール アウトする機能向けです。</span><span class="sxs-lookup"><span data-stu-id="4f04f-268">The interface to BizTalk Server is designed for performance and the ability to scale out by supporting concurrency.</span></span> <span data-ttu-id="4f04f-269">ただし、(MQSeries、MSMQ などのメッセージ キュー製品からメッセージを受信するときは、必要な場合があります)、メッセージの受信を厳密に順序付けられた場合は、同時実行の一部を無効にするアダプターの追加の作業を行う必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-269">However, if you want a strictly ordered receive of messages (as is sometimes required when receiving messages from a message queue product like MQSeries or MSMQ), then you must do some additional work in the adapter to disable some of that concurrency.</span></span> <span data-ttu-id="4f04f-270">これは、2 つの手順で実行できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-270">This can be done in two steps:</span></span>  
  
1. <span data-ttu-id="4f04f-271">アダプターのすべてのデータ処理の 1 つのスレッドを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-271">You must use a single thread for all the data processing in the adapter.</span></span>  
  
2. <span data-ttu-id="4f04f-272">各バッチの処理を完了する BizTalk Server を待つ必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-272">You must wait for BizTalk Server to completely process each batch.</span></span> <span data-ttu-id="4f04f-273">この要件は、重要な .NET スレッド同期プリミティブを使用して実現できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-273">This requirement is important and can be accomplished by using .NET thread synchronization primitives.</span></span> <span data-ttu-id="4f04f-274">たとえばを使用して、 **AutoResetEvent**の場合します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-274">For example, using an **AutoResetEvent**, you would:</span></span>  
  
   -   <span data-ttu-id="4f04f-275">メイン ワーカー スレッドによってアクセスできるイベント オブジェクトを宣言し、 **BatchComplete**コールバック オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="4f04f-275">Declare the event object where it can be accessed by both the main worker thread and the **BatchComplete** callback object.</span></span>  
  
   -   <span data-ttu-id="4f04f-276">メイン ワーカー スレッドで、バッチにメッセージを通常どおり送信が呼び出して**した**バッチへの呼び出しの直前に、イベント オブジェクトに対して**ibttransportbatch::done**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-276">On the main worker thread, submit the messages to the batch as usual but then call **AutoResetEvent.Reset** on the event object just before the call to the batch **IBTTransportBatch::Done**.</span></span>  
  
   -   <span data-ttu-id="4f04f-277">呼び出す**AutoResetEvent.WaitOne**でこの同じスレッドからイベント オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="4f04f-277">Call **AutoResetEvent.WaitOne** on the event object from this same thread.</span></span> <span data-ttu-id="4f04f-278">これによって、メイン ワーカー スレッドがブロックされます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-278">This causees the main worker thread to block.</span></span> <span data-ttu-id="4f04f-279">**BatchComplete** BizTalk Server からのコールバックを呼び出して**AutoResetEvent.Set**同じイベント オブジェクトを別のメッセージを処理できるように、ワーカー スレッドのブロックを解除します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-279">In the **BatchComplete** callback from BizTalk Server you then call **AutoResetEvent.Set** on the same event object to unblock the worker thread so it is ready to process another message.</span></span>  
  
   <span data-ttu-id="4f04f-280">強くお勧めする*受信の順序付け*パフォーマンスが著しく低下するので、構成可能なこのできるようにします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-280">It is strongly suggested that *receive ordering* like this be made configurable because it causes significant performance degradation.</span></span> <span data-ttu-id="4f04f-281">ユーザーのほとんどではない場合は、多くのシナリオでは、メッセージの順序付けは必要ありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-281">Many, if not most, user scenarios do not require ordering of messages.</span></span> <span data-ttu-id="4f04f-282">メッセージを中断するには、順序付けも改ページします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-282">Suspending messages can also break ordering.</span></span> <span data-ttu-id="4f04f-283">でしょうは、ユーザーの構成ポイントを提供するので、最善のため、アダプターをアプリケーションに依存する、ここでは。</span><span class="sxs-lookup"><span data-stu-id="4f04f-283">Exactly what to do in this case is application-dependent, so the best thing for your adapter to do is to offer the user a configuration point.</span></span>  
  
   <span data-ttu-id="4f04f-284">順序付けられた場合は、一部のお客様とを処理を停止は、アダプターを無効にするにはなく、順序付けを解除する希望が述べています。</span><span class="sxs-lookup"><span data-stu-id="4f04f-284">In ordered scenarios, some customers have stated that they would prefer to stop the processing, that is, disable the adapter, rather than break ordering.</span></span> <span data-ttu-id="4f04f-285">MQSeries アダプターは、サポートする受信の順序付けは、ユーザーにこのオプションを提供します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-285">The MQSeries adapter, which supports ordered receive, provides this option to the user.</span></span>  
  
## <a name="handle-send-specific-batch-errors"></a><span data-ttu-id="4f04f-286">特定の送信バッチ エラーを処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-286">Handle Send-Specific Batch Errors</span></span>  
  
### <a name="handle-send-retry-and-batching"></a><span data-ttu-id="4f04f-287">送信再試行とバッチ処理します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-287">Handle Send Retry and Batching</span></span>  
 <span data-ttu-id="4f04f-288">送信側のバッチ処理の典型的な例を次に示します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-288">Here is a typical example of send-side batching:</span></span>  
  
- <span data-ttu-id="4f04f-289">BizTalk Server では、メッセージのバッチをアダプターにします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-289">BizTalk Server gives a batch of messages to the adapter.</span></span>  
  
- <span data-ttu-id="4f04f-290">アダプターは、ことが指定が、メッセージの宛先に正しく判断した場合は、BizTalk Server を示すには、その delete を実行します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-290">When the adapter determines that it has given the message to its destination correctly, it executes delete back on BizTalk Server indicating that it is done.</span></span> <span data-ttu-id="4f04f-291">(通常どおり、いくつか削除するメッセージ任意にバッチ処理できるのパフォーマンスを向上させるためにします。)</span><span class="sxs-lookup"><span data-stu-id="4f04f-291">(As usual, several delete messages can be arbitrarily batched up to improve performance.)</span></span>  
  
  <span data-ttu-id="4f04f-292">送信側のアダプターは、メッセージの処理に失敗した場合のメッセージにいくつかのいずれかを行いますが可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-292">If the send-side adapter fails to process a message, then it may do one of several things with that message:</span></span>  
  
- <span data-ttu-id="4f04f-293">アダプターがメッセージの再試行を求めていることを BizTalk Server で知らせる必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-293">The adapter should tell BizTalk Server that it wants a message retried.</span></span> <span data-ttu-id="4f04f-294">BizTalk Server では、メッセージは自動的に再試行しません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-294">BizTalk Server does not automatically retry a message.</span></span> <span data-ttu-id="4f04f-295">BizTalk Server は、再試行のカウントを保持し、この数は、メッセージ コンテキストで確認できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-295">BizTalk Server keeps a count of the retries, and this count can be seen in the message context.</span></span>  
  
- <span data-ttu-id="4f04f-296">アダプターは、メッセージを処理できないことを確認できます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-296">The adapter may determine that it cannot process a message.</span></span> <span data-ttu-id="4f04f-297">この場合、アダプターでは、次のトランスポートにメッセージを移動する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-297">In this case, the adapter might move the message to the next transport.</span></span> <span data-ttu-id="4f04f-298">アダプターは、これを**MoveToNextTransport**を呼び出す、**バッチ**オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="4f04f-298">The adapter does this with the **MoveToNextTransport** call on the **Batch** object.</span></span>  
  
- <span data-ttu-id="4f04f-299">アダプターは、保留キューにメッセージを移動することがあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-299">The adapter may move the message to the Suspended queue.</span></span>  
  
  <span data-ttu-id="4f04f-300">アダプターは、メッセージに動作を決定します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-300">The adapter determines what happens to the message.</span></span> <span data-ttu-id="4f04f-301">ただし、これにより、BizTalk Server のインストールをサポートしやすくするために、一貫した方法で動作するアダプターがあることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-301">However, it is recommended that you have adapters behave in a consistent manner because this makes a BizTalk Server installation easier to support.</span></span>  
  
  <span data-ttu-id="4f04f-302">以下に示すようにアダプターが動作することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="4f04f-302">It is highly recommended that adapters behave as described below.</span></span> <span data-ttu-id="4f04f-303">BizTalk Server に付属するアダプターは、次のように動作します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-303">The adapters shipped with BizTalk Server behave like this.</span></span>  
  
### <a name="recommended-behavior-for-handling-send-errors-in-a-batch"></a><span data-ttu-id="4f04f-304">バッチの送信エラー処理に関する推奨動作</span><span class="sxs-lookup"><span data-stu-id="4f04f-304">Recommended Behavior for Handling Send Errors in a Batch</span></span>  
 <span data-ttu-id="4f04f-305">送信アダプターは、いくつかのメッセージを受信しに BizTalk Server に送信します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-305">The send adapter receives some messages and submits them to BizTalk Server.</span></span>  
  
 <span data-ttu-id="4f04f-306">成功したメッセージごとに、アダプターは BizTalk Server にメッセージを削除する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-306">For each successful message the adapter should delete that message on BizTalk Server.</span></span> <span data-ttu-id="4f04f-307">BizTalk Server へのすべての通信がバッチで行います、削除もバッチにまとめることができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-307">All communication back to BizTalk Server is done through batches, and the deletes can be batched up.</span></span> <span data-ttu-id="4f04f-308">これらは、アダプターの BizTalk Server を作成した同じバッチではありません。</span><span class="sxs-lookup"><span data-stu-id="4f04f-308">They do not have to be the same batch that BizTalk Server created on the adapter.</span></span> <span data-ttu-id="4f04f-309">関連付けられていると共に (SubmitResponse で) BizTalk サーバーに送信する必要があります (SolicitResponse シナリオの場合) のように、応答メッセージがある場合は削除します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-309">If there are any response messages (as in a SolicitResponse scenario), then they should be submitted back to BizTalk Server (with SubmitResponse) along with the associated delete.</span></span>  
  
- <span data-ttu-id="4f04f-310">アダプターでメッセージ処理が成功しなかった場合は、再試行回数を確認します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-310">If the message processing in the adapter was unsuccessful, check the retry count.</span></span>  
  
  -   <span data-ttu-id="4f04f-311">再試行回数を超過していない場合は、忘れずに、メッセージの再試行回数を設定すること、BizTalk Server にメッセージを再送信します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-311">If the retry count was not exceeded, resubmit the message to BizTalk Server, remembering to set the retry time on the message.</span></span> <span data-ttu-id="4f04f-312">再試行の回数と再試行間隔が、アダプターを使用する必要があります、メッセージ コンテキストを提供します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-312">The message context provides the retry count and the retry interval the adapter should use.</span></span>  
  
  -   <span data-ttu-id="4f04f-313">再試行回数を超えているかどうかは、アダプターを使用して、メッセージの移動を試行する**MoveToNextTransport**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-313">If the retry count was exceeded, then the adapter should attempt to move the message by using **MoveToNextTransport**.</span></span> <span data-ttu-id="4f04f-314">再送信し、 **MoveToNextTransport**メッセージは、BizTalk Server に同じバッチ内で削除と一緒に指定することができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-314">The resubmit and **MoveToNextTransport** messages can be mixed with the deletes in the same batch back to BizTalk Server.</span></span> <span data-ttu-id="4f04f-315">これは必須ではありませんが、有効なことができます。</span><span class="sxs-lookup"><span data-stu-id="4f04f-315">This is not required, but can be a useful step.</span></span>  
  
- <span data-ttu-id="4f04f-316">再送信し、 **MoveToNextTransport**方法はエラーに対処するアダプター。</span><span class="sxs-lookup"><span data-stu-id="4f04f-316">The resubmit and the **MoveToNextTransport** are ways for the adapter to deal with failures.</span></span> <span data-ttu-id="4f04f-317">エラーの処理中にエラーがあります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-317">But there can be a failure within the processing of the failure.</span></span> <span data-ttu-id="4f04f-318">BizTalk Server からの応答の処理中には、この場合、(で、 **BatchComplete**メソッド) アダプターをそのエラーの処理方法を示すために BizTalk Server に対して別のバッチを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-318">In this case, in processing the response from BizTalk Server (in the **BatchComplete** method) the adapter must create another batch against BizTalk Server to indicate what to do with that failure.</span></span>  
  
   <span data-ttu-id="4f04f-319">別のエラーの処理内に発生するエラーを処理するときに、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="4f04f-319">Follow these steps when processing a failure that occurs within the processing of another failure:</span></span>  
  
  -   <span data-ttu-id="4f04f-320">再送信が失敗した場合、 **MoveToNextTransport**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-320">If the resubmit fails, use **MoveToNextTransport**.</span></span>  
  
  -   <span data-ttu-id="4f04f-321">場合、 **MoveToNextTransport**使用して、失敗した場合、 **MoveToSuspendQ**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-321">If the **MoveToNextTransport** fails, use **MoveToSuspendQ**.</span></span>  
  
  <span data-ttu-id="4f04f-322">必要があります保持バッチの作成で BizTalk Server で BizTalk Server で操作の成功を受信するまで。</span><span class="sxs-lookup"><span data-stu-id="4f04f-322">You must keep creating batches on BizTalk Server until you receive a successful action back on BizTalk Server.</span></span>  
  
### <a name="serialization-of-message-context-property"></a><span data-ttu-id="4f04f-323">メッセージ コンテキスト プロパティのシリアル化</span><span class="sxs-lookup"><span data-stu-id="4f04f-323">Serialization of Message Context Property</span></span>  
 <span data-ttu-id="4f04f-324">メッセージ コンテキスト プロパティに割り当てられているすべてのオブジェクトをシリアル化する必要があります。</span><span class="sxs-lookup"><span data-stu-id="4f04f-324">All objects assigned to a message context property must be serializable.</span></span> <span data-ttu-id="4f04f-325">それ以外の場合、メッセージング エンジンは型の例外をスロー **E_NOINTERFACE**します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-325">Otherwise the Messaging Engine will throw an exception of type **E_NOINTERFACE**.</span></span> <span data-ttu-id="4f04f-326">この戻り値は、あいまいしようとすると、メッセージ コンテキストに割り当てられる非シリアル化可能なオブジェクトを表します。</span><span class="sxs-lookup"><span data-stu-id="4f04f-326">This return value ambiguously represents a non-serializable object attempting to be assigned the message context.</span></span>