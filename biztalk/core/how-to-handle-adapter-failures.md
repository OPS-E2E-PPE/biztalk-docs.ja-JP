---
title: "アダプターの障害を処理する方法 |Microsoft ドキュメント"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: bdceb364-38d6-4aab-a176-bf751da1be25
caps.latest.revision: "12"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 94ce45dbf8fcc46c952ddd5ccf7ed45e633641a4
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
---
# <a name="how-to-handle-adapter-failures"></a><span data-ttu-id="eac98-102">アダプターのエラーを処理する方法</span><span class="sxs-lookup"><span data-stu-id="eac98-102">How to Handle Adapter Failures</span></span>
<span data-ttu-id="eac98-103">アダプターでは通常、処理できないメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="eac98-103">In general, adapters should suspend messages that they cannot process.</span></span> <span data-ttu-id="eac98-104">たとえば、受信アダプターで送信エラーが発生した場合は通常、メッセージを中断します。ただし、この判断はアダプターの目的によって変わることがあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-104">For example, a receive adapter that experiences a submit failure should typically suspend the messages, although this decision depends upon the purpose of the adapter.</span></span> <span data-ttu-id="eac98-105">エラーを処理するときには、セキュリティの問題も考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-105">There are also security considerations around handling failures.</span></span> <span data-ttu-id="eac98-106">たとえば、失敗したメッセージをすべてアダプターで自動的に中断すると、そのアダプターはサービス拒否攻撃に対して脆弱になり、BizTalk Server の保留キューがいっぱいになる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-106">For example, if an adapter automatically suspends all failed messages, the adapter might be open to a denial-of-service attack that causes the BizTalk Server Suspended queue to fill up.</span></span>  <span data-ttu-id="eac98-107">HTTP アダプターなど一部のアダプターでは、要求が拒否されたことを示すエラー コードをクライアントに返すことができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-107">Some adapters, such as HTTP, can return a failure code to the client indicating that the request has been rejected.</span></span> <span data-ttu-id="eac98-108">こうした種類のアダプターでは、多くの場合、メッセージを中断するよりもエラー コードを返す方が有効です。</span><span class="sxs-lookup"><span data-stu-id="eac98-108">For these types of adapters it often makes sense to return a failure code rather than suspend the message.</span></span> <span data-ttu-id="eac98-109">送信アダプターでは通常、プライマリ トランスポートとセカンダリ トランスポートの両方で、再試行回数が設定値を超えた後ではじめてメッセージを中断します。</span><span class="sxs-lookup"><span data-stu-id="eac98-109">Typically send adapters only suspend messages after all of the retries have been exhausted for both primary and secondary transports.</span></span>  
  
## <a name="associate-error-processing-with-an-individual-operation-and-not-with-the-batch-that-contains-the-operation"></a><span data-ttu-id="eac98-110">操作を含むバッチではなく、個々の操作にエラー処理を関連付ける</span><span class="sxs-lookup"><span data-stu-id="eac98-110">Associate Error Processing with an Individual Operation and Not with the Batch That Contains the Operation</span></span>  
 <span data-ttu-id="eac98-111">アダプターでのメッセージのバッチ処理は、アダプターのユーザーに見えないところで実行し、</span><span class="sxs-lookup"><span data-stu-id="eac98-111">The batching of messages within an adapter should be invisible to the user of the adapter.</span></span> <span data-ttu-id="eac98-112">バッチ内の操作の 1 つが失敗しても他の操作に影響が生じないようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-112">This means that the failure of one operation in a batch should not affect any other operation in any way.</span></span> <span data-ttu-id="eac98-113">しかし、バッチはアトミックであるため、1 つのメッセージでエラーが発生するとバッチのエラーとなり、操作は処理されなくなります。</span><span class="sxs-lookup"><span data-stu-id="eac98-113">However, batches are atomic, so the failure of one message results in an error for the batch, and no operations are processed.</span></span>  
  
 <span data-ttu-id="eac98-114">したがって、エラーが発生したときに処理するコードを記述し、正常なメッセージを再送信して失敗したメッセージを中断するよう指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-114">You write the code that is responsible for handling the error, resubmitting the successful messages, and suspending the unsuccessful ones.</span></span> <span data-ttu-id="eac98-115">BizTalk Server では詳細なエラー構造が提供されるので、アダプターでは失敗した操作を特定できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-115">Fortunately, BizTalk Server provides a detailed error structure that enables your adapter to determine the specific operation that failed.</span></span> <span data-ttu-id="eac98-116">これを基に、正常な操作を再実行し失敗した操作を中断するバッチをさらに構築できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-116">It permits construction of further batches in which the successful operations are resubmitted and the unsuccessful ones suspended.</span></span>  
  
 <span data-ttu-id="eac98-117">アダプター内のバッチ処理によって、操作の最終的な状態が影響を受けないようにしてください。</span><span class="sxs-lookup"><span data-stu-id="eac98-117">The final state of the operation should not be affected by the batching within the adapter.</span></span>  
  
## <a name="use-seterrorinfo-to-report-failure-to-biztalk-server"></a><span data-ttu-id="eac98-118">SetErrorInfo を使用して BizTalk Server にエラーを報告する</span><span class="sxs-lookup"><span data-stu-id="eac98-118">Use SetErrorInfo to Report Failure to BizTalk Server</span></span>  
 <span data-ttu-id="eac98-119">メッセージを中断する場合は、その前のメッセージ コンテキストから BizTalk Server にエラー情報を送信する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-119">If you are suspending a message, you must provide failure information to BizTalk Server from the previous message context.</span></span> <span data-ttu-id="eac98-120">BizTalk Server は、エラー レポート機能を使用して、 **SetErrorInfo**両方のメソッド、 **IBaseMessage**と**ITransportProxy**インターフェイスです。</span><span class="sxs-lookup"><span data-stu-id="eac98-120">BizTalk Server provides error reporting capabilities using the **SetErrorInfo** method on both the **IBaseMessage** and **ITransportProxy** interfaces.</span></span> <span data-ttu-id="eac98-121">エラーを報告するには次の方法を使用できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-121">You can report errors as follows:</span></span>  
  
-   <span data-ttu-id="eac98-122">メッセージの処理中に、障害が発生したときに設定を使用して例外**SetErrorInfo (Exception e)**メッセージ (**IBaseMessage**) が中断されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-122">When a failure occurs while processing a message, set the exception using **SetErrorInfo(Exception e)** on the message (**IBaseMessage**) to be suspended.</span></span> <span data-ttu-id="eac98-123">こうすると、エンジンではメッセージと共にエラーが保持され、後の診断に使用できます。また、イベント ログにエラーが記録され、管理者はエラーを認識できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-123">This allows the engine to preserve the error with the message for later diagnosis and logs it to the event log to alert the administrator.</span></span>  
  
-   <span data-ttu-id="eac98-124">中ではないメッセージの処理) 初期化または内部ブックキーピング中にエラーが発生した場合を呼び出す必要があります**SetErrorInfo (Exception e)**上、 **ITransportProxy**に渡されたポインター初期化中にします。</span><span class="sxs-lookup"><span data-stu-id="eac98-124">If you encounter an error during initialization or internal bookkeeping (not during message processing) you should call **SetErrorInfo(Exception e)** on the **ITransportProxy** pointer that was passed to you during initialization.</span></span> <span data-ttu-id="eac98-125">アダプターが BaseAdapter 実装を基にしている場合は、このポインターに常にアクセスできるようにしておく必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-125">If your adapter is based on the BaseAdapter implementation, you should always have access to this pointer.</span></span> <span data-ttu-id="eac98-126">そうでない場合は、ポインターをキャッシュしておくようにします。</span><span class="sxs-lookup"><span data-stu-id="eac98-126">Otherwise, you should be certain that you cache it.</span></span>  
  
 <span data-ttu-id="eac98-127">どちらの方法でも、エラーが報告されると、イベント ログにエラー メッセージが書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="eac98-127">Reporting an error with either of these methods results in the error message being written to the event log.</span></span> <span data-ttu-id="eac98-128">エラーとそのメッセージを関連付けることができる場合は、必ず関連付けを行ってください。</span><span class="sxs-lookup"><span data-stu-id="eac98-128">It is important that you associate the error with the related message if you are able to do so.</span></span>  
  
## <a name="handle-a-database-offline-condition"></a><span data-ttu-id="eac98-129">データベースがオフラインになった場合の処理</span><span class="sxs-lookup"><span data-stu-id="eac98-129">Handle a Database-Offline Condition</span></span>  
 <span data-ttu-id="eac98-130">BizTalk Server データベースの 1 つがオフラインになった場合、BizTalk サービスは自身を再利用します。</span><span class="sxs-lookup"><span data-stu-id="eac98-130">If one of the BizTalk Server databases goes offline, the BizTalk service recycles itself.</span></span> <span data-ttu-id="eac98-131">メッセージング エンジンは、サービスが再利用される前にすべての受信場所のシャットダウンをあらゆる方法で試行しますが、</span><span class="sxs-lookup"><span data-stu-id="eac98-131">The Messaging Engine makes a best effort to shut down all of the receive locations before recycling the service.</span></span> <span data-ttu-id="eac98-132">この処理が 60 秒以上かかるとサービスは終了します。</span><span class="sxs-lookup"><span data-stu-id="eac98-132">If this takes longer than 60 seconds, the service terminates.</span></span> <span data-ttu-id="eac98-133">エンジンのトランザクションは行われるので、データの損失は起こりません。</span><span class="sxs-lookup"><span data-stu-id="eac98-133">Because the engine is transacted, this does not cause data loss.</span></span>  
  
 <span data-ttu-id="eac98-134">タイムアウトはレジストリで次のキーを使用して設定できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-134">This time-out can be tuned in the registry by using the key:</span></span>  
  
```  
DWORD   
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\BTSSvc{Host Guid}\MessagingDBFailoverShutdownTimeLimit  
```  
  
 <span data-ttu-id="eac98-135">分離アダプターの場合はプロセスの所有者が BizTalk Server ではないため、BizTalk Server データベースの 1 つがオフラインになると受信場所は無効になります。</span><span class="sxs-lookup"><span data-stu-id="eac98-135">For isolated adapters, because BizTalk Server does not own the process, the receive locations are disabled when one of the BizTalk Server databases goes offline.</span></span> <span data-ttu-id="eac98-136">これらの受信場所は、データベースがオンラインに戻った後で再度有効になります。</span><span class="sxs-lookup"><span data-stu-id="eac98-136">After the database comes back online those receive locations are re-enabled.</span></span>  
  
## <a name="write-to-the-event-log"></a><span data-ttu-id="eac98-137">イベント ログへの書き込み</span><span class="sxs-lookup"><span data-stu-id="eac98-137">Write to the Event Log</span></span>  
 <span data-ttu-id="eac98-138">使用して、アダプターがイベント ログ エントリを書き込むことができます、 **IBTTransportProxy**例外を渡すインターフェイス。</span><span class="sxs-lookup"><span data-stu-id="eac98-138">The adapter can write event log entries by using the **IBTTransportProxy** interface passing in an exception.</span></span> <span data-ttu-id="eac98-139">ネイティブ コードで開発されたアダプターを渡す必要があります、 **IErrorInfo**インターフェイス、 **IBTTransportProxy.SetErrorInfo (例外** `e` **)**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-139">Adapters developed in native code need to pass in an **IErrorInfo** interface, **IBTTransportProxy.SetErrorInfo( Exception** `e` **)**.</span></span>  
  
 <span data-ttu-id="eac98-140">送信エラー後にアダプターでメッセージの送信を再試行したり、アダプターのバックアップ トランスポートにメッセージを移動したり、メッセージを中断するときなどは、メッセージング エンジンがアダプターに代わってイベント ログへの書き込みを行います。</span><span class="sxs-lookup"><span data-stu-id="eac98-140">The Messaging Engine writes to the event log on behalf of the adapter for events such as when an adapter retries a message after transmission failure, moves a message to its backup transport, or suspends a message.</span></span> <span data-ttu-id="eac98-141">このような場合、アダプターで必要になる操作は、API の呼び出し前にメッセージに例外を設定することだけです。</span><span class="sxs-lookup"><span data-stu-id="eac98-141">For operations such as these the adapter only needs to set the exception on the message before calling the API.</span></span> <span data-ttu-id="eac98-142">このコード例の一部を次に示します。</span><span class="sxs-lookup"><span data-stu-id="eac98-142">The following code fragment demonstrates this:</span></span>  
  
```  
IBaseMessage msg;  
...  
// Set exception on msg to indicate why transmission failed...  
msg.SetErrorInfo(  
 new ApplicationException(  
 "The TCP connection was closed by the destination"));  
```  
  
## <a name="handle-receive-specific-batch-errors"></a><span data-ttu-id="eac98-143">受信に固有のバッチ エラーの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-143">Handle Receive-Specific Batch Errors</span></span>  
  
### <a name="handle-receive-failures"></a><span data-ttu-id="eac98-144">受信に失敗した場合の処理</span><span class="sxs-lookup"><span data-stu-id="eac98-144">Handle Receive Failures</span></span>  
 <span data-ttu-id="eac98-145">アダプターから BizTalk Server に操作または操作のバッチを送信するときに失敗した場合は、さまざまな原因が考えられます。</span><span class="sxs-lookup"><span data-stu-id="eac98-145">When an adapter submits an operation (or batch of operations) to BizTalk Server there can be various reasons for failure.</span></span> <span data-ttu-id="eac98-146">最も大きな原因は次の 2 つです。</span><span class="sxs-lookup"><span data-stu-id="eac98-146">The two most significant are:</span></span>  
  
-   <span data-ttu-id="eac98-147">受信パイプラインが失敗した。</span><span class="sxs-lookup"><span data-stu-id="eac98-147">The receive pipeline failed.</span></span>  
  
-   <span data-ttu-id="eac98-148">メッセージを公開するときにルーティング エラーが発生した。</span><span class="sxs-lookup"><span data-stu-id="eac98-148">A routing failure occurred while publishing a message.</span></span>  
  
 <span data-ttu-id="eac98-149">受信パイプラインが失敗した場合、メッセージング エンジンは自動的にメッセージの中断を試行します。</span><span class="sxs-lookup"><span data-stu-id="eac98-149">The Messaging Engine automatically tries to suspend the message when it gets a receive pipeline failure.</span></span> <span data-ttu-id="eac98-150">この中断操作は常に正常に完了するとは限りません。</span><span class="sxs-lookup"><span data-stu-id="eac98-150">The suspend operation may not always be successful.</span></span> <span data-ttu-id="eac98-151">たとえば、メッセージの公開中にメッセージング エンジンでルーティング エラーが発生すると、エンジンではメッセージの中断を試行することもできません。</span><span class="sxs-lookup"><span data-stu-id="eac98-151">For example, if the Messaging Engine hits a routing failure while publishing a message, then the engine does not even try to suspend the message.</span></span>  
  
 <span data-ttu-id="eac98-152">メッセージの失敗は常に発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-152">It is always possible that a message will fail.</span></span> <span data-ttu-id="eac98-153">このような状況で、アダプターが明示的に呼び出す、 **MoveToSuspendQ** API と、メッセージの中断を試行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-153">In such a situation, the adapter should explicitly call the **MoveToSuspendQ** API and should try to suspend the message.</span></span> <span data-ttu-id="eac98-154">アダプターでメッセージの中断を試行する場合は、次のいずれかの状況が該当します。</span><span class="sxs-lookup"><span data-stu-id="eac98-154">When an adapter tries to suspend a message, one of the following should be true:</span></span>  
  
-   <span data-ttu-id="eac98-155">アダプターが送信 (推奨) したメッセージ オブジェクトと同じオブジェクトを中断する必要がある。</span><span class="sxs-lookup"><span data-stu-id="eac98-155">The same message object that the adapter submitted (recommended) should be suspended.</span></span>  
  
-   <span data-ttu-id="eac98-156">アダプターで新しいメッセージを作成する必要がある場合は、新しいメッセージのメッセージ コンテキストに、最初に送信されたメッセージのメッセージ コンテキストへのポインターを設定する必要がある。</span><span class="sxs-lookup"><span data-stu-id="eac98-156">If the adapter has to create a new message, then it should set the message context of the new message with the pointer to the message context of the message that was originally submitted.</span></span> <span data-ttu-id="eac98-157">この理由は、メッセージのメッセージ コンテキストに、メッセージとエラーに関する有用な情報が多く含まれるためです。</span><span class="sxs-lookup"><span data-stu-id="eac98-157">This is because the message context of a message has a lot of valuable information about the message and the failure.</span></span> <span data-ttu-id="eac98-158">この情報は、失敗したメッセージをデバッグするときに必要になります。</span><span class="sxs-lookup"><span data-stu-id="eac98-158">This information is required to debug the failed message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="eac98-159">アダプターで新しいメッセージ オブジェクトを作成して中断する場合、アダプターでは、古いメッセージ オブジェクトから新しいメッセージ オブジェクトにエラー情報をコピーする必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-159">If the adapter creates a new message object and suspends it, the adapter should copy the error information from the old message object to the new message object.</span></span>  
  
 <span data-ttu-id="eac98-160">BizTalk Server 付属の HTTP アダプターなど、一部のアダプターではメッセージを中断する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="eac98-160">Some adapters, such as the HTTP adapter provided with BizTalk Server, do not require that the message be suspended.</span></span> <span data-ttu-id="eac98-161">これらのアダプターでは、エラーをクライアントに返すことができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-161">These adapters can return an error back to their client.</span></span>  
  
#### <a name="causes-of-failure"></a><span data-ttu-id="eac98-162">エラーの原因</span><span class="sxs-lookup"><span data-stu-id="eac98-162">Causes of failure</span></span>  
 <span data-ttu-id="eac98-163">エラーの簡単な原因としては、バッチが構築された場合や場合に発生するエラー **ibttransportbatch::done**と呼びます。</span><span class="sxs-lookup"><span data-stu-id="eac98-163">Simple causes of failure are the errors that can occur as the batch is constructed or when **IBTTransportBatch::Done** is called.</span></span>  
  
-   <span data-ttu-id="eac98-164">**発信に失敗しました。**</span><span class="sxs-lookup"><span data-stu-id="eac98-164">**Submit failure.**</span></span> <span data-ttu-id="eac98-165">**送信**限られた数の理由の呼び出しが失敗して、すべてが致命的です。</span><span class="sxs-lookup"><span data-stu-id="eac98-165">The **Submit** call can fail for a limited number of reasons, and all of them are fatal.</span></span> <span data-ttu-id="eac98-166">原因には次のようなものがあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-166">These reasons include:</span></span>  
  
-   <span data-ttu-id="eac98-167">BizTalk Server のプロセス領域で発生するメモリ不足エラー。</span><span class="sxs-lookup"><span data-stu-id="eac98-167">Out-of-memory errors occurring in the BizTalk Server process space.</span></span>  
  
-   <span data-ttu-id="eac98-168">スキーマ アセンブリが展開先から削除されている。</span><span class="sxs-lookup"><span data-stu-id="eac98-168">The schema assembly has been dropped from the deployment.</span></span> <span data-ttu-id="eac98-169">ここで、**送信**解読不明のエラーで失敗します。</span><span class="sxs-lookup"><span data-stu-id="eac98-169">In this case, the **Submit** fails with a cryptic error.</span></span> <span data-ttu-id="eac98-170">MQSeries アダプターの場合は、BizTalk Server からの一般的なエラー例外がキャッチされ、システム イベント ログに拡張エラー メッセージが書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="eac98-170">In the MQSeries adapter, the generic failure exception from BizTalk Server is caught, and an extended error message is written in the system event log.</span></span> <span data-ttu-id="eac98-171">このメッセージでは、考えられるエラー原因の 1 つとして、スキーマ アセンブリが展開先から削除されていることが示されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-171">This message suggests that one of the possible causes of the error is that the schema assembly has somehow been dropped from the deployment.</span></span>  
  
     <span data-ttu-id="eac98-172">[全般] の場合に**送信**が失敗したが、同じトランザクションを使用してメッセージを中断しようとする必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-172">In general, if **Submit** fails you should try to suspend the message using the same transaction.</span></span>  
  
-   <span data-ttu-id="eac98-173">**Ibttransportbatch::done に失敗しました。**</span><span class="sxs-lookup"><span data-stu-id="eac98-173">**IBTTransportBatch::Done failure.**</span></span> <span data-ttu-id="eac98-174">**Ibttransportbatch::done**呼び出しが失敗する理由はいくつかのいずれか。</span><span class="sxs-lookup"><span data-stu-id="eac98-174">The **IBTTransportBatch::Done** call can fail for one of several reasons.</span></span> <span data-ttu-id="eac98-175">通常は、中断操作を 1 回試行してから、それが失敗したときのみトランザクションを終了してください。</span><span class="sxs-lookup"><span data-stu-id="eac98-175">In general, you should always attempt one suspend operation and end the transaction only if that fails.</span></span> <span data-ttu-id="eac98-176">いずれかのエラー コードの障害から受信する可能性があります**ibttransportbatch::done**は、BizTalk Server がシャット ダウンしようとしていること。</span><span class="sxs-lookup"><span data-stu-id="eac98-176">One of the error codes you might receive from the failure of **IBTTransportBatch::Done** is that BizTalk Server is trying to shut down.</span></span> <span data-ttu-id="eac98-177">この場合、のみ、トランザクションを終了してくださいためにのままに、 **Terminate**呼び出しが同時に行われている可能性があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-177">In this case, you should just end the transaction and leave it because the **Terminate** call is probably happening concurrently.</span></span> <span data-ttu-id="eac98-178">バッチを適切に構築して正常に実行されたときに、その他のシナリオが発生する**ibttransportbatch::done**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-178">Other scenarios occur when you have successfully constructed the batch and successfully executed **IBTTransportBatch::Done**.</span></span> <span data-ttu-id="eac98-179">このような場合、エラーが返される**BatchComplete**し、アダプターは、それらの処理方法を確認する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-179">In these cases, the errors are returned in **BatchComplete** and the adapter must determine what to do with them.</span></span> <span data-ttu-id="eac98-180">以下では、この場合について検討します。</span><span class="sxs-lookup"><span data-stu-id="eac98-180">The rest of this section deals with this case.</span></span>  
  
#### <a name="processing-batchcomplete-errors"></a><span data-ttu-id="eac98-181">BatchComplete エラーの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-181">Processing BatchComplete errors</span></span>  
 <span data-ttu-id="eac98-182">**BatchComplete**バッチ操作の完了状態を示すために BizTalk Server によって呼び出されるアダプターによって提供されるコールバックです。</span><span class="sxs-lookup"><span data-stu-id="eac98-182">**BatchComplete** is a callback provided by the adapter that is invoked by BizTalk Server to indicate the completion status of a batch operation.</span></span>  
  
 <span data-ttu-id="eac98-183">最も重要なパラメーターが渡される**BatchComplete**バッチの状態は、`hResult`です。</span><span class="sxs-lookup"><span data-stu-id="eac98-183">The most important parameter passed to **BatchComplete** is the batch status `hResult`.</span></span> <span data-ttu-id="eac98-184">このパラメーターはバッチの成功または失敗を示します。</span><span class="sxs-lookup"><span data-stu-id="eac98-184">This indicates success or failure for the batch.</span></span> <span data-ttu-id="eac98-185">バッチの失敗は、バッチのいずれの操作も成功しなかったことを意味します。</span><span class="sxs-lookup"><span data-stu-id="eac98-185">If the batch failed, it means that none of the operations in the batch succeeded.</span></span> <span data-ttu-id="eac98-186">アダプターはバッチの状態の構造が組まれ、どのメッセージの失敗を判断 (これは呼ば*バッチのフィルター処理*)。</span><span class="sxs-lookup"><span data-stu-id="eac98-186">The adapter goes through the batch status structure and determines which messages failed (this is known as *filtering the batch*).</span></span>  
  
#### <a name="nontransactional-batchcomplete-errors"></a><span data-ttu-id="eac98-187">非トランザクション BatchComplete エラー</span><span class="sxs-lookup"><span data-stu-id="eac98-187">Nontransactional BatchComplete errors</span></span>  
 <span data-ttu-id="eac98-188">非トランザクション アダプターの障害が発生した場合、ユーザーへの応答を選択する必要があります、 **SubmitMessage**/**SubmitRequestMessage**または**SubmitResponseMessage**操作します。</span><span class="sxs-lookup"><span data-stu-id="eac98-188">For nontransactional adapters, you must choose your response if a failure occurs for a **SubmitMessage**/**SubmitRequestMessage** or **SubmitResponseMessage** operation.</span></span> <span data-ttu-id="eac98-189">アダプターが呼び出すことによって、メッセージを中断する通常**MoveToSuspendQ**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-189">Typically adapters suspend the message by calling **MoveToSuspendQ**.</span></span>  
  
 <span data-ttu-id="eac98-190">次の操作は常に渡すことが: **DeleteMessage**、 **MoveToSuspendQ**、 **ResubmitMessage**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-190">The following operations are always expected to pass: **DeleteMessage**, **MoveToSuspendQ**, **ResubmitMessage**.</span></span> <span data-ttu-id="eac98-191">これらの操作が失敗した場合は、通常、アダプターにバグがあることを示しています。</span><span class="sxs-lookup"><span data-stu-id="eac98-191">If these operations fail, it typically means that there is a bug in the adapter.</span></span> <span data-ttu-id="eac98-192">この場合は、エラーを処理するコードを記述する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="eac98-192">You do not have to write code to handle a failure in these cases.</span></span> <span data-ttu-id="eac98-193">ただし、別の操作の失敗が原因でバッチが失敗した場合は、新しいバッチでこれらの操作を再実行する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-193">However if the batch failed because another operation failed, then these operations must be re-executed in a fresh batch.</span></span>  
  
 <span data-ttu-id="eac98-194">アダプターが呼び出す場合**MovetoBackupTransport** (バックアップ トランスポートがないため) 失敗すると、アダプターを呼び出す必要があります**MoveToSuspendQ**メッセージを保留にします。</span><span class="sxs-lookup"><span data-stu-id="eac98-194">If the adapter calls **MovetoBackupTransport** and that fails (because there was no backup transport), then the adapter should call **MoveToSuspendQ** to suspend the message.</span></span>  
  
#### <a name="transactional-batchcomplete-errors"></a><span data-ttu-id="eac98-195">トランザクション BatchComplete エラー</span><span class="sxs-lookup"><span data-stu-id="eac98-195">Transactional BatchComplete errors</span></span>  
 <span data-ttu-id="eac98-196">アダプターによって作成されたトランザクションを使用して BizTalk Server にバッチを送信するときには、次のいずれかの方法を使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-196">When you submit batches to BizTalk Server using a transaction created by the adapter, you should follow one of these two scenarios:</span></span>  
  
-   <span data-ttu-id="eac98-197">**単一メッセージのバッチを使用します。**</span><span class="sxs-lookup"><span data-stu-id="eac98-197">**Use single-message batches.**</span></span> <span data-ttu-id="eac98-198">。単一メッセージのバッチを BizTalk Server に送信します。</span><span class="sxs-lookup"><span data-stu-id="eac98-198">Send a single-message batch to BizTalk Server.</span></span> <span data-ttu-id="eac98-199">この単一メッセージが失敗した場合は、同じトランザクションで BizTalk Server に 2 つ目のバッチを送信できますが、問題のあるメッセージは再送信せず保留キューへ移動する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-199">If that single message fails, then you can legally send BizTalk Server a second batch under the same transaction, but you must move the offending message to the Suspended queue rather than resubmitting it.</span></span> <span data-ttu-id="eac98-200">失敗したメッセージを削除して 2 つ目のバッチを送信し、</span><span class="sxs-lookup"><span data-stu-id="eac98-200">After the failed message is removed, the submission of the second batch should succeed.</span></span> <span data-ttu-id="eac98-201">BizTalk Server で 2 つ目のバッチが成功したことが確認されたら、トランザクションをコミットできます。</span><span class="sxs-lookup"><span data-stu-id="eac98-201">After that occurs you can commit the transaction when BizTalk Server confirms that the second batch was successful.</span></span> <span data-ttu-id="eac98-202">2 つ目のバッチが失敗した場合、アダプターではトランザクションを中止するか、メッセージの格納先を見つける必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-202">If the second batch fails, the adapter must abort the transaction, or find somewhere else to place that message.</span></span> <span data-ttu-id="eac98-203">この場合、トランザクションのロールバック処理によって、パフォーマンスが急激に低下します。</span><span class="sxs-lookup"><span data-stu-id="eac98-203">In this scenario, you immediately take a significant performance hit due to transaction rollback processing.</span></span>  
  
     <span data-ttu-id="eac98-204">アダプターのパフォーマンスを改善するにはいくつかの方法があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-204">There are some techniques that you can use to improve the performance of the adapter.</span></span> <span data-ttu-id="eac98-205">たとえば MQSeries アダプターでは、実行時に動的に処理方法が調整されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-205">For example, the MQSeries adapter adjusts its approach dynamically at run time.</span></span> <span data-ttu-id="eac98-206">このアダプターは 100 メッセージのバッチを処理できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-206">It runs with 100-message batches.</span></span> <span data-ttu-id="eac98-207">エラーが発生した場合はバッチを終了する必要がありますが、このとき単一メッセージのバッチに切り替えて問題のあるメッセージに対処し、</span><span class="sxs-lookup"><span data-stu-id="eac98-207">If it hits an error, it must end the batch, but it switches to single-message batches for a short time as it gets past the bad message.</span></span> <span data-ttu-id="eac98-208">その後、100 メッセージのバッチに戻ります。</span><span class="sxs-lookup"><span data-stu-id="eac98-208">It then reverts to 100-message batches.</span></span> <span data-ttu-id="eac98-209">再度エラーが発生した場合は、再び処理が遅くなります。</span><span class="sxs-lookup"><span data-stu-id="eac98-209">If it hits the error again, it slows down again.</span></span>  
  
-   <span data-ttu-id="eac98-210">**プリエンプティブ中断を使用します。**</span><span class="sxs-lookup"><span data-stu-id="eac98-210">**Use preemptive suspension.**</span></span> <span data-ttu-id="eac98-211">。複数メッセージのバッチを構築し、その中で、エラーがあるメッセージをプリエンプティブに中断します。</span><span class="sxs-lookup"><span data-stu-id="eac98-211">Construct a multi-message batch in which the erroneous messages are preemptively suspended.</span></span> <span data-ttu-id="eac98-212">バッチには組み合わせが含まれています**送信**と**MoveToSuspendQ**操作は、最初で唯一のバッチ、トランザクションとします。</span><span class="sxs-lookup"><span data-stu-id="eac98-212">The batch contains a mix of **Submit** and **MoveToSuspendQ** operations, and is the first and only batch under the transaction.</span></span> <span data-ttu-id="eac98-213">問題のあるデータはプリエンプティブに中断され、処理が続行されます。BizTalk Server からの確認を受信したら、トランザクションをコミットできます。</span><span class="sxs-lookup"><span data-stu-id="eac98-213">It should succeed because the bad data was preemptively suspended, and the transaction can be committed (after waiting to receive the confirmation from BizTalk Server).</span></span>  
  
     <span data-ttu-id="eac98-214">この処理には予測が必要なように思えますが、この方法は MSMQ アダプターで以前から使用されています。</span><span class="sxs-lookup"><span data-stu-id="eac98-214">This might seem to require looking into the future, but this technique has been used in the MSMQ adapter.</span></span> <span data-ttu-id="eac98-215">この方法を使用する場合は、メッセージ ID がそれぞれ確実に一意であることが必要です。</span><span class="sxs-lookup"><span data-stu-id="eac98-215">It depends on having reliably unique message IDs.</span></span> <span data-ttu-id="eac98-216">このアダプターは複数メッセージを含む単一バッチを構築し、</span><span class="sxs-lookup"><span data-stu-id="eac98-216">This adapter constructs a batch of messages.</span></span> <span data-ttu-id="eac98-217">エラーが発生した場合は、トランザクションとバッチをロールバックします。このとき、アダプターは一時データ構造にメッセージ ID を記録します </span><span class="sxs-lookup"><span data-stu-id="eac98-217">If anything fails it rolls back the transaction (and therefore the batch), but remembers the message ID in a temporary data structure.</span></span> <span data-ttu-id="eac98-218">(この構造が無制限に大きくならないように、中の項目は一定の時間を置いて削除されます)。各バッチの送信前に、アダプターは問題のあるメッセージ ID の一覧を確認します。</span><span class="sxs-lookup"><span data-stu-id="eac98-218">(To prevent this structure from growing indefinitely, items in it are removed after some fixed time delay.) Before each batch is submitted, the adapter checks the list of bad message IDs.</span></span> <span data-ttu-id="eac98-219">問題のあるメッセージ ID があった場合、該当のメッセージは以前に一度失敗しているので、アダプターで失敗を予測できます。したがって、メッセージを送信せずに、プリエンプティブに中断できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-219">If it sees one, it knows that message will fail (because it failed once in the past), and preemptively suspends it rather than trying to submit it.</span></span>  
  
     <span data-ttu-id="eac98-220">すべてのアダプターで、メッセージ ID が確実に一意であるとは限りません。トランザクション ストアではさらに可能性が低くなります。</span><span class="sxs-lookup"><span data-stu-id="eac98-220">Not every adapter has a reliably unique message ID, and a transactional store is less likely to have one.</span></span> <span data-ttu-id="eac98-221">このため、多くのトランザクション アダプターは、単一メッセージ バッチの送信のみに制限されています。</span><span class="sxs-lookup"><span data-stu-id="eac98-221">Because of this, many transactional adapters are restricted to sending single-message batches.</span></span>  
  
#### <a name="processing-other-errors"></a><span data-ttu-id="eac98-222">その他のエラーの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-222">Processing other errors</span></span>  
 <span data-ttu-id="eac98-223">メッセージ中断中のエラーなど、その他のエラーが発生した場合はすべて、アダプターでトランザクションを終了する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-223">In all other cases (such as failures in suspending messages), the adapter must end the transaction.</span></span> <span data-ttu-id="eac98-224">その他の方法ではメッセージが重複するか削除されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-224">Any other outcome results in either duplicate or dropped messages.</span></span>  
  
 <span data-ttu-id="eac98-225">バッチが失敗した場合、アダプターでは可能な限りトランザクションを中止する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-225">Whenever the adapter can, it should abort the transaction if a batch fails.</span></span> <span data-ttu-id="eac98-226">ただし、アダプターでトランザクションを中止できない場合もあり、</span><span class="sxs-lookup"><span data-stu-id="eac98-226">However there are scenarios where the adapter cannot abort the transaction.</span></span> <span data-ttu-id="eac98-227">このような場合は、同じトランザクションを使用するメッセージを中断する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-227">In such a scenario it should suspend the message using the same transaction.</span></span>  
  
#### <a name="processing-errors-on-transactional-receive"></a><span data-ttu-id="eac98-228">トランザクション受信でのエラーの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-228">Processing errors on transactional receive</span></span>  
 <span data-ttu-id="eac98-229">トランザクション処理では、エラーが発生したときにトランザクションを終了するのが一般的なパターンです。</span><span class="sxs-lookup"><span data-stu-id="eac98-229">A common transactional processing pattern is to end a transaction when an error occurs.</span></span> <span data-ttu-id="eac98-230">この場合、すべての操作が以前の状態に戻され、データが失われることはありません。</span><span class="sxs-lookup"><span data-stu-id="eac98-230">In this case everything returns to its previous state and no data is lost.</span></span> <span data-ttu-id="eac98-231">ただし、トランザクションで取得したデータを使用している場合は、これでは十分ではない可能性があります。この例としては、データベースの段階テーブルから一度に 1 行を取得している場合や、MQSeries、MSMQ などのキューイング製品から一度に 1 つのメッセージを取得している場合などがあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-231">However, if you are consuming data from a transactional feed (for example, pulling a row at a time from a staging table in a database, or pulling one message at a time from a queuing product like MQSeries or MSMQ), then this might not be enough.</span></span> <span data-ttu-id="eac98-232">単純にトランザクションを終了して元の状態に戻し、また同じデータを取得すると、同じエラーが発生する可能性が高く、システムはエラーのある状況から抜け出せません。</span><span class="sxs-lookup"><span data-stu-id="eac98-232">If you simply end the transaction and go back and pick up the same data again, the same error is likely to occur and the system becomes stuck in a repeated loop.</span></span>  
  
 <span data-ttu-id="eac98-233">以前のバージョンの BizTalk Server に付属の SQL アダプターには、この動作が設定されていました。</span><span class="sxs-lookup"><span data-stu-id="eac98-233">The SQL adapter in an earlier version of BizTalk Server shipped with this behavior.</span></span> <span data-ttu-id="eac98-234">しかし、リリース後すぐにこのアダプターの動作は変更され、失敗したメッセージの中断とトランザクションのコミットを試行するようになっています。</span><span class="sxs-lookup"><span data-stu-id="eac98-234">However, soon after release the adapter behavior was changed to attempt to suspend a failed message and commit the transaction.</span></span> <span data-ttu-id="eac98-235">同じトランザクションで保留キューにメッセージを移動し、トランザクションをコミットすると、データ損失を防止でき、アダプターでは問題があるデータに対処できるようになります。</span><span class="sxs-lookup"><span data-stu-id="eac98-235">Moving a message to the Suspended queue under the same transaction and then committing the transaction saves the data from being lost and also allows the adapter to get past bad data.</span></span>  
  
 <span data-ttu-id="eac98-236">アダプターの受信部分は、渡されたときに、エラー メッセージに応答を**送信**メッセージ、操作、アダプターがそのエラーを処理する必要があり、メッセージを保留キューに移動します。</span><span class="sxs-lookup"><span data-stu-id="eac98-236">When the receive portion of an adapter is passed an error message in response to a **Submit** message operation, the adapter should process that error and move the message to the Suspended queue.</span></span>  
  
 <span data-ttu-id="eac98-237">アダプターでトランザクション オブジェクトを作成し、そのトランザクションでメッセージを送信するトランザクション バッチの場合、アダプターではエラーが発生したときと同じトランザクションでメッセージを保留キューに移動する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-237">In the case of transactional batches in which the adapter has created the transaction object and submits messages under the transaction, the adapter should logically move the message to the Suspended queue under the same transaction when failures occur.</span></span> <span data-ttu-id="eac98-238">トランザクションでは、エラーの原因となったデータも含めすべてのデータが削除されないようにします。</span><span class="sxs-lookup"><span data-stu-id="eac98-238">The transaction ensures that data is not dropped, and even data that is causing an error should never be dropped.</span></span>  
  
### <a name="handle-messages-without-subscriptions"></a><span data-ttu-id="eac98-239">サブスクリプションが存在しない場合のメッセージの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-239">Handle Messages without Subscriptions</span></span>  
 <span data-ttu-id="eac98-240">BizTalk Server では、メッセージを受け入れるサブスクリプションが定義されていない場合、メッセージ ボックス データベースでのメッセージの公開は許可されません。</span><span class="sxs-lookup"><span data-stu-id="eac98-240">BizTalk Server does not accept a message to be published in its MessageBox database if there are no subscriptions defined to accept it.</span></span> <span data-ttu-id="eac98-241">サブスクリプションはオーケストレーションまたは送信ポートで登録されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-241">Subscriptions are registered by either orchestrations or send ports.</span></span> <span data-ttu-id="eac98-242">複数のサブスクリプションの定義が可能で、この場合メッセージは複数の送信先に送信されます。</span><span class="sxs-lookup"><span data-stu-id="eac98-242">Multiple subscriptions can be defined, in which case the message is sent to multiple destinations.</span></span> <span data-ttu-id="eac98-243">サブスクリプションが存在しない場合、BizTalk Server はメッセージを拒否し、メッセージの中断を試行しません。</span><span class="sxs-lookup"><span data-stu-id="eac98-243">If there are no subscriptions, BizTalk Server rejects the message and does not attempt to suspend it.</span></span> <span data-ttu-id="eac98-244">アダプターでこのエラーを処理せず、明示的にメッセージを中断しない場合は、メッセージは削除され、メッセージのデータも失われる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-244">If the adapter does not handle this error and explicitly suspend the message, then the message is dropped and its data is potentially lost.</span></span> <span data-ttu-id="eac98-245">トランザクション アダプターの場合は、トランザクションを終了してメッセージを送信先に返すものもあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-245">Of course a transactional adapter may end the transaction and return the message to its destination.</span></span>  
  
### <a name="support-seek-with-your-receive-stream"></a><span data-ttu-id="eac98-246">受信ストリームのシークのサポート</span><span class="sxs-lookup"><span data-stu-id="eac98-246">Support Seek with Your Receive Stream</span></span>  
 <span data-ttu-id="eac98-247">受信側のストリームをサポートする必要があります、**シーク**パイプライン エラー発生時にメッセージを中断できる BizTalk Server 用のメソッドです。</span><span class="sxs-lookup"><span data-stu-id="eac98-247">The receive-side stream must support the **Seek** method for BizTalk Server to be able to suspend the message on a pipeline failure.</span></span> <span data-ttu-id="eac98-248">メッセージ ストリームはシーク可能ではないかどうかは、これを実行しようとするときに、BizTalk Server によってエラーが発生**シーク**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-248">If the message stream is not seekable, then BizTalk Server generates an error when it tries to run **Seek**.</span></span>  
  
 <span data-ttu-id="eac98-249">サポートする多くの場合**シーク**容易ではありません。</span><span class="sxs-lookup"><span data-stu-id="eac98-249">In many cases supporting **Seek** is not easy.</span></span> <span data-ttu-id="eac98-250">たとえば、ネットワークからデータをストリーミングするときには、ネットワーク リソースに戻って再度データを要求することは困難です。</span><span class="sxs-lookup"><span data-stu-id="eac98-250">When streaming data from a network, for example, it may be difficult to go back to the network resource and request the data again.</span></span>  
  
 <span data-ttu-id="eac98-251">BizTalk Server に付属のいくつかのアダプターは、BizTalk Server でメッセージ データが読み取られると同時に、データをディスク上のファイルにスプールします。</span><span class="sxs-lookup"><span data-stu-id="eac98-251">Several adapters that ship with BizTalk Server spool the message data onto a file on disk at the same time as BizTalk Server reads the data.</span></span> <span data-ttu-id="eac98-252">これにより、アダプターを使用する**シーク**で (たとえば、メッセージ データのパイプライン処理) のエラーが発生した場合は、そのファイルにします。</span><span class="sxs-lookup"><span data-stu-id="eac98-252">This allows the adapter to use **Seek** on that file if it encounters an error (in the pipeline processing of the message data, for example).</span></span> <span data-ttu-id="eac98-253">内部的に、アダプターが使用して、 **ReadOnlySeekableStream**受信、シークできないストリームをラップし、構成可能なサイズのしきい値に達したときに、ディスクにオーバーフローが発生するクラス。</span><span class="sxs-lookup"><span data-stu-id="eac98-253">Internally the adapter uses the **ReadOnlySeekableStream** class that wraps an incoming non-seekable stream and overflows to disk when a configurable size threshold is reached.</span></span> <span data-ttu-id="eac98-254">しきい値のサイズよりも小さいメッセージはディスクに保存されません。</span><span class="sxs-lookup"><span data-stu-id="eac98-254">For messages smaller than the threshold size, the disk is never hit.</span></span>  
  
### <a name="consider-user-configurable-error-handling-options"></a><span data-ttu-id="eac98-255">ユーザーが構成できるエラー処理オプションについて検討する</span><span class="sxs-lookup"><span data-stu-id="eac98-255">Consider User-Configurable Error-Handling Options</span></span>  
 <span data-ttu-id="eac98-256">エラーへの適切な対応が 1 つでない場合があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-256">Sometimes there is no one correct response to an error.</span></span> <span data-ttu-id="eac98-257">この場合は、ユーザーが構成できるオプションを検討し、動作を選択できるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-257">In this case, you should consider a user-configurable option to choose between behaviors.</span></span> <span data-ttu-id="eac98-258">MQSeries アダプターはこのオプションに対応しています。</span><span class="sxs-lookup"><span data-stu-id="eac98-258">The MQSeries adapter does this.</span></span>  
  
 <span data-ttu-id="eac98-259">エラーが発生したときにアダプターでメッセージを中断する場合の問題点は、BizTalk Server の保留キューが "一方通行" 的な性質を持つことです。</span><span class="sxs-lookup"><span data-stu-id="eac98-259">The problem with having the adapter suspend messages when it sees an error is that the Suspended queue in BizTalk Server is something of a "black hole."</span></span> <span data-ttu-id="eac98-260">キューにメッセージを移動するのは比較的簡単ですが、キューからメッセージを取り出すことは困難です。</span><span class="sxs-lookup"><span data-stu-id="eac98-260">It is relatively easy to get messages into the queue, but harder to get them out again.</span></span>  
  
 <span data-ttu-id="eac98-261">アダプターの使用において、保留キュー内のアイテムをユーザーがまったく必要としない場合もあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-261">Some users of the adapter might not want anything in the Suspended queue.</span></span> <span data-ttu-id="eac98-262">たとえば MQSeries アダプターを使用する場合、ユーザーは構成オプションで次のいずれかの動作を実行できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-262">For example, in the case of the MQSeries adapter, the user is offered a configuration option to do one of the following:</span></span>  
  
-   <span data-ttu-id="eac98-263">アダプターでエラーが発生したとき、現在のトランザクションを終了し、アダプター自身を無効にする。</span><span class="sxs-lookup"><span data-stu-id="eac98-263">Set the adapter to end the current transaction and disable itself when it sees an error.</span></span>  
  
-   <span data-ttu-id="eac98-264">失敗したメッセージを中断し、トランザクションをコミットする。</span><span class="sxs-lookup"><span data-stu-id="eac98-264">Suspend the failed message and commit the transaction.</span></span> <span data-ttu-id="eac98-265">BizTalk Server でメッセージが正常に中断された場合でも、アダプターではこの操作を実行します。</span><span class="sxs-lookup"><span data-stu-id="eac98-265">The adapter does this even when BizTalk Server has successfully suspended the message.</span></span> <span data-ttu-id="eac98-266">この操作では、イベント ログが厳密には正確ではなくなりますが、顧客の要件を満たすことができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-266">This action meets the requirements of the customer even if it causes the event log to not be strictly correct.</span></span>  
  
### <a name="implement-receive-ordering-by-using-a-single-thread-and-waiting-on-batchcomplete"></a><span data-ttu-id="eac98-267">1 つのスレッドを使用して BatchComplete を待機することで受信を順序付ける</span><span class="sxs-lookup"><span data-stu-id="eac98-267">Implement Receive Ordering by Using a Single Thread and Waiting on BatchComplete</span></span>  
 <span data-ttu-id="eac98-268">BizTalk Server のインターフェイスは、同時実行をサポートすることでパフォーマンスと拡張性を向上するよう設計されています。</span><span class="sxs-lookup"><span data-stu-id="eac98-268">The interface to BizTalk Server is designed for performance and the ability to scale out by supporting concurrency.</span></span> <span data-ttu-id="eac98-269">しかし、MQSeries または MSMQ などのメッセージ キュー製品からメッセージを受信するときなどは、しばしばメッセージの受信を厳密に順序付ける必要が生じます。このような場合は、アダプターに対して追加の作業を行い、同時実行の一部を無効にする必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-269">However, if you want a strictly ordered receive of messages (as is sometimes required when receiving messages from a message queue product like MQSeries or MSMQ), then you must do some additional work in the adapter to disable some of that concurrency.</span></span> <span data-ttu-id="eac98-270">これは、次の 2 つの手順で行うことができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-270">This can be done in two steps:</span></span>  
  
1.  <span data-ttu-id="eac98-271">アダプターでのすべてのデータ処理に単一スレッドを使用します。</span><span class="sxs-lookup"><span data-stu-id="eac98-271">You must use a single thread for all the data processing in the adapter.</span></span>  
  
2.  <span data-ttu-id="eac98-272">BizTalk Server でそれぞれのバッチが完全に処理されるまで待機します。</span><span class="sxs-lookup"><span data-stu-id="eac98-272">You must wait for BizTalk Server to completely process each batch.</span></span> <span data-ttu-id="eac98-273">この要件は重要であり、.NET スレッド同期プリミティブを使用して実現できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-273">This requirement is important and can be accomplished by using .NET thread synchronization primitives.</span></span> <span data-ttu-id="eac98-274">たとえばを使用して、 **AutoResetEvent**は。</span><span class="sxs-lookup"><span data-stu-id="eac98-274">For example, using an **AutoResetEvent**, you would:</span></span>  
  
    -   <span data-ttu-id="eac98-275">メイン ワーカー スレッドがアクセスできるイベント オブジェクトを宣言し、 **BatchComplete**コールバック オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="eac98-275">Declare the event object where it can be accessed by both the main worker thread and the **BatchComplete** callback object.</span></span>  
  
    -   <span data-ttu-id="eac98-276">メイン ワーカー スレッドでバッチにメッセージを通常どおりに送信し、呼び出すことは**AutoResetEvent.Reset**バッチへの呼び出しの直前に、イベント オブジェクトに対して**ibttransportbatch::done**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-276">On the main worker thread, submit the messages to the batch as usual but then call **AutoResetEvent.Reset** on the event object just before the call to the batch **IBTTransportBatch::Done**.</span></span>  
  
    -   <span data-ttu-id="eac98-277">呼び出す**AutoResetEvent.WaitOne**この同じスレッドからイベント オブジェクトです。</span><span class="sxs-lookup"><span data-stu-id="eac98-277">Call **AutoResetEvent.WaitOne** on the event object from this same thread.</span></span> <span data-ttu-id="eac98-278">これによって、メイン ワーカー スレッドがブロックされます。</span><span class="sxs-lookup"><span data-stu-id="eac98-278">This causees the main worker thread to block.</span></span> <span data-ttu-id="eac98-279">**BatchComplete** BizTalk Server からのコールバック呼び出して**AutoResetEvent.Set**を別のメッセージを処理できるように、ワーカー スレッドのブロックを解除する同じイベント オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="eac98-279">In the **BatchComplete** callback from BizTalk Server you then call **AutoResetEvent.Set** on the same event object to unblock the worker thread so it is ready to process another message.</span></span>  
  
 <span data-ttu-id="eac98-280">強くお勧めする*受信の順序付け*大幅なパフォーマンスの低下が発生するため構成可能なこのできるようにします。</span><span class="sxs-lookup"><span data-stu-id="eac98-280">It is strongly suggested that *receive ordering* like this be made configurable because it causes significant performance degradation.</span></span> <span data-ttu-id="eac98-281">ほとんどではないにせよ、多くの場合、ユーザーはメッセージの順序付けを必要としません。</span><span class="sxs-lookup"><span data-stu-id="eac98-281">Many, if not most, user scenarios do not require ordering of messages.</span></span> <span data-ttu-id="eac98-282">メッセージを中断すると、順序も崩れる可能性があり、</span><span class="sxs-lookup"><span data-stu-id="eac98-282">Suspending messages can also break ordering.</span></span> <span data-ttu-id="eac98-283">この場合の対応はアプリケーションによって異なります。このため、アダプターを構成するポイントを用意し、ユーザーにオプションを提供するのが最良の方法です。</span><span class="sxs-lookup"><span data-stu-id="eac98-283">Exactly what to do in this case is application-dependent, so the best thing for your adapter to do is to offer the user a configuration point.</span></span>  
  
 <span data-ttu-id="eac98-284">順序付けを使用する場合で、順序を破棄するのではなくアダプターを無効にし、処理を停止することを顧客が希望する場合もあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-284">In ordered scenarios, some customers have stated that they would prefer to stop the processing, that is, disable the adapter, rather than break ordering.</span></span> <span data-ttu-id="eac98-285">受信の順序付けがサポートされている MQSeries アダプターを使用すれば、このオプションをユーザーに提供できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-285">The MQSeries adapter, which supports ordered receive, provides this option to the user.</span></span>  
  
## <a name="handle-send-specific-batch-errors"></a><span data-ttu-id="eac98-286">送信に固有のバッチ エラーの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-286">Handle Send-Specific Batch Errors</span></span>  
  
### <a name="handle-send-retry-and-batching"></a><span data-ttu-id="eac98-287">送信再試行とバッチの処理</span><span class="sxs-lookup"><span data-stu-id="eac98-287">Handle Send Retry and Batching</span></span>  
 <span data-ttu-id="eac98-288">送信側バッチ処理の一般的な例としては、次のような処理があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-288">Here is a typical example of send-side batching:</span></span>  
  
-   <span data-ttu-id="eac98-289">BizTalk Server がアダプターにメッセージのバッチを送信します。</span><span class="sxs-lookup"><span data-stu-id="eac98-289">BizTalk Server gives a batch of messages to the adapter.</span></span>  
  
-   <span data-ttu-id="eac98-290">アダプターは、メッセージが送信先に正常に送信されたことを確認した後、BizTalk Server に送信の完了を示す削除メッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="eac98-290">When the adapter determines that it has given the message to its destination correctly, it executes delete back on BizTalk Server indicating that it is done.</span></span> <span data-ttu-id="eac98-291">通常はパフォーマンス向上のため、複数の削除メッセージが任意にまとめられます。</span><span class="sxs-lookup"><span data-stu-id="eac98-291">(As usual, several delete messages can be arbitrarily batched up to improve performance.)</span></span>  
  
 <span data-ttu-id="eac98-292">送信側アダプターでメッセージの処理に失敗した場合、アダプターはそのメッセージに対して次のいずれかの処理を実行します。</span><span class="sxs-lookup"><span data-stu-id="eac98-292">If the send-side adapter fails to process a message, then it may do one of several things with that message:</span></span>  
  
-   <span data-ttu-id="eac98-293">BizTalk Server にメッセージの再試行を要求する。</span><span class="sxs-lookup"><span data-stu-id="eac98-293">The adapter should tell BizTalk Server that it wants a message retried.</span></span> <span data-ttu-id="eac98-294">BizTalk Server はメッセージの再試行を自動的に実行しませんが、</span><span class="sxs-lookup"><span data-stu-id="eac98-294">BizTalk Server does not automatically retry a message.</span></span> <span data-ttu-id="eac98-295">再試行のカウントを保持しており、このカウントはメッセージのコンテキストで参照できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-295">BizTalk Server keeps a count of the retries, and this count can be seen in the message context.</span></span>  
  
-   <span data-ttu-id="eac98-296">メッセージを処理できないと判断し、</span><span class="sxs-lookup"><span data-stu-id="eac98-296">The adapter may determine that it cannot process a message.</span></span> <span data-ttu-id="eac98-297">メッセージを次のトランスポートに移動する。</span><span class="sxs-lookup"><span data-stu-id="eac98-297">In this case, the adapter might move the message to the next transport.</span></span> <span data-ttu-id="eac98-298">アダプターが、これを**MoveToNextTransport**でを呼び出す、**バッチ**オブジェクト。</span><span class="sxs-lookup"><span data-stu-id="eac98-298">The adapter does this with the **MoveToNextTransport** call on the **Batch** object.</span></span>  
  
-   <span data-ttu-id="eac98-299">メッセージを保留キューに移動する。</span><span class="sxs-lookup"><span data-stu-id="eac98-299">The adapter may move the message to the Suspended queue.</span></span>  
  
 <span data-ttu-id="eac98-300">アダプターではメッセージの処理が決定されますが、</span><span class="sxs-lookup"><span data-stu-id="eac98-300">The adapter determines what happens to the message.</span></span> <span data-ttu-id="eac98-301">アダプターの動作を一貫したものにするようお勧めします。こうすることで、BizTalk Server のサポートが容易になります。</span><span class="sxs-lookup"><span data-stu-id="eac98-301">However, it is recommended that you have adapters behave in a consistent manner because this makes a BizTalk Server installation easier to support.</span></span>  
  
 <span data-ttu-id="eac98-302">アダプターは次のような動作に設定することを強くお勧めします。</span><span class="sxs-lookup"><span data-stu-id="eac98-302">It is highly recommended that adapters behave as described below.</span></span> <span data-ttu-id="eac98-303">BizTalk Server に付属のアダプターにはこの動作が設定されています。</span><span class="sxs-lookup"><span data-stu-id="eac98-303">The adapters shipped with BizTalk Server behave like this.</span></span>  
  
### <a name="recommended-behavior-for-handling-send-errors-in-a-batch"></a><span data-ttu-id="eac98-304">バッチでの送信エラー処理に関する推奨動作</span><span class="sxs-lookup"><span data-stu-id="eac98-304">Recommended Behavior for Handling Send Errors in a Batch</span></span>  
 <span data-ttu-id="eac98-305">送信アダプターはいくつかのメッセージを受信し、BizTalk Server に送信します。</span><span class="sxs-lookup"><span data-stu-id="eac98-305">The send adapter receives some messages and submits them to BizTalk Server.</span></span>  
  
 <span data-ttu-id="eac98-306">アダプターでは成功したメッセージごとに、BizTalk Server にメッセージの削除を要求する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-306">For each successful message the adapter should delete that message on BizTalk Server.</span></span> <span data-ttu-id="eac98-307">BizTalk Server への通信はすべてバッチで行います。削除もバッチにまとめることができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-307">All communication back to BizTalk Server is done through batches, and the deletes can be batched up.</span></span> <span data-ttu-id="eac98-308">これらのバッチは、BizTalk Server によってアダプター上に作成されるバッチと同じである必要はありません。</span><span class="sxs-lookup"><span data-stu-id="eac98-308">They do not have to be the same batch that BizTalk Server created on the adapter.</span></span> <span data-ttu-id="eac98-309">SolicitResponse シナリオなどで応答メッセージがある場合は、これらのメッセージも削除メッセージと共に (SubmitResponse で) BizTalk Server に返送する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-309">If there are any response messages (as in a SolicitResponse scenario), then they should be submitted back to BizTalk Server (with SubmitResponse) along with the associated delete.</span></span>  
  
-   <span data-ttu-id="eac98-310">アダプターでメッセージ処理が失敗した場合は、再試行カウントを確認する。</span><span class="sxs-lookup"><span data-stu-id="eac98-310">If the message processing in the adapter was unsuccessful, check the retry count.</span></span>  
  
    -   <span data-ttu-id="eac98-311">再試行カウントが設定値を超えていない場合は、BizTalk Server にメッセージを再送信する。その際、メッセージの再試行回数を設定する。</span><span class="sxs-lookup"><span data-stu-id="eac98-311">If the retry count was not exceeded, resubmit the message to BizTalk Server, remembering to set the retry time on the message.</span></span> <span data-ttu-id="eac98-312">アダプターで使用する再試行カウントと再試行間隔は、メッセージ コンテキストで確認できます。</span><span class="sxs-lookup"><span data-stu-id="eac98-312">The message context provides the retry count and the retry interval the adapter should use.</span></span>  
  
    -   <span data-ttu-id="eac98-313">再試行回数が超過したかどうかを使用して、メッセージを移動するべきでは、アダプター **MoveToNextTransport**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-313">If the retry count was exceeded, then the adapter should attempt to move the message by using **MoveToNextTransport**.</span></span> <span data-ttu-id="eac98-314">再送信と**MoveToNextTransport** BizTalk サーバーに同じバッチ内で削除とメッセージを混在させることができます。</span><span class="sxs-lookup"><span data-stu-id="eac98-314">The resubmit and **MoveToNextTransport** messages can be mixed with the deletes in the same batch back to BizTalk Server.</span></span> <span data-ttu-id="eac98-315">これは必須ではありませんが、有効な方法です。</span><span class="sxs-lookup"><span data-stu-id="eac98-315">This is not required, but can be a useful step.</span></span>  
  
-   <span data-ttu-id="eac98-316">再送信し、 **MoveToNextTransport**アダプターがエラーに対処するための方法です。</span><span class="sxs-lookup"><span data-stu-id="eac98-316">The resubmit and the **MoveToNextTransport** are ways for the adapter to deal with failures.</span></span> <span data-ttu-id="eac98-317">この処理中にエラーが発生することもあります。</span><span class="sxs-lookup"><span data-stu-id="eac98-317">But there can be a failure within the processing of the failure.</span></span> <span data-ttu-id="eac98-318">BizTalk Server からの応答の処理中には、ここでは、(で、 **BatchComplete**メソッド)、アダプターは、そのエラーの処理方法を示すために BizTalk Server に対して別のバッチを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-318">In this case, in processing the response from BizTalk Server (in the **BatchComplete** method) the adapter must create another batch against BizTalk Server to indicate what to do with that failure.</span></span>  
  
     <span data-ttu-id="eac98-319">失敗への対処中に起こったエラーを処理するには、次の手順に従います。</span><span class="sxs-lookup"><span data-stu-id="eac98-319">Follow these steps when processing a failure that occurs within the processing of another failure:</span></span>  
  
    -   <span data-ttu-id="eac98-320">再送信が失敗すると、 **MoveToNextTransport**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-320">If the resubmit fails, use **MoveToNextTransport**.</span></span>  
  
    -   <span data-ttu-id="eac98-321">場合、 **MoveToNextTransport**失敗した場合を使用して**MoveToSuspendQ**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-321">If the **MoveToNextTransport** fails, use **MoveToSuspendQ**.</span></span>  
  
 <span data-ttu-id="eac98-322">BizTalk Server で操作の成功を受信するまで、BizTalk Server に対してバッチの作成を続ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-322">You must keep creating batches on BizTalk Server until you receive a successful action back on BizTalk Server.</span></span>  
  
### <a name="serialization-of-message-context-property"></a><span data-ttu-id="eac98-323">メッセージ コンテキスト プロパティのシリアル化</span><span class="sxs-lookup"><span data-stu-id="eac98-323">Serialization of Message Context Property</span></span>  
 <span data-ttu-id="eac98-324">メッセージ コンテキスト プロパティに割り当てるオブジェクトはすべてシリアル化できる必要があります。</span><span class="sxs-lookup"><span data-stu-id="eac98-324">All objects assigned to a message context property must be serializable.</span></span> <span data-ttu-id="eac98-325">それ以外の場合、メッセージング エンジンは型の例外をスロー **E_NOINTERFACE**です。</span><span class="sxs-lookup"><span data-stu-id="eac98-325">Otherwise the Messaging Engine will throw an exception of type **E_NOINTERFACE**.</span></span> <span data-ttu-id="eac98-326">この戻り値は、メッセージ コンテキスト プロパティに対してシリアル化できないオブジェクトの割り当てが試行されたことを暗黙的に示すものです。</span><span class="sxs-lookup"><span data-stu-id="eac98-326">This return value ambiguously represents a non-serializable object attempting to be assigned the message context.</span></span>