---
title: "コンボイ シナリオの |Microsoft ドキュメント"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
ms.assetid: 1028ab37-7ead-41a6-a186-53e5344d1a28
caps.latest.revision: "19"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 42f1c9931fe91b284c53a05c7868554c622306fb
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
---
# <a name="working-with-convoy-scenarios"></a><span data-ttu-id="07047-102">コンボイ シナリオの活用</span><span class="sxs-lookup"><span data-stu-id="07047-102">Working with Convoy Scenarios</span></span>
<span data-ttu-id="07047-103">A*コンボイ*複数の単一メッセージは、必要な結果を得るに関連付ける必要があるときに存在します。</span><span class="sxs-lookup"><span data-stu-id="07047-103">A *convoy* exists any time that multiple single messages must be related to achieve the required result.</span></span> <span data-ttu-id="07047-104">大きく分けて、コンボイには "シーケンシャル" と "パラレル" という 2 つの種類があります。</span><span class="sxs-lookup"><span data-stu-id="07047-104">There are two main types of convoys: sequential and parallel.</span></span>  
  
 <span data-ttu-id="07047-105">状況によっては、オーケストレーション インスタンスに、関連付けられた複数のメッセージがすべて一度に渡される場合があります。</span><span class="sxs-lookup"><span data-stu-id="07047-105">Under certain conditions, an orchestration instance might receive a group of correlated messages all at the same time.</span></span> <span data-ttu-id="07047-106">このような場合、グループ内のいずれかのメッセージがオーケストレーション インスタンスの関連付けセットを初期化してからでないと、他のメッセージをそのオーケストレーション インスタンスに関連付けることができないという、競合状態が発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="07047-106">In this situation, a race condition might occur, in which one of the messages in the group must initialize a correlation set in the orchestration instance before the other messages can be correlated to that orchestration instance.</span></span>  
  
 <span data-ttu-id="07047-107">BizTalk Server は、こうした競合状態が発生する可能性を検知し、関連付けられたメッセージをコンボイとして処理することで、すべてのメッセージを同一のオーケストレーション インスタンスで受信できるようにします。</span><span class="sxs-lookup"><span data-stu-id="07047-107">To ensure that all of the correlated messages are received by the same orchestration instance, BizTalk Server detects the potential for such a race condition and treats these messages as a convoy.</span></span> <span data-ttu-id="07047-108">ランタイムは、参加時に全般サブスクリプションを作成し、それをコンボイの一部として識別します。</span><span class="sxs-lookup"><span data-stu-id="07047-108">At enlistment, the runtime creates a general subscription and identifies it as part of a convoy.</span></span> <span data-ttu-id="07047-109">このサブスクリプションの入力が完了した後、メッセージング エンジンは、あらかじめ定義された関連付けプロパティの値に基づいて一時サブスクリプションを作成します。</span><span class="sxs-lookup"><span data-stu-id="07047-109">After filling this subscription, the messaging engine creates a temporary subscription based on the values in the predefined correlation properties.</span></span> <span data-ttu-id="07047-110">この一時サブスクリプションと呼ばれる、*コンボイ セット*です。</span><span class="sxs-lookup"><span data-stu-id="07047-110">This temporary subscription is called a *convoy set*.</span></span> <span data-ttu-id="07047-111">コンボイ セットは、コンボイで使用される関連付けセットのグループです。</span><span class="sxs-lookup"><span data-stu-id="07047-111">A convoy set is a group of correlation sets that are used in a convoy.</span></span> <span data-ttu-id="07047-112">これ以降、全般サブスクリプションに一致するメッセージはすべてコンボイ セットに対して評価され、コンボイ セットに一致するメッセージが既存のポートに送られます。</span><span class="sxs-lookup"><span data-stu-id="07047-112">All subsequent messages that match the general subscription are evaluated against the convoy set, and those that match are routed to an existing port.</span></span>  
  
## <a name="using-convoys-with-business-processes"></a><span data-ttu-id="07047-113">ビジネス プロセスでのコンボイの使用</span><span class="sxs-lookup"><span data-stu-id="07047-113">Using Convoys with Business Processes</span></span>  
 <span data-ttu-id="07047-114">次に、ビジネス プロセスでコンボイ処理を使用する際の注意事項を示します。</span><span class="sxs-lookup"><span data-stu-id="07047-114">Consider the following when using convoy processing with a business process:</span></span>  
  
-   <span data-ttu-id="07047-115">A*関連付けセット*特定のビジネス プロセスにメッセージをルーティングを使用する特定の値を持つプロパティの一覧を示します。</span><span class="sxs-lookup"><span data-stu-id="07047-115">A *correlation set* is a list of properties with specific values that you use to route messages to a specific business process.</span></span> <span data-ttu-id="07047-116">関連付けセットで使用される、**受信**図形で関連付けに使用される 4 つ以上のプロパティを含めることはできません。</span><span class="sxs-lookup"><span data-stu-id="07047-116">The correlation set used on a **Receive** shape cannot contain more than three properties used for correlation.</span></span> <span data-ttu-id="07047-117">これらの値は、最大で 3 つのパラメーターをサポートするデータベース レベルで識別および格納されるためです。</span><span class="sxs-lookup"><span data-stu-id="07047-117">This is because these values are identified and stored at the database level, which supports a maximum of three parameters.</span></span>  
  
-   <span data-ttu-id="07047-118">パラレルなコンボイとシーケンシャルなコンボイは、同じビジネス プロセス内で共存できますが、関連付けセットを共有することはできません。</span><span class="sxs-lookup"><span data-stu-id="07047-118">Parallel and sequential convoys can coexist in the same business process, but they cannot share any correlation sets with each other.</span></span> <span data-ttu-id="07047-119">これは、各関連付けセットが 1 つのコンボイにしか属すことができないためです。</span><span class="sxs-lookup"><span data-stu-id="07047-119">This is because each correlation set can belong to only one convoy.</span></span>  
  
-   <span data-ttu-id="07047-120">コンボイ処理を使用するときに、BizTalk Server でサポートされません、**オーケストレーションの開始**渡すよう初期化済みの関連付けセットが、新しいオーケストレーションに図形です。</span><span class="sxs-lookup"><span data-stu-id="07047-120">BizTalk Server does not support convoy processing when you use the **Start Orchestration** shape to pass an already-initialized correlation set into a new orchestration.</span></span> <span data-ttu-id="07047-121">これは、既に実行中のオーケストレーション インスタンスとは無関係に、コンボイ セットがデータベース レベルで処理されるためです。</span><span class="sxs-lookup"><span data-stu-id="07047-121">This is because convoy sets are handled at the database level, independent of already-running orchestration instances.</span></span>  
  
-   <span data-ttu-id="07047-122">1 つを使用することはできません**受信**図形を別々 のコンボイで使用される 2 つまたは複数の関連付けセットを初期化します。</span><span class="sxs-lookup"><span data-stu-id="07047-122">You cannot use a single **Receive** shape to initialize two or more correlation sets that will be used in separate convoys.</span></span> <span data-ttu-id="07047-123">たとえば、受信図形 r1 で最初のコンボイ用の関連付けセット c1 および c2 を初期化し、受信図形 r2 が 2 番目のコンボイ用の c1 に、受信図形 r3 が 3 番目のコンボイ用の c2 にそれぞれ従うものと仮定します。</span><span class="sxs-lookup"><span data-stu-id="07047-123">For example, suppose that receive r1 initializes correlation sets c1 and c2 for the first convoy, receive r2 follows c1 for the second convoy, and receive r3 follows c2 for the third convoy.</span></span> <span data-ttu-id="07047-124">2 番目のコンボイ用のコンボイ セットは c1 および r2 で、3 番目のコンボイ用のコンボイ セットは c2 および r3 です。これらはすべて r1 によって初期化されます。</span><span class="sxs-lookup"><span data-stu-id="07047-124">The intended convoy sets for the second convoy are c1, r2 and the intended convoy sets for the third convoy are c2, r3, which are all initialized by r1.</span></span> <span data-ttu-id="07047-125">この場合、オーケストレーション エンジンは、これらをコンボイとして処理しません。</span><span class="sxs-lookup"><span data-stu-id="07047-125">In this case, the orchestration engine will not treat these as convoys.</span></span> <span data-ttu-id="07047-126">r2 と r3 の両方が c1 と c2 の両方に従うか (c1、r2、r3、および c2、r2、r3)、両方が c1 のみに従うか (c1、r2、r3)、または両方が c2 のみに従う (c2、r2、r3) 場合、この例は有効なコンボイ シナリオになります。</span><span class="sxs-lookup"><span data-stu-id="07047-126">The example is a valid convoy scenario if both r2 and r3 follow both c1 and c2 (c1, r2, r3 and c2, r2, r3), both follow c1 only (c1, r2, r3), or both follow c2 only (c2, r2, r3).</span></span>  
  
## <a name="zombies"></a><span data-ttu-id="07047-127">ゾンビ</span><span class="sxs-lookup"><span data-stu-id="07047-127">Zombies</span></span>  
 <span data-ttu-id="07047-128">コンボイを使用する場合、ゾンビと呼ばれる "失われた" メッセージが発生する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="07047-128">The use of convoys can result in "lost" messages called zombies.</span></span> <span data-ttu-id="07047-129">実行中のオーケストレーション内の非アクティブな受信サブスクリプションがメッセージ ボックス データベース内のメッセージに一致した場合、メッセージ ボックスはそのメッセージをオーケストレーションに配信します。</span><span class="sxs-lookup"><span data-stu-id="07047-129">When a non-activating receive subscription in a running orchestration matches a message in the MessageBox database, then the MessageBox delivers the message to the orchestration.</span></span> <span data-ttu-id="07047-130">メッセージ ボックスは、オーケストレーション内のビジネス ロジックを認識できません。したがって、サブスクリプションに一致するすべてのメッセージをオーケストレーションに配信するだけです。</span><span class="sxs-lookup"><span data-stu-id="07047-130">Because the MessageBox does not know the business logic inside the orchestration, it simply delivers to the orchestration all the messages that match the subscription.</span></span> <span data-ttu-id="07047-131">これらのメッセージが配信されたとき、オーケストレーション実行フローが、そのメッセージを処理する受信サブスクリプションを既に過ぎていた場合、配信されたメッセージはゾンビになります。</span><span class="sxs-lookup"><span data-stu-id="07047-131">If any of these messages are delivered when the orchestration execution flow has passed the receive subscriptions that can consume the messages, then such messages become zombies.</span></span>  
  
 <span data-ttu-id="07047-132">たとえば、処理を 17 回繰り返すループに受信サブスクリプションが設定されており、そのサブスクリプションに一致するメッセージを 18 件受け取った場合にゾンビが発生します </span><span class="sxs-lookup"><span data-stu-id="07047-132">An example of a situation that creates zombies is a receive inside a loop that iterates 17 times, but 18 messages are delivered that match the receive subscription in the loop.</span></span> <span data-ttu-id="07047-133">(メッセージ ボックスは、17 個のメッセージのみがオーケストレーション ロジックで処理されるということを認識しません)。18 番目のメッセージが配信されたとき、実行フローは既にループから抜けているので、この最後のメッセージはオーケストレーションで処理されません。</span><span class="sxs-lookup"><span data-stu-id="07047-133">(The MessageBox does not know that the orchestration logic only handles 17 messages.) The 18th message delivered is not consumed by the orchestration because execution flow has already exited the loop.</span></span> <span data-ttu-id="07047-134">オーケストレーションはメッセージを破棄して終了します。オーケストレーション インスタンスが既に終了しているため、破棄されたメッセージ (ゾンビ) は再開できません。</span><span class="sxs-lookup"><span data-stu-id="07047-134">The orchestration is completed with discarded messages (zombies), which are not resumable because the orchestration instance has already completed.</span></span>  
  
 <span data-ttu-id="07047-135">ゾンビを管理するには、Windows Management Instrumentation (WMI) スクリプトを使用して、"中断 (再開不可)" 状態のインスタンスをクエリします。</span><span class="sxs-lookup"><span data-stu-id="07047-135">You can manage zombies by using a Windows Management Instrumentation (WMI) script to query the instances with the "Suspended-NonResumable" state.</span></span> <span data-ttu-id="07047-136">また、メッセージング エンジンは、"メッセージを破棄して完了" というエラー メッセージをイベント ログに書き込みます。</span><span class="sxs-lookup"><span data-stu-id="07047-136">In addition, the messaging engine writes an error message, "Completed with discarded messages", to the event log.</span></span>  
  
 <span data-ttu-id="07047-137">さらに、トランザクション スコープが長時間にわたるシーケンシャル コンボイがあり、そのスコープにタイムアウトを設定している場合は、一部のオーケストレーション インスタンスが "中断 (再開不可)" 状態になる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="07047-137">Moreover, if you have a sequential convoy with a long-running transactional scope, and the scope has a time-out setting, some orchestration instances may end up in the "Suspended-NonResumable" state.</span></span> <span data-ttu-id="07047-138">また、出力メッセージの数と "中断 (再開不可)" インスタンスの数の和が、入力メッセージの数より少なくなることもあります。</span><span class="sxs-lookup"><span data-stu-id="07047-138">You may also notice that the number of output messages plus the number of "Suspended-NonResumable" instances is less than the number of input messages.</span></span> <span data-ttu-id="07047-139">この動作は仕様による結果です。</span><span class="sxs-lookup"><span data-stu-id="07047-139">This behavior is by design.</span></span> <span data-ttu-id="07047-140">タイムアウト例外が発生すると、コード内の例外ハンドラーに処理が移ります。</span><span class="sxs-lookup"><span data-stu-id="07047-140">When a time-out exception happens, the code goes into the exception handler.</span></span> <span data-ttu-id="07047-141">BizTalk Server は、例外ハンドラーを呼び出して例外を処理させます (ゾンビの処理など)。</span><span class="sxs-lookup"><span data-stu-id="07047-141">BizTalk Server calls the exception handler to let it handle the exception, including handling the zombies.</span></span> <span data-ttu-id="07047-142">例外ハンドラーで送信ポートを使用し、ゾンビを別の場所へ送信すると、後で詳しく調べて処理することができます。</span><span class="sxs-lookup"><span data-stu-id="07047-142">You can use a send port in the exception handler to send the zombies to a destination for further review and processing.</span></span>  
  
 <span data-ttu-id="07047-143">コンボイ以外のシナリオでもゾンビが発生することがあります。</span><span class="sxs-lookup"><span data-stu-id="07047-143">Scenarios other than convoys can also generate zombies.</span></span> <span data-ttu-id="07047-144">たとえば、オーケストレーション インスタンスが、ビジネス プロセスから 1 件の応答メッセージを受け取ると想定しているときに、何らかの理由でサブスクリプションに一致する応答メッセージを 2 件受け取った場合などです。</span><span class="sxs-lookup"><span data-stu-id="07047-144">For example, suppose that an orchestration instance is expecting one response message from a business process, and for some reason, it receives two matching subscription response messages.</span></span> <span data-ttu-id="07047-145">この場合、2 番目の応答メッセージはゾンビになります。</span><span class="sxs-lookup"><span data-stu-id="07047-145">In this case, the second response message becomes a zombie.</span></span> <span data-ttu-id="07047-146">別の例がある場合、**リッスン**図形を含み、**受信**1 つの分岐に図形と**遅延**他の分岐に図形です。</span><span class="sxs-lookup"><span data-stu-id="07047-146">Another example is when you have a **Listen** shape with a **Receive** shape at one branch and a **Delay** shape at the other branch.</span></span> <span data-ttu-id="07047-147">メッセージの到着と同時にタイムアウトが発生した場合、そのメッセージはゾンビになります。</span><span class="sxs-lookup"><span data-stu-id="07047-147">If a message arrives at the same time that the time-out occurs, the message becomes a zombie.</span></span>  
  
 <span data-ttu-id="07047-148">ゾンビを管理する方法の詳細については、次を参照してください。**中断サービス インスタンスを削除する**[!INCLUDE[ui-guidance-developers-reference](../includes/ui-guidance-developers-reference.md)]です。</span><span class="sxs-lookup"><span data-stu-id="07047-148">For more information about how to manage zombies, see **Removing Suspended Service Instances** [!INCLUDE[ui-guidance-developers-reference](../includes/ui-guidance-developers-reference.md)].</span></span>
  
## <a name="next-steps"></a><span data-ttu-id="07047-149">次の手順</span><span class="sxs-lookup"><span data-stu-id="07047-149">Next steps</span></span>
 [<span data-ttu-id="07047-150">シーケンシャルなコンボイ</span><span class="sxs-lookup"><span data-stu-id="07047-150">Sequential Convoys</span></span>](../core/sequential-convoys.md)  
  
 [<span data-ttu-id="07047-151">パラレルなコンボイ</span><span class="sxs-lookup"><span data-stu-id="07047-151">Parallel Convoys</span></span>](../core/parallel-convoys.md)  
  
## <a name="see-also"></a><span data-ttu-id="07047-152">参照</span><span class="sxs-lookup"><span data-stu-id="07047-152">See Also</span></span>  
 [<span data-ttu-id="07047-153">オーケストレーションでの相関関係の使用</span><span class="sxs-lookup"><span data-stu-id="07047-153">Using Correlations in Orchestrations</span></span>](../core/using-correlations-in-orchestrations.md)