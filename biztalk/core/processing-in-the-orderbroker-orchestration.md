---
title: "OrderBroker オーケストレーションで処理 |Microsoft ドキュメント"
ms.custom: 
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: 
ms.suite: 
ms.tgt_pltfrm: 
ms.topic: article
helpviewer_keywords:
- orchestrations, examples
- orchestrations, nested scopes
- nested scopes, performance
- processing, examples
- nested scopes, orchestrations
- orchestrations, performance
- performance, orchestrations
- performance, nested scopes
- examples, orchestration processing [process management solution]
- scopes, nesting
ms.assetid: c296e00c-b3ad-4161-baf7-258899185c34
caps.latest.revision: "23"
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 7c6a6571ece3190b6195b207b4c45969ce25ddec
ms.sourcegitcommit: cb908c540d8f1a692d01dc8f313e16cb4b4e696d
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/20/2017
---
# <a name="processing-in-the-orderbroker-orchestration"></a><span data-ttu-id="c3149-102">OrderBroker オーケストレーションでの処理</span><span class="sxs-lookup"><span data-stu-id="c3149-102">Processing in the OrderBroker Orchestration</span></span>
<span data-ttu-id="c3149-103">このセクションの内容について説明しますが、どのように**OrderBroker**オーケストレーションが注文を受け付けるし、準備がプロセス マネージャー。</span><span class="sxs-lookup"><span data-stu-id="c3149-103">This section describes how the **OrderBroker** orchestration takes orders and prepares them for a process manager.</span></span> <span data-ttu-id="c3149-104">まず、オーケストレーションの一般的な動作について説明します。</span><span class="sxs-lookup"><span data-stu-id="c3149-104">The section begins by discussing the general workings of the orchestration.</span></span> <span data-ttu-id="c3149-105">次に、オーケストレーションがメッセージを処理する方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="c3149-105">The next part discusses how the orchestration processes a message.</span></span> <span data-ttu-id="c3149-106">最後に、オーケストレーションがアトミック トランザクションを使用してパフォーマンスを向上させるしくみを明らかにします。</span><span class="sxs-lookup"><span data-stu-id="c3149-106">It then highlights how the orchestration uses an atomic transaction to improve performance.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="c3149-107">長さの長さのため、 **OrderBroker**コード、オーケストレーションを Microsoft® Visual Studio で開いてこのセクションを参照する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="c3149-107">Because of the length of the length of the **OrderBroker** code, you may want to read this section with the orchestration open in Microsoft® Visual Studio.</span></span>  
  
## <a name="why-an-order-broker"></a><span data-ttu-id="c3149-108">注文ブローカとは</span><span class="sxs-lookup"><span data-stu-id="c3149-108">Why an Order Broker?</span></span>  
 <span data-ttu-id="c3149-109">目的、 **OrderBroker**オーケストレーションでは、注文を正しいプロセス マネージャにルーティングします。</span><span class="sxs-lookup"><span data-stu-id="c3149-109">The purpose of the **OrderBroker** orchestration is to preprocess an order and route it to the correct process manager.</span></span> <span data-ttu-id="c3149-110">この前処理は、履歴データベース、サービス提供システム、および受注確認のための情報メッセージの生成から成ります。</span><span class="sxs-lookup"><span data-stu-id="c3149-110">Pre-processing here consists of producing informational messages for the history database, for the servicing system, and to acknowledge receipt of the order.</span></span> <span data-ttu-id="c3149-111">**OrderBroker**カスタマー サービス要求から一般的な注文メッセージも作成されます。</span><span class="sxs-lookup"><span data-stu-id="c3149-111">The **OrderBroker** also creates a generic order message from the customer service request.</span></span> <span data-ttu-id="c3149-112">この注文の正規化によって、ビジネスプロセスの要素による注文の汎用使用が可能になります。</span><span class="sxs-lookup"><span data-stu-id="c3149-112">This normalization of the order allows for generic consumption of the order by elements of the business process.</span></span>  
  
 <span data-ttu-id="c3149-113">注文メッセージはマルチパート メッセージであり、ルーティング情報と注文情報に分かれています。</span><span class="sxs-lookup"><span data-stu-id="c3149-113">The order message is a multipart message with routing information separated from the order information.</span></span> <span data-ttu-id="c3149-114">ルーティング情報も汎用的で、どの注文マネージャでも使用できるように設計されています。</span><span class="sxs-lookup"><span data-stu-id="c3149-114">The routing information is also generic and designed to be consumed by any order manager.</span></span> <span data-ttu-id="c3149-115">こうすることで、ソリューションを拡張しやすくなります。</span><span class="sxs-lookup"><span data-stu-id="c3149-115">This, in turn, makes it easier to expand the solution.</span></span> <span data-ttu-id="c3149-116">マルチパート メッセージの詳細については、次を参照してください。[マルチパート メッセージの種類を使用する方法](../core/how-to-use-multi-part-message-types.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-116">For information about multi-part messages, see [How to Use Multi-part Message Types](../core/how-to-use-multi-part-message-types.md).</span></span>  
  
 <span data-ttu-id="c3149-117">ブローカ機能を分離すると、それを別の BizTalk グループに移動することもできます。</span><span class="sxs-lookup"><span data-stu-id="c3149-117">Isolating the brokering function also allows you to move it to another BizTalk group.</span></span> <span data-ttu-id="c3149-118">**OrderBroker**をメッセージ ボックス データベースに公開: つまり、これは直接バインド: も簡単に別のグループに、ブローカーは、オーケストレーションを変更することがなく、ブローカーを行うことができます。</span><span class="sxs-lookup"><span data-stu-id="c3149-118">Because the **OrderBroker** publishes to the MessageBox database—that is, it is direct-bound—also makes it easier to put the broker in another group --you can move the broker without changing the orchestration.</span></span> <span data-ttu-id="c3149-119">配置の詳細については、 **OrderBroker**別のグループで、次を参照してください。 [OrderBroker と OrderManager 間の通信](../core/communication-between-orderbroker-and-ordermanager.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-119">For more information about putting the **OrderBroker** in another group, see [Communication between OrderBroker and OrderManager](../core/communication-between-orderbroker-and-ordermanager.md).</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="c3149-120">**OrderBroker**オーケストレーション、1 つだけがあるため**OrderManager** 、通信するために割り当てるだけ定数文字列を**OrderMgrType**フィールドの順序メッセージのマネージャーです。</span><span class="sxs-lookup"><span data-stu-id="c3149-120">The **OrderBroker** orchestration, because it has only one **OrderManager** to communicate with, simply assigns a constant string to the **OrderMgrType** field in the order manager message.</span></span> <span data-ttu-id="c3149-121">通常、複数の注文マネージャがあるアプリケーションでは、アプリケーションがビジネス ルール エンジンを使用して、このフィールドの値と正しい注文経路を決定します。</span><span class="sxs-lookup"><span data-stu-id="c3149-121">Typically, in an application where there were multiple order managers, the application would use the Business Rule Engine to determine the proper value for this field and the order routing.</span></span> <span data-ttu-id="c3149-122">ビジネス ルール エンジンの詳細については、次を参照してください。[を使用してビジネス ルールの作成と](../core/creating-and-using-business-rules.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-122">For more information about the Business Rule Engine, see [Creating and Using Business Rules](../core/creating-and-using-business-rules.md).</span></span>  
  
## <a name="order-processing"></a><span data-ttu-id="c3149-123">注文処理</span><span class="sxs-lookup"><span data-stu-id="c3149-123">Order Processing</span></span>  
 <span data-ttu-id="c3149-124">**OrderBroker**オーケストレーションは、最初の 2 つ**受信**内の図形は、**リッスン**図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-124">The **OrderBroker** orchestration begins with two **Receive** shapes within a **Listen** shape.</span></span> <span data-ttu-id="c3149-125">1 つ**受信**図形はカスタマー サポート システムからのメッセージは、ベンダ システムから、他のメッセージ。</span><span class="sxs-lookup"><span data-stu-id="c3149-125">One **Receive** shape takes messages from the customer support system; the other, messages from the vendor system.</span></span> <span data-ttu-id="c3149-126">どちらのソースのメッセージも同じスキーマです。</span><span class="sxs-lookup"><span data-stu-id="c3149-126">Messages from either source have the same schema.</span></span>  
  
 <span data-ttu-id="c3149-127">オーケストレーションがメッセージから戻り値のアドレスを抽出し、動的ポートのアドレスを設定するため**CSRPort**です。</span><span class="sxs-lookup"><span data-stu-id="c3149-127">The orchestration extracts the return address from the message and uses it to set the address for the dynamic port, **CSRPort**.</span></span> <span data-ttu-id="c3149-128">オーケストレーションはこのポートを使用して受信確認やエラーメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="c3149-128">The orchestration uses this port to send acknowledgement and error messages.</span></span>  
  
 <span data-ttu-id="c3149-129">次のステップで、 **OrderBroker**履歴メッセージ、サービス メッセージ、確認のメッセージ、および注文メッセージを送信するオーケストレーションが作成、 **OrderManager**オーケストレーションです。</span><span class="sxs-lookup"><span data-stu-id="c3149-129">The next steps in the **OrderBroker** orchestration create the history message, the service message, the confirmation message, and the order message to send to the **OrderManager** orchestration.</span></span> <span data-ttu-id="c3149-130">オーケストレーションを使用して、 **InsertOrderBody**履歴メッセージに、注文メッセージを追加するユーティリティ関数です。</span><span class="sxs-lookup"><span data-stu-id="c3149-130">The orchestration uses the **InsertOrderBody** utility function to add the order message to the history message.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="c3149-131">状況によっては、配信されても使用されないメッセージをソリューションが生成することがあります。</span><span class="sxs-lookup"><span data-stu-id="c3149-131">In some situations the solution may produce messages that are delivered but not consumed.</span></span> <span data-ttu-id="c3149-132">オーダー ブローカ オーケストレーションは送信ポートを使用して、履歴データベースに情報を挿入します。</span><span class="sxs-lookup"><span data-stu-id="c3149-132">The order broker orchestration uses a send port to insert information in the history database.</span></span> <span data-ttu-id="c3149-133">この送信ポートは配信通知を使用します。</span><span class="sxs-lookup"><span data-stu-id="c3149-133">This send port uses delivery notification.</span></span> <span data-ttu-id="c3149-134">構成は、次の 2 つのポートを含む送信ポート グループに、送信ポートをマップ: テスト構成の 1 つのポート (**HISTORYINSERT-SP テスト**)、正規の構成のいずれか (**HISTORYINSERT-SP**)。</span><span class="sxs-lookup"><span data-stu-id="c3149-134">Configuration maps the send port to a send port group containing two ports—one port for the test configuration (**HistoryInsert-Test-SP**), one for the regular configuration (**HistoryInsert-SP**).</span></span> <span data-ttu-id="c3149-135">グループの両方のポートを開けておくと、両方のポートにメッセージが送信されます。</span><span class="sxs-lookup"><span data-stu-id="c3149-135">If you leave both ports in the group running, the solution sends messages on both ports.</span></span> <span data-ttu-id="c3149-136">したがって、2 つの配信通知が要求されますが、処理されるのは 1 つだけです。</span><span class="sxs-lookup"><span data-stu-id="c3149-136">It thus requests two delivery notifications but processes only one.</span></span>  
>   
>  <span data-ttu-id="c3149-137">このような状況を避けるためには、テスト ポートを参加解除 (**HISTORYINSERT-SP テスト**)、または停止する、アプリケーションのテスト版**BTSScn.BPM.OrderBrokerApp.Test**です。</span><span class="sxs-lookup"><span data-stu-id="c3149-137">To avoid this situation, unenlist the test port (**HistoryInsert-Test-SP**), or stop the test version of the application, **BTSScn.BPM.OrderBrokerApp.Test**.</span></span> <span data-ttu-id="c3149-138">配信通知の詳細については、次を参照してください。[を使用して受信確認](../core/using-acknowledgments.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-138">For more information about delivery notifications, see [Using Acknowledgments](../core/using-acknowledgments.md).</span></span>  
  
 <span data-ttu-id="c3149-139">送信するメッセージを構築するときに、 **OrderManager**オーケストレーション、 **OrderBroker**オーケストレーションは、マルチパート メッセージを 2 つの部分を作成します。</span><span class="sxs-lookup"><span data-stu-id="c3149-139">When constructing the message to send to the **OrderManager** orchestration, the **OrderBroker** orchestration creates a multi-part message with two parts.</span></span> <span data-ttu-id="c3149-140">1 つの部分にはルーティング情報、もう一方には注文自体が含まれています。</span><span class="sxs-lookup"><span data-stu-id="c3149-140">One part contains the routing information; the other, the order itself.</span></span> <span data-ttu-id="c3149-141">メッセージのルーティングの部分**OrderMgrMsg.Routing**で c# クラスによって定義されたスキーマを使用して、 **SchemaClasses**アセンブリ。</span><span class="sxs-lookup"><span data-stu-id="c3149-141">The routing part of the message, **OrderMgrMsg.Routing**, uses a schema defined by a C# class in the **SchemaClasses** assembly.</span></span> <span data-ttu-id="c3149-142">ブローカーは、順序、ジェネリックでは、メッセージの一部または種類に関係なく、XML ドキュメントを処理 (**System.Xml.XmlDocument**) に割り当てます**OrderMgrMsg.Order**です。</span><span class="sxs-lookup"><span data-stu-id="c3149-142">The broker treats the order part of the message as a generic, or type-agnostic, XML document (**System.Xml.XmlDocument**) and assigns it to **OrderMgrMsg.Order**.</span></span>  
  
 <span data-ttu-id="c3149-143">ルーティング情報、注文マネージャにとって特に重要な 2 つのフィールドがある**OrderMgrMsg.Routing.OrderMgrType**と**OrderMgrMsg.Routing.Status**です。</span><span class="sxs-lookup"><span data-stu-id="c3149-143">There are two fields in the routing information that are especially important to the order manager, **OrderMgrMsg.Routing.OrderMgrType** and **OrderMgrMsg.Routing.Status**.</span></span> <span data-ttu-id="c3149-144">ブローカーの設定、 **OrderMgrType**は注文を処理する注文マネージャの型にします。</span><span class="sxs-lookup"><span data-stu-id="c3149-144">The broker sets the **OrderMgrType** to the type of the order manager that is to handle the order.</span></span> <span data-ttu-id="c3149-145">ソリューションには注文マネージャが 1 つだけあり、そのフィールドが CABLEORDER に設定されます。</span><span class="sxs-lookup"><span data-stu-id="c3149-145">In the solution, there is only one order manager and the field is set to CABLEORDER.</span></span> <span data-ttu-id="c3149-146">また、ブローカを設定、**ステータス**フィールドを ACCEPTED にします。</span><span class="sxs-lookup"><span data-stu-id="c3149-146">The broker also sets the **Status** field to ACCEPTED.</span></span> <span data-ttu-id="c3149-147">この値は、メッセージが新しい注文であることを注文マネージャに知らせます。</span><span class="sxs-lookup"><span data-stu-id="c3149-147">This is the value that tells the order manager the message is a new order.</span></span> <span data-ttu-id="c3149-148">ソリューションでは、注文マネージャ**OrderManager**オーケストレーションを使用して、**受信**CABLEORDER と状態 accepted と同じ注文タイプのフィルター処理する図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-148">The order manager in the solution, **OrderManager** orchestration, uses a **Receive** shape that filters for the order type equal to CABLEORDER and status equal to ACCEPTED.</span></span>  
  
 <span data-ttu-id="c3149-149">残りの手順を**OrderBroker**オーケストレーションが適切なポートに別のメッセージを送信します。</span><span class="sxs-lookup"><span data-stu-id="c3149-149">The remaining steps in the **OrderBroker** orchestration send the different messages to the appropriate ports.</span></span>  
  
## <a name="improving-performance-with-nested-scopes"></a><span data-ttu-id="c3149-150">入れ子になったスコープのパフォーマンスの向上</span><span class="sxs-lookup"><span data-stu-id="c3149-150">Improving Performance with Nested Scopes</span></span>  
 <span data-ttu-id="c3149-151">について目立つ点の 1 つ、 **OrderBroker**オーケストレーションは、入れ子になったスコープを使用します。</span><span class="sxs-lookup"><span data-stu-id="c3149-151">One of the noticeable things about the **OrderBroker** orchestration is its use of nested scopes.</span></span> <span data-ttu-id="c3149-152">入れ子になったスコープが使用されている理由の 1 つは、永続化ポイントを制限してパフォーマンスを向上させることです。</span><span class="sxs-lookup"><span data-stu-id="c3149-152">The nested scopes are there, in part, to improve performance by limiting the persistence points.</span></span>  
  
 <span data-ttu-id="c3149-153">オーケストレーション エンジンは、永続化ポイントと呼ばれる実行ポイントでオーケストレーション全体の状態を定期的に保存します。</span><span class="sxs-lookup"><span data-stu-id="c3149-153">The orchestration engine periodically saves the state of the entire orchestration at execution points called persistence points.</span></span> <span data-ttu-id="c3149-154">オーケストレーション エンジンを含め、複数のオーケストレーション図形を自動的に処理する**送信**永続化ポイントとしての図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-154">The orchestration engine automatically treats several orchestration shapes, including **Send** shapes, as persistence points.</span></span> <span data-ttu-id="c3149-155">永続化ポイントとその詳細情報の一覧は、次を参照してください。[永続性と、オーケストレーション エンジン](../core/persistence-and-the-orchestration-engine.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-155">For a list of persistence points and more information about them, see [Persistence and the Orchestration Engine](../core/persistence-and-the-orchestration-engine.md).</span></span>  
  
 <span data-ttu-id="c3149-156">5 つ**送信**、図形、 **OrderBroker**オーケストレーションは、5 つの永続化ポイントを持つ必要があります。</span><span class="sxs-lookup"><span data-stu-id="c3149-156">With five **Send** shapes, the **OrderBroker** orchestration should have five persistence points.</span></span> <span data-ttu-id="c3149-157">ただし、グループ**送信**アトミック トランザクション スコープ内部の図形、エンジンは、認識のスコープの 1 つの永続性ポイントしか必要があります。</span><span class="sxs-lookup"><span data-stu-id="c3149-157">However, when you group **Send** shapes inside an atomic transaction scope, the engine recognizes it only needs one persistence point for the scope.</span></span> <span data-ttu-id="c3149-158">の 4 つの**送信**図形に**OrderBroker**オーケストレーションは、例外ハンドラーの一部ではないと何も行う必要があります、送信後に、アトミック トランザクション スコープに移動することができます。</span><span class="sxs-lookup"><span data-stu-id="c3149-158">Because four of the **Send** shapes in **OrderBroker** orchestration are not part of exception handlers and nothing needs to be done after the send, they can go in an atomic transaction scope.</span></span> <span data-ttu-id="c3149-159">これによって永続化ポイントの数が減ります。</span><span class="sxs-lookup"><span data-stu-id="c3149-159">This reduces the number of persistence points.</span></span> <span data-ttu-id="c3149-160">アトミック トランザクションの詳細については、次を参照してください。[アトミック トランザクション](../core/atomic-transactions.md)です。</span><span class="sxs-lookup"><span data-stu-id="c3149-160">For more information about atomic transactions, see [Atomic Transactions](../core/atomic-transactions.md).</span></span>  
  
 <span data-ttu-id="c3149-161">また、トランザクションがすべて同時に終了する場合、入れ子になったトランザクションについて、オーケストレーションが使用する永続化ポイントは 1 つだけです。</span><span class="sxs-lookup"><span data-stu-id="c3149-161">In addition, the orchestration engine will use a single persistence point for nested transactions if the transactions all end at the same time.</span></span> <span data-ttu-id="c3149-162">方法は、そのため、 **OrderBroker**オーケストレーションがトランザクションを入れ子さらに、永続化ポイントの削減: オーケストレーションが単一の永続化の使用によるポイント**スコープ**図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-162">Thus, the way **OrderBroker** orchestration nests transactions further reduces the persistence points: the orchestration has a single persistence point due to the use of **Scope** shapes.</span></span>  
  
> [!TIP]
>  <span data-ttu-id="c3149-163">オーケストレーションの永続化ポイントの数を最小限にすると、パフォーマンスを向上させることができます。</span><span class="sxs-lookup"><span data-stu-id="c3149-163">You can improve performance by minimizing the number of persistence points in an orchestration.</span></span> <span data-ttu-id="c3149-164">グループ化できます**送信**単一の永続化を生成するために、アトミック トランザクション内の図形がすべてのポイント、**送信**図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-164">You can group **Send** shapes in an atomic transaction to produce a single persistence point for all of the **Send** shapes.</span></span> <span data-ttu-id="c3149-165">入れ子になったトランザクションのスコープをすべて同時に終了すると、生成されるトランザクションの永続化ポイントは 1 つだけになります。</span><span class="sxs-lookup"><span data-stu-id="c3149-165">Ending nested transaction scopes at the same time produces a single persistence point for the transactions.</span></span>  
  
 <span data-ttu-id="c3149-166">アトミック トランザクションのスコープでは例外ハンドラを設定することができません。</span><span class="sxs-lookup"><span data-stu-id="c3149-166">An atomic transaction scope cannot have an exception handler.</span></span> <span data-ttu-id="c3149-167">このため、オーケストレーションは、長時間実行されるトランザクションの入れ子としてアトミック スコープを配置します。</span><span class="sxs-lookup"><span data-stu-id="c3149-167">Because of this, the orchestration nests the atomic scope inside a long running transaction.</span></span> <span data-ttu-id="c3149-168">この外側のトランザクションは、例外ハンドラーを持つことができ、この例外を処理するハンドラーは、**送信**図形です。</span><span class="sxs-lookup"><span data-stu-id="c3149-168">This outer transaction can have an exception handler and it is this handler that processes an exception from the **Send** shapes.</span></span>  
  
> [!TIP]
>  <span data-ttu-id="c3149-169">アトミック トランザクションを長時間実行されるトランザクションの入れ子にする方法は、例外処理を可能にする一般的なパターンです。</span><span class="sxs-lookup"><span data-stu-id="c3149-169">Nesting an atomic transaction inside a long running transaction is a common pattern to allow for exception handling.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c3149-170">参照</span><span class="sxs-lookup"><span data-stu-id="c3149-170">See Also</span></span>  
 <span data-ttu-id="c3149-171">[ビジネス プロセス管理ソリューションでの処理](../core/processing-in-the-business-process-management-solution.md) </span><span class="sxs-lookup"><span data-stu-id="c3149-171">[Processing in the Business Process Management Solution](../core/processing-in-the-business-process-management-solution.md) </span></span>  
 <span data-ttu-id="c3149-172">[プロセス マネージャのロジック](../core/process-manager-logic.md) </span><span class="sxs-lookup"><span data-stu-id="c3149-172">[Process Manager Logic](../core/process-manager-logic.md) </span></span>  
 <span data-ttu-id="c3149-173">[ビジネス プロセス管理ソリューションでの処理を中断します。](../core/interrupt-handling-in-the-business-process-management-solution.md) </span><span class="sxs-lookup"><span data-stu-id="c3149-173">[Interrupt Handling in the Business Process Management Solution](../core/interrupt-handling-in-the-business-process-management-solution.md) </span></span>  
 [<span data-ttu-id="c3149-174">ExceptionHandler オーケストレーション</span><span class="sxs-lookup"><span data-stu-id="c3149-174">The ExceptionHandler Orchestration</span></span>](../core/the-exceptionhandler-orchestration.md)