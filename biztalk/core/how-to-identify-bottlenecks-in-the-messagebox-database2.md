---
title: メッセージ ボックス Database2 ボトルネックを特定する方法 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 10b2eb1e-541c-457d-9735-ac6fb069b209
caps.latest.revision: 7
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: ffc04f31544a48f0ab25338c95beefaf14d5097c
ms.sourcegitcommit: 266308ec5c6a9d8d80ff298ee6051b4843c5d626
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/27/2018
ms.locfileid: "37010627"
---
# <a name="how-to-identify-bottlenecks-in-the-messagebox-database"></a><span data-ttu-id="e77e4-102">メッセージ ボックス データベースのボトルネックを特定する方法</span><span class="sxs-lookup"><span data-stu-id="e77e4-102">How to Identify Bottlenecks in the MessageBox Database</span></span>
<span data-ttu-id="e77e4-103">メッセージ ボックス データベースのボトルネックを特定するには、まず SQL Server エージェント サービスが開始されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-103">To identify bottlenecks in the MessageBox database, first ensure that the SQL-Server-Agent Service is started.</span></span> <span data-ttu-id="e77e4-104">サービスのスタートアップ状態を [手動] から [自動] に変更して、サーバーを再起動してもサービスが自動的に再開されるようにします。</span><span class="sxs-lookup"><span data-stu-id="e77e4-104">Change the Service startup state from Manual to Auto so that even if the server is restarted, the service will automatically restart.</span></span>  
  
 <span data-ttu-id="e77e4-105">既定では、Spool、TrackingData、または ApplicationQ テーブルのサイズが増加すると、BizTalk サービスによって制限されるようになっています。</span><span class="sxs-lookup"><span data-stu-id="e77e4-105">By default the BizTalk service will throttle if the Spool, TrackingData or ApplicationQ tables grow.</span></span> <span data-ttu-id="e77e4-106">これらのテーブルの切り捨てを行う SQL エージェント ジョブが実行されていない場合は、Spool テーブルのサイズが増加し、データベースにさらに負荷がかかるのを防ぐために制限が作動することになります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-106">These tables are pruned by SQL-Agent jobs, which, if not running will cause the Spool to grow causing throttling to kick in protecting the database from additional pressure.</span></span> <span data-ttu-id="e77e4-107">以下のパフォーマンス カウンターの状態を確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-107">Check the status of the following performance counters:</span></span>  
  
- <span data-ttu-id="e77e4-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span><span class="sxs-lookup"><span data-stu-id="e77e4-108">BizTalk:Message Agent (Host Name) Message Delivery Throttling State</span></span>  
  
- <span data-ttu-id="e77e4-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span><span class="sxs-lookup"><span data-stu-id="e77e4-109">BizTalk:Message Agent (Host Name) Message Publishing Throttling State</span></span>  
  
  <span data-ttu-id="e77e4-110">値 0 は、制限が発生していないことを示します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-110">A value of 0 indicates no throttling is occurring.</span></span> <span data-ttu-id="e77e4-111">値 6 は、データベース サイズの増加に起因する制限が発生していることを示します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-111">A value of 6 is indicative the system is throttling due to database growth.</span></span> <span data-ttu-id="e77e4-112">これらのカウンターの値を解釈する方法については、ドキュメントを参照してください。</span><span class="sxs-lookup"><span data-stu-id="e77e4-112">Please refer to the documentation on how to interpret other values of these counters.</span></span>  
  
## <a name="spool-table-growth"></a><span data-ttu-id="e77e4-113">Spool テーブルのサイズの増加</span><span class="sxs-lookup"><span data-stu-id="e77e4-113">Spool Table Growth</span></span>  
 <span data-ttu-id="e77e4-114">Spool のサイズが増加し始める原因は複数あります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-114">The Spool can start growing for multiple reasons.</span></span> <span data-ttu-id="e77e4-115">その 1 つとして、アプリケーション キューのサイズの増加があります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-115">One reason for Spool growth is if the application queues are growing.</span></span> <span data-ttu-id="e77e4-116">この増加には、下流のボトルネックやリソースの競合などさまざまな原因が考えられます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-116">They could grow due to various reasons like downstream bottlenecks and/or resource contention.</span></span>  
  
 <span data-ttu-id="e77e4-117">アプリケーション キューのサイズが小さいにもかかわらず Spool のサイズが大きい場合は、Purge ジョブの処理が追いついているかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-117">If the application queues are small and the Spool is still large, verify that the purge jobs are keeping up.</span></span> <span data-ttu-id="e77e4-118">SQL エージェント サービスが実行されていることを確かめたうえで、以下のジョブが正常に完了しているかどうかを確認してください。</span><span class="sxs-lookup"><span data-stu-id="e77e4-118">Ensure that the SQL-Agent Service is running and then verify that the following jobs are successfully completing:</span></span>  
  
- <span data-ttu-id="e77e4-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="e77e4-119">MessageBox_Message_Cleanup_BizTalkMessageBoxDb</span></span>  
  
- <span data-ttu-id="e77e4-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span><span class="sxs-lookup"><span data-stu-id="e77e4-120">MessageBox_Parts_Cleanup_BizTalkMessageBoxDb</span></span>  
  
  <span data-ttu-id="e77e4-121">MessageZeroSum テーブルのサイズが大きい場合は、メッセージの処理 (DeQueue の正常完了とアプリケーション キュー テーブルからのデータの削除) が完了し、該当する行に削除フラグが設定されているものの、</span><span class="sxs-lookup"><span data-stu-id="e77e4-121">If the MessageZeroSum table is large it indicates that the messages have been processed (DeQueue has successfully completed and deleted data from the Application Queue tables) and the rows have been flagged for deletion.</span></span> <span data-ttu-id="e77e4-122">Purge ジョブによるデータの削除が追いついていないことを示します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-122">However, the purge jobs are unable to keep up with deleting the data.</span></span> <span data-ttu-id="e77e4-123">その原因の 1 つとして、SQL Server コンピューターで深刻な CPU の競合が発生しており、CPU 不足のため Purge ジョブが適正な処理能力を維持できなくなっていることが考えられます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-123">One reason for this is if the SQL-Server machine is experiencing severe CPU contention, impacting the ability of the purge jobs to keep up due to CPU starvation.</span></span>  
  
## <a name="application-queue-table-growth"></a><span data-ttu-id="e77e4-124">アプリケーション キュー テーブルのサイズの増加</span><span class="sxs-lookup"><span data-stu-id="e77e4-124">Application Queue Table Growth</span></span>  
 <span data-ttu-id="e77e4-125">アプリケーション キューがホストするインフライト移行データは、処理が完了すると DeQueue によってクリーンアップされます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-125">Application queues host in-flight transition data that, once processed, are cleaned up by DeQueue.</span></span>  
  
 <span data-ttu-id="e77e4-126">これらのメッセージの処理が終わると、(該当する行への参照を保持している) Spool のクリーンアップが可能になります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-126">After these messages are processed the Spool (holding references to these rows) can be cleaned.</span></span>  
  
 <span data-ttu-id="e77e4-127">たとえば、RxHostQ はオーケストレーション PxHostQ にデータを公開し、その PxHostQ はさらに、それぞれ Spool テーブルの行を参照している送信側の TxHostQ にデータを公開します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-127">For example, the RxHostQ publishes data to the orchestration PxHostQ which in turn publishes data to the sending TxHostQ each referencing a row in the Spool table.</span></span> <span data-ttu-id="e77e4-128">特定の HostQ に対するメッセージがシステムで正常に処理されると、該当する行は DeQueue によって削除されます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-128">After the messages for a particular HostQ have successfully processed through the system these rows are deleted by DeQueue.</span></span> <span data-ttu-id="e77e4-129">削除後は、(それらの行によって参照されなくなった) Spool を Purge ジョブでクリーンアップできるようになります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-129">After these rows are deleted, the Spool (which is no longer referenced by these rows) can then be cleaned by the purge jobs.</span></span>  
  
 <span data-ttu-id="e77e4-130">アプリケーション キューのサイズの増加は、アプリケーション キューの排出を担うホスト インスタンスの処理速度が、受信速度 (メッセージが特定のアプリケーション キューに公開される速度) を下回っていることを示します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-130">Application Queue growth indicates that the Host Instances responsible for draining the Application Queue are unable to keep up with the incoming rate, that is, the rate at which messages are being published to the particular application queue.</span></span>  
  
 <span data-ttu-id="e77e4-131">たとえば、オーケストレーションの処理を担うサーバーが CPU に依存していて処理を高速化できないことが原因で、オーケストレーション アプリケーション キュー (PxHostQ) のサイズが増加する場合があります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-131">For example, the orchestration application queue (PxHostQ) may grow because the server responsible for processing orchestrations is CPU bound and unable to process any faster.</span></span> <span data-ttu-id="e77e4-132">オーケストレーション サーバーに引き換え受信サーバーが高速の場合、オーケストレーション サーバーの処理能力を上回る速度で公開が行われる可能性があり、アプリケーション キューのサイズの増加につながります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-132">However, if the receiving server is fast it may publish faster than what the orchestration server can process leading to the application queue growth.</span></span>  
  
 <span data-ttu-id="e77e4-133">オーケストレーション キューのサイズが増加するもう 1 つの原因として、メモリの競合が考えられます。これは、長時間実行される多数のオーケストレーション インスタンスがメモリ内ですべて同時にインスタンス化されることを意味します。その結果、メモリ使用量が膨れ上がり、それが間接的な原因となって制限が作動し、メモリ不足が解消されるまでスレッド プールが縮小されます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-133">Another reason for orchestration queue growth could be due to memory contention whereby numerous long running orchestration instances are all concurrently instantiated in memory, causing memory bloat indirectly causing throttling to shrink the thread pool until memory pressure is relieved.</span></span> <span data-ttu-id="e77e4-134">送信側のアプリケーション キューのサイズが増加する 1 つの原因としては、(BizTalk から送信される) メッセージを受け取る下流システムの受信速度が十分でないことが挙げられます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-134">One reason why the send application queue may grow is if the downstream system is unable to receive (outgoing from BizTalk) messages fast enough.</span></span> <span data-ttu-id="e77e4-135">その結果、メッセージが BizTalk システム内に残存してアプリケーション キューのサイズが増加することになり、最終的には制限が作動して受信速度が低減され、システム全体のスループットに影響が及びます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-135">Thus the messages will continue to reside within the BizTalk system causing Application queue growth which will ultimately cause throttling to kick in reducing the receiving rate impacting the overall throughput of the system.</span></span>  
  
## <a name="trackingdata-table-growth"></a><span data-ttu-id="e77e4-136">TrackingData テーブルのサイズの増加</span><span class="sxs-lookup"><span data-stu-id="e77e4-136">TrackingData Table Growth</span></span>  
 <span data-ttu-id="e77e4-137">メッセージ ボックス データベースの TrackingData テーブルは移行テーブルであり、インターセプターによってメッセージおよびサービス インスタンス追跡と BAM 追跡の両方の追跡データが書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-137">The TrackingData table in the MessageBox database is a transition table into which interceptors write tracking data for both message and service instance tracking and BAM tracking.</span></span> <span data-ttu-id="e77e4-138">追跡が無効になっている場合、このテーブルは空になります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-138">If tracking is disabled, this table should be empty.</span></span> <span data-ttu-id="e77e4-139">既定では、パイプラインおよびオーケストレーション送受信イベントのメッセージおよびサービス インスタンスの追跡が有効になっています。</span><span class="sxs-lookup"><span data-stu-id="e77e4-139">By default message and service instance tracking is enabled for the pipelines and orchestrations In/Out events.</span></span>  
  
 <span data-ttu-id="e77e4-140">メッセージ本文の追跡が有効になっている場合は、メッセージ ボックス サーバー (ホストの追跡を許可する設定になっているホスト) が実行されていることを確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-140">If Message Body Tracking is enabled, ensure that the MessageBox server (that is, the host with "allow host tracking") is running.</span></span> <span data-ttu-id="e77e4-141">これによってメッセージ ボックス データベースの TrackingData テーブルから BizTalkDTADb テーブルにデータが移動されるため、ボトルネックが軽減されます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-141">It will reduce a bottleneck as it moves data from TrackingData table in the MessageBox database to the BizTalkDTADb tables.</span></span>  
  
 <span data-ttu-id="e77e4-142">昇格させたプロパティやメッセージ本文の追跡などについてメッセージおよびサービス インスタンスのカスタム追跡を有効にすることにより、カスタム イベントを追跡することができます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-142">It is possible to track custom events by enabling custom message and service instance  tracking, for example, on promoted properties and message body tracking.</span></span> <span data-ttu-id="e77e4-143">追跡データに加え、BAM データもこのテーブルに書き込まれます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-143">In addition to tracking data, BAM data is also written to this table.</span></span> <span data-ttu-id="e77e4-144">このデータをメッセージ ボックス データベースから BizTalkDTADb データベースと BAMPrimaryImport データベースに移動し、正常に移動されたデータを削除するのは、TDDS (追跡が有効になっているホスト) の役割です。</span><span class="sxs-lookup"><span data-stu-id="e77e4-144">It is the responsibility of TDDS (the host on which tracking is enabled) to move this data from the MessageBox database to the BizTalkDTADb and BAMPrimaryImport databases, and then once successfully moved, delete this data.</span></span> <span data-ttu-id="e77e4-145">メッセージ本文の追跡データは、SQL エージェント ジョブ TrackedMessages_Copy_BizTalkMsgBoxDb によって別途移動されます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-145">Message body tracking data is moved separately by a SQL-Agent job TrackedMessages_Copy_BizTalkMsgBoxDb.</span></span>  
  
 <span data-ttu-id="e77e4-146">TDDS の処理速度が、インターセプターによって TrackingData テーブルにデータが書き込まれる速度を下回っていると、このテーブルのサイズが増加して制限が作動し、最終的には維持可能なスループットにも影響が及びます。</span><span class="sxs-lookup"><span data-stu-id="e77e4-146">If TDDS is unable to keep up with the rate at which the interceptors are writing data to the TrackingData table, this table will grow, causing throttling to kick in, ultimately impacting sustainable throughput.</span></span> <span data-ttu-id="e77e4-147">この問題を軽減するには、追跡が有効になった状態で実行されているホストを少なくとも 1 つ存在させるようにします。</span><span class="sxs-lookup"><span data-stu-id="e77e4-147">To alleviate this problem, ensure that at least 1 host is running with tracking enabled.</span></span>  
  
 <span data-ttu-id="e77e4-148">それでもデータがたまる場合は、BizTalkDTADb データベースを検証して、データベース サイズの増加が制御不能な性質のものではないことを確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-148">If the data still builds up, verify the BizTalkDTADb database to ensure that the database is not growing out of control.</span></span> <span data-ttu-id="e77e4-149">アーカイブおよび削除のジョブが実行されており、その処理速度がデータの到着速度を下回っていないことを確認してください。</span><span class="sxs-lookup"><span data-stu-id="e77e4-149">Ensure that the archiving and purging job is running and is able to keep up with the rate at which data is arriving.</span></span>  
  
> [!NOTE]
>  <span data-ttu-id="e77e4-150">BizTalkDTADb テーブルのデータは、アーカイブ化が完了しない限り Purge ジョブで削除できません。</span><span class="sxs-lookup"><span data-stu-id="e77e4-150">The purge job is unable to delete data from the BizTalkDTADb tables until this data has been archived.</span></span>  
  
 <span data-ttu-id="e77e4-151">TrackingData テーブルのサイズが増加していないかどうかを確認します。</span><span class="sxs-lookup"><span data-stu-id="e77e4-151">Verify that the TrackingData table is not growing.</span></span> <span data-ttu-id="e77e4-152">追跡が有効になった状態で実行されているホスト インスタンス (TDDS) が少なくとも 1 つ存在することを確認してください。</span><span class="sxs-lookup"><span data-stu-id="e77e4-152">Ensure that at least 1 host instance that is running has tracking enabled (TDDS).</span></span> <span data-ttu-id="e77e4-153">BizTalkDTADb データベースのサイズが大きくなりすぎると、メッセージ ボックス データベースから BizTalkDTADb データベースにデータを移動する TDDS の機能に悪影響が及ぶ可能性があります。</span><span class="sxs-lookup"><span data-stu-id="e77e4-153">If the BizTalkDTADb database has grown too large, it can have a negative impact on the ability of TDDS to move data from the MessageBox database to the BizTalkDTADb database.</span></span>  
  
 <span data-ttu-id="e77e4-154">TrackingData テーブルのサイズの増加は、場合によっては制限の作動につながり、維持可能な実行時のスループットに影響を及ぼします。</span><span class="sxs-lookup"><span data-stu-id="e77e4-154">Growth in the TrackingData table can cause throttling to kick in, impacting sustainable runtime throughput.</span></span>