---
title: BizTalk Server がホスト制限を実装する方法 |Microsoft ドキュメント
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- host throttling, rate based throttling
- host throttling, outbound
- host throttling, algorithm
- host throttling, components
- host throttling, inbound
- host throttling, resource based throttling
- host throttling, user controlled throttling
- host throttling, strategies
ms.assetid: 46d3c3de-66b9-4c8a-8369-e68563fc9c40
caps.latest.revision: ''
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 1944b61f9710b02f4e6db18a38972849847c532e
ms.sourcegitcommit: 8418b1a8f38b7f56979cd6e203f0b591e2f40fe1
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/28/2018
---
# <a name="how-biztalk-server-implements-host-throttling"></a>BizTalk Server のホスト制限の実装方法
[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] のホスト制限メカニズムは、制限の条件を継続的に監視し、制限の条件の重大度を評価し、評価された重大度に応じてホスト制限を段階的に適用します。 制限メカニズムは自律的で、既定の構成オプションは、ほとんどの適切な[!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)]シナリオを処理します。 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] ホスト制限は、特定のシナリオの制限を調整するために使用できるいくつかの構成可能なオプションを公開します。 これらの構成オプションを変更する方法の詳細については、次を参照してください。[ホスト設定を変更する方法](../core/how-to-modify-host-settings.md)です。  
  
## <a name="components-of-the-host-throttling-algorithm"></a>ホスト制限アルゴリズムのコンポーネント  
 [!INCLUDE[btsBizTalkServerNoVersion](../includes/btsbiztalkservernoversion-md.md)] は、ホスト制限を適用する際に次のアルゴリズムを使用します。  
  
1.  特定のしきい値を超えているかどうかを確認するため、次のパラメーターを継続的に監視します。 パラメーターの値がパラメーターのしきい値を超えると、制限の条件を満たしたことになります。  
  
    -   メモリの使用量 (システム全体のメモリとホスト プロセス メモリの両方)。  
  
    -   配信または処理されるインプロセス メッセージの数 (送信制限のしきい値)。  
  
    -   使用しているスレッドの数。  
  
    -   すべてのホストのキュー テーブル内の項目数とスプール テーブルおよび追跡テーブル内の項目数によって測定されるデータベース サイズ。  
  
    -   データベースの同時接続数。  
  
    -   メッセージの公開 (受信) と配信または処理 (送信) の割合。  
  
2.  制限の条件の重大度を判定します。 重大度が高い順に、制限の条件を挙げます。  
  
    -   使用しているホスト プロセス メモリがしきい値を超えている。  
  
    -   インプロセス メッセージの数がしきい値を超えている。  
  
    -   使用しているスレッド数がしきい値を超えている。  
  
    -   データベース サイズがしきい値を超えている。  
  
    -   他のすべての制限の条件。  
  
3.  制限の条件の重大度に基づいて、段階的に制限を適用します。 重大度のレベルが上がるにつれて、強化された制限が適用されます。 段階的な制限は、次のように実行されます。  
  
    -   1 つ以上の制限の条件が検出され、重大度が割り当てられます。  
  
    -   最も高い重大度の条件に基づいて、制限を実装する命令が発行されます。 制限の条件によっては、条件が残るとさまざまなスレッド プールのサイズが小さくなり、実行中のオーケストレーションが退避されてメモリが解放される場合があります。  
  
    -   メッセージの受信および送信に応じて、メッセージの公開または処理に遅延期間が適用されます。 遅延期間は、制限の条件の重大度に比例します。このため、重大度の高い制限の条件は、重大度の低い制限の条件よりも制限の期間が長くなります。 この遅延期間は、条件が変わるたびに制限のメカニズムによって特定の範囲内で期間が調整されます。 現在の遅延期間がを通じて公開される、 **メッセージの配信の遅延 (ミリ秒)** と **メッセージ公開の遅延 (ミリ秒)** に関連付けられているパフォーマンス カウンター、 **BizTalk:Message Agent** パフォーマンス オブジェクト カテゴリ。 これらのパフォーマンス オブジェクト カウンターは、トピックに記載されている[ホスト制限パフォーマンス カウンター](../core/host-throttling-performance-counters.md)です。  
  
    -   制限メカニズムは、制限の条件が存在するかどうかの確認を続けます。 制限の条件が緩和されると、制限されたメッセージのブロックが解除され、制限されていないモードでのスレッド プールと他のリソースの操作が許可されます。 制限の条件なしでシステムの実行を続けると、遅延期間が大幅に短縮されます。 制限の条件が残ると、条件の重大度に比例して遅延期間が長くなり、後続のメッセージの遅延期間が長くなります。  
  
    -   遅延期間が経過すると、制限は適用されなくなります。  
  
## <a name="type-of-throttling-conditions"></a>制限の条件の種類  
 制限の条件には、3 つの主要な種類 (比率ベース、リソース ベース、オーケストレーション) があります。  
  
1.  **比率ベースの制限** は 2 つのカテゴリに分かれています (公開) の受信し、送信 (配信)。  
  
    -   受信 (公開) メッセージでは、BizTalk Server は、制限メッセージを公開する場合、 **メッセージ公開の受信速度** インスタンスを超えるホストの **メッセージ公開の送信速度\*** 、指定した **オーバー ドライブ率 (%)** 値。 **オーバー ドライブ率 (%)** パラメーターを構成するには、 **メッセージ公開の制限の設定**  ダイアログ ボックス。 受信メッセージに対する比率ベースの制限は、メッセージのバッチをメッセージ ボックス データベースに公開する前に遅延を発生させることで、主に実現されます。 受信メッセージに対する比率ベースの制限を実現する操作は他にありません。  
  
    -   送信 (配信) メッセージでは、BizTalk Server は、制限メッセージの配信の場合、 **メッセージ配信の受信速度** インスタンスを超えるホストの **メッセージ配信の送信比率** \* 、指定した **オーバー ドライブ率 (%)** 値。 **オーバー ドライブ率 (%)** パラメーターを構成するには、 **メッセージ処理の制限の設定**  ダイアログ ボックス。 送信メッセージに対する比率ベースの制限は、インメモリ キューのメッセージを取り出してエンド ポイント マネージャー (EPM) またはオーケストレーション エンジンの処理にメッセージを配信する前に遅延を発生させることで、主に実現されます。 送信メッセージに対する比率ベースの制限を実現する操作は他にありません。  
  
         オーバー ドライブ率とその他の比率ベースの制限値の詳細については、次を参照してください。[比率ベースの調整設定の変更方法](../core/how-to-modify-rate-based-throttling-settings.md)です。  
  
2.  **リソース ベースの制限** スレッド、メモリ、およびデータベースのサイズなどのシステム リソースを監視し、任意のサービス クラスに適用できます。 リソース ベースの制限値の詳細については、次を参照してください。[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。  
  
3.  **オーケストレーションの制限** 退避およびサブスクリプションの一時停止/再開する場合に防ぐことができます。 オーケストレーション制限値の詳細については、次を参照してください。[オーケストレーション制限の設定の変更方法](../core/how-to-modify-orchestration-throttling-settings.md)です。  
  
## <a name="throttling-condition-triggers-actions-and-mitigation-strategies"></a>制限の条件の発生原因、アクション、および緩和方法  
 このセクションでは、さまざまな制限の条件の発生原因、制限メカニズムによって発生するアクション、および制限の条件を緩和する技術について説明します。  
  
### <a name="inbound-throttling"></a>受信制限  
 BizTalk 制限メカニズムは、オーケストレーション エンジン (XLANG) および受信アダプターに受信制限を適用します。  
  
 使用して、 **メッセージ公開の制限の状態** と **メッセージ公開の制限の状態の持続時間** に関連付けられたカウンター **BizTalk:MessageAgent** スロットルの現在の状態と制限の期間を測定するパフォーマンス オブジェクト カテゴリ。 使用可能なホスト制限パフォーマンス カウンターの詳細については、次を参照してください。[ホスト制限パフォーマンス カウンター](../core/host-throttling-performance-counters.md)です。  
  
 受信制限によって、受信メッセージがソースに残る場合があります。 受信制限が受信アダプターに適用されると、受信アダプターは、制限の条件が緩和されるまで、メッセージの受信を停止することがあります。  
  
|メッセージの公開<br /><br /> 制限の状態|制限の条件の発生原因|実行される制限のアクション|回避策|パフォーマンス オブジェクト|パフォーマンス カウンター|  
|---------------------------------------------|--------------------------------------|------------------------------|-------------------------|------------------------|-------------------------|  
|2|**メッセージ公開の受信速度** インスタンスを超えるホストの **メッセージ公開の送信速度\*** 、指定した **オーバー ドライブ率 (%)** 値。 データベースの処理が公開率についていけません。|まで動的に計算された期間中に、公開スレッドをブロック、 **Message Publishing Incoming Rate** と同じには、 **Message Publishing Outgoing Rate** \* 、指定した **オーバー ドライブ率 (%)** 値。|パフォーマンス カウンターを使用して、メッセージ公開の受信 (および送信) 比率を指定します。 使用している環境に適切なオーバードライブ率を検討してください。<br /><br /> 指定した値を確認、 **サンプリング間隔** と **最小サンプル数** パラメーターは、シナリオに適したします。<br /><br /> これらのパラメーターの詳細については、次を参照してください。[比率ベースの調整設定の変更方法](../core/how-to-modify-rate-based-throttling-settings.md)です。|BizTalk:MessageAgent|Message publishing incoming rate<br /><br /> Message publishing outgoing rate|  
|4|プロセス メモリが指定されたしきい値を超えている。<br /><br /> 公開するバッチのメモリ要求が厳しい場合またはメッセージを処理するスレッドの数が多すぎる場合、この現象が発生する可能性があります。|EPM で使用されるスレッド プールのサイズを小さくします。<br /><br /> 新しいメッセージのバッチの処理を中止 EPM スレッドをブロックします。<br /><br /> バッチのメッセージをデータベースに保存するメモリ要求が厳しい場合、メッセージがデータベースに保存される前に、公開スレッドも段階的に遅れます。<br /><br /> プロセス メモリ不足によって公開バッチがブロックされるかどうかは、バッチのメッセージ数や、バッチで退避コマンドやメッセージ削除コマンドが使用されているかどうかなど、複数の要因によって決まります。|EPM スレッド プールを小さくして読み込みを少なくすること、および、アダプター バッチのサイズを小さくすることを検討します。<br /><br /> プロセスが大量のメモリを使用していない場合は、増やすことを検討、 **プロセス仮想** ホストのしきい値。<br /><br /> 変更の詳細については、**プロセス仮想メモリ**値は、「[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|High process memory<br /><br /> Process memory usage (MB)<br /><br /> Process memory usage threshold (MB)|  
|6|ホスト メッセージ キュー サイズ、スプール テーブル サイズ、または追跡テーブル サイズが指定されたしきい値を超えている。<br /><br /> この条件が考えられる理由には次のものがあります。<br /><br /> -SQL エージェント ジョブは実行されていない BizTalk Server データベースを維持するために BizTalk Server で使用または実行速度が遅い。<br />-ダウン ストリーム コンポーネントは、適切なタイミングで、インメモリ キューからメッセージを処理していません。<br />-保留中のメッセージの数は高です。<br />-システムの維持可能な最大の負荷に達しています。|EPM で使用されるスレッド プールのサイズを小さくします。<br /><br /> 新しいメッセージのバッチの処理を中止 EPM スレッドをブロックします。<br /><br /> メッセージがデータベースに保存される前に、公開スレッドも段階的に遅れます。|BizTalk Server データベースを保守する BizTalk Server で使用される SQL エージェント ジョブが実行されていて障害が発生していないことを確認します。<br /><br /> 必要に応じて、中断したインスタンスを終了および再開します。<br /><br /> 既定値を大きく、 **DB 内の数をメッセージ** しきい値は、BizTalk データベースを格納する SQL server の容量の要件を考慮します。<br /><br /> 場合は、データベースのサイズが、追加のメッセージのバックログを処理する適切では、増やすことを検討、 **スプール乗数** と **追跡データ乗数** 値が、スプール テーブルおよび追跡テーブルに追加のバックログを使用します。<br /><br /> 値の変更の詳細については、次を参照してください。[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent<br /><br /> BizTalk:Message Box:General Counters<br /><br /> BizTalk:Message Box:Host Counters|MessageAgent /Database size<br /><br /> Message Box:General Counters /Spool size<br /><br /> Message Box:General Counters /Tracking data size<br /><br /> Message Box:Host Counters/Host queue – length<br /><br /> Message Box:Host Counters/Host queue - suspended msgs – length|  
|8|ホスト インスタンスによって使用されるデータベース セッションが指定されたしきい値を超えている。|EPM で使用されるスレッド プールのサイズを小さくします。<br /><br /> 新しいメッセージのバッチの処理を中止 EPM スレッドをブロックします。<br /><br /> メッセージがデータベースに保存される前に、公開スレッドも段階的に遅れます。|増やすことを検討、 **データベース接続** ホストのしきい値。<br /><br /> この値を変更する方法の詳細については、次を参照してください。[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|Database session|  
|9|プロセス スレッドの数が指定されたしきい値を超えている。|EPM で使用されるスレッド プールのサイズを小さくします。<br /><br /> 新しいメッセージのバッチの処理を中止 EPM スレッドをブロックします。<br /><br /> メッセージがデータベースに保存される前に、公開スレッドも段階的に遅れます。|多くのスレッドが作成されないように、異なるスレッド プール サイズを設定することを検討します。<br /><br /> スレッド プール サイズを変更する方法の詳細については、次を参照してください。[全般設定を変更する方法](../core/how-to-modify-general-settings.md)と[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|Thread count<br /><br /> Thread count threshold|  
|5|システム メモリが指定されたしきい値を超えている。|EPM で使用されるスレッド プールのサイズを小さくします。<br /><br /> 新しいメッセージのバッチの処理を中止 EPM スレッドをブロックします。<br /><br /> バッチのメッセージをデータベースに保存するメモリ要求が厳しい場合、メッセージがデータベースに保存される前に、公開スレッドも段階的に遅れます。<br /><br /> プロセス メモリ不足によって公開バッチがブロックされるかどうかは、バッチのメッセージ数や、バッチで退避コマンドやメッセージ削除コマンドが使用されているかどうかなど、複数の要因によって決まります。|EPM スレッド プールの既定のサイズを小さくして読み込みを少なくすること、およびアダプター バッチのサイズを小さくすることを検討します。<br /><br /> プロセスが大量のメモリを使用していない場合は、増やすことを検討、 **グローバル物理メモリ** ホストのしきい値。<br /><br /> 変更する方法の詳細について、**グローバル物理**しきい値を参照してください[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|Physical memory usage (MB)<br /><br /> Physical memory usage threshold (MB)|  
  
### <a name="outbound-throttling"></a>送信制限  
 BizTalk 制限メカニズムは、オーケストレーション エンジン (XLANG) および送信アダプターに送信制限を適用します。  
  
 使用して、 **調整の状態メッセージの配信** と **メッセージの配信状態の持続時間を調整** に関連付けられたカウンター **BizTalk:MessageAgent** スロットルの現在の状態と制限の期間を測定するパフォーマンス オブジェクト カテゴリ。 詳細については、使用可能なホスト制限のパフォーマンス カウンターを参照してください[ホスト制限パフォーマンス カウンター](../core/host-throttling-performance-counters.md)です。  
  
 送信制限ではメッセージの配信が遅れる場合があるため、メッセージがインメモリ キューに蓄積され、制限の条件が緩和されるまでキューから取り出すスレッドがブロックされる可能性があります。 キューから取り出すスレッドがブロックされると、メッセージ ボックス データベースから送信用のインメモリ キューに追加のメッセージが格納されます。  
  
|メッセージ配信<br /><br /> 制限の状態|制限の条件の発生原因|実行される制限のアクション|緩和方法|パフォーマンス オブジェクト|パフォーマンス カウンター|  
|-------------------------------------------|--------------------------------------|------------------------------|-------------------------|------------------------|-------------------------|  
|1|**メッセージ配信の受信速度** インスタンスを超えるホストの **メッセージ配信の送信比率 \*** 、指定した **オーバー ドライブ率 (%)** 値<br /><br /> 非常に複雑な処理、低速の送信アダプター、またはシステム リソースの一時的な不足によって、この現象が発生する可能性があります。|まで、メッセージ配信の受信速度と同じに動的に計算された期間中に、配信スレッドをブロックする、 **メッセージ配信の送信比率 \*** 、指定した **オーバー ドライブ率 (%)** 値。|パフォーマンス カウンターを使用して、メッセージ配信の受信 (および送信) 比率を指定します。 適切なオーバー ドライブ率、環境を検討します。<br /><br /> 指定した値を確認、 **サンプリング間隔** と **最小サンプル数** パラメーターは、シナリオに適したします。<br /><br /> これらのパラメーターの詳細については、次を参照してください。[比率ベースの調整設定の変更方法](../core/how-to-modify-rate-based-throttling-settings.md)です。|BizTalk:MessageAgent|Message delivery incoming rate<br /><br /> Message publishing outgoing rate|  
|4|プロセス メモリが指定されたしきい値を超えている。<br /><br /> サイズの大きいメッセージを処理する場合や送信アダプターで多くのメッセージを同時に処理しようとする場合のメモリを大量に使用するシナリオで、この現象が発生する可能性があります。|アダプターまたは XLANG へのメッセージの配信を遅くします。<br /><br /> 適用できる場合にサービス インスタンスを退避してキャッシュを小さくすることで、プロセス メモリ使用量を小さくします。<br /><br /> EPM とメッセージ エージェントのいずれかまたは両方で使用されるスレッド プールのサイズを小さくします。<br /><br /> 定期的に .NET ガベージ コレクション (GC) を強制的に実行します。|プロセス メモリ ベースでの制限のためにシステムがアイドル状態にならない場合、操作が不要になることがあります。<br /><br /> 場合、 **インプロセス メッセージ カウント** カウンターが高いと、CPU 使用率が大きすぎないプロセス メモリ ベースの制限がある場合にも追加操作はありません。<br /><br /> 過剰に制限する、システムが表示された場合は、関連付けられた値を増やすことを検討、 **プロセス仮想** ホストのしきい値をホスト インスタンスで、「メモリ不足」エラーが発生しないことを確認します。 増やすことで、「メモリ不足」エラーが発生した場合、 **プロセス仮想** のしきい値の値を減らすことを検討して、 **内部メッセージ キュー サイズ** と **インプロセス メッセージ** しきい値です。 この方法は、サイズの大きいメッセージを処理するシナリオに特に関連します。<br /><br /> これらのパラメーターの詳細については、次を参照してください。[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|High process memory<br /><br /> プロセス メモリ usage(MB)<br /><br /> Process memory usage threshold (MB)<br /><br /> In-process message count<br /><br /> Active instance count|  
|3|サービス クラスに配信されたインプロセス メッセージの数が指定されたしきい値を超えている。<br /><br /> 非常に複雑な処理、低速の送信アダプター、またはシステム リソースの一時的な不足によって、この現象が発生する可能性があります。|アダプターまたは XLANG へのメッセージの配信を遅くします。<br /><br /> メッセージ エージェントによって使用されるスレッド プールのサイズを小さくします。|制限を超えるが発生した場合は、関連付けられた値を増やすことを検討、 **インプロセス メッセージ** しきい値です。<br /><br /> このパラメーターの詳細については、次を参照してください[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)**注:**悪影響を及ぼす送信アダプターのパフォーマンスに影響を与えるやメモリを増やすことがありますこの値を増やす。プロセスの使用量。|BizTalk:MessageAgent|In-process message count<br /><br /> In-process message count threshold|  
|9|プロセス スレッドの数が指定されたしきい値を超えている。|EPM とメッセージ エージェントによって使用されるスレッド プールのサイズを縮小します。|多くのスレッドが作成されないように、異なるスレッド プール サイズを設定することを検討します。<br /><br /> スレッド プール サイズを変更する方法の詳細については、次を参照してください。[全般設定を変更する方法](../core/how-to-modify-general-settings.md)と[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|Thread count<br /><br /> Thread count threshold|  
|5|システム メモリがしきい値を超えている。|アダプターまたは XLANG へのメッセージの配信を遅くします。<br /><br /> 適用できる場合にサービス インスタンスを退避してキャッシュを小さくすることで、プロセス メモリ使用量を小さくします。<br /><br /> EPM とメッセージ エージェントのいずれかまたは両方で使用されるスレッド プールのサイズを小さくします。|EPM スレッド プールの既定のサイズを小さくして読み込みを少なくすること、およびアダプター バッチのサイズを小さくすることを検討します。<br /><br /> プロセスが大量のメモリを使用していない場合は、増やすことを検討、 **グローバル物理メモリ** ホストのしきい値。<br /><br /> 変更の詳細については、**グローバル物理**しきい値を参照してください[リソース ベースの調整設定の変更方法](../core/how-to-modify-resource-based-throttling-settings.md)です。|BizTalk:MessageAgent|Physical memory usage (MB)|