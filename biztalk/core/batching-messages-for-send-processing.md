---
title: メッセージのバッチ処理の送信 |Microsoft Docs
ms.custom: ''
ms.date: 06/08/2017
ms.prod: biztalk-server
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
ms.assetid: 7d9115ec-13bc-41a8-8928-57b168c95af4
caps.latest.revision: 6
author: MandiOhlinger
ms.author: mandia
manager: anneta
ms.openlocfilehash: 7854151b0b32165d2ec3db83a90516898cf8d8e6
ms.sourcegitcommit: 53b16fe6c1b1707ecf233dbd05f780653eb19419
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/01/2018
ms.locfileid: "50753138"
---
# <a name="batching-messages-for-send-processing"></a><span data-ttu-id="e26fd-102">送信処理用メッセージのバッチ処理</span><span class="sxs-lookup"><span data-stu-id="e26fd-102">Batching Messages for Send Processing</span></span>
## <a name="send-adapter-batch-management"></a><span data-ttu-id="e26fd-103">送信アダプターのバッチ管理</span><span class="sxs-lookup"><span data-stu-id="e26fd-103">Send Adapter Batch Management</span></span>  
 <span data-ttu-id="e26fd-104">送信側でトランザクションを使用する際には、BizTalk Server によって作成され対象システムへの送信に使用されたトランザクションが、メッセージの正常な送信後に、そのメッセージの削除用にも使用されます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-104">When using transactions on the send side, the same transaction created by BizTalk Server and used for sending to the target system is used for the corresponding message deletion once it has been sent successfully.</span></span> <span data-ttu-id="e26fd-105">エラーが発生してトランザクションが終了する場合もあります。その場合は削除が中断し、対象システムではなく BizTalk Server にデータが残ります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-105">If anything fails, the transaction can be ended, in which case the deletion is aborted, and the data remains in BizTalk Server and not in the target system.</span></span> <span data-ttu-id="e26fd-106">これにより、メッセージの重複が防止されます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-106">This prevents duplication of messages.</span></span> <span data-ttu-id="e26fd-107">トランザクションがサポートされるのは非同期送信アダプターに対してのみです。</span><span class="sxs-lookup"><span data-stu-id="e26fd-107">Transactions are only supported for asynchronous send adapters.</span></span> <span data-ttu-id="e26fd-108">同期送信アダプターではトランザクションを使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="e26fd-108">You should not use transactions with synchronous send adapters.</span></span>  
  
 <span data-ttu-id="e26fd-109">ただしアダプターは、トランザクションを終了するだけでなく、渡されたメッセージの状態も正しく処理する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-109">But the adapter cannot just end the transaction; it must also handle correctly the state of the messages it was given.</span></span> <span data-ttu-id="e26fd-110">具体的には、アダプターは、メソッドを呼び出す必要があります**再送信**、 **MoveToNextTransport**、および**MoveToSuspendQ**再試行の回数に応じてとかどうかバックアップ トランスポートを使用。</span><span class="sxs-lookup"><span data-stu-id="e26fd-110">Specifically, the adapter should call the methods **Resubmit**, **MoveToNextTransport**, and **MoveToSuspendQ** appropriately depending upon the retry count and whether a backup transport is available.</span></span>  
  
 <span data-ttu-id="e26fd-111">配置することが重要、**削除**と**SubmitResponse**操作で、同じトランザクションを使用するバッチにまとめています。</span><span class="sxs-lookup"><span data-stu-id="e26fd-111">It is important to place the **Delete** and **SubmitResponse** operations together in a batch that uses the same transaction.</span></span> <span data-ttu-id="e26fd-112">エラーはトランザクションを終了することによって処理されます (外部システムへのデータ送信を 1 回に限定するため)。</span><span class="sxs-lookup"><span data-stu-id="e26fd-112">Failure is handled by ending the transaction (to ensure that data is only submitted once to an external system).</span></span> <span data-ttu-id="e26fd-113">再送信したり、呼び出したりする場合でも、 **MoveToNextTransport** BizTalk Server でのメッセージ。</span><span class="sxs-lookup"><span data-stu-id="e26fd-113">But you still want to resubmit or call **MoveToNextTransport** for the message back on BizTalk Server.</span></span> <span data-ttu-id="e26fd-114">そのためには、別の標準のバッチ (トランザクション バッチではないバッチ) を使用してこれらの操作を行います。</span><span class="sxs-lookup"><span data-stu-id="e26fd-114">To do this, use a separate normal (non-transactional) batch for these types of operations.</span></span>  
  
 <span data-ttu-id="e26fd-115">次の図では、応答メッセージに対して別のバッチを使用しています。</span><span class="sxs-lookup"><span data-stu-id="e26fd-115">The following figure shows the use of separate batches for response messages.</span></span>  
  
 <span data-ttu-id="e26fd-116">![応答メッセージには個別のバッチを使用して](../core/media/eawp-separatebatch.gif "EAWP_SeparateBatch")</span><span class="sxs-lookup"><span data-stu-id="e26fd-116">![Using a separate batch for response messages](../core/media/eawp-separatebatch.gif "EAWP_SeparateBatch")</span></span>  
  
## <a name="sorting-the-send-side-transactional-batches-by-endpoint"></a><span data-ttu-id="e26fd-117">送信側トランザクション バッチのエンドポイント別振り分け</span><span class="sxs-lookup"><span data-stu-id="e26fd-117">Sorting the Send-Side Transactional Batches by Endpoint</span></span>  
 <span data-ttu-id="e26fd-118">BizTalk Server によってアダプターに送信されるメッセージのバッチは、複数の送信ポート (エンドポイント) にまたがっている場合があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-118">Batches of messages sent by BizTalk Server to the adapter can span multiple send ports (or endpoints).</span></span> <span data-ttu-id="e26fd-119">アダプターが送信ポートに基づいてメッセージを並べ替える必要がありますので、通常、アダプターは、トランザクションを単一のエンドポイントにしたいと考えていると、(**SPName**または**OutboundTransportLocation**)。</span><span class="sxs-lookup"><span data-stu-id="e26fd-119">Because the adapter typically wants to have a transaction to a single endpoint, the adapter must sort the messages based on send port (**SPName** or **OutboundTransportLocation**).</span></span> <span data-ttu-id="e26fd-120">そうすることで、特定の送信ポートのみを使用するトランザクションを作成できます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-120">By doing this, the adapter can create a transaction that spans only a particular send port.</span></span>  
  
 <span data-ttu-id="e26fd-121">たとえば、FTP 送信アダプターが BizTalk Server から受信するメッセージのバッチには、現在アクティブなすべての FTP 送信ポートのメッセージのバッチが混在しています。</span><span class="sxs-lookup"><span data-stu-id="e26fd-121">For example, when an FTP send adapter receives a batch of messages from BizTalk Server, it gets a mixed batch of messages for all the currently active FTP send ports.</span></span> <span data-ttu-id="e26fd-122">これは、API がシングルトン ベースであるためです。つまり、読み込まれる FTP アダプターは 1 つだけであり、送信ポートごとにアダプターが読み込まれるわけではありません。</span><span class="sxs-lookup"><span data-stu-id="e26fd-122">This happens because the API is singleton based, meaning that only a single FTP adapter is loaded, not one per send port.</span></span>  
  
 <span data-ttu-id="e26fd-123">アダプターではまず、BizTalk Server によって渡されたメッセージのバッチを、エンドポイントごとに別のバッチに振り分ける必要があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-123">The adapter must first sort the batch of messages it was given by BizTalk Server into separate batches, one for each endpoint.</span></span> <span data-ttu-id="e26fd-124">これにより、各エンドポイントを交代で処理できるようになり、各エンドポイントの削除バッチを作成することも可能になります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-124">Then it can deal with each endpoint in turn and will probably construct delete batches for each endpoint.</span></span> <span data-ttu-id="e26fd-125">SDK サンプル コードの再利用可能な BaseAdapter ジェネリック クラスも同じように動作します。</span><span class="sxs-lookup"><span data-stu-id="e26fd-125">The BaseAdapter generic reusable classes in the SDK sample code work in the same way.</span></span>  
  
## <a name="sorting-for-dynamic-send"></a><span data-ttu-id="e26fd-126">動的送信のための振り分け</span><span class="sxs-lookup"><span data-stu-id="e26fd-126">Sorting for Dynamic Send</span></span>  
 <span data-ttu-id="e26fd-127">BizTalk Server オーケストレーションでは、メッセージ ヘッダーと URL 自体に十分な構成情報が含まれていれば、構成されていないポートにメッセージを送信できます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-127">A BizTalk Server orchestration can send a message to a port that has not been configured as long as it provides sufficient configuration details in the message header and in the URL itself.</span></span> <span data-ttu-id="e26fd-128">BizTalk Server は、URL のプロトコルを認識する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-128">BizTalk Server must recognize the protocol of the URL.</span></span>  
  
 <span data-ttu-id="e26fd-129">メッセージを振り分ける際には、エンドポイントがどのように定義されるのかを明確にしてください。</span><span class="sxs-lookup"><span data-stu-id="e26fd-129">When sorting messages, you should take care to establish what defines an endpoint.</span></span> <span data-ttu-id="e26fd-130">動的送信の場合には特にこれが重要になります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-130">This is especially true in the case of a dynamic send.</span></span> <span data-ttu-id="e26fd-131">エンドポイントを定義するのが URI だけである場合は簡単です。</span><span class="sxs-lookup"><span data-stu-id="e26fd-131">If only the URI defines the endpoint, then things are simple.</span></span> <span data-ttu-id="e26fd-132">しかし、FTP セッションでは、FTP サーバーがユーザー名のログオンの詳細を使用して実際のエンドポイントを定義する場合もあります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-132">However, in an FTP session the user name logon details might be used by the FTP server to define the true endpoint.</span></span> <span data-ttu-id="e26fd-133">その場合は、アダプターが別のアカウントとしてログインすると別のディレクトリに接続されてしまいます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-133">In this case, if the adapter logs in as a different account, it may be connected to a different directory.</span></span>  
  
 <span data-ttu-id="e26fd-134">場合によっては、エンタープライズ シングル サインオン (SSO) コマンドを実行するされるまで実際のエンドポイントは認識されません**ValidateAndRedeemTicket**します。</span><span class="sxs-lookup"><span data-stu-id="e26fd-134">In some cases, the true endpoint is not known until you have run the Enterprise Single Sign-On (SSO) command **ValidateAndRedeemTicket**.</span></span>  
  
 <span data-ttu-id="e26fd-135">MQSeries の場合は、トランザクションを使用するかどうかの決定は構成可能です。</span><span class="sxs-lookup"><span data-stu-id="e26fd-135">In the case of MQSeries, the determination of whether to use transactions is configurable.</span></span> <span data-ttu-id="e26fd-136">このアーキテクチャと、リモートの COM+ オブジェクトが使用されることから、トランザクション エンドポイントを非トランザクション エンドポイントとは別のものと考えることをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="e26fd-136">Given the architecture and the use of a remote COM+ object, it is best to regard a transactional endpoint as distinct from a non-transactional endpoint.</span></span>  
  
 <span data-ttu-id="e26fd-137">つまり、メッセージを 1 つのエンドポイントのバッチに振り分けるのは必ずしも容易ではなく、場合によっては、コンテキスト値や SSO の呼び出しの結果も考慮に入れなければなりません。</span><span class="sxs-lookup"><span data-stu-id="e26fd-137">To summarize, sorting messages into their single endpoint batches is sometimes a nontrivial task and may involve such extra steps as considering the context values and even the result of a call to SSO.</span></span>  
  
## <a name="sorting-for-static-send"></a><span data-ttu-id="e26fd-138">静的送信のための振り分け</span><span class="sxs-lookup"><span data-stu-id="e26fd-138">Sorting for Static Send</span></span>  
 <span data-ttu-id="e26fd-139">場合は、エンドポイントが静的に構成されたエンドポイントが存在する一意の GUID を静的ポートの ID (SPID) と呼ばれるメッセージのコンテキスト。</span><span class="sxs-lookup"><span data-stu-id="e26fd-139">If the endpoint is a statically configured endpoint there is a unique GUID on the message context called the static port ID (SPID).</span></span> <span data-ttu-id="e26fd-140">この値をエンドポイントの識別のために使用できます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-140">This value can be used for sorting the endpoint.</span></span> <span data-ttu-id="e26fd-141">この値を取得するためのコードを以下に示します。</span><span class="sxs-lookup"><span data-stu-id="e26fd-141">The following code can be used to retrieve it:</span></span>  
  
```  
string spid = (string)message.Context.Read("SPID", "http://schemas.microsoft.com/BizTalk/2003/system-properties");  
```  
  
 <span data-ttu-id="e26fd-142">これは、XSD (XML スキーマ定義) ベースの構成フレームワークによる問題を検討する場合に便利です。</span><span class="sxs-lookup"><span data-stu-id="e26fd-142">This is helpful when you consider the problems introduced by the XML Schema Definition (XSD)-based configuration framework.</span></span> <span data-ttu-id="e26fd-143">このフレームワークでは、エンドポイント キーの一部である可能性があるプロパティが、1 つのコンテキスト プロパティの XML に埋め込まれています。</span><span class="sxs-lookup"><span data-stu-id="e26fd-143">With this framework, you have a property that might be part of the endpoint key buried inside XML in a single context property.</span></span> <span data-ttu-id="e26fd-144">そのコンテキストに SPID がある場合は、それを使用してバッチを振り分けることができます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-144">If you have a SPID on the context, you can use that as a way to sort the batch.</span></span> <span data-ttu-id="e26fd-145">それ以外の場合は、動的送信が行われているため、バッチを振り分けるための別のキーを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-145">Otherwise you are doing a dynamic send and you need to construct an alternative key with which to sort the batch.</span></span>  
  
 <span data-ttu-id="e26fd-146">次の図は、エンドポイントによるメッセージの振り分けを示しています。</span><span class="sxs-lookup"><span data-stu-id="e26fd-146">The following figure shows message sorting by endpoint.</span></span>  
  
 <span data-ttu-id="e26fd-147">![エンドポイントでメッセージを振り分ける](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span><span class="sxs-lookup"><span data-stu-id="e26fd-147">![Sorting messages by endpoint](../core/media/eawp-sortbatch.gif "EAWP_SortBatch")</span></span>  
  
 <span data-ttu-id="e26fd-148">メッセージの再試行の回数にはバッチの成功や失敗は反映されないことに注意してください。</span><span class="sxs-lookup"><span data-stu-id="e26fd-148">Remember that the retry count of a message is not aware of the success or failure of a batch.</span></span> <span data-ttu-id="e26fd-149">送信側では、バッチ内の少数のメッセージが失敗したためにそのメッセージのバッチが失敗になる場合があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-149">On the send side, a batch of messages may fail because a few messages in the batch have failed.</span></span> <span data-ttu-id="e26fd-150">アダプターでは、受信するすべてのメッセージについて判断を下す必要があります。</span><span class="sxs-lookup"><span data-stu-id="e26fd-150">The adapter must make a determination for every message that it receives.</span></span> <span data-ttu-id="e26fd-151">失敗したバッチのシナリオでは、すべてのメッセージが再送信されるように思われがちですが、</span><span class="sxs-lookup"><span data-stu-id="e26fd-151">In the failed batch scenario, you might assume that every message is resubmitted.</span></span> <span data-ttu-id="e26fd-152">失敗したバッチのすべてのメッセージが再送信されると、失敗したメッセージとたまたま同じバッチに含まれていた成功したメッセージに対してまで再試行の回数 (BizTalk Server エンジンによって保持される) が加算されてしまいます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-152">However, if all the messages in a failing batch are resubmitted, the retry count (which is maintained by the BizTalk Server engine) is incorrectly incremented even for the successful messages because they happen to be in the same batch as the failed messages.</span></span> <span data-ttu-id="e26fd-153">この場合は、アダプターで送信バッチを作り直して、成功したメッセージを外部システムに対して再試行できます。</span><span class="sxs-lookup"><span data-stu-id="e26fd-153">In this case, an adapter could reform the outbound batch and retry the successful messages against the external system.</span></span>
